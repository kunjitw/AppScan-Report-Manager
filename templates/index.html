<!DOCTYPE html>
<html lang="zh-TW"> <!-- 指定語言為繁體中文 -->
<head>
    <meta charset="UTF-8"> <!-- 使用 UTF-8 編碼 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 設定視口，用於響應式設計 -->
    <!-- 頁面標題，動態顯示專案名稱 -->
    <title>{{ project_display_name | default(project_name) | e }} - AppScan 報告檢視器</title>
    <!-- 引入 Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Font Awesome 6 圖示庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入 Google Fonts (Noto Sans TC) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Chart.js (用於繪製圖表) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 延遲載入 Bootstrap 5 JS Bundle (包含 Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <style>
        /* --- 基礎樣式 (Base Styles) --- */
        body {
            padding: 20px; /* 頁面內邊距 */
            background-color: #f8f9fa; /* 淺灰色背景 */
            font-size: 14px; /* 基礎字體大小 */
            font-family: 'Noto Sans TC', sans-serif; /* 使用 Noto Sans TC 字體 */
            line-height: 1.6; /* 行高 */
            color: #212529; /* 基礎文字顏色 */
            transition: background-color 0.3s ease, color 0.3s ease; /* 背景和文字顏色過渡效果 */
        }
        /* CSS 變數，用於固定標頭的背景和邊框顏色，方便深色模式切換 */
        :root {
            --sticky-bg: #ffffff;
            --sticky-border: #dee2e6;
        }
        .container {
            max-width: 1320px; /* 最大寬度 */
            background-color: #fff; /* 白色背景 */
            padding: 35px; /* 容器內邊距 */
            border-radius: 12px; /* 圓角 */
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* 陰影效果 */
            border: 1px solid #dee2e6; /* 邊框 */
            transition: background-color 0.3s ease, border-color 0.3s ease; /* 背景和邊框顏色過渡 */
        }
        h1 {
            color: #2c3e50; /* 標題顏色 */
            margin-bottom: 15px; /* 下方間距 */
            border-bottom: 1px solid #e0e0e0; /* 底部邊框線 */
            padding-bottom: 15px; /* 邊框線下方內邊距 */
            display: flex; /* 使用 Flexbox 佈局 */
            align-items: center; /* 垂直居中對齊 */
            justify-content: space-between; /* 兩端對齊 */
            flex-wrap: wrap; /* 允許換行 */
            gap: 15px; /* 子元素間距 */
            font-weight: 700; /* 字體加粗 */
            transition: color 0.3s ease, border-color 0.3s ease; /* 顏色和邊框過渡 */
        }
        h1 svg {
            margin-right: 12px; /* 圖示右側間距 */
            vertical-align: -4px; /* 圖示垂直對齊微調 */
            color: #3498db; /* 圖示顏色 */
        }
        /* 標題右側的操作按鈕區域 */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* 按鈕間距 */
            margin-left: auto; /* 將其推到右側 */
            flex-wrap: wrap; /* 允許換行 */
        }
        /* 標題操作按鈕的大小 */
        .header-actions .btn-sm {
            font-size: 0.8em;
            padding: 0.25rem 0.6rem;
        }
        /* 專案標題 (位於 H1 下方) */
        #project-title {
            font-size: 1.3rem;
            font-weight: 500;
            color: #5a6f82; /* 灰色文字 */
            margin-top: -5px;
            margin-bottom: 25px;
            text-align: center; /* 居中顯示 */
            transition: color 0.3s ease;
        }
        /* 返回專案列表的連結 */
        .back-link {
            font-size: 0.9rem;
            color: #6c757d; /* 灰色文字 */
            text-decoration: none; /* 去除底線 */
            display: inline-block;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        .back-link:hover {
            color: #0d6efd; /* 懸停時變藍色 */
            text-decoration: underline; /* 懸停時加底線 */
        }
        .back-link i {
            margin-right: 4px; /* 圖示右側間距 */
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            transition: color 0.3s ease;
        }
        /* 報告區塊樣式 (例如選擇區、內容顯示區) */
        .report-section {
            background-color: #fdfdfd;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative; /* 用於 ::before 定位 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        /* 使用 ::before 偽元素顯示區塊標題 (例如 "1. 選擇報告與操作") */
        .report-section::before {
            content: attr(data-section-title); /* 讀取 data-section-title 屬性內容 */
            display: block;
            font-weight: 700;
            margin-bottom: 20px;
            color: #34495e;
            font-size: 1.15rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        /* 掃描元數據區域 (顯示掃描時間、統計等) */
        .scan-meta-area {
            padding: 15px 20px;
            background-color: #f0f3f5;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #dfe3e6;
            font-size: 0.9rem;
            color: #495057;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .scan-meta-block { margin-bottom: 10px; } /* 元數據塊間距 */
        .scan-meta-block:last-child { margin-bottom: 0; } /* 最後一塊無下間距 */
        .scan-meta-block strong { /* 標籤文字 (例如 "掃描時間:") */
            font-weight: 500;
            color: #34495e;
            display: inline-block;
            margin-right: 8px;
            min-width: 80px; /* 最小寬度，使其對齊 */
            transition: color 0.3s ease;
        }
        .scan-meta-block .value { /* 值文字 */
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            transition: color 0.3s ease;
        }
        .scan-meta-block .badge { /* 徽章樣式 */
            font-size: 0.9em;
            padding: 0.35em 0.65em;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            vertical-align: middle;
            font-weight: 500;
            border: 1px solid transparent;
        }
        /* 狀態摘要徽章群組 */
        .status-summary-group {
            display: inline-flex; /* 使用 inline-flex 以便與標籤同行顯示 */
            flex-wrap: wrap; /* 允許換行 */
            gap: 5px; /* 徽章間距 */
            margin-left: 5px;
        }
        /* 不同狀態的徽章顏色 */
        .status-badge-未審查 { background-color: #e9ecef; color: #495057 !important; border-color: #d3d9df; }
        .status-badge-人工審查中 { background-color: #fff3cd; color: #664d03 !important; border-color: #ffe69c; }
        .status-badge-誤判 { background-color: #e2e3e5; color: #41464b !important; border-color: #d3d6d8; }
        .status-badge-已確認弱點 { background-color: #f8d7da; color: #58151c !important; border-color: #f1aeb5;}
        .status-badge-已自動排除 { background-color: #cfe2ff; color: #052c65 !important; border-color: #b6d4fe;}
        .status-badge-處理錯誤 { background-color: #ffcccc; color: #a00000 !important; border-color: #ff9999;}
        .status-badge-非預期 { background-color: #6c757d; color: #fff !important; } /* 未知狀態 */
        .status-badge-zero { background-color: #f8f9fa; color: #adb5bd !important; border-color: #e9ecef; } /* 計數為 0 的狀態 */

        h4 { /* 問題列表等小標題 */
            color: #7f8c8d;
            margin-top: 25px;
            margin-bottom: 18px;
            font-size: 1.15rem;
            display: flex;
            justify-content: space-between; /* 使計數和排序控制項分開 */
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        h4.text-center { justify-content: center; } /* 居中標題 */
        hr { /* 分隔線 */
            margin-top: 30px;
            margin-bottom: 30px;
            border-top: 1px solid #eee;
            transition: border-color 0.3s ease;
        }
        #reportDetails { margin-top: 0; } /* 報告詳情頂部無間距 */
        /* 報告選擇器區域 */
        .report-selector-area {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        /* 顯示已選報告名稱的區域 */
        #selectedReportDisplay {
            flex-grow: 1; /* 佔用多餘空間 */
            padding: 8px 12px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            min-height: 40px;
            display: flex;
            align-items: center;
            color: #495057;
            font-style: italic; /* 未選擇時斜體 */
            overflow: hidden; /* 超出部分隱藏 */
            text-overflow: ellipsis; /* 超出部分顯示省略號 */
            white-space: nowrap; /* 不換行 */
            min-width: 150px; /* 最小寬度 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #selectedReportDisplay.has-selection {
            font-style: normal; /* 選擇後恢復正常樣式 */
            background-color: #fff;
        }
        /* 報告選擇器區域的按鈕和下拉選單樣式 */
        .report-selector-area .btn, .report-selector-area .form-select {
            padding: 8px 15px;
            font-size: 0.9rem;
            height: 40px; /* 固定高度 */
        }
        .report-selector-area .form-select { max-width: 220px; } /* 限制下拉選單最大寬度 */
        #openScanFileButton { display: none; } /* 預設隱藏打開 .scan 檔案按鈕 */
        #reportFilterGroup { margin-left: 0; } /* 調整報告過濾器組的邊距 */

        /* --- 選擇報告彈窗 (Modal) 樣式 --- */
        #reportSelectModal .modal-dialog { max-width: 1240px; } /* 彈窗寬度 */
        #reportSelectModal .modal-body { max-height: 70vh; overflow-y: auto; } /* 限制高度並允許滾動 */
        /* 報告列表表格 */
        .report-list-table {
            width: 100%;
            table-layout: fixed; /* 固定表格佈局，防止內容撐開列寬 */
            border-collapse: separate; /* 分離邊框 */
            border-spacing: 0 2px; /* 行間距 */
        }
        .report-list-table th, .report-list-table td {
            padding: 10px 8px;
            vertical-align: middle; /* 垂直居中 */
            border-bottom: 1px solid #eee;
            font-size: 0.88rem;
            text-align: center; /* 預設居中 */
            white-space: nowrap; /* 不換行 */
            overflow: hidden; /* 超出隱藏 */
            text-overflow: ellipsis; /* 超出顯示省略號 */
            transition: border-color 0.3s ease, color 0.3s ease;
        }
        .report-list-table th { /* 表頭樣式 */
            font-weight: 500;
            background-color: #f8f9fa;
            color: #555;
            border-bottom-width: 2px;
            border-color: #dee2e6;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        /* 被過濾掉的報告行的樣式 */
        .report-list-table tr.report-row-disabled {
            opacity: 0.5; /* 半透明 */
            cursor: not-allowed; /* 禁用鼠標樣式 */
            background-color: #f8f9fa !important; /* 強制背景色 */
        }
        .report-list-table tr.report-row-disabled td { color: #6c757d !important; } /* 強制文字顏色 */
        .report-list-table tr.report-row-disabled:hover td,
        .report-list-table tr.report-row-disabled:hover .filename-cell {
            background-color: #f8f9fa !important; /* 懸停時背景不變 */
        }
        /* 遺失報告行的樣式 */
        .report-list-table tr.missing-row { font-style: italic; }
        /* 報告行懸停效果 (可選中時) */
        .report-list-table tr:hover:not(.report-row-disabled) .filename-cell {
            background-color: #eef7ff; /* 淺藍色背景 */
            cursor: pointer; /* 手形鼠標 */
            transition: background-color 0.15s ease;
        }
        /* 表格列寬定義 */
        .report-list-table .col-completed { width: 8%; } /* 判讀完成 */
        .report-list-table .col-status { width: 8%; font-size: 1.1em; } /* 掃描狀態 */
        .report-list-table .col-filename { /* 檔案名稱列 */
            width: 30%;
            text-align: left; /* 左對齊 */
            white-space: normal; /* 允許換行 */
            word-break: break-all; /* 強制斷詞 */
            font-weight: 500;
        }
        .report-list-table .col-pages { width: 8%; } /* 掃描頁面 */
        .report-list-table .col-entities { width: 8%; } /* 測試實體 */
        .report-list-table .col-sev-c, .report-list-table .col-sev-h,
        .report-list-table .col-sev-m, .report-list-table .col-sev-l,
        .report-list-table .col-sev-i { width: 6%; } /* 各嚴重性計數 */
        /* 嚴重性計數顏色 */
        .report-list-table .sev-count-c { color: #8B0000; font-weight: bold; } /* 重大 */
        .report-list-table .sev-count-h { color: #dc3545; font-weight: bold; } /* 高 */
        .report-list-table .sev-count-m { color: #fd7e14; } /* 中 */
        .report-list-table .sev-count-l { color: #6c757d; } /* 低 */
        .report-list-table .sev-count-i { color: #adb5bd; } /* 參考 */
        /* 彈窗內掃描狀態顏色 */
        .modal-status-success { color: #198754; } /* 成功 */
        .modal-status-failed, .modal-status-error { color: #dc3545; font-weight: bold;} /* 失敗/錯誤 */
        .modal-status-warning { color: #fd7e14; } /* 警告 (中斷/不完整) */
        .modal-status-missing { color: #6c757d; } /* 遺失 */
        .modal-status-unknown { color: #6c757d; } /* 未知 */
        .modal-status-running { color: #0d6efd; } /* 執行中 (理論上不會出現) */
        /* 報告完成狀態 Checkbox 樣式 */
        .report-completion-checkbox {
            transform: scale(0.9); /* 縮小一點 */
            cursor: pointer;
            vertical-align: middle;
        }
        .report-completion-checkbox:disabled {
            cursor: not-allowed; /* 禁用鼠標 */
            opacity: 0.7;
        }
        /* 更新報告完成狀態時的 Spinner */
        .spinner-report-completion {
            display: none; /* 預設隱藏 */
            width: 0.8rem;
            height: 0.8rem;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* --- 問題卡片樣式 (Issue Card) --- */
        .issue-card {
            margin-bottom: 18px; /* 卡片間距 */
            border-radius: 8px;
            transition: box-shadow 0.2s ease-in-out, border-color 0.3s ease, background-color 0.3s ease;
            background-color: #fff;
            border-width: 2px; /* 邊框寬度 */
            border-style: solid;
            /* 使用 CSS 變數定義邊框顏色，根據嚴重性變化 */
            border-color: var(--severity-border-color, #d8dde2);
        }
        /* 手動新增的問題卡片樣式 */
        .issue-card.source-manual { border-left: 5px solid #6610f2; } /* 紫色左邊框 */
        /* 解析錯誤的問題卡片樣式 */
        .issue-card.source-error { border-left: 5px solid #dc3545; opacity: 0.7; background-color: #fffafa;} /* 紅色左邊框 */
        /* 根據嚴重性定義邊框顏色變數 */
        .severity-low { --severity-border-color: #ffc107; } /* 黃 */
        .severity-medium { --severity-border-color: #fd7e14; } /* 橙 */
        .severity-high { --severity-border-color: #dc3545; } /* 紅 */
        .severity-critical { --severity-border-color: #8B0000; } /* 深紅 */
        .severity-informational { --severity-border-color: #0dcaf0; } /* 藍綠 */
        .severity-unknown, .severity-error { --severity-border-color: #6c757d; } /* 灰 */
        /* 卡片懸停效果 */
        .issue-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        /* 問題卡片標頭 (固定在頂部) */
        .issue-card-header {
            position: sticky; /* 固定定位 */
            top: 0; /* 相對於其滾動容器的頂部 */
            z-index: 1000; /* 確保在其他內容之上 */
            background-color: var(--sticky-bg); /* 使用變數定義背景色 */
            padding: 10px 15px;
            border-bottom: 1px solid var(--sticky-border); /* 使用變數定義邊框色 */
            font-weight: 500;
            font-size: 0.95rem;
            color: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 10px; /* 行/列間距 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            border-top-left-radius: 6px; /* 圓角 (配合卡片) */
            border-top-right-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 細微陰影 */
        }
        /* 手動問題標頭背景色 */
        .source-manual .issue-card-header { background-color: #f0e4ff; }
        /* 錯誤問題標頭背景色 */
        .source-error .issue-card-header { background-color: #ffe0e0; color: #a00000;}
        /* 標頭中的問題類型部分 */
        .issue-card-header .issue-title-part {
            flex-grow: 1; /* 佔用多餘空間 */
            min-width: 200px; /* 最小寬度 */
        }
        /* 手動標示 */
        .issue-card-header .manual-indicator {
            font-size: 0.7em; color: #6610f2; font-weight: bold; margin-left: 5px;
            vertical-align: middle; border: 1px solid #c8a2f0; padding: 1px 3px;
            border-radius: 3px; background-color: #e9d5ff;
        }
        /* 錯誤標示 */
        .issue-card-header .error-indicator {
            font-size: 0.7em; color: #dc3545; font-weight: bold; margin-left: 5px;
            vertical-align: middle; border: 1px solid #f5c6cb; padding: 1px 3px;
            border-radius: 3px; background-color: #f8d7da;
        }
        /* 標頭中的詳細資訊部分 (CVSS/CVE) */
        .issue-card-header .details-part {
            min-width: 100px;
            text-align: right; /* 右對齊 */
            font-weight: 400;
            font-size: 0.9em;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        .issue-card-header .details-part a { color: #3498db; text-decoration: none; }
        .issue-card-header .details-part a:hover { text-decoration: underline; }
        .issue-card-header .badge { font-size: 0.85em; padding: 0.35em 0.6em; }
        /* 問題類型/URL/實體連結樣式 */
        .issue-type-link, .issue-url-link, .issue-entity-link {
            color: #0d6efd;
            text-decoration: none;
            border-bottom: 1px dotted #0d6efd; /* 虛線底線 */
            word-break: break-all; /* 允許在單詞內換行 */
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .issue-type-link:hover, .issue-url-link:hover, .issue-entity-link:hover {
            color: #0a58ca;
            border-bottom-style: solid; /* 懸停時變實線 */
            text-decoration: none;
        }
        /* 連結旁的外部連結小圖示 */
        .issue-type-link .fa-external-link-alt, .issue-url-link .fa-external-link-alt {
            font-size: 0.75em;
            margin-left: 3px;
            color: #6c757d;
            vertical-align: baseline;
            transition: color 0.3s ease;
        }
        /* 自訂嚴重性徽章顏色 */
        .badge-custom-critical { background-color: #8B0000; color: white; }
        .badge-custom-high { background-color: #dc3545; color: white; }
        .badge-custom-medium { background-color: #fd7e14; color: white; }
        .badge-custom-low { background-color: #ffc107; color: #212529; }
        .badge-custom-informational { background-color: #0dcaf0; color: #212529; border: 1px solid #0aa5c2; }
        .badge-custom-unknown, .badge-custom-error { background-color: #6c757d; color: white; }
        /* 問題卡片內容區域 */
        .issue-card-body {
            padding: 15px;
            font-size: 0.9rem;
        }
        /* 錯誤卡片隱藏內容 */
        .issue-card.source-error .issue-card-body { display: none; }
        .issue-card-body p {
            margin-bottom: 8px;
            display: flex; /* 使用 Flexbox 使標籤和值對齊 */
            align-items: flex-start; /* 頂部對齊 */
        }
        .issue-card-body strong { /* 標籤文字 (例如 "URL:") */
            color: #495057;
            min-width: 75px; /* 最小寬度對齊 */
            display: inline-block;
            flex-shrink: 0; /* 防止標籤被壓縮 */
            margin-right: 8px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        /* 允許長內容換行的 span */
        .issue-card-body span[style*="word-break"],
        .issue-card-body p > span:last-child { /* p 標籤的最後一個 span (通常是值) */
            flex-grow: 1; /* 佔用剩餘空間 */
        }

        /* --- 問題群組容器樣式 (Issue Group Container) --- */
        .issue-group-container {
            margin-bottom: 18px;
            border-radius: 8px;
            background-color: #f7faff; /* 淡藍色背景 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border-width: 2px;
            border-style: solid;
            border-color: var(--severity-border-color, #c7d6e6); /* 使用嚴重性顏色變數 */
        }
        /* 根據嚴重性設定群組容器邊框顏色 */
        .issue-group-container.severity-low { --severity-border-color: #ffc107; }
        .issue-group-container.severity-medium { --severity-border-color: #fd7e14; }
        .issue-group-container.severity-high { --severity-border-color: #dc3545; }
        .issue-group-container.severity-critical { --severity-border-color: #8B0000; }
        .issue-group-container.severity-informational { --severity-border-color: #0dcaf0; }
        .issue-group-container.severity-unknown, .issue-group-container.severity-error { --severity-border-color: #6c757d; }
        /* 問題群組標頭 (固定) */
        .issue-group-header {
             position: sticky; /* 固定定位 */
             top: 0; /* 相對滾動容器頂部 */
             z-index: 1010; /* 比單個卡片標頭更高 */
             background-color: var(--sticky-bg); /* 使用變數 */
             padding: 10px 15px;
             border-bottom: 1px solid var(--sticky-border); /* 使用變數 */
             font-weight: 500;
             font-size: 0.95rem;
             color: #052c65; /* 深藍色文字 */
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 10px;
             border-top-left-radius: 6px;
             border-top-right-radius: 6px;
             transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
             box-shadow: 0 1px 3px rgba(0,0,0,0.15); /* 陰影 */
        }
        .issue-group-header .badge { font-size: 0.85em; padding: 0.35em 0.6em; }
        .issue-group-header .group-info { color: #555; font-size: 0.9em; } /* 群組資訊文字 */
        .issue-group-header .btn-toggle-group { /* 展開/收合按鈕 */
            padding: 0.1rem 0.4rem;
            font-size: 0.8rem;
            line-height: 1.2;
        }
        /* 代表性問題卡片 (在群組中第一個顯示) */
        .issue-group-representative-card {
            margin: 0;
            border-radius: 0; /* 無圓角 */
            border: none !important; /* 移除邊框 */
            border-top: 1px solid #e0e6ec !important; /* 頂部細線 */
            border-bottom-left-radius: 7px; /* 底部圓角 (如果未展開) */
            border-bottom-right-radius: 7px;
            background-color: #fff;
        }
        /* 群組內容區域 (可摺疊) */
        .issue-group-body {
            padding: 0;
            background-color: #ffffff;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            transition: background-color 0.3s ease;
        }
        /* 群組內部的問題卡片 */
        .issue-group-body .issue-card {
            border: none !important; /* 移除邊框 */
            border-top: 1px solid #e9ecef !important; /* 頂部分隔線 */
            margin-bottom: 0; /* 無下間距 */
            box-shadow: none !important; /* 無陰影 */
            background-color: #fff;
        }
        .issue-group-body .issue-card:first-child { border-top: none !important; } /* 第一個卡片無頂部分隔線 */

        /* --- 截圖相關樣式 --- */
        .screenshot-section { /* 截圖區域容器 */
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6; /* 頂部分隔虛線 */
            transition: border-color 0.3s ease;
        }
        .screenshot-controls { /* 截圖控制按鈕區域 */
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap; /* 允許換行 */
        }
        .screenshot-controls .btn-sm { /* 控制按鈕大小 */
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            flex-shrink: 0; /* 防止按鈕被壓縮 */
        }
        .screenshot-controls .upload-feedback { /* 上傳反饋訊息 */
            font-size: 0.8em;
            margin-left: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* 限制最大寬度 */
        }
        .screenshot-controls .spinner-border-sm { /* 上傳 Spinner */
            width: 0.8rem;
            height: 0.8rem;
            flex-shrink: 0;
        }
        .uploaded-screenshots-list { /* 已上傳截圖列表 */
            list-style: none; /* 去除列表符號 */
            padding-left: 0;
            margin-top: 10px;
            font-size: 0.85rem;
            max-height: 150px; /* 限制最大高度 */
            overflow-y: auto; /* 超出高度顯示滾動條 */
            border: 1px solid #f1f1f1;
            border-radius: 4px;
            padding: 5px;
            background-color: #fcfcfc;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .uploaded-screenshots-list li { /* 列表項 */
            margin-bottom: 4px;
            padding: 3px 5px;
            border-bottom: 1px solid #f1f1f1; /* 項之間的底線 */
            border-radius: 3px;
            display: flex;
            justify-content: space-between; /* 檔名和刪除按鈕兩端對齊 */
            align-items: center;
            transition: border-color 0.3s ease;
        }
        .uploaded-screenshots-list li:last-child { border-bottom: none; } /* 最後一項無底線 */
        .uploaded-screenshots-list a { /* 檔名連結 */
            text-decoration: none;
            color: #0d6efd;
            word-break: break-all; /* 允許長檔名換行 */
            margin-right: 10px; /* 與刪除按鈕的間距 */
            transition: color 0.3s ease;
        }
        .uploaded-screenshots-list a:hover { text-decoration: underline; }
        .uploaded-screenshots-list a .fa-external-link-alt { /* 外部連結圖示 */
            font-size: 0.8em;
            margin-left: 4px;
            vertical-align: baseline;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        .uploaded-screenshots-list .no-screenshots-msg { /* 無截圖訊息 */
            font-style: italic;
            color: #6c757d;
            padding: 3px 5px;
            flex-grow: 1; /* 佔滿寬度 */
            text-align: center;
            margin: 0;
            border-bottom: none;
        }
        .delete-screenshot-btn { /* 刪除截圖按鈕 */
            padding: 0.1rem 0.4rem;
            font-size: 0.75rem;
            line-height: 1;
            flex-shrink: 0; /* 防止被壓縮 */
        }
        .delete-screenshot-btn i { margin-right: 0; } /* 圖示無右邊距 */
        /* 截圖完成狀態顯示 (目前未使用) */
        .screenshot-controls .screenshot-completion-status { display: none; }

        /* --- HTTP 流量詳情樣式 --- */
        .traffic-details {
            background-color: #f1f3f5;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px; /* 限制最大高度 */
            overflow-y: auto; /* 允許滾動 */
            border: 1px solid #ced4da;
            margin-top: 8px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .traffic-details pre { /* pre 標籤保留格式 */
            margin: 0;
            white-space: pre-wrap; /* 自動換行 */
            word-wrap: break-word; /* 強制斷詞 */
            font-size: 0.85em;
            color: #212529;
            transition: color 0.3s ease;
        }
        .traffic-details code { /* code 標籤樣式 */
            font-family: 'Courier New', Courier, monospace; /* 等寬字體 */
            padding: 0;
            background-color: transparent;
            color: inherit;
            border-radius: 0;
        }
        /* 流量中標記的危險文字顏色 */
        .traffic-details code .text-danger { color: #dc3545 !important; }
        /* 流量中加粗文字 */
        .traffic-details code .fw-bold { font-weight: bold !important; }

        /* --- 過濾表單樣式 --- */
        .filter-form {
            margin-top: 15px;
            margin-bottom: 25px;
            padding: 20px 20px 10px 20px;
            background-color: #f0f3f5;
            border-radius: 8px;
            border: 1px solid #dfe3e6;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .filter-group { margin-bottom: 15px; } /* 過濾組間距 */
        .filter-group h5 { /* 過濾組標題 */
            margin-bottom: 10px;
            font-size: 1rem;
            color: #34495e;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .form-check-label { font-size: 0.9rem; } /* Checkbox 標籤字體 */
        .form-select, .btn { /* 下拉選單和按鈕 */
            border-radius: 6px;
            font-size: 0.9rem;
        }
        /* 按鈕內的圖示 */
        .btn svg, .btn i {
            vertical-align: -2px; /* 微調垂直對齊 */
            margin-right: 5px; /* 圖示右邊距 */
        }
        /* 錯誤訊息樣式 */
        #reportListError.text-danger, .status-update-feedback.text-danger,
        .upload-feedback.text-danger, #previewError.text-danger,
        .screenshot-completion-status .text-danger, .note-feedback.text-danger {
            font-weight: bold; /* 紅色錯誤加粗 */
        }
        /* 提示框樣式 */
        .alert {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .alert svg { margin-right: 8px; } /* 提示框圖示 */

        /* --- 問題卡片內狀態控制項 --- */
        .status-container { /* 狀態下拉選單和反饋訊息的容器 */
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        .status-select { /* 狀態下拉選單 */
            font-size: 0.85em;
            padding: 0.25rem 0.5rem;
            flex-grow: 1; /* 佔用空間 */
            min-width: 110px; /* 最小寬度 */
            max-width: 160px; /* 最大寬度 */
            border-radius: 4px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .status-update-spinner { /* 狀態更新 Spinner */
            display: none;
            width: 0.9rem;
            height: 0.9rem;
            color: #6c757d;
        }
        .status-update-feedback { /* 狀態更新反饋訊息 */
            display: none;
            font-size: 0.8em;
            white-space: nowrap;
        }
        .status-update-feedback.text-success { color: #198754 !important; }
        .status-update-feedback.text-danger { color: #dc3545 !important; }

        /* --- 問題列表標頭 (包含計數和排序) --- */
        .issue-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 18px;
        }
        .issue-list-header h4 { margin: 0; } /* 移除標題預設邊距 */
        #sortControls { /* 排序控制項容器 */
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #sortControls label { margin-bottom: 0; transition: color 0.3s ease;}
        /* 嚴重性分佈圖表容器 */
        #severityChartContainer {
            position: relative;
            height: 280px; /* 圖表高度 */
            width: 100%;
            margin-bottom: 15px;
        }
        /* 過濾表單佈局調整 (大螢幕) */
        .filter-form .row > .col-lg-3 { flex: 0 0 auto; width: 25%; }

        /* --- 截圖預覽彈窗 --- */
        #screenshotPreviewModal .modal-body img { /* 預覽圖片 */
            max-width: 100%;
            max-height: 70vh; /* 限制最大高度 */
            display: block;
            margin: 0 auto; /* 水平居中 */
            border: 1px solid #ccc;
        }
        #screenshotPreviewModal .modal-dialog { max-width: 80%; } /* 彈窗寬度 */

        /* --- 筆記區域 --- */
        .issue-card-body .note-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6; /* 分隔線 */
            transition: border-color 0.3s ease;
        }
        .issue-card-body .note-section textarea { /* 筆記輸入框 */
            width: 100%;
            min-height: 60px;
            font-size: 0.88em;
            border-color: #ced4da;
            border-radius: 4px;
            padding: 5px 8px;
            resize: vertical; /* 允許垂直調整大小 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .issue-card-body .note-controls { /* 筆記控制項 (按鈕、反饋) */
            text-align: right; /* 右對齊 */
            margin-top: 5px;
        }
        .issue-card-body .note-controls .btn-sm { font-size: 0.8rem; padding: 0.2rem 0.5rem; }
        .issue-card-body .note-controls .note-feedback { /* 筆記儲存反饋 */
            font-size: 0.8em;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        .issue-card-body .note-controls .note-spinner { /* 筆記儲存 Spinner */
            width: 0.9rem;
            height: 0.9rem;
            display: none;
            margin-left: 5px;
            vertical-align: middle;
        }
        /* 狀態和截圖完成行的佈局 */
        .issue-card-body .status-and-screenshot-area {
            display: flex;
            flex-direction: column; /* 垂直排列 */
            gap: 5px;
            margin-bottom: 10px;
        }
        .issue-card-body .status-line, .issue-card-body .screenshot-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .issue-card-body .screenshot-line .form-check { /* 截圖完成 Checkbox 容器 */
            margin-bottom: 0;
            padding-left: 0; /* 移除預設左邊距 */
            display: flex;
            align-items: center;
        }
        .issue-card-body .screenshot-line .form-check-label { /* Checkbox 標籤 */
            font-size: 0.9em;
            color: #495057;
            cursor: pointer;
            margin-left: 4px;
            order: 2; /* 將標籤放在後面 */
            transition: color 0.3s ease;
        }
        .issue-card-body .screenshot-line .form-check-input { /* Checkbox 本身 */
            cursor: pointer;
            margin-left: 3px;
            margin-top: 0;
            order: 1; /* 將 Checkbox 放在前面 */
        }
        /* 截圖狀態更新 Spinner 和錯誤訊息 */
        .issue-card-body .screenshot-line .spinner-border-sm,
        .issue-card-body .screenshot-line .text-danger {
            margin-left: 5px;
            display: none; /* 預設隱藏 */
            font-size: 0.9em;
            vertical-align: middle;
            order: 3; /* 放在標籤後面 */
        }
        .issue-card-body .screenshot-line .spinner-border-sm {
            width: 0.8rem;
            height: 0.8rem;
            color: #6c757d;
        }

        /* --- 目前過濾條件顯示區域 --- */
        #filterStatus {
            font-size: 0.85em;
            color: #6c757d;
            background-color: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 10px;
            margin-bottom: -15px; /* 向上移動一點，減少與下方內容的間距 */
            display: none; /* 預設隱藏 */
            border: 1px solid #ced4da;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #filterStatus .badge { margin-right: 4px; margin-bottom: 4px; font-weight: 500; }
        #filterStatus strong { color: #495057; transition: color 0.3s ease;}
        /* 深色模式下的過濾狀態顯示 */
        body.dark-mode #filterStatus { background-color: #3e444a; color: #adb5bd; border-color: #5a6268;}
        body.dark-mode #filterStatus strong { color: #dee2e6; }
        body.dark-mode #filterStatus .badge { border: 1px solid #555;}

        /* --- 浮動操作按鈕 (FAB) --- */
        .fab-container {
            position: fixed; /* 固定定位 */
            bottom: 20px; /* 距離底部 */
            right: 20px; /* 距離右側 */
            z-index: 1030; /* 高於一般內容 */
            display: flex;
            flex-direction: column; /* 垂直排列 */
            gap: 10px; /* 按鈕間距 */
        }
        .btn-fab { /* FAB 按鈕樣式 */
            width: 50px;
            height: 50px;
            border-radius: 50%; /* 圓形 */
            font-size: 1.2rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* 陰影 */
        }
        .btn-fab i { margin-right: 0; } /* 移除圖示預設邊距 */
        /* FAB 過濾器彈出菜單 */
        .fab-filter-menu {
            min-width: 200px;
            max-height: 50vh; /* 限制最大高度 */
            overflow-y: auto; /* 允許滾動 */
        }
        .fab-filter-menu .dropdown-item.form-check { padding-left: 1.5rem; } /* 調整 Checkbox 內邊距 */
        .fab-filter-menu .form-check-label { font-size: 0.85rem; white-space: normal; } /* 允許標籤換行 */
        .fab-filter-menu .dropdown-header { font-size: 0.9rem; font-weight: bold; }
        .fab-filter-menu .fab-report-filter { cursor: pointer; } /* 報告過濾器項目鼠標樣式 */

        /* --- 深色模式樣式 (Dark Mode) --- */
        body.dark-mode { background-color: #121212; color: #e0e0e0 !important; } /* 深色背景和文字 */
        body.dark-mode :root { --sticky-bg: #1a1a1a; --sticky-border: #444; } /* 更新 CSS 變數 */
        body.dark-mode .container { background-color: #1a1a1a; color: #e0e0e0; border-color: #333; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 { color: #ffffff; } /* 標題變白色 */
        body.dark-mode h1 { border-bottom-color: #444; } /* H1 底線顏色 */
        body.dark-mode .back-link { color: #aaaaaa; } /* 返回連結顏色 */
        body.dark-mode .back-link:hover { color: #99cfff; }
        body.dark-mode .report-section { background-color: #222222; border-color: #444; } /* 區塊背景和邊框 */
        body.dark-mode .report-section::before { color: #f0f0f0; border-bottom-color: #444; } /* 區塊標題顏色 */
        body.dark-mode .scan-meta-area { background-color: #282828; border-color: #444; color: #cccccc; } /* 元數據區 */
        body.dark-mode .scan-meta-block strong { color: #f0f0f0; } /* 元數據標籤 */
        body.dark-mode .scan-meta-block .value { color: #f5f5f5; } /* 元數據值 */
        body.dark-mode .scan-meta-block .badge { border: 1px solid #555; background-color: #444; color: #dddddd !important;} /* 徽章 */
        body.dark-mode .scan-meta-block .badge.bg-primary { background-color: #0b5ed7 !important; color: #fff !important;}
        /* 深色模式下的狀態徽章顏色 */
        body.dark-mode .status-badge-未審查 { background-color: #4b545c; color: #ced4da !important; border-color: #5d6770; }
        body.dark-mode .status-badge-人工審查中 { background-color: #664d03; color: #ffecb5 !important; border-color: #80600a; }
        body.dark-mode .status-badge-誤判 { background-color: #555a5f; color: #d1d3d4 !important; border-color: #696e73; }
        body.dark-mode .status-badge-已確認弱點 { background-color: #722027; color: #fcc6cb !important; border-color: #8f2c36;}
        body.dark-mode .status-badge-已自動排除 { background-color: #1c3e70; color: #c3d9ff !important; border-color: #2f5aa6;}
        body.dark-mode .status-badge-處理錯誤 { background-color: #7d2b34; color: #ffc9ce !important; border-color: #b0404a;}
        body.dark-mode .status-badge-非預期 { background-color: #818182; color: #e6e6e6 !important; }
        body.dark-mode .status-badge-zero { background-color: #343a40; color: #6c757d !important; border-color: #495057; }
        body.dark-mode hr { border-top-color: #444; } /* 分隔線顏色 */
        body.dark-mode #selectedReportDisplay { background-color: #555; border-color: #777; color: #f0f0f0; } /* 已選報告顯示 */
        body.dark-mode #selectedReportDisplay.has-selection { background-color: #444; }
        body.dark-mode .modal-content { background-color: #1f1f1f; color: #e0e0e0; border: 1px solid #555;} /* 彈窗背景和邊框 */
        body.dark-mode .modal-header { border-bottom-color: #444; } /* 彈窗標頭底線 */
        body.dark-mode .modal-footer { border-top-color: #444; } /* 彈窗頁腳頂線 */
        body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(150%); } /* 彈窗關閉按鈕變白色 */
        body.dark-mode .report-list-table th { background-color: #333; color: #f0f0f0; border-color: #555; } /* 報告列表表頭 */
        body.dark-mode .report-list-table td { border-color: #444; color: #cccccc !important; } /* 報告列表單元格 */
        /* 報告列表行懸停效果 */
        body.dark-mode .report-list-table tr:hover:not(.report-row-disabled) td,
        body.dark-mode .report-list-table tr:hover:not(.report-row-disabled) .filename-cell {
            background-color: #383838 !important;
        }
        /* 禁用行樣式 */
        body.dark-mode .report-list-table tr.report-row-disabled { background-color: #2a2a2a !important; opacity: 0.4;}
        body.dark-mode .report-list-table tr.report-row-disabled td { color: #777 !important;}
        /* 問題卡片 */
        body.dark-mode .issue-card { background-color: #2a2a2a; border-color: var(--severity-border-color, #444) !important; }
        body.dark-mode .issue-card.source-manual { border-left-color: #9d70ff; }
        body.dark-mode .issue-card.source-error { border-left-color: #ff6b6b; }
        body.dark-mode .issue-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: var(--severity-border-color, #555) !important; background-color: #303030;}
        /* 問題卡片標頭 */
        body.dark-mode .issue-card-header { background-color: var(--sticky-bg); border-bottom-color: var(--sticky-border); color: #f5f5f5; }
        body.dark-mode .source-manual .issue-card-header { background-color: #4a2f6e; } /* 手動標頭背景 */
        body.dark-mode .source-error .issue-card-header { background-color: #6f3333; color: #ffdddd;} /* 錯誤標頭背景 */
        /* 手動/錯誤標示 */
        body.dark-mode .issue-card-header .manual-indicator { color: #e0cffc; border-color: #9d70ff; background-color: #6e40a3;}
        body.dark-mode .issue-card-header .error-indicator { color: #ffc6c6; border-color: #ff8282; background-color: #b02a37;}
        /* 問題群組標頭 */
        body.dark-mode .issue-group-header { background-color: var(--sticky-bg); border-bottom-color: var(--sticky-border) !important; color: #f0f0f0; }
        body.dark-mode .issue-card-header .details-part { color: #bbbbbb; } /* 詳細資訊顏色 */
        /* 連結顏色 */
        body.dark-mode .issue-type-link, body.dark-mode .issue-url-link, body.dark-mode .issue-entity-link { color: #99cfff; border-bottom-color: #99cfff; }
        body.dark-mode .issue-type-link:hover, body.dark-mode .issue-url-link:hover, body.dark-mode .issue-entity-link:hover { color: #cce5ff !important; }
        /* 卡片內容 */
        body.dark-mode .issue-card-body { color: #cccccc !important; }
        body.dark-mode .issue-card-body strong { color: #e8e8e8 !important; } /* 標籤文字 */
        /* 問題群組 */
        body.dark-mode .issue-group-container { background-color: #252525; border-color: var(--severity-border-color, #444) !important; }
        body.dark-mode .issue-group-body { background-color: #2f2f2f; } /* 群組內容背景 */
        body.dark-mode .issue-group-representative-card { background-color: #2a2a2a; border-top-color: #444 !important;} /* 代表性卡片 */
        body.dark-mode .issue-group-body .issue-card { border-top-color: #444 !important; background-color: #2a2a2a; } /* 內部卡片 */
        /* 截圖區域 */
        body.dark-mode .screenshot-section { border-top-color: #444; }
        body.dark-mode .uploaded-screenshots-list { border-color: #444; background-color: #333; }
        body.dark-mode .uploaded-screenshots-list li { border-bottom-color: #444; }
        body.dark-mode .uploaded-screenshots-list a { color: #99cfff; }
        body.dark-mode .uploaded-screenshots-list a:hover { color: #cce5ff !important; text-decoration: underline;}
        body.dark-mode .uploaded-screenshots-list .no-screenshots-msg { color: #888; }
        /* HTTP 流量 */
        body.dark-mode .traffic-details { background-color: #1c1c1c; border-color: #444; }
        body.dark-mode .traffic-details pre, body.dark-mode .traffic-details code { color: #d0d0d0; }
        body.dark-mode .traffic-details code .text-danger { color: #ff8a8a !important; } /* 紅色高亮 */
        /* 過濾表單 */
        body.dark-mode .filter-form { background-color: #333; border-color: #555; }
        body.dark-mode .filter-group h5 { color: #f5f5f5; }
        body.dark-mode .form-check-label { color: #e0e0e0; }
        body.dark-mode .form-control, body.dark-mode .form-select { background-color: #444; color: #f0f0f0; border-color: #666; }
        body.dark-mode .form-control::placeholder { color: #999; }
        body.dark-mode .form-control:focus, body.dark-mode .form-select:focus, body.dark-mode textarea:focus { background-color: #555; color: #fff; border-color: #888; box-shadow: none; }
        body.dark-mode .status-select, body.dark-mode .form-select-sm { background-color: #444; color: #f0f0f0; border-color: #666; }
        body.dark-mode textarea.issue-note-textarea { background-color: #3a3a3a; color: #e0e0e0; border-color: #555; }
        /* Spinner 顏色 */
        body.dark-mode .status-update-spinner, body.dark-mode .note-spinner,
        body.dark-mode .spinner-report-completion, body.dark-mode .screenshot-line .spinner-border-sm {
            color: #aaaaaa;
        }
        body.dark-mode .screenshot-line .form-check-label { color: #cccccc; }
        body.dark-mode #screenshotPreviewModal .modal-body img { border-color: #555; }
        body.dark-mode .text-muted { color: #aaaaaa !important; } /* 輔助文字顏色 */
        /* 按鈕樣式 */
        body.dark-mode .btn-outline-secondary { color: #adb5bd; border-color: #6c757d; }
        body.dark-mode .btn-outline-secondary:hover { background-color: #5a626b; color: #fff; border-color: #5a626b;}
        body.dark-mode .btn-outline-info { color: #0dcaf0; border-color: #0dcaf0; }
        body.dark-mode .btn-outline-info:hover { background-color: #0aa5c2; color: #fff; border-color: #0aa5c2;}
        body.dark-mode .btn-outline-danger { color: #f17883; border-color: #f17883; }
        body.dark-mode .btn-outline-danger:hover { background-color: #b02a37; color: #fff; border-color: #b02a37;}
        body.dark-mode .btn-outline-success { color: #20c997; border-color: #20c997; }
        body.dark-mode .btn-outline-success:hover { background-color: #157347; color: #fff; border-color: #157347;}
        body.dark-mode .btn-outline-warning { color: #ffc107; border-color: #ffc107; }
        body.dark-mode .btn-outline-warning:hover { background-color: #b38a00; color: #fff; border-color: #b38a00;}
        body.dark-mode .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        body.dark-mode .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        body.dark-mode .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        body.dark-mode .btn-secondary:hover { background-color: #5c636a; border-color: #565e64; }
        body.dark-mode .btn-warning { background-color: #ffca2c; border-color: #ffc720; color: #000; }
        body.dark-mode .btn-warning:hover { background-color: #ffda6a; border-color: #ffc720;}
        /* 標頭陰影 */
        body.dark-mode .issue-group-header { box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        body.dark-mode .issue-card-header { box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        /* 手動/錯誤標頭背景 */
        body.dark-mode .source-manual .issue-card-header { background-color: #4a2f6e; }
        body.dark-mode .source-error .issue-card-header { background-color: #6f3333; }
        /* 手動/錯誤標示 */
        body.dark-mode .issue-card-header .manual-indicator { color: #e0cffc; border-color: #9d70ff; background-color: #6e40a3;}
        body.dark-mode .issue-card-header .error-indicator { color: #ffc6c6; border-color: #ff8282; background-color: #b02a37;}
        /* FAB 按鈕 */
        body.dark-mode .btn-fab { background-color: #444; border-color: #555; color: #e0e0e0;}
        body.dark-mode .btn-fab:hover { background-color: #555; }
        /* FAB 過濾菜單 */
        body.dark-mode .fab-filter-menu { background-color: #333; border-color: #555; }
        body.dark-mode .fab-filter-menu .dropdown-header { color: #f0f0f0; }
        body.dark-mode .fab-filter-menu .dropdown-item { color: #d0d0d0; }
        body.dark-mode .fab-filter-menu .dropdown-item:hover,
        body.dark-mode .fab-filter-menu .dropdown-item.fab-report-filter:hover {
            background-color: #444; color: #fff !important;
        }
        body.dark-mode .fab-filter-menu .dropdown-divider { border-top-color: #555; }
        /* 表單驗證失敗樣式 */
        body.dark-mode .form-control.is-invalid, body.dark-mode .form-select.is-invalid { border-color: #ff8a8a; }
        body.dark-mode .invalid-feedback { color: #ff8a8a; }
        /* 提示框樣式 */
        body.dark-mode .alert-danger { background-color: #722027; color: #fcc6cb; border-color: #8f2c36;}

        /* --- 響應式佈局調整 (Responsive Adjustments) --- */
        @media (max-width: 1200px) { /* 大型桌面以下 */
            .report-selector-area { gap: 8px; }
            .report-selector-area .btn, .report-selector-area .form-select { padding: 6px 12px; font-size: 0.85rem; height: 38px; }
            .report-selector-area .form-select { max-width: 200px; }
            .filter-form .row > .col-lg-3 { flex-basis: 50%; max-width: 50%;} /* 過濾器每行 2 個 */
        }
        @media (max-width: 992px) { /* 中型桌面/平板以下 */
            .filter-form .row > div { margin-bottom: 10px; flex-basis: 50%; max-width: 50%; }
            /* 隱藏報告列表中的部分欄位 */
            .report-list-table .col-entities, .report-list-table .col-sev-i { display: none; }
            /* 調整剩餘欄寬 */
            .report-list-table .col-filename { width: 35%; }
            .report-list-table .col-pages { width: 12%; }
            .report-list-table .col-completed { width: 10%; }
            .report-list-table .col-status { width: 10%; }
            .report-list-table .col-sev-c, .report-list-table .col-sev-h,
            .report-list-table .col-sev-m, .report-list-table .col-sev-l { width: 8%; }
            .scan-meta-area { padding: 12px 15px; }
            #screenshotPreviewModal .modal-dialog { max-width: 90%; } /* 截圖預覽彈窗變寬 */
            .issue-list-header { flex-direction: column; align-items: flex-start; } /* 問題列表標頭垂直排列 */
            /* 調整報告選擇器佈局 */
            .report-selector-area { flex-direction: row; justify-content: flex-start; }
            #reportFilterGroup { order: 6; margin-left: auto;} /* 過濾器推到右邊 */
            #selectedReportDisplay { flex-basis: 100%; margin-bottom: 10px; order: 1; } /* 已選報告佔滿一行 */
            .report-selector-area .btn { order: 2; } /* 選擇按鈕在第二位 */
            #openScanFileButton { order: 3; } /* 開啟 .scan 按鈕在第三位 */
            .fab-container { right: 15px; bottom: 15px; gap: 8px;} /* FAB 按鈕位置和間距 */
            .btn-fab { width: 45px; height: 45px; font-size: 1.1rem;} /* FAB 按鈕大小 */
        }
        @media (max-width: 768px) { /* 小型設備/手機 */
            h1 { justify-content: center; } /* 主標題居中 */
            .header-actions { margin-left: 0; width: 100%; justify-content: center; margin-top: 10px; } /* 頭部操作按鈕居中 */
            /* 報告選擇器垂直排列 */
            .report-selector-area { flex-direction: column; align-items: stretch; }
            #selectedReportDisplay, .report-selector-area .btn, .report-selector-area .form-select, #openScanFileButton {
                width: 100%; margin-bottom: 10px; order: 0; margin-left: 0; flex-basis: auto; max-width: none;
            }
            #selectedReportDisplay { text-align: center; justify-content: center; } /* 已選報告文字居中 */
            #reportFilterGroup { margin-left: 0;} /* 過濾器不推到右邊 */
            .issue-card-header .details-part { min-width: 80px; } /* 縮小詳細資訊最小寬度 */
            #severityChartContainer { height: 300px; } /* 增加圖表高度 */
            .scan-meta-area { padding: 10px; }
            .scan-meta-block { margin-bottom: 8px; }
            /* 進一步隱藏報告列表欄位 */
            .report-list-table .col-stats, .report-list-table .col-severity, .report-list-table .col-pages,
            .report-list-table .col-entities, .report-list-table .col-sev-c, .report-list-table .col-sev-h,
            .report-list-table .col-sev-m, .report-list-table .col-sev-l, .report-list-table .col-sev-i {
                display: none;
            }
            .report-list-table .col-filename { width: auto; } /* 檔名欄自動寬度 */
            .report-list-table .col-completed { width: 18%; } /* 調整剩餘欄寬 */
            .report-list-table .col-status { width: 18%; }
            .screenshot-controls { flex-wrap: wrap; } /* 截圖控制項換行 */
            #screenshotPreviewModal .modal-dialog { max-width: 95%; } /* 截圖預覽更寬 */
            .filter-form .row > div { flex-basis: 100%; max-width: 100%; } /* 過濾器每行一個 */
            .header-actions .btn-sm { width: 100%; } /* 頭部小按鈕佔滿寬度 */
            .fab-container { right: 10px; bottom: 10px; gap: 6px;} /* FAB 按鈕位置和間距 */
            .btn-fab { width: 40px; height: 40px; font-size: 1rem;} /* FAB 按鈕大小 */
        }

    </style>
</head>
<body class=""> <!-- body class 會被 JS 用來切換 dark-mode -->

    <!-- 全局 JS 常數，由後端 Jinja2 注入 -->
    <script>
        // 這個常數用於 Selenium 驗證邏輯，判斷是否為特定的外部連結問題
        const EXTERNAL_LINK_REASONING_TEXT = {{ external_link_reasoning_text | default('') | tojson | safe }};
    </script>

    <!-- 主要內容容器 -->
    <div class="container">
        <!-- 頁面主標題 -->
        <h1>
            <span>
                 <!-- Shield Icon -->
                 <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-shield-check" viewBox="0 0 16 16">
                    <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                    <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                </svg>
                 AppScan 報告檢視器
            </span>
             <!-- 頁面頭部右側的操作按鈕 -->
             <div class="header-actions">
                 <!-- 深色/淺色模式切換按鈕 -->
                 <button type="button" class="btn btn-outline-secondary btn-sm" id="darkModeToggle" title="切換深色/淺色模式">
                    <i class="fas fa-moon"></i> <!-- 預設月亮圖示 -->
                    <span class="d-none d-md-inline">深色模式</span> <!-- 在中等螢幕以上顯示文字 -->
                </button>
                 <!-- 匯出已確認弱點按鈕 (觸發彈窗) -->
                 <button type="button" class="btn btn-success btn-sm" id="exportButton" title="匯出已確認弱點選項">
                    <i class="fas fa-file-excel"></i> 匯出已確認弱點
                </button>
                 <!-- 匯出所有筆記按鈕 (直接下載) -->
                 <a href="{{ url_for('export_all_notes', project_name=project_name) }}" class="btn btn-info btn-sm ms-2" id="exportAllNotesButton" download title="匯出所有問題的筆記(不合併)">
                    <i class="fas fa-file-alt"></i> 匯出所有筆記
                </a>
             </div>
        </h1>
        <!-- 專案名稱顯示 -->
        <h2 id="project-title" class="text-center text-muted mb-4">{{ project_display_name | default(project_name) | e }}</h2>
        <!-- 返回專案列表的連結 -->
        <a href="{{ url_for('list_projects') }}" class="back-link"><i class="fas fa-arrow-left"></i> 返回專案列表</a>

        <!-- 區塊 1: 選擇報告與操作 -->
        <div id="selection-container" class="report-section" data-section-title="1. 選擇報告與操作">
             <!-- 報告選擇器區域 -->
             <div class="report-selector-area mb-3">
                <!-- 觸發選擇報告彈窗的按鈕 -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reportSelectModal">
                    <i class="fas fa-folder-open"></i> 選擇報告檔案 (此專案)
                </button>
                <!-- 顯示當前選定報告名稱的區域 -->
                <div id="selectedReportDisplay">尚未選擇報告</div>
                 <!-- 開啟 .scan 檔案按鈕 (預設隱藏) -->
                 <button type="button" class="btn btn-outline-info btn-sm" id="openScanFileButton" title="在本機開啟對應的 .scan 檔案" style="display: none;">
                    <i class="fas fa-external-link-alt"></i> 開啟 .scan
                 </button>
                <!-- 報告列表過濾器 -->
                <div id="reportFilterGroup" class="ms-md-auto"> <!-- ms-md-auto 將其推到右側 (中螢幕以上) -->
                     <select id="reportFilterSelect" class="form-select form-select-sm" title="篩選報告列表">
                         <option value="low">列表: 低風險及以上</option>
                         <option value="medium">列表: 中風險及以上</option>
                         <option value="high">列表: 高風險及以上</option>
                         <option value="critical">列表: 僅重大風險</option>
                         <option value="errors_only">列表: 僅異常掃描</option>
                         <option value="informational">列表: 所有報告 (含缺失)</option>
                     </select>
                </div>
             </div>
             <!-- 手動新增弱點按鈕 (預設禁用) -->
             <div class="mt-2">
                 <button type="button" class="btn btn-outline-secondary btn-sm" id="addVulnerabilityBtn" disabled title="手動新增弱點至目前選定的報告">
                    <i class="fas fa-plus"></i> 手動新增弱點
                </button>
             </div>
             <!-- 報告列表載入錯誤訊息顯示區域 -->
             <div id="reportListError" class="text-danger small mt-3" style="display: none;"></div>
        </div>

        <!-- 選擇報告彈窗 (Modal) -->
        <div class="modal fade" id="reportSelectModal" tabindex="-1" aria-labelledby="reportSelectModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable"> <!-- modal-xl: 加寬; modal-dialog-scrollable: 內容可滾動 -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportSelectModalLabel">選擇報告檔案 - {{ project_display_name | default(project_name) | e }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small">點擊檔案名稱以載入詳細資訊。標示 <span class="badge bg-secondary">完成</span> 表示該報告已被標記為判讀完成。</p>
                        <div class="table-responsive"> <!-- 表格響應式容器 -->
                            <table class="report-list-table table table-hover"> <!-- table-hover: 懸停效果 -->
                                <thead>
                                    <tr>
                                        <th class="col-completed">判讀完成</th>
                                        <th class="col-status">掃描狀態</th>
                                        <th class="col-filename">檔案名稱</th>
                                        <th class="col-pages">掃描頁面</th>
                                        <th class="col-entities">測試實體</th>
                                        <th class="col-sev-c">重大</th>
                                        <th class="col-sev-h">高</th>
                                        <th class="col-sev-m">中</th>
                                        <th class="col-sev-l">低</th>
                                        <th class="col-sev-i">參考</th>
                                    </tr>
                                </thead>
                                <!-- 報告列表內容將由 JavaScript 動態填入 -->
                                <tbody id="reportModalListBody">
                                    <tr><td colspan="10" class="text-center text-muted"><i>正在載入報告列表...</i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <!-- 匯出異常報告按鈕 (預設隱藏) -->
                        <a href="{{ url_for('export_abnormal_reports', project_name=project_name) }}" class="btn btn-warning btn-sm me-auto" id="exportAbnormalButton" style="display: none;" download title="匯出目前篩選出的異常/遺失報告列表">
                            <i class="fas fa-file-excel"></i> 匯出異常報告列表
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 截圖預覽彈窗 -->
        <div class="modal fade" id="screenshotPreviewModal" tabindex="-1" aria-labelledby="screenshotPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- modal-lg: 較大; modal-dialog-centered: 垂直居中 -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="screenshotPreviewModalLabel">預覽剪貼簿圖片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <!-- 預覽圖片顯示區域 -->
                        <img id="previewImage" src="#" alt="截圖預覽" style="display: none; max-width: 100%; max-height: 70vh; margin-bottom: 15px; border: 1px solid #ccc;">
                        <!-- 預覽錯誤訊息 -->
                        <p id="previewError" class="text-danger" style="display: none;">無法預覽圖片。</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmUploadButton">確認上傳</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 匯出選項彈窗 -->
        <div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exportOptionsModalLabel">匯出已確認弱點 - 選項</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="mb-3">請選擇匯出時要使用的選項：</p>
                <!-- 合併重複項選項 -->
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="" id="modalMergeDuplicatesCheckbox">
                  <label class="form-check-label" for="modalMergeDuplicatesCheckbox">
                    合併相同弱點類型 (同一報告內)
                  </label>
                   <small class="d-block text-muted">相同類型的弱點合併成單一項目，顯示代表性 URL，並列出所有相關實體及其最高嚴重性。</small>
                </div>
                <!-- 包含筆記選項 -->
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="modalIncludeNotesCheckbox">
                  <label class="form-check-label" for="modalIncludeNotesCheckbox">
                    包含筆記內容
                  </label>
                  <small class="d-block text-muted">在匯出的儲存格中附加相關問題的筆記 (合併模式下會合併所有相關筆記)。</small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmExportBtn">確認匯出</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 手動新增弱點彈窗 -->
        <div class="modal fade" id="addVulnerabilityModal" tabindex="-1" aria-labelledby="addVulnerabilityModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addVulnerabilityModalLabel">手動新增弱點</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 新增弱點表單 -->
                        <form id="addVulnerabilityForm" novalidate> <!-- novalidate 禁用瀏覽器預設驗證 -->
                            <!-- 隱藏欄位，用於傳遞報告檔名 -->
                            <input type="hidden" id="addVulnReportFilename" name="reportFilename">
                            <!-- 弱點名稱輸入 -->
                            <div class="mb-3">
                                <label for="addVulnIssueName" class="form-label">弱點名稱 <span class="text-danger">*</span></label>
                                <!-- 使用 datalist 提供預定義選項 -->
                                <input type="text" class="form-control" id="addVulnIssueName" name="issueName" list="weakness-names-list" required placeholder="輸入或從列表選擇弱點名稱">
                                <datalist id="weakness-names-list">
                                    <!-- 弱點名稱選項將由 JS 動態填入 -->
                                </datalist>
                                <div class="invalid-feedback">弱點名稱為必填項目。</div> <!-- Bootstrap 驗證失敗提示 -->
                            </div>
                            <!-- 嚴重性和 URL -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="addVulnSeverity" class="form-label">嚴重性 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="addVulnSeverity" name="severity" required>
                                        <!-- 嚴重性選項由後端 Jinja2 填入 -->
                                        {% for key, display in severities.items() %}
                                            {% set lower_key = key.lower() %}
                                            {% if lower_key in severity_levels_map %}
                                                <option value="{{ lower_key }}" {{ 'selected' if lower_key == 'medium' else '' }}>{{ display }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="addVulnUrl" class="form-label">URL</label>
                                    <input type="text" class="form-control" id="addVulnUrl" name="url" placeholder="https://example.com/page (或 N/A)">
                                </div>
                            </div>
                            <!-- 實體名稱 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="addVulnEntityName" class="form-label">實體名稱/說明</label>
                                    <input type="text" class="form-control" id="addVulnEntityName" name="entityName" placeholder="例如：登入繞過、未授權訪問頁面 (或 N/A)">
                                </div>
                                <!-- 實體類型輸入已移除，固定為 "手動新增" -->
                            </div>
                            <!-- 筆記 -->
                            <div class="mb-3">
                                <label for="addVulnNote" class="form-label">筆記</label>
                                <textarea class="form-control" id="addVulnNote" name="note" rows="3" placeholder="輸入此手動弱點的相關說明或筆記..."></textarea>
                            </div>
                            <!-- 新增弱點時的錯誤/成功訊息提示區域 -->
                            <div id="addVulnFeedback" class="alert alert-danger small mt-2 py-2" style="display: none;" role="alert"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="saveCustomVulnerabilityBtn">儲存新增</button>
                    </div>
                </div>
            </div>
        </div> <!-- END 手動新增弱點彈窗 -->

        <!-- 區塊 2: 報告內容顯示 (預設隱藏) -->
        <div id="display-container" class="report-section" data-section-title="2. 報告內容" style="display: none;">
            <div id="reportDetails">
                <!-- 報告標頭資訊 (掃描時間、摘要、圖表) 將由 JS 動態填入 -->
                <div id="reportHeaderInfo"></div>

                <!-- 過濾器區域 (預設隱藏，選擇報告後顯示) -->
                <div id="filterSection" style="display: none;">
                     <!-- 目前生效的過濾條件顯示 -->
                     <div id="filterStatus" class="mb-2">
                        <strong>目前篩選：</strong> <span id="activeFiltersDisplay">無</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1 ms-2" id="clearFiltersBtn" title="清除所有篩選條件" style="display: none;"><i class="fas fa-times"></i> 清除</button>
                    </div>
                    <!-- 過濾表單 -->
                    <form id="filterForm" class="filter-form pt-2">
                        <div class="row">
                            <!-- 嚴重性過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>嚴重性:</h5>
                                <!-- 嚴重性 Checkbox 由後端 Jinja2 生成 -->
                                {% for key, display_name in severities.items() %}
                                    {% set lower_key = key.lower() %}
                                    {% if lower_key in severity_levels_map %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input severity-checkbox filter-checkbox" type="checkbox" id="severity-{{ lower_key }}" name="severity" value="{{ lower_key }}">
                                            <label class="form-check-label" for="severity-{{ lower_key }}">{{ display_name }}</label>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <!-- 審查狀況過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>審查狀況:</h5>
                                <!-- 狀態 Checkbox 由後端 Jinja2 生成 -->
                                {% for value, text in status_options.items() %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input status-filter-checkbox filter-checkbox" type="checkbox" id="status-filter-{{ value | urlencode }}" name="status_filter" value="{{ value }}">
                                        <label class="form-check-label" for="status-filter-{{ value | urlencode }}">{{ text }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                            <!-- 截圖狀態過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>截圖狀態:</h5>
                                <!-- 截圖狀態 Checkbox 由後端 Jinja2 生成 -->
                                {% if screenshot_filter_options %}
                                    {% for value, text in screenshot_filter_options.items() %}
                                        <div class="form-check">
                                            <input class="form-check-input screenshot-status-filter-checkbox filter-checkbox" type="checkbox" id="ss-filter-{{ value }}" name="screenshot_status_filter" value="{{ value }}">
                                            <label class="form-check-label" for="ss-filter-{{ value }}">{{ text }}</label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted small">截圖過濾器選項未載入。</p>
                                {% endif %}
                            </div>
                            <!-- 來源過濾 -->
                             <div class="col-lg-3 filter-group">
                                <h5>來源:</h5>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input source-filter-checkbox filter-checkbox" type="checkbox" id="source-filter-appscan" name="source_filter" value="appscan" checked>
                                    <label class="form-check-label" for="source-filter-appscan">AppScan</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input source-filter-checkbox filter-checkbox" type="checkbox" id="source-filter-manual" name="source_filter" value="manual" checked>
                                    <label class="form-check-label" for="source-filter-manual">手動新增</label>
                                </div>
                                <!-- 錯誤來源過濾器已移除，通常不需要從 UI 過濾此項 -->
                            </div>
                        </div>
                    </form>
                    <hr/> <!-- 過濾器下方分隔線 -->
                </div> <!-- END #filterSection -->

                <!-- 問題列表標頭 (包含計數和排序控制項) -->
                <div class="issue-list-header" style="display: none;">
                    <h4>問題列表 (<span id="issueCount">0</span>)</h4>
                    <div id="sortControls" class="d-flex align-items-center">
                        <label for="sortSelect" class="col-form-label col-form-label-sm me-2">排序方式:</label>
                        <select id="sortSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="severity">嚴重程度 (高到低)</option>
                            <option value="url">URL (A-Z)</option>
                            <option value="issue_type">弱點名稱 (A-Z)</option>
                            <option value="status">審查狀況 (A-Z)</option>
                        </select>
                    </div>
                </div>

                <!-- 問題列表容器 (將由 JS 動態填入) -->
                <div id="reportIssueList">
                    <!-- 初始提示訊息 -->
                    <div class="alert alert-secondary initial-message" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        報告內容將顯示於此。請先從上方選擇一個報告檔案。
                    </div>
                </div> <!-- END #reportIssueList -->
            </div> <!-- END #reportDetails -->
        </div> <!-- END #display-container -->
    </div> <!-- END .container -->

     <!-- 浮動操作按鈕 (Floating Action Buttons) -->
     <div class="fab-container">
        <!-- 回到頂部按鈕 -->
        <button type="button" class="btn btn-secondary btn-fab" id="fabScrollTop" title="回到頂部">
            <i class="fas fa-arrow-up"></i>
        </button>
        <!-- 選擇報告按鈕 (觸發彈窗) -->
         <button type="button" class="btn btn-primary btn-fab" id="fabSelectReport" title="選擇報告" data-bs-toggle="modal" data-bs-target="#reportSelectModal">
            <i class="fas fa-folder-open"></i>
        </button>
        <!-- 開啟 .scan 按鈕 (預設隱藏) -->
        <button type="button" class="btn btn-info btn-fab" id="fabOpenScanFile" title="開啟 .scan 檔案" style="display: none;">
            <i class="fas fa-external-link-alt"></i>
        </button>
        <!-- 報告列表過濾器按鈕 (下拉菜單) -->
        <div class="dropup"> <!-- 使用 dropup 使菜單向上彈出 -->
            <button type="button" class="btn btn-warning btn-fab dropdown-toggle" id="fabFilterToggle" data-bs-toggle="dropdown" aria-expanded="false" title="篩選報告列表">
                <i class="fas fa-list-check"></i>
            </button>
            <ul class="dropdown-menu fab-filter-menu" aria-labelledby="fabFilterToggle">
                <li><h6 class="dropdown-header">篩選報告列表</h6></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="low">低風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="medium">中風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="high">高風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="critical">僅重大風險</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="errors_only">僅異常掃描</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="informational">所有報告 (含缺失)</a></li>
            </ul>
        </div>
    </div> <!-- END .fab-container -->

    <!-- JavaScript 主要邏輯區塊 -->
    <script>
        // ========================================================================
        // === 全局 DOM 元素變數 (在 DOMContentLoaded 中初始化) ===
        // ========================================================================
        let reportModalListBody, selectedReportDisplay, openScanFileButton, exportButton,
            exportAllNotesButton, filterForm, filterSection, reportDetailsDiv,
            reportListErrorDiv, reportFilterSelect, issueListHeaderDiv, issueCountSpan,
            sortControlsDiv, sortSelect, reportHeaderInfoDiv, issueListContainer,
            previewModalElement, previewImage, previewError, confirmUploadButton,
            selectionContainer, displayContainer, darkModeToggle, fabContainer, fabScrollTop,
            fabSelectReport, fabOpenScanFile, fabFilterToggle, exportOptionsModalElement,
            modalMergeDuplicatesCheckbox, modalIncludeNotesCheckbox, confirmExportBtn,
            exportAbnormalButton, addVulnerabilityBtn, addVulnerabilityModalElement,
            addVulnerabilityForm, saveCustomVulnerabilityBtn, addVulnFeedback,
            weaknessDatalist, filterStatusDiv, activeFiltersDisplaySpan, clearFiltersBtn;

        // ========================================================================
        // === 全局狀態變數 ===
        // ========================================================================
        let currentReportFilename = '';     // 當前選定的報告檔名
        let activeCollapses = [];           // 保存已初始化的 Bootstrap Collapse 實例
        let currentReportFullData = null;   // 當前載入報告的完整數據 (包含問題列表、摘要等)
        let severityChartInstance = null;   // Chart.js 實例
        let reportSelectModal = null;       // 選擇報告彈窗的 Bootstrap Modal 實例
        let previewModal = null;            // 截圖預覽彈窗的 Bootstrap Modal 實例
        let exportOptionsModal = null;      // 匯出選項彈窗的 Bootstrap Modal 實例
        let addVulnerabilityModal = null;   // 新增弱點彈窗的 Bootstrap Modal 實例
        let blobToUpload = null;            // 預備從剪貼簿上傳的 Blob 對象
        let uploadContext = {};             // 儲存上傳時的上下文資訊 (issueId, issueName 等)
        let currentReportList = [];         // 當前可用於導航的報告列表 (不含缺失)
        let currentModalReportList = [];    // 當前彈窗中顯示的完整報告列表 (含缺失和篩選狀態)
        let currentReportIndex = -1;        // 當前報告在 currentReportList 中的索引 (未使用於導航)
        let groupedIssuesData = {};         // 用於儲存已分組的問題數據，方便後續查找群組成員

        // ========================================================================
        // === 全局常數 (在 DOMContentLoaded 中根據後端數據定義) ===
        // ========================================================================
        let CURRENT_PROJECT_NAME, CURRENT_PROJECT_DISPLAY_NAME, BASE_CONFIRMED_EXPORT_URL,
            BASE_ABNORMAL_EXPORT_URL, WEAKNESS_NAME_LIST, STATUS_OPTIONS, SEVERITY_OPTIONS,
            SEVERITY_LEVELS, AUTO_EXCLUDED_STATUS, SCREENSHOT_FILTER_OPTIONS, SEVERITY_KEYS,
            STATUS_KEYS, SCREENSHOT_FILTER_KEYS, displayNameToKeyMap, EXTERNAL_LINK_REASONING;

        // 允許的圖片 MIME 類型
        const ALLOWED_IMAGE_TYPES = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp'];
        // 掃描狀態常數 (與後端對應)
        const SCAN_STATUS = { SUCCESS: "成功", FAILED: "失敗", ABORTED: "已中斷", RUNNING: "執行中", UNKNOWN: "狀態未知", PARSE_ERROR: "解析錯誤", INCOMPLETE: "格式不完整", READ_ERROR: "讀取錯誤", MISSING: "Missing", FILE_NOT_FOUND: "檔案遺失" };
        // 掃描狀態對應的 Emoji (用於報告列表)
        const STATUS_EMOJI = { [SCAN_STATUS.SUCCESS]: '✅', [SCAN_STATUS.FAILED]: '❌', [SCAN_STATUS.PARSE_ERROR]: '❌', [SCAN_STATUS.READ_ERROR]: '❌', [SCAN_STATUS.ABORTED]: '⚠️', [SCAN_STATUS.INCOMPLETE]: '⚠️', [SCAN_STATUS.RUNNING]: '⏳', [SCAN_STATUS.UNKNOWN]: '❓', [SCAN_STATUS.MISSING]: '🚫', [SCAN_STATUS.FILE_NOT_FOUND]: '🚫' };
        // 嚴重性縮寫 (未使用)
        const SEVERITY_SHORT_LABELS = { critical: 'C', high: 'H', medium: 'M', low: 'L', informational: 'I' };
        // 下拉菜單中摘要的顯示順序
        const DROPDOWN_SUMMARY_ORDER = ['critical', 'high', 'medium', 'low', 'informational'];
        // 異常狀態列表 (用於報告列表篩選和樣式)
        const problematicStatuses = [ SCAN_STATUS.FAILED, SCAN_STATUS.PARSE_ERROR, SCAN_STATUS.READ_ERROR, SCAN_STATUS.INCOMPLETE, SCAN_STATUS.FILE_NOT_FOUND, SCAN_STATUS.MISSING, SCAN_STATUS.UNKNOWN, SCAN_STATUS.ABORTED ];
        // LocalStorage 鍵名常量
        const LS_DARK_MODE_KEY = `appscanViewerDarkMode_v1`; // 深色模式
        let LS_SEVERITY_FILTER_KEY, LS_STATUS_FILTER_KEY, LS_SCREENSHOT_FILTER_KEY,
            LS_SOURCE_FILTER_KEY, LS_REPORT_FILTER_KEY, LS_SORT_KEY,
            LS_MODAL_MERGE_DUP_KEY, LS_MODAL_INCLUDE_NOTES_KEY; // 其他鍵名將在 DOMContentLoaded 中根據專案名動態生成
        // 預設過濾條件
        const DEFAULT_SEVERITY_FILTERS = ['critical', 'high', 'medium', 'low', 'informational']; // 預設全選嚴重性
        let DEFAULT_STATUS_FILTERS; // 將在 DOMContentLoaded 中根據 STATUS_OPTIONS 初始化
        const DEFAULT_SCREENSHOT_FILTERS = []; // 預設不篩選截圖狀態
        const DEFAULT_SOURCE_FILTERS = ['appscan', 'manual']; // 預設顯示 AppScan 和手動來源
        const DEFAULT_REPORT_FILTER = 'low'; // 預設報告列表篩選條件
        const DEFAULT_SORT = 'severity'; // 預設排序方式
        const DEFAULT_STATUS = '未審查'; // 預設問題狀態

        // --- API URL 輔助函式 ---
        /**
         * 構造指向後端 API 的完整 URL
         * @param {string} endpoint API 端點路徑 (例如 'api/reports')
         * @returns {string} 完整的 API URL
         */
        function getApiUrl(endpoint) {
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
            return `/project/${encodeURIComponent(CURRENT_PROJECT_NAME)}/${cleanEndpoint}`;
        }

        // ========================================================================
        // === DOMContentLoaded 事件監聽器 (初始化頁面) ===
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // --- 定義依賴後端注入的常數 ---
            CURRENT_PROJECT_NAME = {{ project_name | tojson | safe }};
            CURRENT_PROJECT_DISPLAY_NAME = {{ project_display_name | default(project_name) | tojson | safe }};
            BASE_CONFIRMED_EXPORT_URL = "{{ url_for('export_confirmed_vulnerabilities', project_name=project_name) }}";
            BASE_ABNORMAL_EXPORT_URL = "{{ url_for('export_abnormal_reports', project_name=project_name) }}";
            WEAKNESS_NAME_LIST = {{ weakness_name_list | default([]) | tojson | safe }};
            STATUS_OPTIONS = {{ status_options | default({}) | tojson | safe }};
            SEVERITY_OPTIONS = {{ severities | default({}) | tojson | safe }};
            SEVERITY_LEVELS = {{ severity_levels_map | default({}) | tojson | safe }};
            AUTO_EXCLUDED_STATUS = {{ auto_excluded_status_value | default('已自動排除') | tojson | safe }};
            SCREENSHOT_FILTER_OPTIONS = {{ screenshot_filter_options | default({}) | tojson | safe }};
            EXTERNAL_LINK_REASONING = EXTERNAL_LINK_REASONING_TEXT; // 從頁面頂部 script 標籤獲取

            // --- 定義衍生的常數 ---
            SEVERITY_KEYS = Object.keys(SEVERITY_LEVELS);
            STATUS_KEYS = Object.keys(STATUS_OPTIONS);
            SCREENSHOT_FILTER_KEYS = Object.keys(SCREENSHOT_FILTER_OPTIONS);
            // 建立嚴重性顯示名稱到內部鍵名的映射 (用於圖表等)
            displayNameToKeyMap = {};
            for (const [key, value] of Object.entries(SEVERITY_OPTIONS)) { displayNameToKeyMap[value] = key.toLowerCase(); };
            if (SEVERITY_OPTIONS["Informational"]) { displayNameToKeyMap[SEVERITY_OPTIONS["Informational"]] = "informational"; } // 修正 Informational 鍵名
            // 預設狀態過濾器 (排除自動排除)
            DEFAULT_STATUS_FILTERS = STATUS_KEYS.filter(k => k !== AUTO_EXCLUDED_STATUS);

            // --- 定義 LocalStorage 鍵名 (包含專案名稱以區分不同專案的設定) ---
            LS_SEVERITY_FILTER_KEY = `appscanViewerSeverityFilters_${CURRENT_PROJECT_NAME}_v2`;
            LS_STATUS_FILTER_KEY = `appscanViewerStatusFilters_${CURRENT_PROJECT_NAME}_v2`;
            LS_SCREENSHOT_FILTER_KEY = `appscanViewerScreenshotFilters_${CURRENT_PROJECT_NAME}_v1`;
            LS_SOURCE_FILTER_KEY = `appscanViewerSourceFilters_${CURRENT_PROJECT_NAME}_v1`;
            LS_REPORT_FILTER_KEY = `appscanViewerReportFilter_${CURRENT_PROJECT_NAME}_v1`;
            LS_SORT_KEY = `appscanViewerSortOption_${CURRENT_PROJECT_NAME}_v1`;
            LS_MODAL_MERGE_DUP_KEY = `appscanViewerModalMergeDup_${CURRENT_PROJECT_NAME}_v1`;
            LS_MODAL_INCLUDE_NOTES_KEY = `appscanViewerModalIncludeNotes_${CURRENT_PROJECT_NAME}_v1`;

            // --- 初始化全局 DOM 元素變數 ---
            console.log("DOMContentLoaded: Initializing DOM element variables...");
            reportModalListBody = document.getElementById('reportModalListBody');
            selectedReportDisplay = document.getElementById('selectedReportDisplay');
            openScanFileButton = document.getElementById('openScanFileButton');
            exportButton = document.getElementById('exportButton');
            exportAllNotesButton = document.getElementById('exportAllNotesButton');
            filterForm = document.getElementById('filterForm');
            filterSection = document.getElementById('filterSection');
            reportDetailsDiv = document.getElementById('reportDetails');
            reportListErrorDiv = document.getElementById('reportListError');
            reportFilterSelect = document.getElementById('reportFilterSelect');
            issueListHeaderDiv = document.querySelector('.issue-list-header');
            issueCountSpan = document.getElementById('issueCount');
            sortControlsDiv = document.getElementById('sortControls');
            sortSelect = document.getElementById('sortSelect');
            reportHeaderInfoDiv = document.getElementById('reportHeaderInfo');
            issueListContainer = document.getElementById('reportIssueList');
            previewModalElement = document.getElementById('screenshotPreviewModal');
            previewImage = document.getElementById('previewImage');
            previewError = document.getElementById('previewError');
            confirmUploadButton = document.getElementById('confirmUploadButton');
            selectionContainer = document.getElementById('selection-container');
            displayContainer = document.getElementById('display-container');
            darkModeToggle = document.getElementById('darkModeToggle');
            fabContainer = document.querySelector('.fab-container');
            fabScrollTop = document.getElementById('fabScrollTop');
            fabSelectReport = document.getElementById('fabSelectReport');
            fabOpenScanFile = document.getElementById('fabOpenScanFile');
            fabFilterToggle = document.getElementById('fabFilterToggle');
            exportOptionsModalElement = document.getElementById('exportOptionsModal');
            modalMergeDuplicatesCheckbox = document.getElementById('modalMergeDuplicatesCheckbox');
            modalIncludeNotesCheckbox = document.getElementById('modalIncludeNotesCheckbox');
            confirmExportBtn = document.getElementById('confirmExportBtn');
            exportAbnormalButton = document.getElementById('exportAbnormalButton');
            addVulnerabilityBtn = document.getElementById('addVulnerabilityBtn');
            addVulnerabilityModalElement = document.getElementById('addVulnerabilityModal');
            addVulnerabilityForm = document.getElementById('addVulnerabilityForm');
            saveCustomVulnerabilityBtn = document.getElementById('saveCustomVulnerabilityBtn');
            addVulnFeedback = document.getElementById('addVulnFeedback');
            weaknessDatalist = document.getElementById('weakness-names-list');
            filterStatusDiv = document.getElementById('filterStatus');
            activeFiltersDisplaySpan = document.getElementById('activeFiltersDisplay');
            clearFiltersBtn = document.getElementById('clearFiltersBtn');
            console.log("DOMContentLoaded: DOM element variables initialized.");

            // --- 初始化功能 ---
            console.log(`DOM loaded for project: ${CURRENT_PROJECT_NAME} (${CURRENT_PROJECT_DISPLAY_NAME})`);
            document.title = `${CURRENT_PROJECT_DISPLAY_NAME} - AppScan 報告檢視器`; // 設定頁面標題

            // 初始化 Bootstrap Modals
            try {
                const reportModalEl = document.getElementById('reportSelectModal');
                const previewModalEl = document.getElementById('screenshotPreviewModal');
                const exportOptionsModalEl = document.getElementById('exportOptionsModal');
                const addVulnerabilityModalEl = document.getElementById('addVulnerabilityModal');

                // 檢查元素是否存在後才初始化
                if (reportModalEl) { reportSelectModal = new bootstrap.Modal(reportModalEl); console.log("Report modal initialized."); } else { console.error("Report modal element ('reportSelectModal') not found!"); }
                if (previewModalEl) {
                    previewModal = new bootstrap.Modal(previewModalEl); console.log("Preview modal initialized.");
                    // 添加關閉彈窗時的清理事件監聽器 (只添加一次)
                    if (!previewModalEl.dataset.listenerAttached) {
                        previewModalEl.addEventListener('hidden.bs.modal', () => {
                            // 釋放預覽圖片的 Blob URL
                            if (previewImage.src && previewImage.src.startsWith('blob:')) URL.revokeObjectURL(previewImage.src);
                            previewImage.src = '#'; // 清空圖片源
                            previewImage.style.display = 'none';
                            previewError.style.display = 'none';
                            blobToUpload = null; // 清空待上傳的 Blob
                            uploadContext = {}; // 清空上傳上下文
                        });
                        previewModalEl.dataset.listenerAttached = 'true'; // 標記已添加監聽器
                    }
                } else { console.error("Preview modal element ('screenshotPreviewModal') not found!"); }
                if (exportOptionsModalEl) { exportOptionsModal = new bootstrap.Modal(exportOptionsModalEl); console.log("Export options modal initialized."); } else { console.error("Export options modal element ('exportOptionsModal') not found!"); }
                if (addVulnerabilityModalEl) {
                    addVulnerabilityModal = new bootstrap.Modal(addVulnerabilityModalEl); console.log("Add Vulnerability modal initialized.");
                    // 添加關閉新增弱點彈窗時的清理事件監聽器
                    addVulnerabilityModalEl.addEventListener('hidden.bs.modal', () => {
                        addVulnerabilityForm.reset(); // 重設表單
                        addVulnFeedback.style.display = 'none'; // 隱藏反饋訊息
                        addVulnFeedback.textContent = '';
                        addVulnerabilityForm.classList.remove('was-validated'); // 移除 Bootstrap 驗證樣式
                        const issueNameInput = document.getElementById('addVulnIssueName');
                        issueNameInput?.classList.remove('is-invalid'); // 移除名稱輸入框的錯誤樣式
                    });
                } else { console.error("Add Vulnerability modal element ('addVulnerabilityModal') not found!"); }
            } catch (e) {
                console.error("Error initializing Modals:", e);
                alert("無法初始化互動視窗元件，部分功能可能異常。");
            }

            // 載入並應用 LocalStorage 中的設定
            loadAndApplyDarkMode();      // 深色模式
            loadAndApplyFilters();       // 問題列表過濾條件
            loadAndApplyReportFilter();  // 報告列表過濾條件
            loadAndApplySort();          // 問題列表排序方式
            updateFilterStatusDisplay(); // 根據當前過濾條件更新顯示區域
            populateWeaknessDatalist(); // 填充弱點名稱 datalist

            // 初始化時獲取報告列表
            fetchReportList();
            toggleAbnormalExportButtonVisibility(); // 根據初始報告過濾條件決定是否顯示匯出異常按鈕

            // --- 綁定事件監聽器 ---
            console.log("DOMContentLoaded: Attaching event listeners...");
            // 報告列表過濾器變更
            if (reportFilterSelect) reportFilterSelect.addEventListener('change', handleReportListFilterChange);
            // 問題列表過濾器 Checkbox 變更
            if (filterForm) filterForm.querySelectorAll('input.filter-checkbox').forEach(cb => cb.addEventListener('change', handleFilterChange));
            // 問題列表容器的事件代理 (處理狀態變更、截圖 Checkbox 變更) - 使用 'change' 事件
            if (issueListContainer) { issueListContainer.addEventListener('change', handleIssueCardChange); } else { console.error("issueListContainer not found, cannot add 'change' listener!"); }
            // 問題列表容器的事件代理 (處理按鈕點擊) - 使用 'click' 事件
            if (issueListContainer) { issueListContainer.addEventListener('click', handleIssueCardClick); } else { console.error("issueListContainer not found, cannot add 'click' listener!"); }
            // 報告選擇彈窗內的事件代理 (處理 Checkbox 變更)
            if (reportModalListBody) { reportModalListBody.addEventListener('change', handleReportModalChange); }
            // 報告選擇彈窗內的事件代理 (處理報告點擊)
            if (reportModalListBody) { reportModalListBody.addEventListener('click', handleModalReportClick); }
            // 問題列表排序方式變更
            if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
            // 截圖預覽彈窗確認上傳按鈕
            if (confirmUploadButton) confirmUploadButton.addEventListener('click', handlePreviewConfirm);
            // 開啟 .scan 檔案按鈕
            if (openScanFileButton) openScanFileButton.addEventListener('click', handleOpenScanFile);
            // 深色模式切換按鈕
            if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);
            // 匯出已確認弱點按鈕 (觸發彈窗)
            if (exportButton) exportButton.addEventListener('click', handleExportButtonClick);
            // 匯出選項彈窗確認按鈕
            if (confirmExportBtn) confirmExportBtn.addEventListener('click', handleConfirmExport);
            // 匯出異常報告按鈕
            if (exportAbnormalButton) exportAbnormalButton.addEventListener('click', handleExportAbnormalClick);
            // 匯出所有筆記按鈕
            if (exportAllNotesButton) exportAllNotesButton.addEventListener('click', handleExportAllNotesClick);
            // 手動新增弱點按鈕 (觸發彈窗)
            if (addVulnerabilityBtn) addVulnerabilityBtn.addEventListener('click', handleAddVulnerabilityClick);
            // 新增弱點彈窗儲存按鈕
            if (saveCustomVulnerabilityBtn) saveCustomVulnerabilityBtn.addEventListener('click', handleSaveCustomVulnerability);
            // 清除過濾條件按鈕
            if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', handleClearFilters);
            // FAB - 回到頂部
            if (fabScrollTop) fabScrollTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            // FAB - 選擇報告
            if (fabSelectReport) fabSelectReport.addEventListener('click', () => { if(reportSelectModal) reportSelectModal.show(); });
            // FAB - 開啟 .scan
            if (fabOpenScanFile) fabOpenScanFile.addEventListener('click', handleOpenScanFile);
            // FAB - 過濾器下拉菜單項
            if (fabFilterToggle) document.querySelectorAll('.fab-report-filter').forEach(item => { item.addEventListener('click', handleFabReportFilterClick); });
            console.log("DOMContentLoaded: Event listeners attached.");

            // 初始化 FAB 按鈕的可見性
            updateFabNavButtons();

        }); // END DOMContentLoaded

        // ========================================================================
        // === 深色模式處理邏輯 ===
        // ========================================================================
        /**
         * 從 LocalStorage 載入深色模式設定並應用到 body
         */
        function loadAndApplyDarkMode() {
            const savedMode = localStorage.getItem(LS_DARK_MODE_KEY);
            const isDark = savedMode === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            updateDarkModeButton(isDark); // 更新按鈕圖示和文字
            // 同步更新 CSS 變數
            document.documentElement.style.setProperty('--sticky-bg', isDark ? '#1a1a1a' : '#ffffff');
            document.documentElement.style.setProperty('--sticky-border', isDark ? '#444' : '#dee2e6');
        }

        /**
         * 更新深色模式切換按鈕的圖示和文字
         * @param {boolean} isDark 當前是否為深色模式
         */
        function updateDarkModeButton(isDark) {
            if (!darkModeToggle) return;
            const icon = darkModeToggle.querySelector('i');
            const text = darkModeToggle.querySelector('span');
            if (isDark) { // 切換到太陽圖示和淺色模式文字
                icon?.classList.replace('fa-moon', 'fa-sun');
                if (text) text.textContent = '淺色模式';
                darkModeToggle.title = '切換至淺色模式';
            } else { // 切換到月亮圖示和深色模式文字
                icon?.classList.replace('fa-sun', 'fa-moon');
                if (text) text.textContent = '深色模式';
                darkModeToggle.title = '切換至深色模式';
            }
        }

        /**
         * 切換深色/淺色模式，並保存設定到 LocalStorage
         */
        function toggleDarkMode() {
            const isCurrentlyDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(LS_DARK_MODE_KEY, isCurrentlyDark ? 'dark' : 'light');
            updateDarkModeButton(isCurrentlyDark); // 更新按鈕
            // 更新 CSS 變數
            document.documentElement.style.setProperty('--sticky-bg', isCurrentlyDark ? '#1a1a1a' : '#ffffff');
            document.documentElement.style.setProperty('--sticky-border', isCurrentlyDark ? '#444' : '#dee2e6');
            // 如果圖表已存在，重新渲染以應用深色模式顏色
            if (severityChartInstance && currentReportFullData?.summary) {
                renderSeverityChart(currentReportFullData.summary);
            }
        }

        // ========================================================================
        // === 輔助函式 ===
        // ========================================================================
        /**
         * HTML 特殊字符轉義，防止 XSS
         * @param {string | any} unsafe 可能包含不安全字符的輸入
         * @returns {string} 轉義後的安全字符串，或在無法轉換時返回 'N/A' 或 'Err'
         */
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return 'N/A';
            if (typeof unsafe !== 'string') {
                try { unsafe = String(unsafe); } catch (e) { return 'Err'; } // 嘗試轉換為字串
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        /**
         * 銷毀所有已初始化的 Bootstrap Collapse 實例 (防止內存洩漏)
         */
        function disposeCollapses() {
            activeCollapses.forEach(c => {
                if (c) { try { c.dispose(); } catch (e) {} } // 忽略可能的錯誤
            });
            activeCollapses = []; // 清空列表
        }

        /**
         * 初始化頁面上所有 .collapse 元素的 Bootstrap Collapse 功能
         */
        function initializeCollapses() {
            disposeCollapses(); // 先銷毀舊的實例
            if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                const collapseElements = Array.from(document.querySelectorAll('.collapse'));
                activeCollapses = collapseElements.map(el => {
                    try {
                        // 獲取現有實例或創建新實例，設置 toggle: false 避免自動展開
                        return bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
                    } catch (e) {
                        console.error("Collapse initialization error:", e);
                        return null; // 初始化失敗返回 null
                    }
                }).filter(Boolean); // 過濾掉 null
            } else {
                console.warn("Bootstrap Collapse not ready for initialization.");
            }
        }

        /**
         * 根據嚴重性鍵名獲取對應的 Bootstrap 徽章顏色 class
         * @param {string} key 嚴重性鍵名 (例如 'critical', 'high')
         * @returns {string} 對應的 CSS class 名稱
         */
        function getSeverityBadgeColor(key) {
            switch (key?.toLowerCase()) {
                case 'critical': return 'badge-custom-critical';
                case 'high': return 'badge-custom-high';
                case 'medium': return 'badge-custom-medium';
                case 'low': return 'badge-custom-low';
                case 'informational': return 'badge-custom-informational';
                default: return 'badge-custom-unknown'; // 未知或錯誤
            }
        }

        /**
         * 從 URL 字串中提取主機名 (hostname)
         * @param {string} urlString URL 字串
         * @returns {string | null} 提取到的主機名，或 null 如果無效
         */
        function extractHostname(urlString) {
            if (!urlString || typeof urlString !== 'string' || urlString.toLowerCase() === 'n/a') return null;
            try {
                let urlToParse = urlString;
                // 如果沒有協議頭，嘗試添加 https:// (如果包含 '.')
                if (!urlString.startsWith('http://') && !urlString.startsWith('https://')) {
                    urlToParse = urlString.includes('.') ? ('https://' + urlString) : null;
                }
                if (!urlToParse) return null; // 無法構建有效 URL
                const url = new URL(urlToParse);
                let hostname = url.hostname;
                // 處理 IPv6 地址格式 [::1]
                if (hostname.startsWith('[') && hostname.endsWith(']')) {
                    hostname = hostname.substring(1, hostname.length - 1);
                }
                return hostname || null;
            } catch (e) {
                // 如果 new URL() 失敗，嘗試使用正則表達式做最後的努力
                const match = urlString.match(/^(?:(?:https?|ftp):\/\/)?(?:www\.)?([^\/:\?#]+)/i);
                if (match && match[1]) {
                    let hostname = match[1];
                    if (hostname.startsWith('[') && hostname.endsWith(']')) {
                        hostname = hostname.substring(1, hostname.length - 1);
                    }
                    return hostname;
                }
                return null; // 最終無法提取
            }
        }

        /**
         * 重設報告選擇狀態和顯示內容
         */
        function resetReportSelection() {
            currentReportFilename = ''; // 清空當前報告檔名
            currentReportFullData = null; // 清空報告數據
            currentReportIndex = -1; // 重設索引
            groupedIssuesData = {}; // 清空分組數據

            // 重設 UI 元素
            if(selectedReportDisplay) {
                selectedReportDisplay.textContent = '尚未選擇報告';
                selectedReportDisplay.classList.remove('has-selection'); // 移除選中樣式
            }
            if (severityChartInstance) { // 銷毀圖表
                severityChartInstance.destroy();
                severityChartInstance = null;
            }
            if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = ''; // 清空報告頭部
            if(issueListContainer) { // 重設問題列表區域
                issueListContainer.innerHTML = '<div class="alert alert-secondary initial-message" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>請從上方選擇報告檔案。</div>';
            }
            if(filterSection) filterSection.style.display = 'none'; // 隱藏過濾器
            if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none'; // 隱藏問題列表標頭
            if(displayContainer) displayContainer.style.display = 'none'; // 隱藏報告內容區塊
            if(filterStatusDiv) filterStatusDiv.style.display = 'none'; // 隱藏過濾狀態顯示
            if(openScanFileButton) openScanFileButton.style.display = 'none'; // 隱藏打開 .scan 按鈕
            if(addVulnerabilityBtn) addVulnerabilityBtn.disabled = true; // 禁用新增弱點按鈕
            if(fabOpenScanFile) fabOpenScanFile.style.display = 'none'; // 隱藏 FAB 開啟 .scan 按鈕

            updateFabNavButtons(); // 更新 FAB 按鈕可見性
            disposeCollapses(); // 銷毀可能存在的 Collapse 實例
        }

        /**
         * 更新 FAB 按鈕的可見性 (目前主要是 Open Scan 按鈕)
         */
        function updateFabNavButtons() {
            if(fabOpenScanFile) {
                fabOpenScanFile.style.display = (currentReportFilename && !currentReportFilename.endsWith("-找不到掃描檔")) ? 'flex' : 'none';
            }
        }

        // ========================================================================
        // === 過濾器/排序狀態的讀取、保存與顯示 ===
        // ========================================================================
        /**
         * 從 LocalStorage 載入過濾條件並應用到表單 Checkbox
         */
        function loadAndApplyFilters() {
             let savedSeverities = null, savedStatuses = null, savedScreenshotStatuses = null, savedSources = null;
             // 分別嘗試讀取並解析各種過濾條件
             try { const sD = localStorage.getItem(LS_SEVERITY_FILTER_KEY); if (sD) savedSeverities = JSON.parse(sD); if (!Array.isArray(savedSeverities)) savedSeverities = null; } catch (e) { console.warn("Failed to parse saved severity filters", e); }
             try { const stD = localStorage.getItem(LS_STATUS_FILTER_KEY); if (stD) savedStatuses = JSON.parse(stD); if (!Array.isArray(savedStatuses)) savedStatuses = null; } catch (e) { console.warn("Failed to parse saved status filters", e); }
             try { const ssD = localStorage.getItem(LS_SCREENSHOT_FILTER_KEY); if (ssD) savedScreenshotStatuses = JSON.parse(ssD); if (!Array.isArray(savedScreenshotStatuses)) savedScreenshotStatuses = null; } catch (e) { console.warn("Failed to parse saved screenshot filters", e); }
             try { const srcD = localStorage.getItem(LS_SOURCE_FILTER_KEY); if (srcD) savedSources = JSON.parse(srcD); if (!Array.isArray(savedSources)) savedSources = null; } catch (e) { console.warn("Failed to parse saved source filters", e); }

             // 如果 LocalStorage 中沒有或無效，則使用預設值
             const severitiesToCheck = savedSeverities ?? DEFAULT_SEVERITY_FILTERS;
             const statusesToCheck = savedStatuses ?? DEFAULT_STATUS_FILTERS;
             const screenshotStatusesToCheck = savedScreenshotStatuses ?? DEFAULT_SCREENSHOT_FILTERS;
             const sourcesToCheck = savedSources ?? DEFAULT_SOURCE_FILTERS;

             // 將讀取到的或預設的過濾條件應用到表單 Checkbox 的選中狀態
             if(filterForm) {
                 filterForm.querySelectorAll('.severity-checkbox').forEach(cb => { cb.checked = severitiesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.status-filter-checkbox').forEach(cb => { cb.checked = statusesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.screenshot-status-filter-checkbox').forEach(cb => { cb.checked = screenshotStatusesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.source-filter-checkbox').forEach(cb => { cb.checked = sourcesToCheck.includes(cb.value); });
             }
        }

        /**
         * 將當前過濾表單的狀態保存到 LocalStorage
         */
        function saveFiltersToLocalStorage() {
            if (!filterForm) return; // 確保表單存在
            // 獲取各類過濾器當前選中的值
            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.value);
            // 只保存 'appscan' 和 'manual' 來源
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked'))
                                  .map(cb => cb.value)
                                  .filter(val => val === 'appscan' || val === 'manual');

            // 分別保存到 LocalStorage，忽略可能的錯誤
            try { localStorage.setItem(LS_SEVERITY_FILTER_KEY, JSON.stringify(severities)); } catch (e) { console.error("Failed to save severity filters", e); }
            try { localStorage.setItem(LS_STATUS_FILTER_KEY, JSON.stringify(statuses)); } catch (e) { console.error("Failed to save status filters", e); }
            try { localStorage.setItem(LS_SCREENSHOT_FILTER_KEY, JSON.stringify(screenshotStatuses)); } catch (e) { console.error("Failed to save screenshot filters", e); }
            try { localStorage.setItem(LS_SOURCE_FILTER_KEY, JSON.stringify(sources)); } catch (e) { console.error("Failed to save source filters", e); }
        }

        /**
         * 從 LocalStorage 載入報告列表的過濾條件並應用到下拉選單
         */
        function loadAndApplyReportFilter() {
            if(reportFilterSelect) {
                reportFilterSelect.value = localStorage.getItem(LS_REPORT_FILTER_KEY) || DEFAULT_REPORT_FILTER;
            }
        }

        /**
         * 從 LocalStorage 載入問題列表的排序方式並應用到下拉選單
         */
        function loadAndApplySort() {
            if(sortSelect) {
                sortSelect.value = localStorage.getItem(LS_SORT_KEY) || DEFAULT_SORT;
            }
        }

        /**
         * 獲取當前生效的過濾條件 (用於顯示)
         * @returns {object} 包含各類過濾條件名稱的對象
         */
        function getActiveFilters() {
            if (!filterForm) return { severities: [], statuses: [], screenshotStatuses: [], sources: [], sourceFiltered: false };
            // 獲取選中 Checkbox 的標籤文字
            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked'))
                                  .filter(cb => cb.value === 'appscan' || cb.value === 'manual') // 只考慮 appscan/manual
                                  .map(cb => cb.labels[0]?.textContent || cb.value);
            // 獲取所有可用的來源選項 (appscan/manual)
            const allAvailableSources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox'))
                                        .filter(cb => cb.value === 'appscan' || cb.value === 'manual')
                                        .map(cb => cb.labels[0]?.textContent || cb.value);
            // 判斷來源是否被過濾 (選中的數量少於總數)
            const sourceFiltered = sources.length > 0 && sources.length < allAvailableSources.length;

            return { severities, statuses, screenshotStatuses, sources, sourceFiltered };
        }

        /**
         * 更新頁面上顯示當前過濾條件的區域 (#filterStatus)
         */
        function updateFilterStatusDisplay() {
            if (!filterStatusDiv || !activeFiltersDisplaySpan) return;
            const { severities, statuses, screenshotStatuses, sources, sourceFiltered } = getActiveFilters();
            // 判斷是否有任何過濾條件生效
            const hasActiveFilters = severities.length < DEFAULT_SEVERITY_FILTERS.length ||
                                     statuses.length < DEFAULT_STATUS_FILTERS.length ||
                                     screenshotStatuses.length > 0 ||
                                     sourceFiltered;

            if (hasActiveFilters) {
                let html = '';
                // 輔助函式，用於生成帶有徽章的過濾條件顯示
                const getBadge = (label, values, colorClass) => {
                    // 只有當該類型的過濾條件與預設不同或有選中時才顯示
                    let show = false;
                    if (label === '嚴重性') show = values.length < DEFAULT_SEVERITY_FILTERS.length;
                    else if (label === '狀況') show = values.length < DEFAULT_STATUS_FILTERS.length;
                    else if (label === '截圖') show = values.length > 0;
                    else if (label === '來源') show = sourceFiltered; // 只有部分來源被選中時顯示
                    return show ? ` <span class="badge ${colorClass}">${label}: ${values.join(', ')}</span>` : '';
                };
                // 生成各類過濾條件的徽章 HTML
                html += getBadge('嚴重性', severities, 'bg-danger');
                html += getBadge('狀況', statuses, 'bg-info text-dark');
                html += getBadge('截圖', screenshotStatuses, 'bg-warning text-dark');
                if (sourceFiltered) html += getBadge('來源', sources, 'bg-primary');

                activeFiltersDisplaySpan.innerHTML = html || '無有效篩選'; // 如果 HTML 為空，顯示提示
                filterStatusDiv.style.display = 'block'; // 顯示區域
                if (clearFiltersBtn) clearFiltersBtn.style.display = 'inline-block'; // 顯示清除按鈕
            } else {
                // 如果沒有生效的過濾條件
                activeFiltersDisplaySpan.textContent = '無';
                filterStatusDiv.style.display = 'none'; // 隱藏區域
                if (clearFiltersBtn) clearFiltersBtn.style.display = 'none'; // 隱藏清除按鈕
            }
        }

        /**
         * 處理過濾條件 Checkbox 變更事件
         */
        function handleFilterChange() {
             saveFiltersToLocalStorage(); // 保存新的過濾條件
             updateFilterStatusDisplay(); // 更新顯示區域
             if (currentReportFilename) { // 如果當前已選擇報告
                 const scrollY = window.scrollY; // 記錄當前滾動位置
                 fetchReportData(currentReportFilename, scrollY); // 重新獲取並渲染報告數據，並嘗試恢復滾動位置
             }
        }

        /**
         * 處理清除過濾條件按鈕點擊事件
         */
        function handleClearFilters() {
            if (!filterForm) return;
            // 將所有 Checkbox (除了可能的 'error' 來源) 設為選中狀態
            filterForm.querySelectorAll('input.filter-checkbox').forEach(cb => {
                 cb.checked = (cb.value !== 'error'); // 預設全選，但排除 error (如果存在)
            });
            saveFiltersToLocalStorage(); // 保存狀態
            updateFilterStatusDisplay(); // 更新顯示
            if (currentReportFilename) { // 重新載入報告數據
                 const scrollY = window.scrollY;
                 fetchReportData(currentReportFilename, scrollY);
            }
        }

        // ========================================================================
        // === 匯出選項彈窗狀態的讀取與保存 ===
        // ========================================================================
        /**
         * 從 LocalStorage 載入匯出選項並應用到彈窗 Checkbox
         */
        function loadExportModalOptions() {
             if (!modalMergeDuplicatesCheckbox || !modalIncludeNotesCheckbox) return;
             const savedMerge = localStorage.getItem(LS_MODAL_MERGE_DUP_KEY);
             const savedNotes = localStorage.getItem(LS_MODAL_INCLUDE_NOTES_KEY);
             // 預設不合併，包含筆記
             modalMergeDuplicatesCheckbox.checked = savedMerge === 'true'; // 如果存的是 'true' 則勾選
             modalIncludeNotesCheckbox.checked = savedNotes !== 'false'; // 預設勾選，除非存的是 'false'
        }
        /**
         * 將當前匯出選項彈窗的狀態保存到 LocalStorage
         */
        function saveExportModalOptions() {
             if (!modalMergeDuplicatesCheckbox || !modalIncludeNotesCheckbox) return;
             localStorage.setItem(LS_MODAL_MERGE_DUP_KEY, modalMergeDuplicatesCheckbox.checked);
             localStorage.setItem(LS_MODAL_INCLUDE_NOTES_KEY, modalIncludeNotesCheckbox.checked);
        }

        // ========================================================================
        // === FAB 報告列表過濾器處理 ===
        // ========================================================================
        /**
         * 處理 FAB 過濾菜單項目的點擊事件
         * @param {Event} event 點擊事件對象
         */
        function handleFabReportFilterClick(event) {
            event.preventDefault(); // 阻止連結默認行為
            const selectedValue = event.target.dataset.value; // 獲取點擊項目的值
            if (selectedValue && reportFilterSelect) {
                reportFilterSelect.value = selectedValue; // 更新主過濾器下拉選單的值
                handleReportListFilterChange(); // 觸發主過濾器變更處理函式
            }
            // 關閉 FAB 下拉菜單
            const dropdownInstance = bootstrap.Dropdown.getInstance(fabFilterToggle);
            if (dropdownInstance) dropdownInstance.hide();
        }

        // ========================================================================
        // === 主要事件處理函式 ===
        // ========================================================================
        /**
         * 處理報告選擇彈窗中報告行的點擊事件 (排除完成 Checkbox)
         * @param {Event} event 點擊事件對象
         */
        function handleModalReportClick(event) {
             // 忽略對 "判讀完成" Checkbox 單元格的點擊
             const targetCell = event.target.closest('td');
             if (targetCell && targetCell.classList.contains('col-completed')) return;

             // 找到被點擊的報告行 (tr 元素)
             const targetRow = event.target.closest('tr[data-filename]');
             if (targetRow && reportSelectModal) {
                 const filename = targetRow.dataset.filename; // 獲取檔名
                 // 如果報告行已被禁用 (不符合篩選條件)，則不處理
                 if (targetRow.classList.contains('report-row-disabled')) {
                     console.log(`Clicked on filtered-out report: ${filename}`);
                     return;
                 }
                 selectReport(filename); // 選擇該報告
                 reportSelectModal.hide(); // 關閉彈窗
             }
        }

        /**
         * 處理問題卡片內的 Change 事件 (狀態下拉選單、截圖 Checkbox)
         * @param {Event} event Change 事件對象
         */
        function handleIssueCardChange(event) {
            const target = event.target; // 觸發事件的元素 (select 或 input)
            // console.log("handleIssueCardChange - Target:", target);
            // console.log("handleIssueCardChange - Target Dataset:", target.dataset);

            // --- 查找包含群組成員數據的父元素 ---
            // 優先查找外層的群組容器
            const groupContainer = target.closest('.issue-group-container');
            // 如果不在群組容器內，查找單獨的問題卡片 (但要排除群組內的卡片)
            const singleIssueCard = !groupContainer ? target.closest('.issue-card') : null;

            let targetElement = groupContainer || singleIssueCard; // 包含數據的目標元素
            let membersJson = null;

            if (targetElement) {
                membersJson = targetElement.dataset.groupMembers; // 嘗試讀取 data-group-members
                // console.log("handleIssueCardChange - Found groupMembers from:", targetElement, membersJson);
            } else {
                 // 理論上不應發生，因為事件目標總應在 card 或 group 內
                 console.error("Could not find parent card or group container for event target:", target);
                 return; // 無法繼續
            }

            if (!membersJson) {
                // **這是之前錯誤的核心** - 如果在外層容器上找不到 membersJson
                // 這個警告表示 generateIssueCardHTML 或 renderIssueList 可能沒有正確添加 data-group-members 屬性
                console.warn("Could not find membersJson from targetElement:", targetElement);
                // 嘗試從觸發事件的元素自身讀取 (作為備用，但可能只包含單個成員)
                // membersJson = target.dataset.groupMembers; // 這個屬性通常不在 select/input 上
                // return; // 直接返回，因為缺少必要的群組信息
            }


            // 直接從觸發事件的元素讀取 issueId 和 reportFilename (這些應始終存在)
            let issueId = target.dataset.issueId;
            let reportFilename = target.dataset.reportFilename;
            // console.log("handleIssueCardChange - Direct Read - Issue ID:", issueId, "Report:", reportFilename);

            // --- 根據觸發的元素類型，調用相應的處理函式 ---
            if (target.classList.contains('screenshot-completion-checkbox')) { // 截圖完成 Checkbox
                 if(issueId && reportFilename && membersJson) {
                     handleScreenshotCompletionChange(target, issueId, reportFilename, membersJson);
                 } else {
                     // 如果缺少任何必要數據，記錄錯誤
                     console.error("Missing data for screenshot completion change.", {issueId, reportFilename, membersJson});
                 }
            } else if (target.classList.contains('status-select')) { // 狀態下拉選單
                 if(issueId && reportFilename && membersJson) {
                     handleStatusUpdate(target, issueId, reportFilename, membersJson);
                 } else {
                     // 如果缺少任何必要數據，記錄錯誤
                     console.error("Missing data for status update.", {issueId, reportFilename, membersJson});
                 }
            } else if (target.classList.contains('screenshot-file-input')) { // 截圖檔案選擇 input (雖然是 change，但單獨處理)
                 handleScreenshotFileInputChange(target);
            }
        }

        /**
         * 處理問題卡片內的 Click 事件 (主要用於按鈕)
         * @param {Event} event Click 事件對象
         */
        function handleIssueCardClick(event) {
            const target = event.target; // 被點擊的元素
            const button = target.closest('button'); // 找到最近的按鈕父元素
            if (!button) return; // 如果點擊的不是按鈕或按鈕內的元素，則忽略

            // 找到按鈕所在的卡片或群組容器
            const issueCardOrGroup = button.closest('.issue-card, .issue-group-container');
            if (!issueCardOrGroup) return; // 如果找不到卡片/群組，忽略

            // --- 根據按鈕的 class 判斷功能 ---
            if (button.classList.contains('upload-screenshot-btn')) { // 上傳按鈕
                handleUploadButtonClick(button);
            } else if (button.classList.contains('paste-screenshot-btn')) { // 貼上按鈕
                handlePasteButtonClick(button);
            } else if (button.classList.contains('delete-screenshot-btn')) { // 刪除截圖按鈕
                 const filename = button.dataset.filename; // 從按鈕獲取檔名
                 // 嘗試從截圖區域找到相關的上傳按鈕來獲取 issueId (作為備用)
                 const uploadBtn = button.closest('.screenshot-section')?.querySelector('.upload-screenshot-btn');
                 const issueId = uploadBtn?.dataset.issueId;
                 if (filename && issueId) {
                     handleDeleteButtonClick(button, filename, issueId);
                 } else {
                     console.error("Could not find filename or issueId for delete button:", button);
                 }
            } else if (button.classList.contains('save-note-btn')) { // 儲存筆記按鈕
                handleSaveNote(button);
            } else if (button.classList.contains('verify-vulnerability-btn')) { // Selenium 驗證按鈕
                handleVerifyVulnerabilityClick(button);
            }
        }

        /**
         * 處理報告選擇彈窗內的 "判讀完成" Checkbox 變更事件
         * @param {HTMLInputElement} checkboxElement 被變更的 Checkbox 元素
         */
        function handleReportModalChange(event) {
            if (event.target?.classList.contains('report-completion-checkbox')) {
                handleReportCompletionChange(event.target);
            }
        }

        /**
         * 處理報告列表主過濾器 (下拉選單) 的變更事件
         */
        function handleReportListFilterChange() {
            if (!reportFilterSelect) return;
            const newReportFilter = reportFilterSelect.value || DEFAULT_REPORT_FILTER;
            console.log(`Report list filter changed to: ${newReportFilter}`);
            localStorage.setItem(LS_REPORT_FILTER_KEY, newReportFilter); // 保存設定

            // 如果當前已選擇報告，重設選擇狀態並提示用戶重新選擇
            if (currentReportFilename) {
                 resetReportSelection(); // 重設界面
                 if (reportListErrorDiv) { // 顯示提示訊息
                     reportListErrorDiv.textContent = '報告列表篩選條件已變更。請從下方更新後的列表中重新選擇報告。';
                     reportListErrorDiv.style.display = 'block';
                 }
                 if(displayContainer) displayContainer.style.display = 'none'; // 隱藏報告內容區
            }
            toggleAbnormalExportButtonVisibility(); // 更新匯出異常按鈕可見性
            fetchReportList(); // 重新獲取報告列表
        }

        /**
         * 處理問題列表排序方式下拉選單的變更事件
         */
        function handleSortChange() {
            if(sortSelect) localStorage.setItem(LS_SORT_KEY, sortSelect.value); // 保存設定
            if (currentReportFullData?.issues) { // 如果有問題數據，重新渲染列表
                renderIssueList(currentReportFullData.issues);
            }
        }

        // ========================================================================
        // === 狀態與截圖完成標記更新邏輯 (調用後端批次 API) ===
        // ========================================================================
        /**
         * 處理狀態下拉選單變更，發送批次更新請求
         * @param {HTMLSelectElement} selectElement 觸發事件的 select 元素
         * @param {string} issueId 觸發事件的問題 ID
         * @param {string} reportFilename 報告檔名
         * @param {string} membersJson 包含群組所有成員 ({issueId, reportFilename}) 的 JSON 字串
         */
        async function handleStatusUpdate(selectElement, issueId, reportFilename, membersJson) {
            const newStatus = selectElement.value; // 獲取新的狀態值
            // 找到包含此 select 的卡片或群組容器 (用於 UI 更新)
            const groupContainer = selectElement.closest('.issue-group-container');
            const issueCard = selectElement.closest('.issue-card');
            const targetElementForUI = groupContainer || issueCard;
            if (!targetElementForUI) { console.error("Could not find parent card or group for status update UI."); return; }

            // 再次驗證必要數據是否存在
            if (!issueId || !reportFilename || !membersJson) { console.error("Missing data for status update (params or groupMembers).", {issueId, reportFilename, membersJson}); return; }

            // 解析群組成員 JSON
            let membersToUpdate;
            try {
                membersToUpdate = JSON.parse(membersJson);
                if (!Array.isArray(membersToUpdate) || membersToUpdate.length === 0) throw new Error("Invalid members data.");
            } catch (e) {
                alert("狀態更新失敗：無法讀取相關弱點資訊。"); return;
            }

            // 獲取 UI 元素用於顯示反饋
            const container = selectElement.closest('.status-container');
            const feedback = container?.querySelector('.status-update-feedback');
            const spinner = container?.querySelector('.status-update-spinner');

            // 記錄舊狀態以便失敗時恢復
            let oldStatuses = {};
            membersToUpdate.forEach(member => {
                const issue = currentReportFullData?.issues.find(i => i.id === member.issueId);
                if (issue) oldStatuses[member.issueId] = issue.status;
            });

            // --- 更新 UI: 顯示 Spinner，禁用相關下拉選單 ---
            if (feedback) { feedback.style.display = 'none'; feedback.textContent = ''; feedback.className = 'status-update-feedback ms-1'; }
            if (spinner) spinner.style.display = 'inline-block';
            targetElementForUI.querySelectorAll(`select.status-select`).forEach(sel => sel.disabled = true);

            // 構建請求數據
            const requestData = { updates: membersToUpdate, status: newStatus };
            console.log("Sending batch status update:", requestData);

            // --- 發送 API 請求 ---
            try {
                const response = await fetch(getApiUrl('api/batch_update_status'), { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(requestData) });
                const responseData = await response.json().catch(() => ({ error: `伺服器回應無效 (${response.status})` })); // 處理 JSON 解析失敗
                if (!response.ok) { throw new Error(responseData?.error || `伺服器錯誤 ${response.status}`); } // 拋出後端錯誤或通用錯誤

                // --- 更新成功: 更新前端數據和 UI ---
                let headerNeedsUpdate = false; // 標記是否需要更新報告頭部摘要
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    // 更新內存中的問題數據
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1) {
                        if (currentReportFullData.issues[idx].status !== newStatus) {
                            currentReportFullData.issues[idx].status = newStatus;
                            headerNeedsUpdate = true; // 標記需要更新摘要
                        }
                    }
                    // 更新頁面上所有相關的下拉選單值
                    document.querySelectorAll(`select.status-select[data-issue-id="${id}"]`).forEach(sel => sel.value = newStatus);
                });

                // 顯示成功反饋訊息
                if (feedback) {
                    const count = responseData?.updated_count ?? membersToUpdate.length;
                    feedback.textContent = count > 1 ? `✔ 群組已更新 (${count})` : '✔ 已更新';
                    feedback.classList.add('text-success');
                    feedback.style.display = 'inline';
                    // 短暫顯示後隱藏
                    setTimeout(() => { if (feedback?.classList.contains('text-success')) { feedback.style.display = 'none'; feedback.classList.remove('text-success'); } }, 2000);
                }
                // 如果狀態改變了，更新報告頭部的狀態摘要
                if (headerNeedsUpdate && currentReportFullData?.status_summary) {
                    displayReportHeaderInfo(currentReportFullData);
                }
            } catch (error) {
                // --- 更新失敗: 顯示錯誤訊息，恢復舊值 ---
                console.error("Batch status update failed:", error);
                if (feedback) {
                    feedback.textContent = `✘ 更新失敗`;
                    feedback.title = error.message; // 將詳細錯誤放在 title 屬性中
                    feedback.classList.add('text-danger');
                    feedback.style.display = 'inline';
                    // 較長時間顯示後隱藏
                    setTimeout(() => { if (feedback?.classList.contains('text-danger')) { feedback.style.display = 'none'; feedback.classList.remove('text-danger'); feedback.title='';} }, 6000);
                } else {
                    alert(`狀態更新失敗：\n${error.message}`); // 如果沒有反饋元素，彈窗提示
                }
                // 恢復下拉選單的值
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const oldStatus = oldStatuses[id];
                    if (oldStatus !== undefined) {
                        targetElementForUI.querySelectorAll(`select.status-select[data-issue-id="${id}"]`).forEach(sel => sel.value = oldStatus);
                    }
                });
            } finally {
                // --- 無論成功或失敗，最後恢復 UI ---
                if (spinner) spinner.style.display = 'none'; // 隱藏 Spinner
                // 重新啟用相關下拉選單
                targetElementForUI.querySelectorAll(`select.status-select`).forEach(sel => sel.disabled = false);
            }
        }

        /**
         * 處理截圖完成 Checkbox 變更，發送批次更新請求
         * @param {HTMLInputElement} checkboxElement 觸發事件的 Checkbox 元素
         * @param {string} issueId 觸發事件的問題 ID
         * @param {string} reportFilename 報告檔名
         * @param {string} membersJson 包含群組所有成員 ({issueId, reportFilename}) 的 JSON 字串
         */
        async function handleScreenshotCompletionChange(checkboxElement, issueId, reportFilename, membersJson) {
            const isChecked = checkboxElement.checked; // 獲取新的選中狀態
            // 找到父級卡片或群組容器
            const groupContainer = checkboxElement.closest('.issue-group-container');
            const issueCard = checkboxElement.closest('.issue-card');
            const targetElementForUI = groupContainer || issueCard;
            if (!targetElementForUI) { console.error("Could not find parent card/group for screenshot completion update UI."); return; }

            // 再次驗證必要數據
            if (!issueId || !reportFilename || !membersJson) { console.error("Missing data for screenshot completion update (params or groupMembers).", {issueId, reportFilename, membersJson}); checkboxElement.checked = !isChecked; return; } // 如果數據缺失，恢復原狀

            // 解析群組成員
            let membersToUpdate;
            try { membersToUpdate = JSON.parse(membersJson); if (!Array.isArray(membersToUpdate) || membersToUpdate.length === 0) throw new Error("Invalid members data."); } catch (e) { alert("截圖狀態更新失敗：無法讀取相關弱點資訊。"); checkboxElement.checked = !isChecked; return; }

            // 獲取 UI 反饋元素
            const container = checkboxElement.closest('.screenshot-line');
            const spinner = container?.querySelector('.spinner-border-sm');
            const errorSpan = container?.querySelector('.text-danger');

            // 記錄舊狀態以便恢復
            let oldFlags = {};
            membersToUpdate.forEach(member => {
                const issue = currentReportFullData?.issues.find(i => i.id === member.issueId);
                if (issue) oldFlags[member.issueId] = issue.screenshot_taken;
            });

            // --- 更新 UI: 顯示 Spinner，禁用相關 Checkbox ---
            if (spinner) spinner.style.display = 'inline-block';
            if (errorSpan) { errorSpan.style.display = 'none'; errorSpan.textContent = ''; }
            targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox`).forEach(cb => cb.disabled = true);

            // 構建請求數據
            const requestData = { updates: membersToUpdate, screenshot_taken: isChecked };
            console.log("Sending batch screenshot update:", requestData);

            // --- 發送 API 請求 ---
            try {
                const response = await fetch(getApiUrl('api/batch_update_status'), { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(requestData) });
                const responseData = await response.json().catch(() => ({ error: `伺服器回應無效 (${response.status})` }));
                if (!response.ok) { throw new Error(responseData?.error || `伺服器錯誤 ${response.status}`); }

                // --- 更新成功: 更新前端數據和 UI ---
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    // 更新內存數據
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1) { currentReportFullData.issues[idx].screenshot_taken = isChecked; }
                    // 更新頁面上所有相關 Checkbox
                    document.querySelectorAll(`input.screenshot-completion-checkbox[data-issue-id="${id}"]`).forEach(cb => cb.checked = isChecked);
                });
                 // (可以選擇在此處添加短暫的成功提示，但通常 Checkbox 狀態改變本身就是一種反饋)

            } catch (error) {
                // --- 更新失敗: 顯示錯誤訊息，恢復舊值 ---
                console.error("Batch screenshot update failed:", error);
                if (errorSpan) { // 顯示錯誤提示
                    errorSpan.textContent = `✘ 儲存失敗`;
                    errorSpan.style.display = 'inline';
                    setTimeout(() => { if (errorSpan) errorSpan.style.display = 'none'; }, 3000);
                } else {
                    alert(`截圖狀態更新失敗：\n${error.message}`);
                }
                // 恢復 Checkbox 狀態
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const oldFlag = oldFlags[id];
                    if (oldFlag !== undefined) {
                        targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox[data-issue-id="${id}"]`).forEach(cb => cb.checked = oldFlag);
                    }
                });
                // 同步恢復內存數據
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1 && oldFlags[id] !== undefined) {
                        currentReportFullData.issues[idx].screenshot_taken = oldFlags[id];
                    }
                });
            } finally {
                // --- 無論成功或失敗，最後恢復 UI ---
                if (spinner) spinner.style.display = 'none'; // 隱藏 Spinner
                // 重新啟用相關 Checkbox
                targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox`).forEach(cb => cb.disabled = false);
            }
        }

        // ========================================================================
        // === 報告判讀完成狀態處理 ===
        // ========================================================================
        /**
         * 處理報告選擇彈窗中 "判讀完成" Checkbox 的變更事件
         * @param {HTMLInputElement} checkboxElement 被變更的 Checkbox
         */
        function handleReportCompletionChange(checkboxElement) {
            const reportFilename = checkboxElement.dataset.reportFilename; // 獲取報告檔名
            const isChecked = checkboxElement.checked; // 獲取選中狀態
            const cell = checkboxElement.closest('td'); // 找到所在的單元格
            const spinner = cell?.querySelector('.spinner-report-completion'); // 找到 Spinner

            if (!reportFilename) { checkboxElement.checked = !isChecked; return; } // 防禦性檢查

            checkboxElement.disabled = true; // 禁用 Checkbox
            if (spinner) spinner.style.display = 'inline-block'; // 顯示 Spinner

            // 發送 API 請求更新後端狀態
            fetch(getApiUrl('api/report_completion_status'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reportFilename: reportFilename, isCompleted: isChecked })
            })
            .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.error || `Server error ${response.status}`); }))
            .then(data => {
                // 更新成功後，同步更新內存中的列表數據 (彈窗列表和主列表)
                const modalIdx = currentModalReportList.findIndex(r => r.filename === reportFilename);
                if (modalIdx > -1) currentModalReportList[modalIdx].review_completed = isChecked;
                const navIdx = currentReportList.findIndex(r => r.filename === reportFilename);
                if (navIdx > -1) currentReportList[navIdx].review_completed = isChecked;
                // (可以添加成功提示，但 Checkbox 狀態本身也是反饋)
            })
            .catch(error => {
                // 更新失敗，彈窗提示並恢復 Checkbox 狀態
                alert(`更新報告完成狀態失敗: ${error.message}`);
                if (checkboxElement?.closest('body')) { // 確保元素還在 DOM 中
                    checkboxElement.checked = !isChecked;
                }
            })
            .finally(() => {
                // 無論成功失敗，恢復 UI
                if (checkboxElement?.closest('body')) {
                    checkboxElement.disabled = false;
                    if (spinner) spinner.style.display = 'none';
                }
            });
        }

        // ========================================================================
        // === 筆記儲存邏輯 ===
        // ========================================================================
        /**
         * 處理儲存筆記按鈕的點擊事件
         * @param {HTMLButtonElement} button 被點擊的儲存按鈕
         */
        async function handleSaveNote(button) {
            const noteSection = button.closest('.note-section'); // 找到筆記區域容器
            if (!noteSection) return;
            // 找到相關的 UI 元素
            const textarea = noteSection.querySelector('textarea.issue-note-textarea');
            const feedbackSpan = noteSection.querySelector('.note-feedback');
            const spinner = noteSection.querySelector('.note-spinner');
            if (!textarea || !feedbackSpan || !spinner) return;

            // 獲取必要數據
            const issueId = textarea.dataset.issueId;
            const reportFilename = textarea.dataset.reportFilename;
            const newNote = textarea.value; // 獲取當前筆記內容
            if (!issueId || !reportFilename) {
                feedbackSpan.textContent = '✘ 內部錯誤';
                feedbackSpan.className = 'note-feedback text-danger';
                return;
            }

            // 更新 UI: 禁用按鈕，顯示 Spinner 和提示
            button.disabled = true;
            spinner.style.display = 'inline-block';
            feedbackSpan.textContent = '儲存中...';
            feedbackSpan.className = 'note-feedback text-muted';

            // 發送 API 請求
            try {
                const response = await fetch(getApiUrl('api/note'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ reportFilename, issueId, note: newNote })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `伺服器錯誤 ${response.status}`);

                // 更新成功: 顯示成功訊息，更新內存數據
                feedbackSpan.textContent = '✔ 已儲存';
                feedbackSpan.className = 'note-feedback text-success';
                // 同步更新內存中的筆記數據
                if (currentReportFullData?.issues) {
                    const idx = currentReportFullData.issues.findIndex(iss => iss.id === issueId);
                    if (idx > -1) currentReportFullData.issues[idx].note = newNote;
                }
                // 短暫顯示成功訊息後清除
                setTimeout(() => {
                    if (feedbackSpan?.classList.contains('text-success')) {
                        feedbackSpan.textContent = '';
                        feedbackSpan.className = 'note-feedback';
                    }
                }, 2500);
            } catch (error) {
                // 更新失敗: 顯示錯誤訊息
                feedbackSpan.textContent = `✘ 儲存失敗`;
                feedbackSpan.title = error.message;
                feedbackSpan.className = 'note-feedback text-danger';
                // 較長時間顯示後清除
                setTimeout(() => {
                    if (feedbackSpan?.classList.contains('text-danger')) {
                        feedbackSpan.textContent = '';
                        feedbackSpan.className = 'note-feedback';
                        feedbackSpan.title='';
                    }
                }, 6000);
            } finally {
                // 無論成功失敗，恢復 UI
                if (button?.closest('body')) button.disabled = false; // 檢查按鈕是否還在 DOM 中
                if (spinner) spinner.style.display = 'none';
            }
        }

        // ========================================================================
        // === 截圖上傳 / 貼上 / 刪除 相關邏輯 ===
        // ========================================================================
        /**
         * 處理 "上傳" 按鈕點擊，觸發隱藏的 file input
         * @param {HTMLButtonElement} button 被點擊的上傳按鈕
         */
        function handleUploadButtonClick(button) {
            const fileInputId = button.dataset.fileInputId; // 從按鈕獲取對應 input 的 ID
            const fileInput = document.getElementById(fileInputId);
            if (fileInput) {
                fileInput.click(); // 觸發 input 的點擊事件
            } else {
                alert("內部錯誤：無法找到上傳元件。");
            }
        }

        /**
         * 處理 "貼上" 按鈕點擊，嘗試從剪貼簿讀取圖片並觸發預覽
         * @param {HTMLButtonElement} button 被點擊的貼上按鈕
         */
        async function handlePasteButtonClick(button) {
            const issueId = button.dataset.issueId;
            const issueName = button.dataset.issueName;
            const controlsDiv = button.closest('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');

            // 檢查瀏覽器是否支援剪貼簿 API
            if (!feedbackSpan || !navigator.clipboard?.read) {
                alert('瀏覽器不支援剪貼簿讀取或找不到元件。');
                return;
            }

            setUploadFeedback(feedbackSpan, '讀取中...', false, 0); // 顯示讀取中
            button.disabled = true; // 禁用按鈕

            try {
                const items = await navigator.clipboard.read(); // 讀取剪貼簿內容
                let blob = null;
                // 遍歷剪貼簿項目，尋找第一個支援的圖片類型
                for (const item of items) {
                    const type = item.types.find(t => t.startsWith('image/') && ALLOWED_IMAGE_TYPES.includes(t));
                    if (type) {
                        blob = await item.getType(type); // 獲取圖片的 Blob 對象
                        break;
                    }
                }

                if (blob) { // 如果成功讀取到圖片 Blob
                    setUploadFeedback(feedbackSpan, '', false, 0); // 清除讀取中訊息
                    blobToUpload = blob; // 將 Blob 存到全局變數，待確認後上傳

                    // 準備上傳上下文信息
                    let issueUrl = 'N_A'; let entityName = 'N_A'; let isManual = false; let source = 'appscan';
                    const issue = currentReportFullData?.issues.find(i => i.id === issueId);
                    if (issue) {
                        source = issue.source || 'appscan';
                        isManual = (source === 'manual');
                        issueUrl = issue.url || 'N/A';
                        entityName = issue.entity_name || 'N/A';
                    }
                    uploadContext = { issueId, issueName, isManual, source, issueUrl, entityName };

                    // 創建 Blob URL 用於預覽
                    const url = URL.createObjectURL(blob);
                    previewImage.src = url; // 設置預覽圖片
                    previewImage.style.display = 'block';
                    previewError.style.display = 'none'; // 隱藏錯誤訊息

                    // 顯示預覽彈窗
                    if (previewModal) {
                        previewModal.show();
                    } else {
                        // 如果彈窗未初始化，直接釋放 URL 並清空狀態
                        URL.revokeObjectURL(url);
                        blobToUpload = null;
                        uploadContext = {};
                    }
                } else {
                    throw new Error('剪貼簿中未找到支援的圖片格式。'); // 未找到圖片
                }
            } catch (error) {
                setUploadFeedback(feedbackSpan, '', false, 0); // 清除讀取中訊息
                alert(`讀取剪貼簿失敗：${error.message}.`); // 提示錯誤
                blobToUpload = null; // 清空狀態
                uploadContext = {};
            } finally {
                if (button?.closest('body')) button.disabled = false; // 恢復按鈕狀態
            }
        }

        /**
         * 處理截圖預覽彈窗的 "確認上傳" 按鈕點擊事件
         */
        function handlePreviewConfirm() {
            if (!blobToUpload || !uploadContext.issueId) { // 檢查是否有待上傳的 Blob 和上下文
                if (previewModal) previewModal.hide(); // 沒有則直接關閉彈窗
                return;
            }

            // 從上下文中獲取必要信息
            const { issueId, issueName, isManual, source, issueUrl, entityName } = uploadContext;

            // 找到對應的 UI 元素以顯示反饋
            const issueElement = issueListContainer?.querySelector(`.issue-card[id*="issue-${issueId.replace(/[^a-zA-Z0-9-_]/g, '_')}"]`) ||
                               issueListContainer?.querySelector(`.issue-group-container[data-group-members*='"issueId":"${issueId}"']`); // 查找卡片或群組容器
            const controlsDiv = issueElement?.querySelector(`.screenshot-controls`);
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');
            const screenshotListDiv = issueElement?.querySelector('.uploaded-screenshots-list');

            if (!currentReportFilename || !feedbackSpan || !screenshotListDiv) {
                console.error("Missing elements for upload confirmation.");
                alert("上傳確認失敗：找不到必要的頁面元件。");
                if (previewModal) previewModal.hide();
                return;
            }

            // 確定檔案副檔名
            let ext = 'png'; // 預設 png
            const mime = blobToUpload.type;
            if (mime?.startsWith('image/')) {
                const pExt = mime.split('/')[1];
                const valid = ['png', 'jpg', 'jpeg', 'gif', 'bmp'];
                if (pExt && valid.includes(pExt.toLowerCase())) {
                    ext = pExt.toLowerCase() === 'jpeg' ? 'jpg' : pExt.toLowerCase(); // jpeg 統一用 jpg
                }
            }

            // 創建 FormData 對象準備上傳
            const formData = new FormData();
            formData.append('imageFile', blobToUpload, `pasted_image_${Date.now()}.${ext}`); // 添加 Blob 文件
            formData.append('reportFilename', currentReportFilename);
            formData.append('issueId', issueId);
            formData.append('issueName', issueName);
            formData.append('isManual', String(isManual));
            formData.append('source', source);
            formData.append('issueUrl', issueUrl);
            formData.append('entityName', entityName);

            if (previewModal) previewModal.hide(); // 關閉預覽彈窗
            uploadScreenshot(formData, feedbackSpan, screenshotListDiv); // 調用上傳函式

            // 清空全局變數
            blobToUpload = null;
            uploadContext = {};
        }

        /**
         * 處理文件選擇 input 的 change 事件
         * @param {HTMLInputElement} fileInput 觸發事件的 input 元素
         */
        function handleScreenshotFileInputChange(fileInput) {
            if (!fileInput.files || fileInput.files.length === 0) return; // 沒有選擇檔案

            const file = fileInput.files[0]; // 獲取第一個檔案
            const issueId = fileInput.dataset.issueId;
            const issueName = fileInput.dataset.issueName;
            // 找到相關 UI 元素
            const controlsDiv = fileInput.closest('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');
            const screenshotListDiv = fileInput.closest('.screenshot-section')?.querySelector('.uploaded-screenshots-list');

            // 驗證必要數據是否存在
            if (!currentReportFilename || !issueId || !issueName || !feedbackSpan || !screenshotListDiv) {
                if (feedbackSpan) setUploadFeedback(feedbackSpan, '✘ 內部錯誤', true, 4000);
                fileInput.value = ''; // 清空選擇
                return;
            }

            // 驗證檔案類型和副檔名
            const ext = file.name.split('.').pop()?.toLowerCase();
            const validExts = ['png', 'jpg', 'jpeg', 'gif', 'bmp'];
            if (!ALLOWED_IMAGE_TYPES.includes(file.type) || !ext || !validExts.includes(ext)) {
                setUploadFeedback(feedbackSpan, '✘ 檔案類型錯誤', true, 4000);
                fileInput.value = ''; // 清空選擇
                return;
            }

            // 創建 FormData
            const formData = new FormData();
            formData.append('imageFile', file);
            formData.append('reportFilename', currentReportFilename);
            formData.append('issueId', issueId);
            formData.append('issueName', issueName);

            // 添加額外上下文信息
            let issueUrl = 'N_A'; let entityName = 'N_A'; let isManual = false; let source = 'appscan';
            const issue = currentReportFullData?.issues.find(i => i.id === issueId);
            if (issue) {
                source = issue.source || 'appscan';
                isManual = (source === 'manual');
                issueUrl = issue.url || 'N/A';
                entityName = issue.entity_name || 'N/A';
            }
            formData.append('isManual', String(isManual));
            formData.append('source', source);
            formData.append('issueUrl', issueUrl);
            formData.append('entityName', entityName);

            uploadScreenshot(formData, feedbackSpan, screenshotListDiv); // 調用上傳函式
            fileInput.value = ''; // 清空文件選擇，以便可以再次選擇同一個文件
        }

        /**
         * 設置上傳反饋訊息
         * @param {HTMLElement} feedbackElement 顯示反饋的元素
         * @param {string} message 要顯示的訊息
         * @param {boolean} isError 是否為錯誤訊息
         * @param {number} clearAfter 多少毫秒後自動清除訊息 (0 表示不清除)
         */
        function setUploadFeedback(feedbackElement, message, isError = false, clearAfter = 3000) {
             if (!feedbackElement) return;
             feedbackElement.textContent = message; // 設置文字
             // 設置 class (成功/失敗)
             feedbackElement.className = `upload-feedback ms-1 ${isError ? 'text-danger' : 'text-success'}`;
             feedbackElement.style.display = message ? 'inline' : 'none'; // 根據是否有訊息決定顯示或隱藏

             // 清除之前的計時器
             const existingTimeoutId = feedbackElement.dataset.timeoutId;
             if (existingTimeoutId) clearTimeout(parseInt(existingTimeoutId));
             delete feedbackElement.dataset.timeoutId;

             // 如果需要自動清除，設置新的計時器
             if (clearAfter > 0 && message) {
                 const timeoutId = setTimeout(() => {
                     // 在計時器觸發時，再次檢查元素是否存在
                     if (feedbackElement?.closest('body')) {
                         feedbackElement.textContent = '';
                         feedbackElement.style.display = 'none';
                         delete feedbackElement.dataset.timeoutId;
                     }
                 }, clearAfter);
                 feedbackElement.dataset.timeoutId = timeoutId; // 儲存計時器 ID
             }
        }

        /**
         * 實際執行截圖上傳的異步函式
         * @param {FormData} formData 包含文件和元數據的 FormData 對象
         * @param {HTMLElement} feedbackSpan 用於顯示反饋的 span 元素
         * @param {HTMLElement} screenshotListDiv 顯示已上傳截圖列表的 ul 元素
         */
        function uploadScreenshot(formData, feedbackSpan, screenshotListDiv) {
            // 獲取相關 UI 元素用於顯示狀態
            const controlsDiv = feedbackSpan.closest('.screenshot-controls');
            const spinner = controlsDiv?.querySelector('.spinner-border-sm');
            const uploadBtn = controlsDiv?.querySelector('.upload-screenshot-btn');
            const pasteBtn = controlsDiv?.querySelector('.paste-screenshot-btn');

            // 更新 UI: 顯示 Spinner，禁用按鈕
            if (spinner) spinner.style.display = 'inline-block';
            if (uploadBtn) uploadBtn.disabled = true;
            if (pasteBtn) pasteBtn.disabled = true;
            setUploadFeedback(feedbackSpan, '上傳中...', false, 0);

            // 發送 POST 請求到後端
            fetch(getApiUrl('api/upload_screenshot'), { method: 'POST', body: formData })
            .then(response => response.ok ? response.json() : response.json().catch(() => response.text().then(text => ({ error: `伺服器錯誤 ${response.status}: ${text || '未知錯誤'}` }))).then(errData => { throw new Error(errData.error || `伺服器錯誤 ${response.status}`); })) // 處理各種錯誤情況
            .then(data => {
                // 上傳成功
                setUploadFeedback(feedbackSpan, '✔ 上傳成功', false, 3000); // 顯示成功訊息
                if (data.filename && screenshotListDiv) { // 如果後端返回了檔名
                    addScreenshotToList(screenshotListDiv, data.filename); // 將新檔名添加到列表中
                    const issueId = formData.get('issueId'); // 從 FormData 獲取 issueId
                    // 同步更新內存中的截圖列表
                    if (currentReportFullData?.issues) {
                        const idx = currentReportFullData.issues.findIndex(iss => iss.id === issueId);
                        if (idx > -1) {
                            if (!currentReportFullData.issues[idx].screenshots) currentReportFullData.issues[idx].screenshots = []; // 初始化數組
                            if (!currentReportFullData.issues[idx].screenshots.includes(data.filename)) { // 避免重複添加
                                currentReportFullData.issues[idx].screenshots.push(data.filename);
                                currentReportFullData.issues[idx].screenshots.sort(naturalSort); // 保持排序
                            }
                        }
                    }
                } else if (!data.filename) {
                    // 如果成功但後端未返回檔名 (理論上不應發生)
                    setUploadFeedback(feedbackSpan, '⚠ 上傳完成但未收到檔名', true, 5000);
                }
            }).catch(error => {
                // 上傳失敗
                setUploadFeedback(feedbackSpan, `✘ 上傳失敗: ${error.message}`, true, 5000); // 顯示錯誤訊息
            })
            .finally(() => {
                // 無論成功失敗，恢復 UI 狀態
                try {
                    if (controlsDiv?.closest('body')) { // 檢查元素是否存在
                        if (spinner) spinner.style.display = 'none';
                        if (uploadBtn) uploadBtn.disabled = false;
                        if (pasteBtn) pasteBtn.disabled = false;
                    }
                } catch(e){} // 忽略可能的錯誤
            });
        }

        /**
         * 將新的截圖檔名添加到指定的列表元素中
         * @param {HTMLElement} listDiv ul 列表元素
         * @param {string} filename 新的檔名
         */
        function addScreenshotToList(listDiv, filename) {
            if (!listDiv || !filename) return;
            const fileUrl = getApiUrl(`screenshots/${encodeURIComponent(filename)}`); // 構造圖片 URL
            const noMsg = listDiv.querySelector('.no-screenshots-msg'); // 查找 "尚無截圖" 的提示
            if (noMsg) noMsg.remove(); // 如果存在則移除

            // 檢查是否已存在相同的連結，避免重複添加
            const existing = listDiv.querySelector(`a[href="${fileUrl}"]`);
            if (existing) return;

            // 創建新的列表項 li
            const li = document.createElement('li');
            li.innerHTML = `
                <a href="${fileUrl}" target="_blank" title="在新分頁開啟截圖">${escapeHtml(filename)} <i class="fas fa-external-link-alt fa-xs"></i></a>
                <button type="button" class="btn btn-outline-danger btn-xs delete-screenshot-btn" data-filename="${escapeHtml(filename)}" title="移至垃圾桶"><i class="fas fa-trash-alt"></i></button>
            `;
            listDiv.appendChild(li); // 添加到列表末尾

            // 重新排序列表項 (自然排序)
            const items = Array.from(listDiv.querySelectorAll('li:not(.no-screenshots-msg)'));
            items.sort((a, b) => naturalSort(a.querySelector('a')?.textContent.trim() || '', b.querySelector('a')?.textContent.trim() || ''));
            items.forEach(item => listDiv.appendChild(item)); // 將排序後的項重新插入
        }

        /**
         * 處理刪除截圖按鈕的點擊事件
         * @param {HTMLButtonElement} button 被點擊的刪除按鈕
         * @param {string} filename 要刪除的檔名
         * @param {string} issueId 相關的 issue ID
         */
        function handleDeleteButtonClick(button, filename, issueId) {
            const listItem = button.closest('li'); // 找到所在的列表項
            const listDiv = button.closest('.uploaded-screenshots-list'); // 找到列表容器
            // 找到反饋元素
            const controlsDiv = button.closest('.screenshot-section')?.querySelector('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');
            if (!filename || !listItem || !listDiv) {
                if(feedbackSpan) setUploadFeedback(feedbackSpan, '✘ 刪除錯誤(內部)', true, 4000);
                return;
            }

            // 彈出確認對話框
            if (confirm(`確定要將截圖檔案 "${filename}" 移至垃圾桶嗎？\n(可在伺服器 data 資料夾內找回)`)) {
                 // 更新 UI: 禁用按鈕，顯示 Spinner
                 button.disabled = true;
                 button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; // 顯示小 Spinner
                 if (feedbackSpan) setUploadFeedback(feedbackSpan, '移動中...', false, 0);

                 // 調用後端刪除 API
                 deleteScreenshot(filename)
                 .then(result => {
                      // 刪除成功: 從列表中移除該項
                      listItem.remove();
                      // 如果列表空了，顯示 "尚無截圖" 提示
                      if (listDiv.querySelectorAll('li:not(.no-screenshots-msg)').length === 0) {
                          const m = document.createElement('li');
                          m.className = 'no-screenshots-msg text-muted';
                          m.innerHTML = '<em>尚無截圖</em>';
                          listDiv.appendChild(m);
                      }
                      // 顯示成功反饋
                      if (feedbackSpan) setUploadFeedback(feedbackSpan, '✔ 已移至垃圾桶', false, 2000);
                      // 同步更新內存數據
                      if (currentReportFullData?.issues && issueId) {
                          const idx = currentReportFullData.issues.findIndex(i => i.id === issueId);
                          if (idx > -1 && currentReportFullData.issues[idx].screenshots) {
                              // 從數組中過濾掉被刪除的檔名
                              currentReportFullData.issues[idx].screenshots = currentReportFullData.issues[idx].screenshots.filter(f => f !== filename);
                          }
                      }
                 }).catch(error => {
                      // 刪除失敗: 顯示錯誤訊息，恢復按鈕狀態
                      if (feedbackSpan) setUploadFeedback(feedbackSpan, `✘ 操作失敗: ${error.message}`, true, 5000);
                      if (button?.closest('body')) { // 檢查按鈕是否存在
                          button.disabled = false;
                          button.innerHTML = '<i class="fas fa-trash-alt"></i>'; // 恢復圖示
                      }
                 });
            }
        }

        /**
         * 調用後端 API 將截圖移至垃圾桶
         * @param {string} filename 要刪除的檔名
         * @returns {Promise<object>} 後端返回的 JSON 對象
         */
        async function deleteScreenshot(filename) {
            const response = await fetch(getApiUrl('api/delete_screenshot'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            });
            if (!response.ok) {
                const errData = await response.json().catch(() => ({ error: `伺服器錯誤 ${response.status}` }));
                throw new Error(errData.error || `伺服器錯誤 ${response.status}`);
            }
            return await response.json();
        }

        /**
         * 自然排序函式 (處理檔名中的數字)
         * @param {string} a 字串 a
         * @param {string} b 字串 b
         * @returns {number} 排序結果
         */
        function naturalSort(a, b) {
            const re = /(\d+)/g; // 匹配數字的正則
            const ax = a.split(re); // 按數字分割字串 a
            const bx = b.split(re); // 按數字分割字串 b
            // 逐段比較
            for (let i = 0; i < Math.min(ax.length, bx.length); i++) {
                const an = parseInt(ax[i], 10); // 嘗試將段落轉為數字
                const bn = parseInt(bx[i], 10);
                if (!isNaN(an) && !isNaN(bn)) { // 如果兩段都是數字
                    if (an !== bn) return an - bn; // 按數字大小比較
                } else if (ax[i] !== bx[i]) { // 如果是字串
                    return ax[i].localeCompare(bx[i]); // 按字典序比較
                }
            }
            return ax.length - bx.length; // 如果前面都相同，較短的排前面
        }

        // ========================================================================
        // === 打開 .scan 檔案邏輯 ===
        // ========================================================================
        /**
         * 處理打開 .scan 檔案按鈕的點擊事件
         */
        function handleOpenScanFile() {
            if (!currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔")) {
                alert("無法開啟遺失報告的 .scan 檔案。");
                return;
            }
            // 禁用按鈕並顯示載入狀態
            if (openScanFileButton) openScanFileButton.disabled = true;
            if (fabOpenScanFile) fabOpenScanFile.disabled = true;
            const originalText = openScanFileButton ? openScanFileButton.innerHTML : '';
            const fabOriginalIcon = fabOpenScanFile ? fabOpenScanFile.innerHTML : '';
            if (openScanFileButton) openScanFileButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 開啟中...`;
            if (fabOpenScanFile) fabOpenScanFile.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

            // 發送 API 請求
            fetch(getApiUrl('api/open_scan_file'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reportFilename: currentReportFilename })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data }))) // 解析 JSON 並保留響應狀態
            .then(({ ok, data }) => {
                if (!ok) throw new Error(data.error || '伺服器錯誤'); // 處理錯誤
                console.log(data.message); // 輸出成功訊息
            })
            .catch(error => {
                alert(`無法開啟 .scan 檔案: ${error.message}`); // 提示錯誤
            })
            .finally(() => {
                // 無論成功失敗，恢復按鈕狀態
                try {
                    if (openScanFileButton?.closest('body')) {
                        openScanFileButton.disabled = !currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔");
                        openScanFileButton.innerHTML = originalText;
                    }
                } catch(e) {};
                try {
                    if (fabOpenScanFile?.closest('body')) {
                        fabOpenScanFile.disabled = !currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔");
                        fabOpenScanFile.innerHTML = fabOriginalIcon;
                    }
                } catch(e) {}
            });
        }

        // ========================================================================
        // === 匯出處理邏輯 ===
        // ========================================================================
        /**
         * 處理主匯出按鈕點擊，顯示選項彈窗
         * @param {Event} event 點擊事件
         */
        function handleExportButtonClick(event) {
            event.preventDefault(); // 阻止可能的默認行為
            if (exportOptionsModal) {
                loadExportModalOptions(); // 載入上次的選項
                exportOptionsModal.show(); // 顯示彈窗
            } else {
                // 如果彈窗未初始化 (理論上不應發生)
                console.error("Export options modal not initialized!");
                alert("匯出選項視窗錯誤，將使用預設選項匯出。");
                window.location.href = BASE_CONFIRMED_EXPORT_URL; // 直接使用基礎 URL 匯出
            }
        }

        /**
         * 處理匯出選項彈窗的確認按鈕點擊
         */
         function handleConfirmExport() {
            saveExportModalOptions(); // 保存當前選項到 LocalStorage
            const mergeChecked = modalMergeDuplicatesCheckbox.checked; // 獲取是否合併重複項
            const notesChecked = modalIncludeNotesCheckbox.checked; // 獲取是否包含筆記

            // 構造最終的下載 URL，包含選項作為查詢參數
            let url = new URL(BASE_CONFIRMED_EXPORT_URL, window.location.origin); // 使用基礎 URL
            const params = url.searchParams; // 獲取 URL 查詢參數對象
            if (mergeChecked) {
                params.set('merge_duplicates', 'true'); // 添加合併參數
            } else {
                params.delete('merge_duplicates'); // 移除合併參數 (如果未選中)
            }
            if (notesChecked) {
                params.set('include_notes', 'true'); // 添加包含筆記參數
            } else {
                params.delete('include_notes'); // 移除包含筆記參數 (如果未選中)
            }
            const downloadUrl = url.pathname + url.search; // 組合最終 URL

            console.log("Triggering confirmed export with URL:", downloadUrl);
            window.location.href = downloadUrl; // 透過設置 location.href 觸發瀏覽器下載

            if (exportOptionsModal) exportOptionsModal.hide(); // 關閉選項彈窗
        }

        /**
         * 處理匯出所有筆記按鈕點擊 (直接觸發下載)
         * @param {Event} event 點擊事件
         */
        function handleExportAllNotesClick(event) {
            // 這裡是點擊事件處理，下載由 <a> 標籤的 download 屬性觸發
            console.log("All notes export clicked. Href:", exportAllNotesButton.href);
            // 可以選擇在此處添加一些 UI 反饋，例如短暫的提示
        }

        /**
         * 處理匯出異常報告按鈕點擊 (直接觸發下載)
         */
        function handleExportAbnormalClick() {
            // 這裡是點擊事件處理，下載由 <a> 標籤的 download 屬性觸發
            console.log("Abnormal report export clicked. Href:", exportAbnormalButton.href);
            // 可以選擇在此處添加一些 UI 反饋
        }

        // ========================================================================
        // === Selenium 驗證邏輯 ===
        // ========================================================================
        /**
         * 處理 "驗證" 按鈕點擊，調用後端 Selenium API
         * @param {HTMLButtonElement} button 被點擊的驗證按鈕
         */
        async function handleVerifyVulnerabilityClick(button) {
            // 從按鈕的 data-* 屬性獲取必要信息
            const issueUrl = button.dataset.issueUrl;
            const entityName = button.dataset.entityName;
            const entityType = button.dataset.entityType;
            const reasoning = button.dataset.reasoning;
            const componentName = button.dataset.componentName;
            const componentVersion = button.dataset.componentVersion;

            // 檢查是否有有效的 URL
            if (!issueUrl || issueUrl === 'N/A') {
                alert("無法驗證：缺少有效的頁面 URL。");
                return;
            }

            // 更新 UI: 禁用按鈕並顯示載入狀態
            button.disabled = true;
            const originalIcon = button.innerHTML; // 保存原始按鈕內容
            button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 驗證中...`;

            try {
                // 發送 API 請求到後端
                const response = await fetch(getApiUrl('api/verify_vulnerability'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({
                        issueUrl: issueUrl,
                        entityName: entityName,
                        entityType: entityType,
                        reasoning: reasoning,
                        componentName: componentName,
                        componentVersion: componentVersion
                    })
                });
                const data = await response.json(); // 解析 JSON 回應
                if (!response.ok) { // 檢查 HTTP 狀態碼
                    throw new Error(data.error || `伺服器錯誤 ${response.status}`);
                }
                // 顯示後端返回的訊息 (例如 "已找到..." 或 "無法定位...")
                alert(data.message || "已嘗試開啟瀏覽器進行驗證。");
                console.log("Verification result:", data);
            } catch (error) {
                // 處理錯誤
                console.error("Verification failed:", error);
                alert(`驗證請求失敗：\n${error.message}`);
            } finally {
                // 無論成功或失敗，恢復按鈕狀態 (檢查按鈕是否還在 DOM 中)
                if (document.body.contains(button)) {
                    button.disabled = false;
                    button.innerHTML = originalIcon; // 恢復原始內容
                }
            }
        }

        // ========================================================================
        // === 新增自訂弱點邏輯 ===
        // ========================================================================
        /**
         * 填充弱點名稱 datalist (用於輸入建議)
         */
        function populateWeaknessDatalist() {
            if (weaknessDatalist && Array.isArray(WEAKNESS_NAME_LIST)) {
                let optionsHtml = '';
                // 為每個預定義弱點名稱創建一個 option 元素
                WEAKNESS_NAME_LIST.forEach(name => {
                    optionsHtml += `<option value="${escapeHtml(name)}"></option>`;
                });
                weaknessDatalist.innerHTML = optionsHtml; // 設置 datalist 的內容
            }
        }

        /**
         * 處理 "手動新增弱點" 按鈕點擊事件，顯示新增彈窗
         */
        function handleAddVulnerabilityClick() {
            if (!currentReportFilename) { // 必須先選擇一個報告
                alert("請先選擇一個報告檔案，才能新增自訂弱點。");
                return;
            }
            if (addVulnerabilityModal) {
                // 將當前報告檔名存儲在彈窗元素上，以便提交時使用
                addVulnerabilityModalElement.dataset.reportFilename = currentReportFilename;
                addVulnerabilityForm.reset(); // 重設表單內容
                document.getElementById('addVulnSeverity').value = 'medium'; // 預設嚴重性為中
                 // 清空之前的反饋訊息和驗證狀態
                 addVulnFeedback.style.display = 'none';
                 addVulnFeedback.textContent = '';
                 addVulnFeedback.classList.remove('alert-danger','alert-success');
                 addVulnerabilityForm.classList.remove('was-validated');
                 const issueNameInput = document.getElementById('addVulnIssueName');
                 issueNameInput?.classList.remove('is-invalid'); // 移除可能的錯誤樣式

                 addVulnerabilityModal.show(); // 顯示彈窗
            } else {
                alert("新增弱點介面錯誤。");
            }
        }

        /**
         * 處理新增弱點彈窗的 "儲存新增" 按鈕點擊事件
         */
        async function handleSaveCustomVulnerability() {
            const reportFilename = addVulnerabilityModalElement.dataset.reportFilename; // 從彈窗獲取報告檔名
            if (!reportFilename) { // 防禦性檢查
                addVulnFeedback.textContent = '錯誤：缺少報告檔案資訊。';
                addVulnFeedback.style.display = 'block';
                addVulnFeedback.className = 'alert alert-danger small mt-2 py-2';
                return;
            }

            // 清空舊的反饋和驗證狀態
            addVulnFeedback.style.display = 'none';
            addVulnerabilityForm.classList.remove('was-validated'); // 移除 Bootstrap 驗證樣式

            // 進行簡單的前端驗證 (弱點名稱必填)
            const issueNameInput = document.getElementById('addVulnIssueName');
            if (!issueNameInput.value.trim()) {
                issueNameInput.classList.add('is-invalid'); // 添加 Bootstrap 錯誤樣式
                addVulnFeedback.textContent = '請填寫弱點名稱。';
                addVulnFeedback.style.display = 'block';
                addVulnFeedback.className = 'alert alert-danger small mt-2 py-2';
                return; // 驗證失敗，停止提交
            } else {
                issueNameInput.classList.remove('is-invalid'); // 移除錯誤樣式
            }

            // 從表單獲取數據
            const formData = new FormData(addVulnerabilityForm);
            const data = {
                reportFilename: reportFilename,
                issueName: formData.get('issueName'),
                severity: formData.get('severity'),
                url: formData.get('url') || 'N/A', // 如果為空，設為 'N/A'
                entityName: formData.get('entityName') || 'N/A', // 如果為空，設為 'N/A'
                note: formData.get('note')
            };

            // 更新 UI: 禁用按鈕並顯示載入狀態
            saveCustomVulnerabilityBtn.disabled = true;
            saveCustomVulnerabilityBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 儲存中...`;

            // 發送 API 請求到後端
            try {
                const response = await fetch(getApiUrl('api/add_custom_vulnerability'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) { // 檢查 HTTP 狀態碼
                    throw new Error(result.error || `伺服器錯誤 ${response.status}`);
                }

                // 新增成功
                console.log("Custom vulnerability added:", result);
                addVulnFeedback.textContent = ''; // 清空反饋
                addVulnerabilityModal.hide(); // 關閉彈窗

                // 重新載入當前報告數據以顯示新添加的弱點
                fetchReportData(currentReportFilename);

            } catch (error) {
                // 新增失敗
                console.error("Failed to add custom vulnerability:", error);
                // 顯示錯誤訊息
                addVulnFeedback.textContent = `新增失敗: ${error.message}`;
                addVulnFeedback.style.display = 'block';
                addVulnFeedback.className = 'alert alert-danger small mt-2 py-2';
            } finally {
                // 無論成功失敗，恢復按鈕狀態
                if (saveCustomVulnerabilityBtn.closest('body')) { // 檢查按鈕是否存在
                    saveCustomVulnerabilityBtn.disabled = false;
                    saveCustomVulnerabilityBtn.innerHTML = '儲存新增';
                }
            }
        }

        // ========================================================================
        // === 報告選擇與數據獲取 ===
        // ========================================================================
        /**
         * 選擇一個報告並觸發數據加載
         * @param {string} filename 被選擇的報告檔名
         */
        function selectReport(filename) {
            if (!filename) return;

            // 檢查是否試圖選擇一個已被過濾掉的報告 (來自彈窗)
            const modalRow = reportModalListBody?.querySelector(`tr[data-filename="${filename}"]`);
            if (modalRow && modalRow.classList.contains('report-row-disabled')) {
                console.warn(`Attempted to select filtered-out report: ${filename}`);
                return; // 不允許選擇
            }

            currentReportFilename = filename; // 更新全局狀態

            // 更新 UI: 顯示選定的檔名
            if(selectedReportDisplay) {
                selectedReportDisplay.textContent = filename;
                selectedReportDisplay.classList.add('has-selection'); // 添加選中樣式
            }

            // 判斷是否為遺失報告佔位符
            const isPlaceholder = filename.endsWith("-找不到掃描檔");

            // 更新按鈕狀態
            if(openScanFileButton) openScanFileButton.style.display = isPlaceholder ? 'none' : 'inline-block'; // 顯示/隱藏打開 .scan 按鈕
            if(addVulnerabilityBtn) addVulnerabilityBtn.disabled = false; // 啟用新增弱點按鈕
            if(fabOpenScanFile) fabOpenScanFile.style.display = isPlaceholder ? 'none' : 'flex'; // FAB 打開 .scan 按鈕

            // 查找當前報告在列表中的索引 (目前未使用於導航)
            currentReportIndex = currentReportList.findIndex(r => r.filename === filename && !r.is_missing);
            updateFabNavButtons(); // 更新 FAB 按鈕可見性

            fetchReportData(filename); // 獲取並顯示報告數據

            // 顯示報告內容區塊和過濾器
            if(filterSection) filterSection.style.display = 'block';
            if(displayContainer) displayContainer.style.display = 'block';
            if(reportListErrorDiv) { // 隱藏可能的列表錯誤訊息
                reportListErrorDiv.style.display = 'none';
                reportListErrorDiv.textContent = '';
            }
            updateFilterStatusDisplay(); // 更新過濾條件顯示

            // 短暫延遲後，平滑滾動到報告內容區域
            setTimeout(() => {
                if (displayContainer) {
                    displayContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        /**
         * 從後端獲取報告列表數據
         */
        function fetchReportList() {
             if (!reportFilterSelect || !reportModalListBody) return; // 確保必要元素存在
             const reportFilterValue = reportFilterSelect.value || DEFAULT_REPORT_FILTER; // 獲取當前報告過濾條件
             console.log(`Fetching report list: Filter=${reportFilterValue}`);

             // 更新彈窗 UI: 顯示載入中
             reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm"></div> 載入中...</td></tr>`;

             // 構造 API URL
             const apiUrl = getApiUrl(`api/reports?filter=${encodeURIComponent(reportFilterValue)}`);

             // 發送請求
             fetch(apiUrl)
                 .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.error || `Server error ${response.status}`); })) // 處理成功和失敗情況
                 .then(reportData => {
                     if (!Array.isArray(reportData)) throw new Error("報告列表格式無效。"); // 驗證數據格式
                     currentModalReportList = reportData; // 更新彈窗列表數據
                     populateReportModalList(currentModalReportList); // 填充彈窗列表
                     // 過濾掉遺失的報告，用於可能的導航 (雖然目前未實現導航)
                     currentReportList = reportData.filter(r => !r.is_missing);
                     // 更新當前報告在列表中的索引
                     currentReportIndex = currentReportList.findIndex(r => r.filename === currentReportFilename);
                     updateFabNavButtons(); // 更新 FAB 按鈕狀態
                     toggleAbnormalExportButtonVisibility(); // 更新匯出異常按鈕狀態
                 })
                 .catch(error => {
                     // 獲取失敗，顯示錯誤訊息
                     reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>無法載入報告列表: ${escapeHtml(error.message)}</td></tr>`;
                     if(reportListErrorDiv) { // 在主頁面也顯示錯誤
                         reportListErrorDiv.textContent = `無法載入報告列表: ${error.message}`;
                         reportListErrorDiv.style.display = 'block';
                     }
                     // 清空列表數據
                     currentReportList = [];
                     currentModalReportList = [];
                     currentReportIndex = -1;
                     updateFabNavButtons();
                     toggleAbnormalExportButtonVisibility();
                  });
         }

        /**
         * 比較兩個報告對象，用於排序報告列表
         * @param {object} a 報告對象 A
         * @param {object} b 報告對象 B
         * @param {string} filter 當前的報告篩選條件 ('errors_only', 'informational', etc.)
         * @returns {number} 排序結果 (-1, 0, 1)
         */
        function compareReports(a, b, filter) {
            // 處理可能的 null 或 undefined
            const aNum = a?.file_number ?? Infinity; // 編號，無編號排在後面
            const bNum = b?.file_number ?? Infinity;
            // 判斷是否為異常或遺失報告
            const aIsProblematic = a?.is_missing || problematicStatuses.includes(a?.status);
            const bIsProblematic = b?.is_missing || problematicStatuses.includes(b?.status);

            if (filter === 'errors_only') { // 只顯示錯誤模式
                // 優先顯示異常/遺失的
                if (aIsProblematic !== bIsProblematic) return aIsProblematic ? -1 : 1;
                return aNum - bNum; // 同為異常或同為正常，按編號排序
            } else if (filter === 'informational') { // 顯示所有模式
                return aNum - bNum; // 直接按編號排序
            } else { // 其他篩選模式 (例如 low, medium, high, critical)
                // 異常/遺失的報告排在後面
                if (aIsProblematic !== bIsProblematic) return aIsProblematic ? 1 : -1;
                return aNum - bNum; // 同為異常或同為正常，按編號排序
            }
        }

        /**
         * 根據當前報告列表篩選條件，決定是否顯示 "匯出異常報告" 按鈕
         */
        function toggleAbnormalExportButtonVisibility() {
            if (exportAbnormalButton && reportFilterSelect) {
                // 只有當篩選條件為 'errors_only' 時才顯示
                exportAbnormalButton.style.display = (reportFilterSelect.value === 'errors_only') ? 'inline-block' : 'none';
            }
        }

        /**
         * 將報告列表數據填充到選擇報告的彈窗表格中
         * @param {Array<object>} reports 報告數據數組
         */
        function populateReportModalList(reports) {
             if (!reportModalListBody) return; // 確保表格體存在
             reportModalListBody.innerHTML = ''; // 清空現有內容
             if (!Array.isArray(reports)) { console.error("populateReportModalList received non-array:", reports); reports = []; } // 防禦性檢查

             const reportFilterValue = reportFilterSelect.value || DEFAULT_REPORT_FILTER; // 獲取當前篩選條件
             reports.sort((a, b) => compareReports(a, b, reportFilterValue)); // 根據篩選條件排序

             if (reports && reports.length > 0) {
                 reports.forEach(report => {
                     const tr = document.createElement('tr'); // 創建表格行
                     tr.dataset.filename = report.filename; // 存儲檔名
                     if (report.file_number !== undefined && report.file_number !== null) tr.dataset.fileNumber = report.file_number; // 存儲檔案編號
                     tr.dataset.isMissing = report.is_missing ?? false; // 存儲是否遺失標記

                     // 判斷報告狀態
                     const isErrorOrMissing = report.is_missing || problematicStatuses.includes(report.status);
                     // 判斷是否因篩選條件而被禁用 (不是錯誤/遺失，且不滿足閾值，且不是顯示全部/只顯示錯誤模式)
                     const isDisabledDueToFilter = !report.meets_threshold && !isErrorOrMissing && !['informational', 'errors_only'].includes(reportFilterValue);

                     // 設置行樣式和提示文字
                     let rowClass = 'report-row-hover'; // 預設可懸停
                     let titleText = `點擊載入: ${escapeHtml(report.filename)}`;
                     if (report.is_missing) {
                         rowClass += ' missing-row'; // 遺失行樣式
                         titleText = `檔案遺失 (${escapeHtml(report.filename)})，點擊以新增手動弱點`;
                     } else if (isErrorOrMissing) {
                         titleText = `掃描異常 (${escapeHtml(report.status)})，點擊以新增手動弱點`;
                     } else if (isDisabledDueToFilter) {
                         rowClass = 'report-row-disabled'; // 禁用行樣式
                         titleText = '低於篩選條件，無法載入';
                     }

                     tr.className = rowClass;
                     tr.title = titleText; // 設置行的 title 提示

                     // 獲取狀態文字、Emoji 和 CSS Class
                     const statusText = report.status || SCAN_STATUS.UNKNOWN;
                     const statusEmoji = STATUS_EMOJI[statusText] || STATUS_EMOJI[SCAN_STATUS.UNKNOWN];
                     let statusClass = 'modal-status-unknown';
                     if (statusText === SCAN_STATUS.SUCCESS) statusClass = 'modal-status-success';
                     else if ([SCAN_STATUS.FAILED, SCAN_STATUS.PARSE_ERROR, SCAN_STATUS.READ_ERROR].includes(statusText)) statusClass = 'modal-status-error';
                     else if ([SCAN_STATUS.ABORTED, SCAN_STATUS.INCOMPLETE].includes(statusText)) statusClass = 'modal-status-warning';
                     else if (statusText === SCAN_STATUS.MISSING || statusText === SCAN_STATUS.FILE_NOT_FOUND) statusClass = 'modal-status-missing';

                     // 格式化掃描統計數據
                     let pagesStr = '-', entitiesStr = '-';
                     if (report.scan_stats && !report.is_missing) {
                         const ps = report.scan_stats.pages_scanned ?? '?';
                         const tp = report.scan_stats.total_pages ?? '?';
                         const et = report.scan_stats.entities_tested ?? '?';
                         const te = report.scan_stats.total_entities ?? '?';
                         pagesStr = `${ps}/${tp}`;
                         entitiesStr = `${et}/${te}`;
                     }

                     // 獲取各嚴重性計數
                     const sevCounts = { c: '-', h: '-', m: '-', l: '-', i: '-' };
                     if (report.severity_summary && !report.is_missing) {
                         sevCounts.c = report.severity_summary['critical'] ?? 0;
                         sevCounts.h = report.severity_summary['high'] ?? 0;
                         sevCounts.m = report.severity_summary['medium'] ?? 0;
                         sevCounts.l = report.severity_summary['low'] ?? 0;
                         sevCounts.i = report.severity_summary['informational'] ?? report.severity_summary['info'] ?? 0; // 兼容舊鍵名
                     }

                     // 生成 "判讀完成" Checkbox HTML
                     const completedChecked = report.review_completed ? 'checked' : '';
                     const checkboxDisabled = report.is_missing ? 'disabled' : ''; // 遺失報告禁用 Checkbox
                     const completedCell = `
                         <td class="col-completed">
                             <input class="form-check-input report-completion-checkbox" type="checkbox" value=""
                                    data-report-filename="${escapeHtml(report.filename)}" ${completedChecked} ${checkboxDisabled}
                                    title="${checkboxDisabled ? '無法標記遺失檔案' : '標記/取消標記判讀完成'}">
                             <span class="spinner-border spinner-border-sm spinner-report-completion"></span> <!-- 更新時的 Spinner -->
                         </td>`;

                     // 輔助函式，用於生成嚴重性計數的 CSS class
                     const sevCls = (s, k) => (parseInt(s[k]) > 0 ? `sev-count-${k}` : '');
                     // 檔名單元格的 title (用於禁用時提示)
                     const filenameCellTitle = isDisabledDueToFilter ? '低於篩選條件' : `點擊載入: ${escapeHtml(report.filename)}`;

                     // 填充表格行內容
                     tr.innerHTML = `
                         ${completedCell}
                         <td class="col-status ${statusClass}" title="${escapeHtml(statusText)}">${statusEmoji}</td>
                         <td class="col-filename filename-cell" title="${filenameCellTitle}">${escapeHtml(report.filename)}</td>
                         <td class="col-pages">${escapeHtml(pagesStr)}</td>
                         <td class="col-entities">${escapeHtml(entitiesStr)}</td>
                         <td class="col-sev-c ${sevCls(sevCounts, 'c')}">${escapeHtml(sevCounts.c)}</td>
                         <td class="col-sev-h ${sevCls(sevCounts, 'h')}">${escapeHtml(sevCounts.h)}</td>
                         <td class="col-sev-m ${sevCls(sevCounts, 'm')}">${escapeHtml(sevCounts.m)}</td>
                         <td class="col-sev-l ${sevCls(sevCounts, 'l')}">${escapeHtml(sevCounts.l)}</td>
                         <td class="col-sev-i ${sevCls(sevCounts, 'i')}">${escapeHtml(sevCounts.i)}</td>
                     `;
                     reportModalListBody.appendChild(tr); // 將行添加到表格體
                 });
             } else {
                  // 如果沒有報告符合條件
                  const filterText = reportFilterSelect?.options[reportFilterSelect.selectedIndex]?.text || `"${reportFilterSelect?.value}"`;
                  let msg = `未找到符合條件 "${escapeHtml(filterText)}" 的報告。`;
                  // 如果是選擇顯示全部但仍然沒有，說明資料夾是空的
                  if (reportFilterSelect?.value === 'informational') {
                      msg = '此專案報告資料夾中目前沒有任何 XML 報告檔案。';
                  }
                  reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">${msg}</td></tr>`;
             }
        }

        /**
         * 獲取並顯示指定報告的詳細數據
         * @param {string} filename 要獲取的報告檔名
         * @param {number | null} scrollYToRestore 可選，如果提供了滾動位置，則在渲染後嘗試恢復
         */
        function fetchReportData(filename, scrollYToRestore = null) {
            console.log(`Fetching data for report: ${filename}`);
            if (scrollYToRestore !== null) { console.log("fetchReportData - Will restore scroll to:", scrollYToRestore); }

            // --- 重設 UI ---
            if (severityChartInstance) { severityChartInstance.destroy(); severityChartInstance = null; } // 銷毀舊圖表
            if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = ''; // 清空報告頭部
            if(issueListContainer) issueListContainer.innerHTML = ''; // 清空問題列表
            groupedIssuesData = {}; // 清空分組數據
            if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none'; // 隱藏問題列表標頭
            if(displayContainer) displayContainer.style.display = 'block'; // 顯示報告內容區塊
            // 顯示載入中提示
            if(issueListContainer) issueListContainer.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div><p class="mt-2">載入中...</p></div>`;

            // --- 獲取當前過濾條件 ---
            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.value);
            // 只包含有效的來源過濾器
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked'))
                                  .map(cb => cb.value)
                                  .filter(val => val === 'appscan' || val === 'manual');

            // --- 構造帶有過濾參數的 API URL ---
            const params = new URLSearchParams();
            severities.forEach(s => params.append('severity', s));
            statuses.forEach(s => params.append('status_filter', s));
            screenshotStatuses.forEach(s => params.append('screenshot_status_filter', s));
            sources.forEach(s => params.append('source_filter', s));
            const url = getApiUrl(`report/${encodeURIComponent(filename)}?${params.toString()}`);
            console.log("Fetching Report Data URL:", url);

            // --- 發送請求 ---
            fetch(url)
            .then(response => {
                 // 處理 HTTP 錯誤
                 if (!response.ok) {
                     return response.json().catch(() => null).then(errData => { // 嘗試解析錯誤 JSON
                         throw new Error(errData?.error || `伺服器錯誤 ${response.status}: ${response.statusText}`);
                     });
                 }
                 return response.json(); // 解析成功的 JSON
             })
            .then(data => {
                 // 處理數據
                 if (!data || typeof data !== 'object') { // 驗證數據格式
                     throw new Error("報告數據格式無效或為空。");
                 }
                 console.log("Received report data:", data);
                 currentReportFullData = data; // 保存完整數據到全局變數

                 console.log("Calling displayReportHeaderInfo...");
                 displayReportHeaderInfo(currentReportFullData); // 渲染報告頭部
                 console.log("displayReportHeaderInfo finished.");

                 console.log("Calling renderIssueList...");
                 renderIssueList(data.issues || []); // 渲染問題列表
                 console.log("renderIssueList finished.");

                 // 顯示相關 UI 元素
                 if(filterSection) filterSection.style.display = 'block';
                 if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'flex';
                 updateFilterStatusDisplay(); // 更新過濾狀態顯示
                 console.log("Report data processed successfully.");

                 // 如果需要恢復滾動位置
                 if (scrollYToRestore !== null) {
                     console.log("Restoring scroll position to:", scrollYToRestore);
                     // 使用 requestAnimationFrame 確保在 DOM 更新後執行滾動
                     requestAnimationFrame(() => {
                         window.scrollTo({ top: scrollYToRestore, left: 0, behavior: 'instant' }); // 立即滾動，避免動畫延遲
                         console.log("Scroll position restore attempt finished.");
                     });
                 }
             })
            .catch(error => {
                 // 處理獲取或處理數據時的錯誤
                 console.error("Error fetching or processing report data:", error);
                 if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = ''; // 清空頭部
                 // 在問題列表區域顯示錯誤訊息
                 if(issueListContainer) {
                    issueListContainer.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-octagon-fill me-2" viewBox="0 0 16 16">
                                <path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </svg>
                            載入報告失敗: ${escapeHtml(error.message)}
                        </div>`;
                 }
                 // 隱藏相關 UI
                 if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none';
                 if(filterSection) filterSection.style.display = 'none';
                 if(filterStatusDiv) filterStatusDiv.style.display = 'none';
             });
         }

        // ========================================================================
        // === 渲染邏輯 (將數據轉換為 HTML) ===
        // ========================================================================
        /**
         * 渲染報告頭部信息 (掃描時間、摘要、圖表等)
         * @param {object} data 包含 scan_info, scan_stats, status_summary, summary 的報告數據
         */
        function displayReportHeaderInfo(data) {
            console.log("Inside displayReportHeaderInfo - Start");
            let headerHtml = '';
            disposeCollapses(); // 清理舊的 Collapse 實例
            // 銷毀舊的圖表實例
            if (severityChartInstance) {
                try { severityChartInstance.destroy(); } catch (e) { console.error("Error destroying existing chart:", e); }
                severityChartInstance = null;
            }

            try {
                // --- 渲染掃描基本資訊 ---
                if (data.scan_info) {
                    headerHtml += `<h2 class="text-center report-scan-name">${escapeHtml(data.scan_info.scan_name)}</h2>`; // 掃描名稱
                    headerHtml += `<div class="scan-meta-area">`; // 元數據區域開始
                    // 掃描時間
                    headerHtml += `<div class="scan-meta-block"><strong>掃描時間:</strong> <span class="value">${escapeHtml(data.scan_info.scan_date)}</span></div>`;
                    // 掃描統計
                    if (data.scan_stats && Object.keys(data.scan_stats).length > 0) {
                        const { pages_scanned: ps = '?', total_pages: tp = '?', entities_tested: et = '?', total_entities: te = '?', issues_found: ifs = '?' } = data.scan_stats;
                        headerHtml += `
                            <div class="scan-meta-block">
                                <strong>掃描統計:</strong>
                                <span class="value">頁面: <span class="badge bg-secondary">${escapeHtml(ps)}/${escapeHtml(tp)}</span></span>
                                <span class="value">實體: <span class="badge bg-secondary">${escapeHtml(et)}/${escapeHtml(te)}</span></span>
                                <span class="value">問題: <span class="badge bg-primary">${escapeHtml(ifs)}</span></span>
                            </div>`;
                    } else { // 無統計數據
                        headerHtml += `<div class="scan-meta-block"><strong>掃描統計:</strong> <span class="badge bg-light text-dark">N/A</span></div>`;
                    }
                    // --- 渲染狀態摘要 ---
                    let statusEntries = [];
                    const statusOrder = ['未審查', '人工審查中', '已確認弱點', '誤判', '已自動排除', '處理錯誤']; // 定義顯示順序
                    const statusCounts = data.status_summary || {}; // 獲取狀態計數
                    // 按預定順序生成徽章
                    statusOrder.forEach(statusKey => {
                        const count = statusCounts[statusKey] || 0;
                        const badgeClass = count > 0 ? `status-badge-${statusKey.replace(/\s+/g, '')}` : 'status-badge-zero'; // 根據計數選擇樣式
                        statusEntries.push(`<span class="badge ${badgeClass}" title="${escapeHtml(statusKey)}">${escapeHtml(statusKey)}: ${count}</span>`);
                    });
                    // 添加未在預定順序中但有計數的狀態 (理論上不應發生)
                    for (const k in statusCounts) {
                        if (!statusOrder.includes(k) && k !== '__unexpected__' && statusCounts[k] > 0) {
                            statusEntries.push(`<span class="badge status-badge-非預期">${escapeHtml(k)}: ${statusCounts[k]}</span>`);
                        }
                    };
                    // 添加非預期狀態計數
                    if (statusCounts['__unexpected__'] > 0) {
                        statusEntries.push(`<span class="badge status-badge-非預期">非預期: ${statusCounts['__unexpected__']}</span>`);
                    }
                    headerHtml += `<div class="scan-meta-block"><strong>狀態統計(已套用規則):</strong> <div class="status-summary-group">${statusEntries.join('')}</div></div>`; // 狀態摘要行
                    headerHtml += `</div>`; // 元數據區域結束
                } else { // 無掃描資訊
                    headerHtml += `<h2 class="text-center text-muted">掃描資訊 N/A</h2>`;
                }

                // --- 渲染嚴重性圖表 ---
                if (data.summary && Object.keys(data.summary).length > 0 && parseInt(data.summary.total_issues || '0') > 0) {
                    // 只有在有摘要數據且問題總數大於 0 時才顯示圖表區域
                    headerHtml += `<h4 class="text-center mt-3">問題摘要 (依嚴重性)</h4>`;
                    headerHtml += `<div id="severityChartContainer" style="position: relative; height:200px; width:80%; margin: 15px auto;"><canvas id="severityChartCanvas"></canvas></div>`;
                }
                headerHtml += `<hr/>`; // 分隔線

                // 更新報告頭部區域的 HTML
                if (reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = headerHtml; else console.error("reportHeaderInfoDiv not found!");

                // 如果需要渲染圖表，延遲執行 renderSeverityChart
                if (data.summary && Object.keys(data.summary).length > 0 && parseInt(data.summary.total_issues || '0') > 0) {
                    console.log("Scheduling chart rendering...");
                    setTimeout(() => { renderSeverityChart(data.summary); }, 0); // 使用 setTimeout 確保 DOM 更新完成
                } else {
                    // 如果不需要圖表，確保圖表容器是空的
                    const chartContainer = document.getElementById('severityChartContainer');
                    if (chartContainer) chartContainer.innerHTML = '';
                    console.log("No chart data.");
                }
            } catch (e) {
                // 處理渲染頭部時的錯誤
                console.error("Error inside displayReportHeaderInfo logic:", e);
                if (reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = `<div class="alert alert-danger">顯示報告標頭時出錯: ${escapeHtml(e.message)}</div>`;
            }
            console.log("Inside displayReportHeaderInfo - End");
        }

        /**
         * 使用 Chart.js 渲染嚴重性分佈圖表
         * @param {object} summaryData 包含各嚴重性計數的摘要數據
         */
        function renderSeverityChart(summaryData) {
             const canvasElement = document.getElementById('severityChartCanvas'); // 獲取 canvas 元素
             if (!canvasElement) {console.error("Canvas element not found for chart."); return; }
             const container = canvasElement.parentNode; // 獲取父容器
             if (!container || container.offsetParent === null) { // 如果容器不可見，則不渲染
                 console.warn("Chart container is not visible, skipping render.");
                 return;
             }
             const severityOrder = ['critical', 'high', 'medium', 'low', 'informational']; // 定義順序
             const backgroundColors = ['#8B0000', '#dc3545', '#fd7e14', '#ffc107', '#0dcaf0']; // 定義顏色
             // 獲取標籤 (顯示名稱)
             const labels = severityOrder.map(k => SEVERITY_OPTIONS[k.charAt(0).toUpperCase() + k.slice(1)] || k);
             // 獲取數據點 (計數)
             const dataPoints = severityOrder.map(k => {
                 const dataKey = k === 'informational' ? 'info' : k; // 兼容 'info' 鍵名
                 const count = parseInt(summaryData[dataKey] || summaryData[k] || '0', 10); // 轉換為整數
                 return isNaN(count) ? 0 : count;
             });
             // 銷毀舊的圖表實例 (如果存在)
             if (severityChartInstance) { try { severityChartInstance.destroy(); } catch(e) {} }
             try {
                 // 根據是否為深色模式設置顏色
                 const isDarkMode = document.body.classList.contains('dark-mode');
                 const tickColor = isDarkMode ? '#bdc1c6' : '#555'; // 刻度顏色
                 const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; // 網格線顏色

                 // 創建新的 Chart.js 實例
                 severityChartInstance = new Chart(canvasElement, {
                     type: 'bar', // 條形圖
                     data: {
                         labels: labels,
                         datasets: [{
                             label: '問題數量',
                             data: dataPoints,
                             backgroundColor: backgroundColors,
                             borderWidth: 1
                         }]
                     },
                     options: {
                         indexAxis: 'x', // 設置 x 軸為類別軸
                         responsive: true, // 響應式
                         maintainAspectRatio: false, // 不保持固定比例
                         scales: {
                             y: { // Y 軸 (計數)
                                 beginAtZero: true, // 從 0 開始
                                 ticks: { precision: 0, color: tickColor }, // 整數刻度，設置顏色
                                 grid: { color: gridColor } // 網格線顏色
                             },
                             x: { // X 軸 (嚴重性)
                                 ticks: {
                                     autoSkip: false, // 不自動跳過標籤
                                     maxRotation: 0, // 標籤不旋轉
                                     minRotation: 0,
                                     color: tickColor, // 標籤顏色
                                     // 自定義標籤格式，包含計數
                                     callback: function(v, i) {
                                         return `${this.getLabelForValue(v)}\n(${dataPoints[i] ?? '?'})`;
                                     }
                                 },
                                 grid: { display: false } // 不顯示 X 軸網格線
                             }
                         },
                         plugins: {
                             legend: { display: false }, // 不顯示圖例
                             tooltip: { // 提示框回調
                                 callbacks: {
                                     label: (ctx) => `${ctx.dataset.label || ''}: ${ctx.parsed.y ?? ''}`
                                 }
                             }
                         }
                     }
                 });
             } catch (e) {
                 // 渲染圖表時出錯
                 console.error("Error rendering chart:", e);
                 if (container) { // 在容器中顯示錯誤訊息
                     container.innerHTML = '<p class="text-danger small text-center">無法載入圖表。</p>';
                 }
             }
        }

        /**
         * 生成單個問題卡片或群組代表性卡片的 HTML
         * @param {object} issue 問題數據對象
         * @param {string} uniqueIndexSuffix 用於生成唯一 ID 的後綴
         * @param {boolean} isGroupRepresentative 是否為群組的代表性卡片
         * @param {string | null} groupKey 如果是群組的一部分，群組的鍵名
         * @param {string} groupMembersJson 包含群組成員信息的 JSON 字串
         * @returns {string} 生成的 HTML 字串
         */
        function generateIssueCardHTML(issue, uniqueIndexSuffix, isGroupRepresentative = false, groupKey = null, groupMembersJson = '[]') {
            if (!issue || !issue.id) return ''; // 無效輸入則返回空

            // --- 生成唯一的 HTML ID ---
            const severityKey = issue.severity_key || 'unknown'; // 獲取嚴重性鍵名
            const severityClass = `severity-${severityKey}`; // CSS class for border color
            const cardId = `issue-card-${uniqueIndexSuffix}`;
            const collapseId = `traffic-${uniqueIndexSuffix}`; // HTTP 流量摺疊區 ID
            const trafficCodeId = `traffic-code-${collapseId}`; // HTTP 流量代碼區 ID
            const screenshotCheckboxId = `screenshot-completion-check-${uniqueIndexSuffix}`; // 截圖完成 Checkbox ID
            const screenshotFileInputId = `screenshot-input-${uniqueIndexSuffix}`; // 截圖文件輸入 ID
            const screenshotListId = `screenshot-list-${uniqueIndexSuffix}`; // 截圖列表 ID
            const noteTextareaId = `note-textarea-${uniqueIndexSuffix}`; // 筆記輸入框 ID
            const noteFeedbackId = `note-feedback-${uniqueIndexSuffix}`; // 筆記反饋 ID
            const noteSpinnerId = `note-spinner-${uniqueIndexSuffix}`; // 筆記 Spinner ID
            const noteSaveBtnId = `note-save-btn-${uniqueIndexSuffix}`; // 筆記儲存按鈕 ID

            const isManual = issue.source === 'manual'; // 是否手動新增
            const isError = issue.source === 'error'; // 是否為錯誤條目
            // 組合卡片 CSS class
            const cardClasses = `issue-card ${severityClass} source-${issue.source || 'appscan'}`;

            // --- 添加 data-* 屬性用於 JS 操作 ---
            const representativeAttr = isGroupRepresentative ? `data-is-representative="true"` : ''; // 標記是否為代表卡片
            const groupKeyAttr = groupKey ? `data-group-key="${escapeHtml(groupKey)}"` : ''; // 存儲群組鍵
            const representativeIssueIdAttr = isGroupRepresentative ? `data-representative-issue-id="${escapeHtml(issue.id)}"` : ''; // 存儲代表性問題 ID
            // **關鍵:** 將群組成員信息添加到卡片上
            const groupMembersAttr = `data-group-members='${escapeHtml(groupMembersJson)}'`;

            // --- 提取和處理問題細節 ---
            const entityType = issue.entity_type || '';
            const entityName = issue.entity_name || '';
            const issueReasoning = issue.reasoning || '';
            // 判斷是否為組件或連結類型 (用於 Selenium 驗證)
            const isComponent = entityType.toLowerCase().includes('component');
            const isLink = entityType.toLowerCase().includes('link');
            let componentVersion = 'N/A'; // 初始化組件版本
            let componentName = 'N/A'; // 初始化組件名稱
            // 如果是組件且有實體名稱，嘗試解析版本號和名稱
            if (isComponent && entityName !== 'N/A') {
                componentName = entityName;
                const versionMatch = entityName.match(/([\d][\d\.a-zA-Z_-]+)/); // 匹配版本號的正則
                if (versionMatch) {
                    componentVersion = versionMatch[0];
                    let baseName = entityName.substring(0, versionMatch.index).trim(); // 提取版本號前的名稱
                    if (baseName.endsWith(' (')) baseName = baseName.substring(0, baseName.length - 2).trim(); // 清理可能的後綴
                    if(baseName) componentName = baseName; // 如果提取到名稱則更新
                } else { // 如果無法匹配版本號，嘗試清理 "(Component)" 後綴
                    componentName = entityName.replace(/\(Component\)$/i, '').trim();
                }
            }

            // --- 生成卡片標頭 HTML ---
            // 顯示 CVE 或 CVSS
            let detailsHtml = '';
            if (issue.cve_name) {
                detailsHtml = issue.cve_url ? `<a href="${escapeHtml(issue.cve_url)}" target="_blank">${escapeHtml(issue.cve_name)}</a>` : escapeHtml(issue.cve_name);
            } else if (issue.cvss_score && issue.cvss_score !== 'N/A') {
                detailsHtml = `CVSS: ${escapeHtml(issue.cvss_score)}`;
            }
            // 處理問題類型顯示 (特殊處理 TLS 問題，添加 SSLLabs 連結)
            const issueType = issue.issue_type || '';
            const issueUrl = issue.url || '';
            let issueTypeHtml = escapeHtml(issueType);
            const specificTlsIssueNames = ['支援較早的 TLS 版本', 'SSL/TLS Server Supports TLSv1.0', 'SSL/TLS Server Supports TLSv1.1'];
            if (specificTlsIssueNames.includes(issueType)) {
                const hostname = extractHostname(issueUrl); // 提取主機名
                if (hostname) {
                    const sslLabsUrl = `https://www.ssllabs.com/ssltest/analyze.html?d=${encodeURIComponent(hostname)}`; // 構造 SSLLabs URL
                    issueTypeHtml = `<a href="${sslLabsUrl}" target="_blank" class="issue-type-link">${escapeHtml(issueType)} <i class="fas fa-external-link-alt fa-xs"></i></a>`; // 添加連結
                }
            }
            // 添加來源標示 (手動/錯誤)
            const sourceIndicatorHtml = isManual ? '<span class="manual-indicator">手動</span>' : (isError ? '<span class="error-indicator">錯誤</span>' : '');
            // 組合標頭 HTML ('{#Num#}' 是一個佔位符，會在 renderIssueList 中替換為編號)
            const headerHtml = `
                <div class="issue-card-header">
                    {#Num#} <!-- 編號佔位符 -->
                    <span class="badge ${getSeverityBadgeColor(severityKey)} me-2">${escapeHtml(issue.severity_display)}</span> <!-- 嚴重性徽章 -->
                    <span class="issue-title-part">${issueTypeHtml} ${sourceIndicatorHtml}</span> <!-- 問題類型和來源標示 -->
                    <span class="details-part">${detailsHtml}</span> <!-- CVE/CVSS -->
                </div>`;

            // --- 生成狀態控制項 HTML ---
            let statusDropdownHtml = `<select class="form-select form-select-sm status-select" data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}" ${isError ? 'disabled title="無法變更錯誤狀態"' : ''}>`;
            for (const [value, text] of Object.entries(STATUS_OPTIONS)) {
                const isDisabled = value === AUTO_EXCLUDED_STATUS; // 自動排除狀態不可選
                const isSelected = value === issue.status;
                statusDropdownHtml += `<option value="${escapeHtml(value)}" ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}>${escapeHtml(text)}</option>`;
            }
            statusDropdownHtml += `</select>`;
            // 包含下拉選單、Spinner 和反饋訊息
            const statusContainerHtml = `
                <span class="status-container ms-1">
                    ${statusDropdownHtml}
                    <span class="spinner-border spinner-border-sm status-update-spinner ms-1" style="display: none;"></span>
                    <span class="status-update-feedback ms-1" style="display: none;"></span>
                </span>`;

            // --- 生成截圖完成 Checkbox HTML ---
            const isScreenshotCompleted = issue.screenshot_taken === true;
            const screenshotCompletionCheckHtml = `
                <div class="form-check form-switch screenshot-line">
                    <input class="form-check-input screenshot-completion-checkbox" type="checkbox" role="switch" id="${screenshotCheckboxId}"
                           data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}"
                           ${isScreenshotCompleted ? 'checked' : ''} ${isError ? 'disabled' : ''}>
                    <label class="form-check-label" for="${screenshotCheckboxId}">已完成全部截圖</label>
                    <div class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></div> <!-- Spinner -->
                    <span class="text-danger ms-1" style="display: none;"></span> <!-- 錯誤訊息 -->
                </div>`;

            // --- 生成 URL 和實體顯示 HTML ---
            // 處理 URL，使其可點擊
            let urlHtml = escapeHtml(issue.url);
            const rawUrl = issue.url;
            if (rawUrl && typeof rawUrl === 'string' && rawUrl.toLowerCase() !== 'n/a' && (rawUrl.startsWith('http') || rawUrl.includes('.'))) {
                let clickableUrl = rawUrl;
                if (!clickableUrl.startsWith('http://') && !clickableUrl.startsWith('https://')) clickableUrl = 'http://' + clickableUrl; // 添加協議頭
                try { new URL(clickableUrl); urlHtml = `<a href="${escapeHtml(clickableUrl)}" target="_blank" class="issue-url-link">${escapeHtml(rawUrl)} <i class="fas fa-external-link-alt fa-xs"></i></a>`; } catch (e) {} // 驗證 URL
            }
            // 處理實體名稱，如果像 URL 也使其可點擊
            const rawEntityName = issue.entity_name;
            let entityDisplayHtml = '';
            if (typeof rawEntityName === 'string' && (rawEntityName.startsWith('http://') || rawEntityName.startsWith('https://'))) {
                entityDisplayHtml = `<a href="${escapeHtml(rawEntityName)}" target="_blank" class="issue-entity-link">${escapeHtml(rawEntityName)}</a>`;
            } else {
                entityDisplayHtml = escapeHtml(rawEntityName || 'N/A');
            }
            const entityHtml = `<span style="word-break: break-all;">${entityDisplayHtml} (${escapeHtml(entityType)})</span>`; // 組合名稱和類型

            // --- 生成 HTTP 流量和驗證按鈕 HTML ---
            let trafficSectionHtml = '';
            if (!isError && !isManual) { // 只對 AppScan 問題顯示
                const rawTraffic = issue.http_traffic || '無 HTTP 流量數據。';
                const escapedTraffic = escapeHtml(rawTraffic);
                // 將標記的內容用 span 包裹以高亮顯示
                const formattedTrafficHtml = escapedTraffic.replace(/--begin_mark_tag--(.*?)--end_mark_tag--/g,'<span class="text-danger fw-bold">$1</span>');
                // 顯示/隱藏按鈕
                const trafficToggleHtml = `<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}"><i class="fas fa-code"></i> 顯示/隱藏 HTTP 流量</button>`;
                // 摺疊內容區域
                const trafficCollapseHtml = `
                    <div class="collapse" id="${collapseId}">
                        <div class="traffic-details mt-2"><pre><code id="${trafficCodeId}">${formattedTrafficHtml}</code></pre></div>
                    </div>`;
                // Selenium 驗證按鈕 (僅對特定類型問題顯示)
                let verifyButtonHtml = '';
                if ((isComponent || isLink || issueReasoning == EXTERNAL_LINK_REASONING) && issue.url && issue.url !== 'N/A') {
                    verifyButtonHtml = `
                        <button type="button" class="btn btn-outline-warning btn-sm verify-vulnerability-btn ms-2"
                                title="嘗試使用 Selenium 開啟原始碼並尋找相關內容"
                                data-issue-url="${escapeHtml(issue.url)}"
                                data-entity-name="${escapeHtml(entityName)}"
                                data-entity-type="${escapeHtml(entityType)}"
                                data-reasoning="${escapeHtml(issueReasoning)}"
                                data-component-name="${escapeHtml(componentName)}"
                                data-component-version="${escapeHtml(componentVersion)}">
                            <i class="fab fa-chrome"></i> 驗證
                        </button>`;
                }
                 // 組合流量區域 HTML
                 trafficSectionHtml = `
                    <div class="mt-2 d-flex gap-2 flex-wrap">
                        ${trafficToggleHtml}
                        ${verifyButtonHtml}
                    </div>
                    ${trafficCollapseHtml}`;
            }

            // --- 生成截圖區域 HTML ---
            let screenshotSectionHtml = '';
            if (!isError) { // 錯誤條目不顯示截圖
                screenshotSectionHtml = `
                    <div class="screenshot-section">
                        <div class="screenshot-controls">
                            <!-- 上傳按鈕 -->
                            <button type="button" class="btn btn-outline-primary btn-sm upload-screenshot-btn"
                                    data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}"
                                    data-file-input-id="${screenshotFileInputId}">
                                <i class="fas fa-upload"></i> 上傳
                            </button>
                            <!-- 貼上按鈕 -->
                            <button type="button" class="btn btn-outline-secondary btn-sm paste-screenshot-btn ms-1"
                                    data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}">
                                <i class="fas fa-paste"></i> 貼上
                            </button>
                            <!-- 隱藏的文件選擇輸入框 -->
                            <input type="file" id="${screenshotFileInputId}" class="screenshot-file-input" accept="image/*" style="display: none;"
                                   data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}">
                            <!-- 上傳 Spinner 和反饋訊息 -->
                            <span class="spinner-border spinner-border-sm ms-1" style="display: none;"></span>
                            <span class="upload-feedback ms-1" style="display: none;"></span>
                        </div>
                        <!-- 已上傳截圖列表 -->
                        <ul class="uploaded-screenshots-list" id="${screenshotListId}">`;
                // 添加已存在的截圖列表項
                if (issue.screenshots && issue.screenshots.length > 0) {
                     const sortedScreenshots = [...issue.screenshots].sort(naturalSort); // 自然排序
                     sortedScreenshots.forEach(f => {
                         const url = getApiUrl(`screenshots/${encodeURIComponent(f)}`); // 構造圖片 URL
                         screenshotSectionHtml += `
                            <li>
                                <a href="${url}" target="_blank" title="在新分頁開啟截圖">${escapeHtml(f)} <i class="fas fa-external-link-alt fa-xs"></i></a>
                                <button type="button" class="btn btn-outline-danger btn-xs delete-screenshot-btn" data-filename="${escapeHtml(f)}" title="移至垃圾桶"><i class="fas fa-trash-alt"></i></button>
                            </li>`;
                     });
                 } else { // 如果沒有截圖
                     screenshotSectionHtml += `<li class="no-screenshots-msg text-muted"><em>尚無截圖</em></li>`;
                 }
                 screenshotSectionHtml += `</ul></div>`; // 截圖區域結束
            }

            // --- 生成筆記區域 HTML ---
            let noteSectionHtml = '';
            if (!isError) { // 錯誤條目不顯示筆記
                noteSectionHtml = `
                    <div class="note-section">
                        <label for="${noteTextareaId}" class="form-label form-label-sm mb-1">筆記:</label>
                        <textarea class="form-control form-control-sm issue-note-textarea" id="${noteTextareaId}" rows="3"
                                  data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}"
                                  placeholder="在此輸入筆記...">${escapeHtml(issue.note || '')}</textarea> <!-- 顯示現有筆記 -->
                        <div class="note-controls">
                            <span class="note-feedback me-2" id="${noteFeedbackId}"></span> <!-- 儲存反饋 -->
                            <span class="spinner-border spinner-border-sm text-secondary note-spinner" id="${noteSpinnerId}" role="status" style="display: none;"></span> <!-- 儲存 Spinner -->
                            <button type="button" class="btn btn-outline-success btn-sm save-note-btn" id="${noteSaveBtnId}">
                                <i class="fas fa-save"></i> 儲存筆記
                            </button>
                        </div>
                    </div>`;
            }

            // --- 組合卡片內容 HTML ---
            const cardBodyHtml = `
                <div class="issue-card-body">
                     <!-- 狀態和截圖完成行 -->
                     <div class="status-and-screenshot-area">
                         <div class="status-line"><strong>狀態:</strong>${statusContainerHtml}</div>
                         ${screenshotCompletionCheckHtml}
                     </div>
                     <!-- 基本信息 -->
                     <p class="mb-1"><strong>URL:</strong> <span style="word-break: break-all;">${urlHtml}</span></p>
                     <p class="mb-1"><strong>實體:</strong> ${entityHtml}</p>
                     <p class="mb-1"><strong>原因:</strong> <span style="white-space: pre-wrap;">${escapeHtml(issueReasoning)}</span></p>
                     <!-- HTTP 流量 -->
                     ${trafficSectionHtml}
                     <!-- 截圖區域 -->
                     ${screenshotSectionHtml}
                     <!-- 筆記區域 -->
                     ${noteSectionHtml}
                 </div>`;

            // --- 返回完整的卡片 HTML ---
            // 將 groupMembersAttr 添加到最外層 div
            return `
                <div class="${cardClasses}" id="${cardId}" ${representativeAttr} ${groupKeyAttr} ${representativeIssueIdAttr} ${groupMembersAttr}>
                    ${headerHtml.replace('{#Num#}', '')} <!-- 替換編號佔位符 -->
                    ${cardBodyHtml}
                </div>`;
        }


        /**
         * 渲染問題列表，包括排序、分組和生成 HTML
         * @param {Array<object>} issues 要渲染的問題數據數組
         */
        function renderIssueList(issues) {
            console.log("Inside renderIssueList - Start, issue count:", (issues || []).length);
            let issueListHtml = ''; // 初始化最終 HTML 字串
            const issueCount = (issues || []).length; // 獲取問題數量
            if(issueCountSpan) issueCountSpan.textContent = issueCount; // 更新問題計數顯示

            const sortBy = sortSelect?.value || DEFAULT_SORT; // 獲取當前排序方式
            let issuesToDisplay = [...(issues || [])]; // 複製一份問題數組以進行排序
            let groupedIssues = {}; // 初始化分組後的問題數據

            try {
                // === 步驟 1: 排序問題 ===
                issuesToDisplay.sort((a, b) => {
                    const ia = a || {}, ib = b || {}; // 處理可能的 null 值
                    // 將錯誤條目排在最後
                    const aIsError = ia.source === 'error'; const bIsError = ib.source === 'error';
                    if (aIsError !== bIsError) return aIsError ? 1 : -1; // 錯誤的排後面

                    // 根據選擇的排序方式進行比較
                    switch (sortBy) {
                        case 'severity': // 按嚴重性 (高到低)
                            return (SEVERITY_LEVELS[ib.severity_key?.toLowerCase()] ?? -1) - (SEVERITY_LEVELS[ia.severity_key?.toLowerCase()] ?? -1);
                        case 'url': // 按 URL (字典序)
                            return (ia.url || '').localeCompare(ib.url || '');
                        case 'issue_type': // 按問題類型 (字典序)
                            return (ia.issue_type || '').localeCompare(ib.issue_type || '');
                        case 'status': // 按狀態 (字典序)
                            return (ia.status || '').localeCompare(ib.status || '');
                        default: return 0; // 預設不排序
                    }
                });
                console.log("Sorting finished.");

                // === 步驟 2: 問題分組 ===
                groupedIssues = {}; // 清空上次的分組結果
                issuesToDisplay.forEach(issue => {
                    // 錯誤條目單獨分組
                    const groupKey = issue.source === 'error'
                        ? `error_${issue.id}` // 錯誤條目的唯一 key
                        // 其他問題按 URL ||| 問題類型 ||| 實體名稱 分組
                        : `${issue.url || 'N/A'}|||${issue.issue_type || 'Unknown Type'}|||${issue.entity_name || 'N/A'}`;
                    if (!groupedIssues[groupKey]) groupedIssues[groupKey] = []; // 如果 key 不存在，則創建數組
                    groupedIssues[groupKey].push(issue); // 將問題加入對應的分組
                });
                groupedIssuesData = groupedIssues; // 將分組結果存儲到全局變數，供後續使用
                console.log("Grouping finished. Group count:", Object.keys(groupedIssues).length);

                // === 步驟 3: 生成 HTML ===
                let displayIndex = 0; // 用於顯示編號 (1, 2, 3...)
                if (groupedIssues && typeof groupedIssues === 'object') {
                    // 遍歷每個分組
                    Object.entries(groupedIssues).forEach(([groupKey, group], groupIndex) => {
                        displayIndex++; // 增加顯示編號
                        const isErrorGroup = group[0]?.source === 'error'; // 判斷是否為錯誤分組

                        // 為該群組準備成員信息 (用於批次更新)
                        const memberIdentifiers = group.map(member => ({ reportFilename: currentReportFilename, issueId: member.id }));
                        const membersJsonString = JSON.stringify(memberIdentifiers); // 轉換為 JSON 字串

                        // --- 情況 A: 分組只有一個問題或為錯誤分組 ---
                        if (group.length === 1 || isErrorGroup) {
                            const issue = group[0];
                            // 創建唯一的 ID 後綴
                            const uniqueSuffix = `issue-${issue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`;
                            // 生成單個問題卡片的 HTML
                            let cardHtml = generateIssueCardHTML(issue, uniqueSuffix, false, null, membersJsonString);
                            if (cardHtml) {
                                 // 將顯示編號插入到卡片標頭的佔位符位置
                                 const headerRegex = /(<div class="issue-card-header.*?>)/;
                                 cardHtml = cardHtml.replace(headerRegex, `$1<span class="me-2 issue-title-part">${displayIndex}.</span> `);
                                 issueListHtml += cardHtml; // 添加到最終 HTML
                            }
                         }
                         // --- 情況 B: 分組有多個問題 (需要顯示群組結構) ---
                         else {
                            // 找到該群組中嚴重性最高的作為代表
                            let highestSeverityLevel = -1;
                            let representativeIssue = group[0]; // 預設第一個為代表
                            group.forEach(iss => {
                                const level = SEVERITY_LEVELS[iss.severity_key?.toLowerCase()] ?? -1;
                                if (level > highestSeverityLevel) {
                                    highestSeverityLevel = level;
                                    representativeIssue = iss; // 更新代表性問題
                                }
                            });
                            // 獲取代表性嚴重性信息
                            const groupSeverityKey = Object.keys(SEVERITY_LEVELS).find(key => SEVERITY_LEVELS[key] === highestSeverityLevel) || 'unknown';
                            const groupSeverityClass = `severity-${groupSeverityKey}`; // CSS class for border
                            const highestSeverityDisplay = representativeIssue?.severity_display || '未知';
                            // 生成群組摺疊區域的 ID
                            const groupCollapseId = `group-collapse-${groupIndex}`;
                            const groupContainerId = `group-container-${groupIndex}`;
                            const representativeUniqueSuffix = `issue-${representativeIssue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`;

                            // --- 生成代表性卡片的 HTML ---
                            // 注意：isGroupRepresentative=true, 傳入 groupKey 和 membersJsonString
                            let repCardHtml = generateIssueCardHTML(representativeIssue, representativeUniqueSuffix, true, groupKey, membersJsonString);
                            if (repCardHtml) { // 移除卡片本身的嚴重性邊框 class (由外層容器控制)
                                repCardHtml = repCardHtml.replace(/ severity-[a-z\-]+/, '');
                            }

                            // --- 生成群組標頭 HTML ---
                            const groupHeaderHtml = `
                                <div class="issue-group-header">
                                    <span class="issue-title-part">
                                        ${displayIndex}. <!-- 顯示編號 -->
                                        <span class="badge ${getSeverityBadgeColor(groupSeverityKey)} me-2">${escapeHtml(highestSeverityDisplay)}</span> <!-- 最高嚴重性 -->
                                        ${escapeHtml(representativeIssue.issue_type)} <!-- 問題類型 -->
                                        <span class="badge bg-secondary ms-2">${group.length} 個實例</span> <!-- 實例數量 -->
                                    </span>
                                    <!-- 展開/收合按鈕 -->
                                    <button class="btn btn-outline-secondary btn-sm btn-toggle-group" type="button" data-bs-toggle="collapse" data-bs-target="#${groupCollapseId}">
                                        <i class="fas fa-chevron-down"></i> <span>查看 ${group.length} 個實例</span>
                                    </button>
                                </div>`;

                            // --- 生成群組內部其他卡片的 HTML ---
                            let innerCardsHtml = '';
                            group.forEach((issue, issueIndex) => {
                                // 跳過代表性問題本身
                                if (issue.id === representativeIssue.id) return;
                                const uniqueSuffix = `issue-${issue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`;
                                // 生成內部卡片 HTML，注意 isGroupRepresentative=false, 但傳入 groupKey 和 membersJsonString
                                let cardHtml = generateIssueCardHTML(issue, uniqueSuffix, false, groupKey, membersJsonString);
                                if(cardHtml) {
                                     // 在標頭插入實例編號和 CVE (如果有的話)
                                     const headerRegex = /(<div class="issue-card-header.*?>)/;
                                     cardHtml = cardHtml.replace(headerRegex, `$1<span class="me-2 text-muted small issue-title-part">(實例 ${issueIndex + 1} / CVE: ${escapeHtml(issue.cve_name || 'N/A')})</span>`);
                                     cardHtml = cardHtml.replace(/ severity-[a-z\-]+/, ''); // 移除內部卡片邊框顏色
                                     innerCardsHtml += cardHtml; // 添加到內部 HTML
                                 }
                            });

                            // --- 組合群組容器的最終 HTML ---
                            // **關鍵:** 在外層 div.issue-group-container 上添加 data-group-members 屬性
                            issueListHtml += `
                                <div class="issue-group-container ${groupSeverityClass}" id="${groupContainerId}" data-group-key="${escapeHtml(groupKey)}" data-group-members='${escapeHtml(membersJsonString)}'>
                                    ${groupHeaderHtml} <!-- 群組標頭 -->
                                    <div class="issue-group-representative-card">${repCardHtml}</div> <!-- 代表性卡片 -->
                                    <div class="collapse issue-group-body" id="${groupCollapseId}">${innerCardsHtml}</div> <!-- 摺疊的內部卡片 -->
                                </div>`;
                        }
                    });
                     console.log("HTML generation loop finished.");
                } else {
                     // 如果 groupedIssues 不是對象 (理論上不應發生)
                     console.error("groupedIssues is not an object after grouping logic!");
                     issueListHtml = `<div class="alert alert-danger">處理問題分組時發生內部錯誤。</div>`;
                }

            } catch (e) {
                 // 處理排序、分組或 HTML 生成過程中的錯誤
                 console.error("Error during issue processing or HTML generation:", e);
                 issueListHtml = `<div class="alert alert-danger">渲染問題列表時出錯: ${escapeHtml(e.message)}</div>`;
            }

            // === 步驟 4: 顯示最終 HTML 或 "無問題" 提示 ===
            if (issueCount === 0 && !issueListHtml.includes('alert-danger')) { // 如果沒有問題且沒有錯誤
                 // 檢查是否有過濾條件生效
                 const filterCheckboxes = filterForm?.querySelectorAll('.filter-checkbox');
                 const checkedCheckboxes = filterForm?.querySelectorAll('.filter-checkbox:checked');
                 const hasFilters = filterCheckboxes && checkedCheckboxes && checkedCheckboxes.length < filterCheckboxes.length;
                 // 根據是否有過濾條件顯示不同的提示
                 const msg = hasFilters
                    ? '目前報告中沒有任何問題符合目前的篩選條件。請嘗試清除篩選條件。'
                    : '此報告中未發現問題，或所有問題已被預設篩選器排除。';
                 issueListHtml = `
                    <div class="alert alert-${hasFilters ? 'warning' : 'info'} mt-3" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                           <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        ${escapeHtml(msg)}
                    </div>`;
            }

            // 將生成的 HTML 填充到問題列表容器
            if(issueListContainer) issueListContainer.innerHTML = issueListHtml;

            // === 步驟 5: 初始化 Bootstrap Collapse 功能 ===
            try {
                if(issueListContainer) {
                    // 為群組的展開/收合按鈕添加事件監聽器，以更新按鈕文字和圖示
                    issueListContainer.querySelectorAll('.btn-toggle-group').forEach(button => {
                        const targetId = button.dataset.bsTarget; // 獲取目標摺疊區 ID
                        const collapseEl = document.querySelector(targetId);
                        // 獲取群組鍵和實例數量
                        const container = button.closest('.issue-group-container');
                        const groupKey = container?.dataset.groupKey;
                        const count = groupedIssuesData[groupKey]?.length || 0; // 從分組數據獲取數量

                        if (collapseEl && count > 1) { // 確保目標存在且有多個實例
                            const viewText = `查看 ${count} 個實例`;
                            const collapseText = `收合實例`;
                            button.querySelector('span').textContent = viewText; // 初始文字
                            // 監聽展開事件
                            collapseEl.addEventListener('show.bs.collapse', () => {
                                button.querySelector('span').textContent = collapseText; // 更新文字
                                button.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up'); // 切換圖示
                            });
                            // 監聽收合事件
                            collapseEl.addEventListener('hide.bs.collapse', () => {
                                button.querySelector('span').textContent = viewText; // 恢復文字
                                button.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down'); // 切換圖示
                            });
                        } else if (button) {
                            // 如果沒有摺疊目標或只有一個實例，隱藏按鈕
                            button.style.display = 'none';
                        }
                    });
                }
                initializeCollapses(); // 初始化頁面上所有的 Collapse 元件
            } catch (e) {
                console.error("Error initializing collapses or toggle buttons:", e);
            }
            console.log("Inside renderIssueList - End");
        }

    </script>

</body>
</html>
