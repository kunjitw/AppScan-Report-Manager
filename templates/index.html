<!DOCTYPE html>
<html lang="zh-TW"> <!-- 指定語言為繁體中文 -->
<head>
    <meta charset="UTF-8"> <!-- 使用 UTF-8 編碼 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 設定視口，用於響應式設計 -->
    <!-- 頁面標題，動態顯示專案名稱 -->
    <title>{{ project_display_name | default(project_name) | e }} - AppScan 報告檢視器</title>
    <!-- 引入 Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Font Awesome 6 圖示庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入 Google Fonts (Noto Sans TC) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Chart.js (用於繪製圖表) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 延遲載入 Bootstrap 5 JS Bundle (包含 Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <style>
        /* --- 基礎樣式 (Base Styles) --- */
        body {
            padding: 20px; /* 頁面內邊距 */
            background-color: #f8f9fa; /* 淺灰色背景 */
            font-size: 14px; /* 基礎字體大小 */
            font-family: 'Noto Sans TC', sans-serif; /* 使用 Noto Sans TC 字體 */
            line-height: 1.6; /* 行高 */
            color: #212529; /* 基礎文字顏色 */
            transition: background-color 0.3s ease, color 0.3s ease; /* 背景和文字顏色過渡效果 */
        }
        /* CSS 變數，用於固定標頭的背景和邊框顏色，方便深色模式切換 */
        :root {
            --sticky-bg: #ffffff;
            --sticky-border: #dee2e6;
        }
        .container {
            max-width: 1320px; /* 最大寬度 */
            background-color: #fff; /* 白色背景 */
            padding: 35px; /* 容器內邊距 */
            border-radius: 12px; /* 圓角 */
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* 陰影效果 */
            border: 1px solid #dee2e6; /* 邊框 */
            transition: background-color 0.3s ease, border-color 0.3s ease; /* 背景和邊框顏色過渡 */
        }
        h1 {
            color: #2c3e50; /* 標題顏色 */
            margin-bottom: 15px; /* 下方間距 */
            border-bottom: 1px solid #e0e0e0; /* 底部邊框線 */
            padding-bottom: 15px; /* 邊框線下方內邊距 */
            display: flex; /* 使用 Flexbox 佈局 */
            align-items: center; /* 垂直居中對齊 */
            justify-content: space-between; /* 兩端對齊 */
            flex-wrap: wrap; /* 允許換行 */
            gap: 15px; /* 子元素間距 */
            font-weight: 700; /* 字體加粗 */
            transition: color 0.3s ease, border-color 0.3s ease; /* 顏色和邊框過渡 */
        }
        h1 svg {
            margin-right: 12px; /* 圖示右側間距 */
            vertical-align: -4px; /* 圖示垂直對齊微調 */
            color: #3498db; /* 圖示顏色 */
        }
        /* 標題右側的操作按鈕區域 */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* 按鈕間距 */
            margin-left: auto; /* 將其推到右側 */
            flex-wrap: wrap; /* 允許換行 */
        }
        /* 標題操作按鈕的大小 */
        .header-actions .btn-sm {
            font-size: 0.8em;
            padding: 0.25rem 0.6rem;
        }
        /* 專案標題 (位於 H1 下方) */
        #project-title {
            font-size: 1.3rem;
            font-weight: 500;
            color: #5a6f82; /* 灰色文字 */
            margin-top: -5px;
            margin-bottom: 25px;
            text-align: center; /* 居中顯示 */
            transition: color 0.3s ease;
        }
        /* 返回專案列表的連結 */
        .back-link {
            font-size: 0.9rem;
            color: #6c757d; /* 灰色文字 */
            text-decoration: none; /* 去除底線 */
            display: inline-block;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        .back-link:hover {
            color: #0d6efd; /* 懸停時變藍色 */
            text-decoration: underline; /* 懸停時加底線 */
        }
        .back-link i {
            margin-right: 4px; /* 圖示右側間距 */
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            transition: color 0.3s ease;
        }
        /* 報告區塊樣式 (例如選擇區、內容顯示區) */
        .report-section {
            background-color: #fdfdfd;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative; /* 用於 ::before 定位 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        /* 使用 ::before 偽元素顯示區塊標題 (例如 "1. 選擇報告與操作") */
        .report-section::before {
            content: attr(data-section-title); /* 讀取 data-section-title 屬性內容 */
            display: block;
            font-weight: 700;
            margin-bottom: 20px;
            color: #34495e;
            font-size: 1.15rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        /* 掃描元數據區域 (顯示掃描時間、統計等) */
        .scan-meta-area {
            padding: 15px 20px;
            background-color: #f0f3f5;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #dfe3e6;
            font-size: 0.9rem;
            color: #495057;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .scan-meta-block { margin-bottom: 10px; } /* 元數據塊間距 */
        .scan-meta-block:last-child { margin-bottom: 0; } /* 最後一塊無下間距 */
        .scan-meta-block strong { /* 標籤文字 (例如 "掃描時間:") */
            font-weight: 500;
            color: #34495e;
            display: inline-block;
            margin-right: 8px;
            min-width: 80px; /* 最小寬度，使其對齊 */
            transition: color 0.3s ease;
        }
        .scan-meta-block .value { /* 值文字 */
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            transition: color 0.3s ease;
        }
        .scan-meta-block .badge { /* 徽章樣式 */
            font-size: 0.9em;
            padding: 0.35em 0.65em;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            vertical-align: middle;
            font-weight: 500;
            border: 1px solid transparent;
        }
        /* 狀態摘要徽章群組 */
        .status-summary-group {
            display: inline-flex; /* 使用 inline-flex 以便與標籤同行顯示 */
            flex-wrap: wrap; /* 允許換行 */
            gap: 5px; /* 徽章間距 */
            margin-left: 5px;
        }
        /* 不同狀態的徽章顏色 */
        .status-badge-未審查 { background-color: #fff3cd; color: #495047 !important; border-color: #d3d9df; }
        .status-badge-人工審查中 { background-color: #fff3cd; color: #664d03 !important; border-color: #ffe69c; }
        .status-badge-誤判 { background-color: #e2e3e5; color: #41464b !important; border-color: #d3d6d8; }
        .status-badge-已確認弱點 { background-color: #f8d7da; color: #58151c !important; border-color: #f1aeb5;}
        .status-badge-已自動排除 { background-color: #cfe2ff; color: #052c65 !important; border-color: #b6d4fe;}
        .status-badge-處理錯誤 { background-color: #ffcccc; color: #a00000 !important; border-color: #ff9999;}
        .status-badge-非預期 { background-color: #6c757d; color: #fff !important; } /* 未知狀態 */
        .status-badge-zero { background-color: #f8f9fa; color: #adb5bd !important; border-color: #e9ecef; } /* 計數為 0 的狀態 */

        h4 { /* 問題列表等小標題 */
            color: #7f8c8d;
            margin-top: 25px;
            margin-bottom: 18px;
            font-size: 1.15rem;
            display: flex;
            justify-content: space-between; /* 使計數和排序控制項分開 */
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        h4.text-center { justify-content: center; } /* 居中標題 */
        hr { /* 分隔線 */
            margin-top: 30px;
            margin-bottom: 30px;
            border-top: 1px solid #eee;
            transition: border-color 0.3s ease;
        }
        #reportDetails { margin-top: 0; } /* 報告詳情頂部無間距 */
        /* 報告選擇器區域 */
        .report-selector-area {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        /* 顯示已選報告名稱的區域 */
        #selectedReportDisplay {
            flex-grow: 1; /* 佔用多餘空間 */
            padding: 8px 12px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            min-height: 40px;
            display: flex;
            align-items: center;
            color: #495057;
            font-style: italic; /* 未選擇時斜體 */
            overflow: hidden; /* 超出部分隱藏 */
            text-overflow: ellipsis; /* 超出部分顯示省略號 */
            white-space: nowrap; /* 不換行 */
            min-width: 150px; /* 最小寬度 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #selectedReportDisplay.has-selection {
            font-style: normal; /* 選擇後恢復正常樣式 */
            background-color: #fff;
        }
        /* 報告選擇器區域的按鈕和下拉選單樣式 */
        .report-selector-area .btn, .report-selector-area .form-select {
            padding: 8px 15px;
            font-size: 0.9rem;
            height: 40px; /* 固定高度 */
        }
        .report-selector-area .form-select { max-width: 220px; } /* 限制下拉選單最大寬度 */
        #openScanFileButton { display: none; } /* 預設隱藏打開 .scan 檔案按鈕 */
        #reportFilterGroup { margin-left: 0; } /* 調整報告過濾器組的邊距 */

        /* --- 選擇報告彈窗 (Modal) 樣式 --- */
        #reportSelectModal .modal-dialog { max-width: 1240px; } /* 彈窗寬度 */
        #reportSelectModal .modal-body { max-height: 70vh; overflow-y: auto; } /* 限制高度並允許滾動 */
        /* 報告列表表格 */
        .report-list-table {
            width: 100%;
            table-layout: fixed; /* 固定表格佈局，防止內容撐開列寬 */
            border-collapse: separate; /* 分離邊框 */
            border-spacing: 0 2px; /* 行間距 */
        }
        .report-list-table th, .report-list-table td {
            padding: 10px 8px;
            vertical-align: middle; /* 垂直居中 */
            border-bottom: 1px solid #eee;
            font-size: 0.88rem;
            text-align: center; /* 預設居中 */
            white-space: nowrap; /* 不換行 */
            overflow: hidden; /* 超出隱藏 */
            text-overflow: ellipsis; /* 超出顯示省略號 */
            transition: border-color 0.3s ease, color 0.3s ease;
        }
        .report-list-table th { /* 表頭樣式 */
            font-weight: 500;
            background-color: #f8f9fa;
            color: #555;
            border-bottom-width: 2px;
            border-color: #dee2e6;
            position: sticky; /* 使表頭固定 */
            top: -1px; /* 微調固定位置 */
            z-index: 10; /* 確保在滾動內容之上 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        /* 被過濾掉的報告行的樣式 */
        .report-list-table tr.report-row-disabled {
            opacity: 0.5; /* 半透明 */
            cursor: not-allowed; /* 禁用鼠標樣式 */
            background-color: #f8f9fa !important; /* 強制背景色 */
        }
        .report-list-table tr.report-row-disabled td { color: #6c757d !important; } /* 強制文字顏色 */
        .report-list-table tr.report-row-disabled:hover td,
        .report-list-table tr.report-row-disabled:hover .filename-cell {
            background-color: #f8f9fa !important; /* 懸停時背景不變 */
        }
        /* 遺失報告行的樣式 */
        .report-list-table tr.missing-row { font-style: italic; }
        /* 報告行懸停效果 (可選中時) */
        .report-list-table tr:not(.report-row-disabled):hover .filename-cell {
            background-color: #eef7ff; /* 淺藍色背景 */
            cursor: pointer; /* 手形鼠標 */
            transition: background-color 0.15s ease;
        }
        /* 表格列寬定義 */
        .report-list-table .col-completed { width: 8%; } /* 判讀完成 */
        .report-list-table .col-status { width: 8%; font-size: 1.1em; } /* 掃描狀態 */
        .report-list-table .col-filename { /* 檔案名稱列 */
            width: 30%;
            text-align: left; /* 左對齊 */
            white-space: normal; /* 允許換行 */
            word-break: break-all; /* 強制斷詞 */
            font-weight: 500;
        }
        .report-list-table .col-pages { width: 8%; } /* 掃描頁面 */
        .report-list-table .col-entities { width: 8%; } /* 測試實體 */
        .report-list-table .col-sev-c, .report-list-table .col-sev-h,
        .report-list-table .col-sev-m, .report-list-table .col-sev-l,
        .report-list-table .col-sev-i { width: 6%; } /* 各嚴重性計數 */
        /* 嚴重性計數顏色 */
        .report-list-table .sev-count-c { color: #8B0000; font-weight: bold; } /* 重大 */
        .report-list-table .sev-count-h { color: #dc3545; font-weight: bold; } /* 高 */
        .report-list-table .sev-count-m { color: #fd7e14; } /* 中 */
        .report-list-table .sev-count-l { color: #6c757d; } /* 低 */
        .report-list-table .sev-count-i { color: #adb5bd; } /* 參考 */
        /* 彈窗內掃描狀態顏色 */
        .modal-status-success { color: #198754; } /* 成功 */
        .modal-status-failed, .modal-status-error { color: #dc3545; font-weight: bold;} /* 失敗/錯誤 */
        .modal-status-warning { color: #fd7e14; } /* 警告 (中斷/不完整) */
        .modal-status-missing { color: #6c757d; } /* 遺失 */
        .modal-status-unknown { color: #6c757d; } /* 未知 */
        .modal-status-running { color: #0d6efd; } /* 執行中 (理論上不會出現) */
        /* 報告完成狀態 Checkbox 樣式 */
        .report-completion-checkbox {
            transform: scale(0.9); /* 縮小一點 */
            cursor: pointer;
            vertical-align: middle;
        }
        .report-completion-checkbox:disabled {
            cursor: not-allowed; /* 禁用鼠標 */
            opacity: 0.7;
        }
        /* 更新報告完成狀態時的 Spinner */
        .spinner-report-completion {
            display: none; /* 預設隱藏 */
            width: 0.8rem;
            height: 0.8rem;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* --- 問題卡片樣式 (Issue Card) --- */
        .issue-card {
            margin-bottom: 18px; /* 卡片間距 */
            border-radius: 8px;
            transition: box-shadow 0.2s ease-in-out, border-color 0.3s ease, background-color 0.3s ease;
            background-color: #fff;
            border-width: 2px; /* 邊框寬度 */
            border-style: solid;
            /* 使用 CSS 變數定義邊框顏色，根據嚴重性變化 */
            border-color: var(--severity-border-color, #d8dde2);
        }
        /* 手動新增的問題卡片樣式 */
        .issue-card.source-manual { border-left: 5px solid #6610f2; } /* 紫色左邊框 */
        /* 解析錯誤的問題卡片樣式 */
        .issue-card.source-error { border-left: 5px solid #dc3545; opacity: 0.7; background-color: #fffafa;} /* 紅色左邊框 */
        /* 根據嚴重性定義邊框顏色變數 */
        .severity-low { --severity-border-color: #ffc107; } /* 黃 */
        .severity-medium { --severity-border-color: #fd7e14; } /* 橙 */
        .severity-high { --severity-border-color: #dc3545; } /* 紅 */
        .severity-critical { --severity-border-color: #8B0000; } /* 深紅 */
        .severity-informational { --severity-border-color: #0dcaf0; } /* 藍綠 */
        .severity-unknown, .severity-error { --severity-border-color: #6c757d; } /* 灰 */
        /* 卡片懸停效果 */
        .issue-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        /* 問題卡片標頭 (固定在頂部) */
        .issue-card-header {
            position: sticky; /* 固定定位 */
            top: 0; /* 相對於其滾動容器的頂部 */
            z-index: 1000; /* 確保在其他內容之上 */
            background-color: var(--sticky-bg); /* 使用變數定義背景色 */
            padding: 10px 15px;
            border-bottom: 1px solid var(--sticky-border); /* 使用變數定義邊框色 */
            font-weight: 500;
            font-size: 0.95rem;
            color: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 10px; /* 行/列間距 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            border-top-left-radius: 6px; /* 圓角 (配合卡片) */
            border-top-right-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 細微陰影 */
        }
        /* 手動問題標頭背景色 */
        .source-manual .issue-card-header { background-color: #f0e4ff; }
        /* 錯誤問題標頭背景色 */
        .source-error .issue-card-header { background-color: #ffe0e0; color: #a00000;}
        /* 標頭中的問題類型部分 */
        .issue-card-header .issue-title-part {
            flex-grow: 1; /* 佔用多餘空間 */
            min-width: 200px; /* 最小寬度 */
        }
        /* 手動標示 */
        .issue-card-header .manual-indicator {
            font-size: 0.7em; color: #6610f2; font-weight: bold; margin-left: 5px;
            vertical-align: middle; border: 1px solid #c8a2f0; padding: 1px 3px;
            border-radius: 3px; background-color: #e9d5ff;
        }
        /* 錯誤標示 */
        .issue-card-header .error-indicator {
            font-size: 0.7em; color: #dc3545; font-weight: bold; margin-left: 5px;
            vertical-align: middle; border: 1px solid #f5c6cb; padding: 1px 3px;
            border-radius: 3px; background-color: #f8d7da;
        }
        /* 標頭中的詳細資訊部分 (CVSS/CVE) */
        .issue-card-header .details-part {
            min-width: 100px;
            text-align: right; /* 右對齊 */
            font-weight: 400;
            font-size: 0.9em;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        .issue-card-header .details-part a { color: #3498db; text-decoration: none; }
        .issue-card-header .details-part a:hover { text-decoration: underline; }
        .issue-card-header .badge { font-size: 0.85em; padding: 0.35em 0.6em; }
        /* 問題類型/URL/實體連結樣式 */
        .issue-type-link, .issue-url-link, .issue-entity-link {
            color: #0d6efd;
            text-decoration: none;
            border-bottom: 1px dotted #0d6efd; /* 虛線底線 */
            word-break: break-all; /* 允許在單詞內換行 */
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .issue-type-link:hover, .issue-url-link:hover, .issue-entity-link:hover {
            color: #0a58ca;
            border-bottom-style: solid; /* 懸停時變實線 */
            text-decoration: none;
        }
        /* 連結旁的外部連結小圖示 */
        .issue-type-link .fa-external-link-alt, .issue-url-link .fa-external-link-alt {
            font-size: 0.75em;
            margin-left: 3px;
            color: #6c757d;
            vertical-align: baseline;
            transition: color 0.3s ease;
        }
        /* 自訂嚴重性徽章顏色 */
        .badge-custom-critical { background-color: #8B0000; color: white; }
        .badge-custom-high { background-color: #dc3545; color: white; }
        .badge-custom-medium { background-color: #fd7e14; color: white; }
        .badge-custom-low { background-color: #ffc107; color: #212529; }
        .badge-custom-informational { background-color: #0dcaf0; color: #212529; border: 1px solid #0aa5c2; }
        .badge-custom-unknown, .badge-custom-error { background-color: #6c757d; color: white; }
        /* 問題卡片內容區域 */
        .issue-card-body {
            padding: 15px;
            font-size: 0.9rem;
        }
        /* 錯誤卡片隱藏內容 */
        .issue-card.source-error .issue-card-body { display: none; }
        .issue-card-body p {
            margin-bottom: 8px;
            display: flex; /* 使用 Flexbox 使標籤和值對齊 */
            align-items: flex-start; /* 頂部對齊 */
        }
        .issue-card-body strong { /* 標籤文字 (例如 "URL:") */
            color: #495057;
            min-width: 75px; /* 最小寬度對齊 */
            display: inline-block;
            flex-shrink: 0; /* 防止標籤被壓縮 */
            margin-right: 8px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        /* 允許長內容換行的 span */
        .issue-card-body span[style*="word-break"],
        .issue-card-body p > span:last-child { /* p 標籤的最後一個 span (通常是值) */
            flex-grow: 1; /* 佔用剩餘空間 */
        }

        /* --- 問題群組容器樣式 (Issue Group Container) --- */
        .issue-group-container {
            margin-bottom: 18px;
            border-radius: 8px;
            background-color: #f7faff; /* 淡藍色背景 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border-width: 2px;
            border-style: solid;
            border-color: var(--severity-border-color, #c7d6e6); /* 使用嚴重性顏色變數 */
        }
        /* 根據嚴重性設定群組容器邊框顏色 */
        .issue-group-container.severity-low { --severity-border-color: #ffc107; }
        .issue-group-container.severity-medium { --severity-border-color: #fd7e14; }
        .issue-group-container.severity-high { --severity-border-color: #dc3545; }
        .issue-group-container.severity-critical { --severity-border-color: #8B0000; }
        .issue-group-container.severity-informational { --severity-border-color: #0dcaf0; }
        .issue-group-container.severity-unknown, .issue-group-container.severity-error { --severity-border-color: #6c757d; }
        /* 問題群組標頭 (固定) */
        .issue-group-header {
             position: sticky; /* 固定定位 */
             top: 0; /* 相對滾動容器頂部 */
             z-index: 1010; /* 比單個卡片標頭更高 */
             background-color: var(--sticky-bg); /* 使用變數 */
             padding: 10px 15px;
             border-bottom: 1px solid var(--sticky-border); /* 使用變數 */
             font-weight: 500;
             font-size: 0.95rem;
             color: #052c65; /* 深藍色文字 */
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 10px;
             border-top-left-radius: 6px;
             border-top-right-radius: 6px;
             transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
             box-shadow: 0 1px 3px rgba(0,0,0,0.15); /* 陰影 */
        }
        .issue-group-header .badge { font-size: 0.85em; padding: 0.35em 0.6em; }
        .issue-group-header .group-info { color: #555; font-size: 0.9em; } /* 群組資訊文字 */
        .issue-group-header .btn-toggle-group { /* 展開/收合按鈕 */
            padding: 0.1rem 0.4rem;
            font-size: 0.8rem;
            line-height: 1.2;
        }
        /* 代表性問題卡片 (在群組中第一個顯示) */
        .issue-group-representative-card {
            margin: 0;
            border-radius: 0; /* 無圓角 */
            border: none !important; /* 移除邊框 */
            border-top: 1px solid #e0e6ec !important; /* 頂部細線 */
            border-bottom-left-radius: 7px; /* 底部圓角 (如果未展開) */
            border-bottom-right-radius: 7px;
            background-color: #fff;
        }
        /* 群組內容區域 (可摺疊) */
        .issue-group-body {
            padding: 0;
            background-color: #ffffff;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            transition: background-color 0.3s ease;
        }
        /* 群組內部的問題卡片 */
        .issue-group-body .issue-card {
            border: none !important; /* 移除邊框 */
            border-top: 1px solid #e9ecef !important; /* 頂部分隔線 */
            margin-bottom: 0; /* 無下間距 */
            box-shadow: none !important; /* 無陰影 */
            background-color: #fff;
        }
        .issue-group-body .issue-card:first-child { border-top: none !important; } /* 第一個卡片無頂部分隔線 */

        /* --- 截圖相關樣式 --- */
        .screenshot-section { /* 截圖區域容器 */
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6; /* 頂部分隔虛線 */
            transition: border-color 0.3s ease;
        }
        .screenshot-controls { /* 截圖控制按鈕區域 */
            display: flex;
            align-items: center;
            gap: 5px; /* Reduced gap */
            margin-bottom: 8px;
            flex-wrap: wrap; /* 允許換行 */
        }
        .screenshot-controls .btn-sm { /* 控制按鈕大小 */
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            flex-shrink: 0; /* 防止按鈕被壓縮 */
        }
        /* Style for caption input - Removed from here */
        /*
        .screenshot-controls .screenshot-caption-input { ... }
        */
        .screenshot-controls .upload-feedback { /* 上傳反饋訊息 */
            font-size: 0.8em;
            margin-left: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* 限制最大寬度 */
        }
        .screenshot-controls .spinner-border-sm { /* 上傳 Spinner */
            width: 0.8rem;
            height: 0.8rem;
            flex-shrink: 0;
        }
        .uploaded-screenshots-list { /* 已上傳截圖列表 */
            list-style: none; /* 去除列表符號 */
            padding-left: 0;
            margin-top: 10px;
            font-size: 0.85rem;
            max-height: 150px; /* 限制最大高度 */
            overflow-y: auto; /* 超出高度顯示滾動條 */
            border: 1px solid #f1f1f1;
            border-radius: 4px;
            padding: 5px;
            background-color: #fcfcfc;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .uploaded-screenshots-list li { /* 列表項 */
            margin-bottom: 4px;
            padding: 3px 5px;
            border-bottom: 1px solid #f1f1f1; /* 項之間的底線 */
            border-radius: 3px;
            transition: border-color 0.3s ease;
        }
        .uploaded-screenshots-list li:last-child { border-bottom: none; } /* 最後一項無底線 */
        .uploaded-screenshots-list li .d-flex { /* Use flex on inner div */
             align-items: flex-start; /* Align items top */
        }
        .uploaded-screenshots-list li .flex-grow-1 { /* Let filename/caption area grow */
            overflow: hidden; /* Prevent long text overflowing */
        }

        /* Screenshot view link */
        .uploaded-screenshots-list a.screenshot-view-link {
            text-decoration: none;
            color: #0d6efd;
            word-break: break-all;
            display: inline;
            cursor: pointer; /* Indicate it's clickable */
            transition: color 0.3s ease;
        }
        .uploaded-screenshots-list a.screenshot-view-link:hover {
            text-decoration: underline;
            color: #0a58ca;
        }
        .uploaded-screenshots-list a.screenshot-view-link .fa-external-link-alt { /* Icon style if you keep it */
            font-size: 0.8em;
            margin-left: 4px;
            vertical-align: baseline;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        /* Caption display */
        .uploaded-screenshots-list .screenshot-caption {
            display: block; /* Display caption on a new line */
            margin-top: 2px; /* Small space */
            color: #6c757d;
            font-size: 0.9em;
            padding-left: 2px; /* Indent slightly */
            word-break: break-all; /* Allow long captions to wrap */
        }

        .uploaded-screenshots-list .no-screenshots-msg { /* 無截圖訊息 */
            font-style: italic;
            color: #6c757d;
            padding: 3px 5px;
            text-align: center;
            margin: 0;
            border-bottom: none;
        }
        .uploaded-screenshots-list .btn-group-sm .btn-xs { /* Smaller buttons in list */
            padding: 0.1rem 0.4rem;
            font-size: 0.75rem;
            line-height: 1;
        }
        .uploaded-screenshots-list .btn-group-sm .btn-xs i { margin-right: 0; } /* 圖示無右邊距 */
        /* Spinner for edit/delete */
        .uploaded-screenshots-list .spinner-border-xs {
            width: 0.8rem;
            height: 0.8rem;
            border-width: .15em;
        }

        /* 截圖完成狀態顯示 (目前未使用) */
        .screenshot-controls .screenshot-completion-status { display: none; }

        /* --- HTTP 流量詳情樣式 --- */
        .traffic-details {
            background-color: #f1f3f5;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px; /* 限制最大高度 */
            overflow-y: auto; /* 允許滾動 */
            border: 1px solid #ced4da;
            margin-top: 8px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .traffic-details pre { /* pre 標籤保留格式 */
            margin: 0;
            white-space: pre-wrap; /* 自動換行 */
            word-wrap: break-word; /* 強制斷詞 */
            font-size: 0.85em;
            color: #212529;
            transition: color 0.3s ease;
        }
        .traffic-details code { /* code 標籤樣式 */
            font-family: 'Courier New', Courier, monospace; /* 等寬字體 */
            padding: 0;
            background-color: transparent;
            color: inherit;
            border-radius: 0;
        }
        /* 流量中標記的危險文字顏色 */
        .traffic-details code .text-danger { color: #dc3545 !important; }
        /* 流量中加粗文字 */
        .traffic-details code .fw-bold { font-weight: bold !important; }

        /* --- 過濾表單樣式 --- */
        .filter-form {
            margin-top: 15px;
            margin-bottom: 25px;
            padding: 20px 20px 10px 20px;
            background-color: #f0f3f5;
            border-radius: 8px;
            border: 1px solid #dfe3e6;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .filter-group { margin-bottom: 15px; } /* 過濾組間距 */
        .filter-group h5 { /* 過濾組標題 */
            margin-bottom: 10px;
            font-size: 1rem;
            color: #34495e;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .form-check-label { font-size: 0.9rem; } /* Checkbox 標籤字體 */
        .form-select, .btn { /* 下拉選單和按鈕 */
            border-radius: 6px;
            font-size: 0.9rem;
        }
        /* 按鈕內的圖示 */
        .btn svg, .btn i {
            vertical-align: -2px; /* 微調垂直對齊 */
            margin-right: 5px; /* 圖示右邊距 */
        }
        /* 錯誤訊息樣式 */
        #reportListError.text-danger, .status-update-feedback.text-danger,
        .upload-feedback.text-danger, #previewError.text-danger,
        .screenshot-completion-status .text-danger, .note-feedback.text-danger {
            font-weight: bold; /* 紅色錯誤加粗 */
        }
        /* 提示框樣式 */
        .alert {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .alert svg { margin-right: 8px; } /* 提示框圖示 */

        /* --- 問題卡片內狀態控制項 --- */
        .status-container { /* 狀態下拉選單和反饋訊息的容器 */
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        .status-select { /* 狀態下拉選單 */
            font-size: 0.85em;
            padding: 0.25rem 0.5rem;
            flex-grow: 1; /* 佔用空間 */
            min-width: 110px; /* 最小寬度 */
            max-width: 160px; /* 最大寬度 */
            border-radius: 4px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .status-update-spinner { /* 狀態更新 Spinner */
            display: none;
            width: 0.9rem;
            height: 0.9rem;
            color: #6c757d;
        }
        .status-update-feedback { /* 狀態更新反饋訊息 */
            display: none;
            font-size: 0.8em;
            white-space: nowrap;
        }
        .status-update-feedback.text-success { color: #198754 !important; }
        .status-update-feedback.text-danger { color: #dc3545 !important; }

        /* --- 問題列表標頭 (包含計數和排序) --- */
        .issue-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 18px;
        }
        .issue-list-header h4 { margin: 0; } /* 移除標題預設邊距 */
        #sortControls { /* 排序控制項容器 */
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #sortControls label { margin-bottom: 0; transition: color 0.3s ease;}
        /* 嚴重性分佈圖表容器 */
        #severityChartContainer {
            position: relative;
            height: 280px; /* 圖表高度 */
            width: 100%;
            margin-bottom: 15px;
        }
        /* 過濾表單佈局調整 (大螢幕) */
        .filter-form .row > .col-lg-3 { flex: 0 0 auto; width: 25%; }

        /* --- 截圖預覽/編輯/查看彈窗 --- */
        #screenshotPreviewModal .modal-body img { /* 預覽圖片 */
            max-width: 100%;
            max-height: 70vh; /* 限制最大高度 */
            display: block;
            margin: 0 auto; /* 水平居中 */
            border: 1px solid #ccc;
        }
        #screenshotPreviewModal .modal-dialog { max-width: 80%; } /* 彈窗寬度 */

        /* --- 筆記區域 --- */
        .issue-card-body .note-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6; /* 分隔線 */
            transition: border-color 0.3s ease;
        }
        .issue-card-body .note-section textarea { /* 筆記輸入框 */
            width: 100%;
            min-height: 60px;
            font-size: 0.88em;
            border-color: #ced4da;
            border-radius: 4px;
            padding: 5px 8px;
            resize: vertical; /* 允許垂直調整大小 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .issue-card-body .note-controls { /* 筆記控制項 (按鈕、反饋) */
            text-align: left; /* Changed to left */
            margin-top: 5px;
            display: flex; /* Use flex */
            align-items: center; /* Align items */
            gap: 5px; /* Add gap */
            position: relative; /* For dropdown positioning */
        }
        .issue-card-body .note-controls .note-feedback { /* 筆記儲存反饋 */
            font-size: 0.8em;
            order: 3; /* Put feedback last */
            flex-grow: 1; /* Take up space */
            text-align: left;
        }
        .issue-card-body .note-controls .note-spinner { /* 筆記儲存 Spinner */
            width: 0.9rem;
            height: 0.9rem;
            display: none;
            order: 2; /* Spinner before feedback */
        }
        .issue-card-body .note-controls .btn {
             order: 1; /* Buttons first */
             flex-shrink: 0; /* Prevent button shrinking */
        }
        .issue-card-body .note-controls .btn-sm { font-size: 0.8rem; padding: 0.2rem 0.5rem; }

        /* --- Common Notes Dynamic Dropdown Menu --- */
        .common-notes-dynamic-menu { /* Style for the dynamically populated menu */
            max-height: 250px; /* Example max height */
            overflow-y: auto; /* Add scroll if needed */
            min-width: 200px; /* Ensure minimum width */
            z-index: 1055; /* Ensure it's above other elements but potentially below modals */
        }
        .common-note-item {
            cursor: pointer;
            white-space: normal; /* Allow wrapping */
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
            font-size: 0.85rem; /* Adjust font size if needed */
        }

        /* 狀態和截圖完成行的佈局 */
        .issue-card-body .status-and-screenshot-area {
            display: flex;
            flex-direction: column; /* 垂直排列 */
            gap: 5px;
            margin-bottom: 10px;
        }
        .issue-card-body .status-line, .issue-card-body .screenshot-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .issue-card-body .screenshot-line .form-check { /* 截圖完成 Checkbox 容器 */
            margin-bottom: 0;
            padding-left: 0; /* 移除預設左邊距 */
            display: flex;
            align-items: center;
        }
        .issue-card-body .screenshot-line .form-check-label { /* Checkbox 標籤 */
            font-size: 0.9em;
            color: #495057;
            cursor: pointer;
            margin-left: 4px;
            order: 2; /* 將標籤放在後面 */
            transition: color 0.3s ease;
        }
        .issue-card-body .screenshot-line .form-check-input { /* Checkbox 本身 */
            cursor: pointer;
            margin-left: 3px;
            margin-top: 0;
            order: 1; /* 將 Checkbox 放在前面 */
        }
        /* 截圖狀態更新 Spinner 和錯誤訊息 */
        .issue-card-body .screenshot-line .spinner-border-sm,
        .issue-card-body .screenshot-line .text-danger {
            margin-left: 5px;
            display: none; /* 預設隱藏 */
            font-size: 0.9em;
            vertical-align: middle;
            order: 3; /* 放在標籤後面 */
        }
        .issue-card-body .screenshot-line .spinner-border-sm {
            width: 0.8rem;
            height: 0.8rem;
            color: #6c757d;
        }

        /* --- 目前過濾條件顯示區域 --- */
        #filterStatus {
            font-size: 0.85em;
            color: #6c757d;
            background-color: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 10px;
            margin-bottom: -15px; /* 向上移動一點，減少與下方內容的間距 */
            display: none; /* 預設隱藏 */
            border: 1px solid #ced4da;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #filterStatus .badge { margin-right: 4px; margin-bottom: 4px; font-weight: 500; }
        #filterStatus strong { color: #495057; transition: color 0.3s ease;}
        /* 深色模式下的過濾狀態顯示 */
        body.dark-mode #filterStatus { background-color: #3e444a; color: #adb5bd; border-color: #5a6268;}
        body.dark-mode #filterStatus strong { color: #dee2e6; }
        body.dark-mode #filterStatus .badge { border: 1px solid #555;}

        /* --- Target Info Display --- */
        .target-info-display {
            background-color: #f8f9fa; /* Light background */
            padding: 10px 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 20px; /* Space below */
            font-size: 0.85rem; /* Slightly smaller */
            color: #495057; /* Text color */
        }
        .target-info-display strong {
            color: #343a40; /* Darker label */
            margin-right: 5px;
        }
        .target-info-display a {
            color: #0d6efd;
            text-decoration: none;
        }
        .target-info-display a:hover {
            text-decoration: underline;
        }
        .target-info-display .fa-external-link-alt {
            font-size: 0.8em;
            margin-left: 3px;
            color: #6c757d;
        }

        /* Dark Mode for Target Info */
        body.dark-mode .target-info-display {
            background-color: #2a2a2a;
            border-color: #444;
            color: #adb5bd;
        }
        body.dark-mode .target-info-display strong {
            color: #e0e0e0;
        }
        body.dark-mode .target-info-display a {
            color: #99cfff;
        }
        body.dark-mode .target-info-display a:hover {
            color: #cce5ff;
        }
        body.dark-mode .target-info-display .fa-external-link-alt {
            color: #8a8d91;
        }


        /* --- 浮動操作按鈕 (FAB) --- */
        .fab-container {
            position: fixed; /* 固定定位 */
            bottom: 20px; /* 距離底部 */
            right: 20px; /* 距離右側 */
            z-index: 1030; /* 高於一般內容 */
            display: flex;
            flex-direction: column; /* 垂直排列 */
            gap: 10px; /* 按鈕間距 */
        }
        .btn-fab { /* FAB 按鈕樣式 */
            width: 50px;
            height: 50px;
            border-radius: 50%; /* 圓形 */
            font-size: 1.2rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* 陰影 */
        }
        .btn-fab i { margin-right: 0; } /* 移除圖示預設邊距 */
        /* FAB 過濾器彈出菜單 */
        .fab-filter-menu {
            min-width: 200px;
            max-height: 50vh; /* 限制最大高度 */
            overflow-y: auto; /* 允許滾動 */
        }
        .fab-filter-menu .dropdown-item.form-check { padding-left: 1.5rem; } /* 調整 Checkbox 內邊距 */
        .fab-filter-menu .form-check-label { font-size: 0.85rem; white-space: normal; } /* 允許標籤換行 */
        .fab-filter-menu .dropdown-header { font-size: 0.9rem; font-weight: bold; }
        .fab-filter-menu .fab-report-filter { cursor: pointer; } /* 報告過濾器項目鼠標樣式 */

        /* --- 深色模式樣式 (Dark Mode) --- */
        body.dark-mode { background-color: #121212; color: #e0e0e0 !important; } /* 深色背景和文字 */
        body.dark-mode :root { --sticky-bg: #1a1a1a; --sticky-border: #444; } /* 更新 CSS 變數 */
        body.dark-mode .container { background-color: #1a1a1a; color: #e0e0e0; border-color: #333; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 { color: #ffffff; } /* 標題變白色 */
        body.dark-mode h1 { border-bottom-color: #444; } /* H1 底線顏色 */
        body.dark-mode .back-link { color: #aaaaaa; } /* 返回連結顏色 */
        body.dark-mode .back-link:hover { color: #99cfff; }
        body.dark-mode .report-section { background-color: #222222; border-color: #444; } /* 區塊背景和邊框 */
        body.dark-mode .report-section::before { color: #f0f0f0; border-bottom-color: #444; } /* 區塊標題顏色 */
        body.dark-mode .scan-meta-area { background-color: #282828; border-color: #444; color: #cccccc; } /* 元數據區 */
        body.dark-mode .scan-meta-block strong { color: #f0f0f0; } /* 元數據標籤 */
        body.dark-mode .scan-meta-block .value { color: #f5f5f5; } /* 元數據值 */
        body.dark-mode .scan-meta-block .badge { border: 1px solid #555; background-color: #444; color: #dddddd !important;} /* 徽章 */
        body.dark-mode .scan-meta-block .badge.bg-primary { background-color: #0b5ed7 !important; color: #fff !important;}
        /* 深色模式下的狀態徽章顏色 */
        body.dark-mode .status-badge-未審查 { background-color: #4b545c; color: #ced4da !important; border-color: #5d6770; }
        body.dark-mode .status-badge-人工審查中 { background-color: #664d03; color: #ffecb5 !important; border-color: #80600a; }
        body.dark-mode .status-badge-誤判 { background-color: #555a5f; color: #d1d3d4 !important; border-color: #696e73; }
        body.dark-mode .status-badge-已確認弱點 { background-color: #722027; color: #fcc6cb !important; border-color: #8f2c36;}
        body.dark-mode .status-badge-已自動排除 { background-color: #1c3e70; color: #c3d9ff !important; border-color: #2f5aa6;}
        body.dark-mode .status-badge-處理錯誤 { background-color: #7d2b34; color: #ffc9ce !important; border-color: #b0404a;}
        body.dark-mode .status-badge-非預期 { background-color: #818182; color: #e6e6e6 !important; }
        body.dark-mode .status-badge-zero { background-color: #343a40; color: #6c757d !important; border-color: #495057; }
        body.dark-mode hr { border-top-color: #444; } /* 分隔線顏色 */
        body.dark-mode #selectedReportDisplay { background-color: #555; border-color: #777; color: #f0f0f0; } /* 已選報告顯示 */
        body.dark-mode #selectedReportDisplay.has-selection { background-color: #444; }
        body.dark-mode .modal-content { background-color: #1f1f1f; color: #e0e0e0; border: 1px solid #555;} /* 彈窗背景和邊框 */
        body.dark-mode .modal-header { border-bottom-color: #444; } /* 彈窗標頭底線 */
        body.dark-mode .modal-footer { border-top-color: #444; } /* 彈窗頁脚頂線 */
        body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(150%); } /* 彈窗關閉按鈕變白色 */
        body.dark-mode .report-list-table th { background-color: #333; color: #f0f0f0; border-color: #555; } /* 報告列表表頭 */
        body.dark-mode .report-list-table td { border-color: #444; color: #cccccc !important; } /* 報告列表單元格 */
        /* 報告列表行懸停效果 */
        body.dark-mode .report-list-table tr:not(.report-row-disabled):hover td,
        body.dark-mode .report-list-table tr:not(.report-row-disabled):hover .filename-cell {
            background-color: #383838 !important;
        }
        /* 禁用行樣式 */
        body.dark-mode .report-list-table tr.report-row-disabled { background-color: #2a2a2a !important; opacity: 0.4;}
        body.dark-mode .report-list-table tr.report-row-disabled td { color: #777 !important;}
        /* 問題卡片 */
        body.dark-mode .issue-card { background-color: #2a2a2a; border-color: var(--severity-border-color, #444) !important; }
        body.dark-mode .issue-card.source-manual { border-left-color: #9d70ff; }
        body.dark-mode .issue-card.source-error { border-left-color: #ff6b6b; }
        body.dark-mode .issue-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: var(--severity-border-color, #555) !important; background-color: #303030;}
        /* 問題卡片標頭 */
        body.dark-mode .issue-card-header { background-color: var(--sticky-bg); border-bottom-color: var(--sticky-border); color: #f5f5f5; }
        body.dark-mode .source-manual .issue-card-header { background-color: #4a2f6e; } /* 手動標頭背景 */
        body.dark-mode .source-error .issue-card-header { background-color: #6f3333; color: #ffdddd;} /* 錯誤標頭背景 */
        /* 手動/錯誤標示 */
        body.dark-mode .issue-card-header .manual-indicator { color: #e0cffc; border-color: #9d70ff; background-color: #6e40a3;}
        body.dark-mode .issue-card-header .error-indicator { color: #ffc6c6; border-color: #ff8282; background-color: #b02a37;}
        /* 問題群組標頭 */
        body.dark-mode .issue-group-header { background-color: var(--sticky-bg); border-bottom-color: var(--sticky-border) !important; color: #f0f0f0; }
        body.dark-mode .issue-card-header .details-part { color: #bbbbbb; } /* 詳細資訊顏色 */
        /* 連結顏色 */
        body.dark-mode .issue-type-link, body.dark-mode .issue-url-link, body.dark-mode .issue-entity-link { color: #99cfff; border-bottom-color: #99cfff; }
        body.dark-mode .issue-type-link:hover, body.dark-mode .issue-url-link:hover, body.dark-mode .issue-entity-link:hover { color: #cce5ff !important; }
        /* 卡片內容 */
        body.dark-mode .issue-card-body { color: #cccccc !important; }
        body.dark-mode .issue-card-body strong { color: #e8e8e8 !important; } /* 標籤文字 */
        /* 問題群組 */
        body.dark-mode .issue-group-container { background-color: #252525; border-color: var(--severity-border-color, #444) !important; }
        body.dark-mode .issue-group-body { background-color: #2f2f2f; } /* 群組內容背景 */
        body.dark-mode .issue-group-representative-card { background-color: #2a2a2a; border-top-color: #444 !important;} /* 代表性卡片 */
        body.dark-mode .issue-group-body .issue-card { border-top-color: #444 !important; background-color: #2a2a2a; } /* 內部卡片 */
        /* 截圖區域 */
        body.dark-mode .screenshot-section { border-top-color: #444; }
        body.dark-mode .uploaded-screenshots-list { border-color: #444; background-color: #333; }
        body.dark-mode .uploaded-screenshots-list li { border-bottom-color: #444; }
        body.dark-mode .uploaded-screenshots-list a.screenshot-view-link { color: #99cfff; }
        body.dark-mode .uploaded-screenshots-list a.screenshot-view-link:hover { color: #cce5ff !important; text-decoration: underline;}
        body.dark-mode .uploaded-screenshots-list .no-screenshots-msg { color: #888; }
        body.dark-mode .uploaded-screenshots-list .screenshot-caption { color: #aaa; } /* Caption text color */
        /* HTTP 流量 */
        body.dark-mode .traffic-details { background-color: #1c1c1c; border-color: #444; }
        body.dark-mode .traffic-details pre, body.dark-mode .traffic-details code { color: #d0d0d0; }
        body.dark-mode .traffic-details code .text-danger { color: #ff8a8a !important; } /* 紅色高亮 */
        /* 過濾表單 */
        body.dark-mode .filter-form { background-color: #333; border-color: #555; }
        body.dark-mode .filter-group h5 { color: #f5f5f5; }
        body.dark-mode .form-check-label { color: #e0e0e0; }
        body.dark-mode .form-control, body.dark-mode .form-select { background-color: #444; color: #f0f0f0; border-color: #666; }
        body.dark-mode .form-control::placeholder { color: #999; }
        body.dark-mode .form-control:focus, body.dark-mode .form-select:focus, body.dark-mode textarea:focus { background-color: #555; color: #fff; border-color: #888; box-shadow: none; }
        body.dark-mode .status-select, body.dark-mode .form-select-sm { background-color: #444; color: #f0f0f0; border-color: #666; }
        body.dark-mode textarea.issue-note-textarea { background-color: #3a3a3a; color: #e0e0e0; border-color: #555; }
        /* Spinner 顏色 */
        body.dark-mode .status-update-spinner, body.dark-mode .note-spinner,
        body.dark-mode .spinner-report-completion, body.dark-mode .screenshot-line .spinner-border-sm {
            color: #aaaaaa;
        }
        body.dark-mode .screenshot-line .form-check-label { color: #cccccc; }
        body.dark-mode #screenshotPreviewModal .modal-body img { border-color: #555; }
        body.dark-mode .text-muted { color: #aaaaaa !important; } /* 輔助文字顏色 */
        /* 按鈕樣式 */
        body.dark-mode .btn-outline-secondary { color: #adb5bd; border-color: #6c757d; }
        body.dark-mode .btn-outline-secondary:hover { background-color: #5a626b; color: #fff; border-color: #5a626b;}
        body.dark-mode .btn-outline-info { color: #0dcaf0; border-color: #0dcaf0; }
        body.dark-mode .btn-outline-info:hover { background-color: #0aa5c2; color: #fff; border-color: #0aa5c2;}
        body.dark-mode .btn-outline-danger { color: #f17883; border-color: #f17883; }
        body.dark-mode .btn-outline-danger:hover { background-color: #b02a37; color: #fff; border-color: #b02a37;}
        body.dark-mode .btn-outline-success { color: #20c997; border-color: #20c997; }
        body.dark-mode .btn-outline-success:hover { background-color: #157347; color: #fff; border-color: #157347;}
        body.dark-mode .btn-outline-warning { color: #ffc107; border-color: #ffc107; }
        body.dark-mode .btn-outline-warning:hover { background-color: #b38a00; color: #fff; border-color: #b38a00;}
        body.dark-mode .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        body.dark-mode .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        body.dark-mode .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        body.dark-mode .btn-secondary:hover { background-color: #5c636a; border-color: #565e64; }
        body.dark-mode .btn-warning { background-color: #ffca2c; border-color: #ffc720; color: #000; }
        body.dark-mode .btn-warning:hover { background-color: #ffda6a; border-color: #ffc720;}
        /* 標頭陰影 */
        body.dark-mode .issue-group-header { box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        body.dark-mode .issue-card-header { box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        /* 手動/錯誤標頭背景 */
        body.dark-mode .source-manual .issue-card-header { background-color: #4a2f6e; }
        body.dark-mode .source-error .issue-card-header { background-color: #6f3333; }
        /* 手動/錯誤標示 */
        body.dark-mode .issue-card-header .manual-indicator { color: #e0cffc; border-color: #9d70ff; background-color: #6e40a3;}
        body.dark-mode .issue-card-header .error-indicator { color: #ffc6c6; border-color: #ff8282; background-color: #b02a37;}
        /* FAB 按鈕 */
        body.dark-mode .btn-fab { background-color: #444; border-color: #555; color: #e0e0e0;}
        body.dark-mode .btn-fab:hover { background-color: #555; }
        /* FAB 過濾菜單 */
        body.dark-mode .fab-filter-menu { background-color: #333; border-color: #555; }
        body.dark-mode .fab-filter-menu .dropdown-header { color: #f0f0f0; }
        body.dark-mode .fab-filter-menu .dropdown-item { color: #d0d0d0; }
        body.dark-mode .fab-filter-menu .dropdown-item:hover,
        body.dark-mode .fab-filter-menu .dropdown-item.fab-report-filter:hover {
            background-color: #444; color: #fff !important;
        }
        body.dark-mode .fab-filter-menu .dropdown-divider { border-top-color: #555; }
        /* Common Notes Dropdown Dark Mode */
        body.dark-mode .common-notes-dynamic-menu {
            background-color: #333;
            border-color: #555;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.4);
        }
        body.dark-mode .common-notes-dynamic-menu .dropdown-item { /* Target items inside */
            color: #d0d0d0;
        }
        body.dark-mode .common-notes-dynamic-menu .dropdown-item:hover,
        body.dark-mode .common-notes-dynamic-menu .dropdown-item:focus {
            background-color: #444;
            color: #fff;
        }
        /* 表單驗證失敗樣式 */
        body.dark-mode .form-control.is-invalid, body.dark-mode .form-select.is-invalid { border-color: #ff8a8a; }
        body.dark-mode .invalid-feedback { color: #ff8a8a; }
        /* 提示框樣式 */
        body.dark-mode .alert-danger { background-color: #722027; color: #fcc6cb; border-color: #8f2c36;}
        body.dark-mode .alert-info { background-color: #052c65; color: #cfe2ff; border-color: #b6d4fe;}
        body.dark-mode .alert-warning { background-color: #664d03; color: #ffecb5; border-color: #ffe69c;}
        body.dark-mode .alert-secondary { background-color: #41464b; color: #e2e3e5; border-color: #d3d6d8;}


        /* --- 響應式佈局調整 (Responsive Adjustments) --- */
        @media (max-width: 1200px) { /* 大型桌面以下 */
            .report-selector-area { gap: 8px; }
            .report-selector-area .btn, .report-selector-area .form-select { padding: 6px 12px; font-size: 0.85rem; height: 38px; }
            .report-selector-area .form-select { max-width: 200px; }
            .filter-form .row > .col-lg-3 { flex-basis: 50%; max-width: 50%;} /* 過濾器每行 2 個 */
        }
        @media (max-width: 992px) { /* 中型桌面/平板以下 */
            .filter-form .row > div { margin-bottom: 10px; flex-basis: 50%; max-width: 50%; }
            /* 隱藏報告列表中的部分欄位 */
            .report-list-table .col-entities, .report-list-table .col-sev-i { display: none; }
            /* 調整剩餘欄寬 */
            .report-list-table .col-filename { width: 35%; }
            .report-list-table .col-pages { width: 12%; }
            .report-list-table .col-completed { width: 10%; }
            .report-list-table .col-status { width: 10%; }
            .report-list-table .col-sev-c, .report-list-table .col-sev-h,
            .report-list-table .col-sev-m, .report-list-table .col-sev-l { width: 8%; }
            .scan-meta-area { padding: 12px 15px; }
            #screenshotPreviewModal .modal-dialog { max-width: 90%; } /* 截圖預覽彈窗變寬 */
            .issue-list-header { flex-direction: column; align-items: flex-start; } /* 問題列表標頭垂直排列 */
            /* 調整報告選擇器佈局 */
            .report-selector-area { flex-direction: row; justify-content: flex-start; }
            #reportFilterGroup { order: 6; margin-left: auto;} /* 過濾器推到右邊 */
            #selectedReportDisplay { flex-basis: 100%; margin-bottom: 10px; order: 1; } /* 已選報告佔滿一行 */
            .report-selector-area .btn { order: 2; } /* 選擇按鈕在第二位 */
            #openScanFileButton { order: 3; } /* 開啟 .scan 按鈕在第三位 */
            .fab-container { right: 15px; bottom: 15px; gap: 8px;} /* FAB 按鈕位置和間距 */
            .btn-fab { width: 45px; height: 45px; font-size: 1.1rem;} /* FAB 按鈕大小 */
        }
        @media (max-width: 768px) { /* 小型設備/手機 */
            h1 { justify-content: center; } /* 主標題居中 */
            .header-actions { margin-left: 0; width: 100%; justify-content: center; margin-top: 10px; } /* 頭部操作按鈕居中 */
            /* 報告選擇器垂直排列 */
            .report-selector-area { flex-direction: column; align-items: stretch; }
            #selectedReportDisplay, .report-selector-area .btn, .report-selector-area .form-select, #openScanFileButton {
                width: 100%; margin-bottom: 10px; order: 0; margin-left: 0; flex-basis: auto; max-width: none;
            }
            #selectedReportDisplay { text-align: center; justify-content: center; } /* 已選報告文字居中 */
            #reportFilterGroup { margin-left: 0;} /* 過濾器不推到右邊 */
            .issue-card-header .details-part { min-width: 80px; } /* 縮小詳細資訊最小寬度 */
            #severityChartContainer { height: 300px; } /* 增加圖表高度 */
            .scan-meta-area { padding: 10px; }
            .scan-meta-block { margin-bottom: 8px; }
            /* 進一步隱藏報告列表欄位 */
            .report-list-table .col-stats, .report-list-table .col-severity, .report-list-table .col-pages,
            .report-list-table .col-entities, .report-list-table .col-sev-c, .report-list-table .col-sev-h,
            .report-list-table .col-sev-m, .report-list-table .col-sev-l, .report-list-table .col-sev-i {
                display: none;
            }
            .report-list-table .col-filename { width: auto; } /* 檔名欄自動寬度 */
            .report-list-table .col-completed { width: 18%; } /* 調整剩餘欄寬 */
            .report-list-table .col-status { width: 18%; }
            .screenshot-controls { flex-wrap: wrap; } /* 截圖控制項換行 */
            #screenshotPreviewModal .modal-dialog { max-width: 95%; } /* 截圖預覽更寬 */
            .filter-form .row > div { flex-basis: 100%; max-width: 100%; } /* 過濾器每行一個 */
            .header-actions .btn-sm { width: 100%; } /* 頭部小按鈕佔滿寬度 */
            .fab-container { right: 10px; bottom: 10px; gap: 6px;} /* FAB 按鈕位置和間距 */
            .btn-fab { width: 40px; height: 40px; font-size: 1rem;} /* FAB 按鈕大小 */
        }

    </style>
</head>
<body class=""> <!-- body class 會被 JS 用來切換 dark-mode -->

    <!-- 全局 JS 常數，由後端 Jinja2 注入 -->
    <script>
        // 這個常數用於 Selenium 驗證邏輯，判斷是否為特定的外部連結問題
        const EXTERNAL_LINK_REASONING_TEXT = {{ external_link_reasoning_text | default('') | tojson | safe }};
        let commonNotesData = {}; // Initialize common notes data store
    </script>

    <!-- 主要內容容器 -->
    <div class="container">
        <!-- 頁面主標題 -->
        <h1>
            <span>
                 <!-- Shield Icon -->
                 <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-shield-check" viewBox="0 0 16 16">
                    <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                    <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                </svg>
                 AppScan 報告檢視器
            </span>
             <!-- 頁面頭部右側的操作按鈕 -->
             <div class="header-actions">
                 <!-- 深色/淺色模式切換按鈕 -->
                 <button type="button" class="btn btn-outline-secondary btn-sm" id="darkModeToggle" title="切換深色/淺色模式">
                    <i class="fas fa-moon"></i> <!-- 預設月亮圖示 -->
                    <span class="d-none d-md-inline">深色模式</span> <!-- 在中等螢幕以上顯示文字 -->
                </button>
                 <!-- 匯出已確認弱點 (Excel) 按鈕 (觸發彈窗) -->
                 <button type="button" class="btn btn-success btn-sm" id="exportButton" title="匯出已確認弱點選項 (Excel)">
                    <i class="fas fa-file-excel"></i> 匯出確認弱點 (Excel)
                </button>
                 <!-- JSON EXPORT BUTTON -->
                 <a href="{{ url_for('export_confirmed_json', project_name=project_name) }}" class="btn btn-primary btn-sm ms-2" id="exportJsonButton" download title="匯出已確認弱點為 JSON 格式 (含備註)">
                    <i class="fas fa-file-code"></i> 匯出確認弱點 (JSON)
                 </a>
                 <!-- 匯出所有筆記按鈕 (直接下載) -->
                 <a href="{{ url_for('export_all_notes', project_name=project_name) }}" class="btn btn-info btn-sm ms-2" id="exportAllNotesButton" download title="匯出所有問題的筆記(不合併)">
                    <i class="fas fa-file-alt"></i> 匯出所有筆記
                </a>
             </div>
        </h1>
        <!-- 專案名稱顯示 -->
        <h2 id="project-title" class="text-center text-muted mb-4">{{ project_display_name | default(project_name) | e }}</h2>
        <!-- 返回專案列表的連結 -->
        <a href="{{ url_for('list_projects') }}" class="back-link"><i class="fas fa-arrow-left"></i> 返回專案列表</a>

        <!-- 區塊 1: 選擇報告與操作 -->
        <div id="selection-container" class="report-section" data-section-title="1. 選擇報告與操作">
             <!-- 報告選擇器區域 -->
             <div class="report-selector-area mb-3">
                <!-- 觸發選擇報告彈窗的按鈕 -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reportSelectModal">
                    <i class="fas fa-folder-open"></i> 選擇報告檔案 (此專案)
                </button>
                <!-- 顯示當前選定報告名稱的區域 -->
                <div id="selectedReportDisplay">尚未選擇報告</div>
                 <!-- 開啟 .scan 檔案按鈕 (預設隱藏) -->
                 <button type="button" class="btn btn-outline-info btn-sm" id="openScanFileButton" title="在本機開啟對應的 .scan 檔案" style="display: none;">
                    <i class="fas fa-external-link-alt"></i> 開啟 .scan
                 </button>
                <!-- 報告列表過濾器 -->
                <div id="reportFilterGroup" class="ms-md-auto"> <!-- ms-md-auto 將其推到右側 (中螢幕以上) -->
                     <select id="reportFilterSelect" class="form-select form-select-sm" title="篩選報告列表">
                         <option value="low">低風險及以上</option>
                         <option value="medium">中風險及以上</option>
                         <option value="high">高風險及以上</option>
                         <option value="critical">僅嚴重風險</option>
                         <option value="errors_only">僅異常掃描</option>
                         <option value="informational">所有報告（含異常）</option>
                     </select>
                </div>
             </div>
             <!-- 手動新增弱點按鈕 (預設禁用) -->
             <div class="mt-2">
                 <button type="button" class="btn btn-outline-secondary btn-sm" id="addVulnerabilityBtn" disabled title="手動新增弱點至目前選定的報告">
                    <i class="fas fa-plus"></i> 手動新增弱點
                </button>
             </div>
             <!-- 報告列表載入錯誤訊息顯示區域 -->
             <div id="reportListError" class="text-danger small mt-3" style="display: none;"></div>
        </div>

        <!-- 選擇報告彈窗 (Modal) -->
        <div class="modal fade" id="reportSelectModal" tabindex="-1" aria-labelledby="reportSelectModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable"> <!-- modal-xl: 加寬; modal-dialog-scrollable: 內容可滾動 -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportSelectModalLabel">選擇報告檔案 - {{ project_display_name | default(project_name) | e }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small">點擊檔案名稱以載入詳細資訊。標示 <span class="badge bg-secondary">完成</span> 表示該報告已被標記為判讀完成。</p>
                        <div class="table-responsive"> <!-- 表格響應式容器 -->
                            <table class="report-list-table table table-hover"> <!-- table-hover: 懸停效果 -->
                                <thead>
                                    <tr>
                                        <th class="col-completed">判讀完成</th>
                                        <th class="col-status">掃描狀態</th>
                                        <th class="col-filename">檔案名稱</th>
                                        <th class="col-pages">掃描頁面</th>
                                        <th class="col-entities">測試實體</th>
                                        <th class="col-sev-c">重大</th>
                                        <th class="col-sev-h">高</th>
                                        <th class="col-sev-m">中</th>
                                        <th class="col-sev-l">低</th>
                                        <th class="col-sev-i">參考</th>
                                    </tr>
                                </thead>
                                <!-- 報告列表內容將由 JavaScript 動態填入 -->
                                <tbody id="reportModalListBody">
                                    <tr><td colspan="10" class="text-center text-muted"><i>正在載入報告列表...</i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <!-- 匯出異常報告按鈕 (預設隱藏) -->
                        <a href="{{ url_for('export_abnormal_reports', project_name=project_name) }}" class="btn btn-warning btn-sm me-auto" id="exportAbnormalButton" style="display: none;" download title="匯出目前篩選出的異常/遺失報告列表">
                            <i class="fas fa-file-excel"></i> 匯出異常報告列表
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 截圖預覽/編輯/查看 彈窗 (Modal for Preview/Edit/View Screenshot) -->
        <div class="modal fade" id="screenshotPreviewModal" tabindex="-1" aria-labelledby="screenshotPreviewModalLabel" aria-hidden="true"
             data-modal-mode="" data-issue-id="" data-screenshot-filename=""> <!-- Added data attributes -->
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="screenshotPreviewModalLabel">圖片預覽</h5> <!-- Title will be updated by JS -->
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="previewImage" src="#" alt="截圖預覽" style="display: none; max-width: 100%; max-height: 70vh; margin-bottom: 15px; border: 1px solid #ccc;">
                        <p id="previewError" class="text-danger" style="display: none;">無法預覽圖片。</p>

                        <!-- Caption Input Area (for paste/upload/edit) -->
                        <div id="captionInputArea" class="mt-3 d-flex align-items-center gap-2">
                            <label for="previewCaptionInput" class="form-label mb-0 flex-shrink-0">圖片備註:</label>
                            <input type="text" class="form-control form-control-sm flex-grow-1" id="previewCaptionInput" placeholder="輸入此截圖的說明...">
                            <!-- Corrected Common Note Button for Preview Caption -->
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-insert-common-note flex-shrink-0"
                                    id="preview-common-note-btn"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    data-target-input-id="previewCaptionInput"
                                    data-issue-type=""  /* This will be set dynamically by JS */
                                    title="插入常用備註">
                                <i class="fas fa-list"></i>
                            </button>
                            <ul class="dropdown-menu common-notes-dynamic-menu" aria-labelledby="preview-common-note-btn"></ul>
                            <!-- End Corrected Button -->
                        </div>

                        <!-- Caption Display Area (for view mode) -->
                        <div id="captionDisplayArea" class="mt-3 text-start" style="display: none;">
                             <strong>備註:</strong> <p id="previewCaptionDisplay" class="d-inline" style="white-space: pre-wrap;"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <!-- Changed ID -->
                        <button type="button" class="btn btn-primary" id="modalConfirmButton">確認上傳</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 匯出選項彈窗 -->
        <div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exportOptionsModalLabel">匯出已確認弱點 (Excel) - 選項</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="mb-3">請選擇匯出 Excel 時要使用的選項：</p>
                <!-- 合併重複項選項 -->
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="" id="modalMergeDuplicatesCheckbox">
                  <label class="form-check-label" for="modalMergeDuplicatesCheckbox">
                    合併相同弱點類型 (同一報告內)
                  </label>
                   <small class="d-block text-muted">相同類型的弱點合併成單一項目，顯示代表性 URL，並列出所有相關實體及其最高嚴重性。</small>
                </div>
                <!-- 包含筆記選項 -->
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="modalIncludeNotesCheckbox">
                  <label class="form-check-label" for="modalIncludeNotesCheckbox">
                    包含筆記內容
                  </label>
                  <small class="d-block text-muted">在匯出的儲存格中附加相關問題的筆記 (合併模式下會合併所有相關筆記)。</small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmExportBtn">確認匯出 Excel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 手動新增弱點彈窗 -->
        <div class="modal fade" id="addVulnerabilityModal" tabindex="-1" aria-labelledby="addVulnerabilityModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addVulnerabilityModalLabel">手動新增弱點</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 新增弱點表單 -->
                        <form id="addVulnerabilityForm" novalidate> <!-- novalidate 禁用瀏覽器預設驗證 -->
                            <!-- 隱藏欄位，用於傳遞報告檔名 -->
                            <input type="hidden" id="addVulnReportFilename" name="reportFilename">
                            <!-- 弱點名稱輸入 -->
                            <div class="mb-3">
                                <label for="addVulnIssueName" class="form-label">弱點名稱 <span class="text-danger">*</span></label>
                                <!-- 使用 datalist 提供預定義選項 -->
                                <input type="text" class="form-control" id="addVulnIssueName" name="issueName" list="weakness-names-list" required placeholder="輸入或從列表選擇弱點名稱">
                                <datalist id="weakness-names-list">
                                    <!-- 弱點名稱選項將由 JS 動態填入 -->
                                </datalist>
                                <div class="invalid-feedback">弱點名稱為必填項目。</div> <!-- Bootstrap 驗證失敗提示 -->
                            </div>
                            <!-- 嚴重性和 URL -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="addVulnSeverity" class="form-label">嚴重性 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="addVulnSeverity" name="severity" required>
                                        <!-- 嚴重性選項由後端 Jinja2 填入 -->
                                        {% for key, display in severities.items() %}
                                            {% set lower_key = key.lower() %}
                                            {% if lower_key in severity_levels_map %}
                                                <option value="{{ lower_key }}" {{ 'selected' if lower_key == 'medium' else '' }}>{{ display }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="addVulnUrl" class="form-label">URL</label>
                                    <input type="text" class="form-control" id="addVulnUrl" name="url" placeholder="https://example.com/page (或 N/A)">
                                </div>
                            </div>
                            <!-- 實體名稱 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="addVulnEntityName" class="form-label">實體名稱/說明</label>
                                    <input type="text" class="form-control" id="addVulnEntityName" name="entityName" placeholder="例如：登入繞過、未授權訪問頁面 (或 N/A)">
                                </div>
                                <!-- 實體類型輸入已移除，固定為 "手動新增" -->
                            </div>
                            <!-- 筆記 -->
                            <div class="mb-3">
                                <label for="addVulnNote" class="form-label">筆記</label>
                                <textarea class="form-control" id="addVulnNote" name="note" rows="3" placeholder="輸入此手動弱點的相關說明或筆記..."></textarea>
                            </div>
                            <!-- 新增弱點時的錯誤/成功訊息提示區域 -->
                            <div id="addVulnFeedback" class="alert alert-danger small mt-2 py-2" style="display: none;" role="alert"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="saveCustomVulnerabilityBtn">儲存新增</button>
                    </div>
                </div>
            </div>
        </div> <!-- END 手動新增弱點彈窗 -->

        <!-- 區塊 2: 報告內容顯示 (預設隱藏) -->
        <div id="display-container" class="report-section" data-section-title="2. 報告內容" style="display: none;">

            <!-- <<< NEW: Placeholder for Target Info >>> -->
            <div id="selectedReportTargetInfo" class="mb-3 text-muted small target-info-display" style="display: none; border-bottom: 1px dotted #ccc; padding-bottom: 10px;">
                <!-- Content will be filled by JS -->
                <span><strong>標的名稱:</strong> <span id="targetNameDisplay">N/A</span></span>
                <br>
                <span><strong>目標 URL:</strong> <span id="targetUrlDisplay">N/A</span></span>
            </div>
            <!-- <<< END NEW >>> -->

            <div id="reportDetails">
                <!-- 報告標頭資訊 (掃描時間、摘要、圖表) 將由 JS 動態填入 -->
                <div id="reportHeaderInfo"></div>

                <!-- 過濾器區域 (預設隱藏，選擇報告後顯示) -->
                <div id="filterSection" style="display: none;">
                     <!-- 目前生效的過濾條件顯示 -->
                     <div id="filterStatus" class="mb-2">
                        <strong>目前篩選：</strong> <span id="activeFiltersDisplay">無</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1 ms-2" id="clearFiltersBtn" title="清除所有篩選條件" style="display: none;"><i class="fas fa-times"></i> 清除</button>
                    </div>
                    <!-- 過濾表單 -->
                    <form id="filterForm" class="filter-form pt-2">
                        <div class="row">
                            <!-- 嚴重性過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>嚴重性:</h5>
                                <!-- 嚴重性 Checkbox 由後端 Jinja2 生成 -->
                                {% for key, display_name in severities.items() %}
                                    {% set lower_key = key.lower() %}
                                    {% if lower_key in severity_levels_map %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input severity-checkbox filter-checkbox" type="checkbox" id="severity-{{ lower_key }}" name="severity" value="{{ lower_key }}">
                                            <label class="form-check-label" for="severity-{{ lower_key }}">{{ display_name }}</label>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <!-- 審查狀況過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>審查狀況:</h5>
                                <!-- 狀態 Checkbox 由後端 Jinja2 生成 -->
                                {% for value, text in status_options.items() %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input status-filter-checkbox filter-checkbox" type="checkbox" id="status-filter-{{ value | urlencode }}" name="status_filter" value="{{ value }}">
                                        <label class="form-check-label" for="status-filter-{{ value | urlencode }}">{{ text }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                            <!-- 截圖狀態過濾 -->
                            <div class="col-lg-3 filter-group">
                                <h5>截圖狀態:</h5>
                                <!-- 截圖狀態 Checkbox 由後端 Jinja2 生成 -->
                                {% if screenshot_filter_options %}
                                    {% for value, text in screenshot_filter_options.items() %}
                                        <div class="form-check">
                                            <input class="form-check-input screenshot-status-filter-checkbox filter-checkbox" type="checkbox" id="ss-filter-{{ value }}" name="screenshot_status_filter" value="{{ value }}">
                                            <label class="form-check-label" for="ss-filter-{{ value }}">{{ text }}</label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted small">截圖過濾器選項未載入。</p>
                                {% endif %}
                            </div>
                            <!-- 來源過濾 -->
                             <div class="col-lg-3 filter-group">
                                <h5>來源:</h5>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input source-filter-checkbox filter-checkbox" type="checkbox" id="source-filter-appscan" name="source_filter" value="appscan" checked>
                                    <label class="form-check-label" for="source-filter-appscan">AppScan</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input source-filter-checkbox filter-checkbox" type="checkbox" id="source-filter-manual" name="source_filter" value="manual" checked>
                                    <label class="form-check-label" for="source-filter-manual">手動新增</label>
                                </div>
                                <!-- 錯誤來源過濾器已移除，通常不需要從 UI 過濾此項 -->
                            </div>
                        </div>
                    </form>
                    <hr/> <!-- 過濾器下方分隔線 -->
                </div> <!-- END #filterSection -->

                <!-- 問題列表標頭 (包含計數和排序控制項) -->
                <div class="issue-list-header" style="display: none;">
                    <h4>問題列表 (<span id="issueCount">0</span>)</h4>
                    <div id="sortControls" class="d-flex align-items-center">
                        <label for="sortSelect" class="col-form-label col-form-label-sm me-2">排序方式:</label>
                        <select id="sortSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="severity">嚴重程度 (高到低)</option>
                            <option value="url">URL (A-Z)</option>
                            <option value="issue_type">弱點名稱 (A-Z)</option>
                            <option value="status">審查狀況 (A-Z)</option>
                        </select>
                    </div>
                </div>

                <!-- 問題列表容器 (將由 JS 動態填入) -->
                <div id="reportIssueList">
                    <!-- 初始提示訊息 -->
                    <div class="alert alert-secondary initial-message" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        報告內容將顯示於此。請先從上方選擇一個報告檔案。
                    </div>
                </div> <!-- END #reportIssueList -->
            </div> <!-- END #reportDetails -->
        </div> <!-- END #display-container -->
    </div> <!-- END .container -->

     <!-- 浮動操作按鈕 (Floating Action Buttons) -->
     <div class="fab-container">
        <!-- 回到頂部按鈕 -->
        <button type="button" class="btn btn-secondary btn-fab" id="fabScrollTop" title="回到頂部">
            <i class="fas fa-arrow-up"></i>
        </button>
        <!-- 選擇報告按鈕 (觸發彈窗) -->
         <button type="button" class="btn btn-primary btn-fab" id="fabSelectReport" title="選擇報告" data-bs-toggle="modal" data-bs-target="#reportSelectModal">
            <i class="fas fa-folder-open"></i>
        </button>
        <!-- 開啟 .scan 按鈕 (預設隱藏) -->
        <button type="button" class="btn btn-info btn-fab" id="fabOpenScanFile" title="開啟 .scan 檔案" style="display: none;">
            <i class="fas fa-external-link-alt"></i>
        </button>
        <!-- 報告列表過濾器按鈕 (下拉菜單) -->
        <div class="dropup"> <!-- 使用 dropup 使菜單向上彈出 -->
            <button type="button" class="btn btn-warning btn-fab dropdown-toggle" id="fabFilterToggle" data-bs-toggle="dropdown" aria-expanded="false" title="篩選報告列表">
                <i class="fas fa-list-check"></i>
            </button>
            <ul class="dropdown-menu fab-filter-menu" aria-labelledby="fabFilterToggle">
                <li><h6 class="dropdown-header">篩選報告列表</h6></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="low">低風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="medium">中風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="high">高風險及以上</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="critical">僅重大風險</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="errors_only">僅異常掃描</a></li>
                <li><a class="dropdown-item fab-report-filter" href="#" data-value="informational">所有報告 (含缺失)</a></li>
            </ul>
        </div>
    </div> <!-- END .fab-container -->

    <!-- JavaScript 主要邏輯區塊 -->
    <script>
        // --- 全局狀態和顏色映射 ---
        const statusOptionColors = {
            '未審查': { bg: '#fff3cd', text: '#664d03' },
            '人工審查中': { bg: '#fff3cd', text: '#664d03' },
            '誤判': { bg: '#e2e3e5', text: '#41464b' },
            '已確認弱點': { bg: '#f8d7da', text: '#58151c' },
            '已自動排除': { bg: '#cfe2ff', text: '#052c65' },
            '處理錯誤': { bg: '#ffcccc', text: '#a00000' },
            'default': { bg: '#ffffff', text: '#212529' }
        };

        // ========================================================================
        // === 全局 DOM 元素變數 (在 DOMContentLoaded 中初始化) ===
        // ========================================================================
        let reportModalListBody, selectedReportDisplay, openScanFileButton, exportButton,
            exportAllNotesButton, filterForm, filterSection, reportDetailsDiv,
            reportListErrorDiv, reportFilterSelect, issueListHeaderDiv, issueCountSpan,
            sortControlsDiv, sortSelect, reportHeaderInfoDiv, issueListContainer,
            previewModalElement, previewImage, previewError, modalConfirmButton,
            selectionContainer, displayContainer, darkModeToggle, fabContainer, fabScrollTop,
            fabSelectReport, fabOpenScanFile, fabFilterToggle, exportOptionsModalElement,
            modalMergeDuplicatesCheckbox, modalIncludeNotesCheckbox, confirmExportBtn,
            exportAbnormalButton, addVulnerabilityBtn, addVulnerabilityModalElement,
            addVulnerabilityForm, saveCustomVulnerabilityBtn, addVulnFeedback,
            weaknessDatalist, filterStatusDiv, activeFiltersDisplaySpan, clearFiltersBtn,
            exportJsonButton, selectedReportTargetInfoDiv, targetNameDisplaySpan, targetUrlDisplaySpan; // <<< Added target info elements

        // ========================================================================
        // === 全局狀態變數 ===
        // ========================================================================
        let currentReportFilename = '';
        let activeCollapses = [];
        let currentReportFullData = null;
        let severityChartInstance = null;
        let reportSelectModal = null;
        let previewModal = null;
        let exportOptionsModal = null;
        let addVulnerabilityModal = null;
        let blobToUpload = null;
        let fileToUpload = null; // <<< For file input uploads
        let uploadContext = {};
        let currentReportList = [];
        let currentModalReportList = [];
        let currentReportIndex = -1;
        let groupedIssuesData = {};

        // ========================================================================
        // === 全局常數 (在 DOMContentLoaded 中根據後端數據定義) ===
        // ========================================================================
        let CURRENT_PROJECT_NAME, CURRENT_PROJECT_DISPLAY_NAME, BASE_CONFIRMED_EXPORT_URL,
            BASE_ABNORMAL_EXPORT_URL, WEAKNESS_NAME_LIST, STATUS_OPTIONS, SEVERITY_OPTIONS,
            SEVERITY_LEVELS, AUTO_EXCLUDED_STATUS, SCREENSHOT_FILTER_OPTIONS, SEVERITY_KEYS,
            STATUS_KEYS, SCREENSHOT_FILTER_KEYS, displayNameToKeyMap, EXTERNAL_LINK_REASONING;

        const ALLOWED_IMAGE_TYPES = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp'];
        const SCAN_STATUS = { SUCCESS: "成功", FAILED: "失敗", ABORTED: "已中斷", RUNNING: "執行中", UNKNOWN: "狀態未知", PARSE_ERROR: "解析錯誤", INCOMPLETE: "格式不完整", READ_ERROR: "讀取錯誤", MISSING: "Missing", FILE_NOT_FOUND: "檔案遺失" };
        const STATUS_EMOJI = { [SCAN_STATUS.SUCCESS]: '✅', [SCAN_STATUS.FAILED]: '❌', [SCAN_STATUS.PARSE_ERROR]: '❌', [SCAN_STATUS.READ_ERROR]: '❌', [SCAN_STATUS.ABORTED]: '⚠️', [SCAN_STATUS.INCOMPLETE]: '⚠️', [SCAN_STATUS.RUNNING]: '⏳', [SCAN_STATUS.UNKNOWN]: '❓', [SCAN_STATUS.MISSING]: '🚫', [SCAN_STATUS.FILE_NOT_FOUND]: '🚫' };
        const problematicStatuses = [ SCAN_STATUS.FAILED, SCAN_STATUS.PARSE_ERROR, SCAN_STATUS.READ_ERROR, SCAN_STATUS.INCOMPLETE, SCAN_STATUS.FILE_NOT_FOUND, SCAN_STATUS.MISSING, SCAN_STATUS.UNKNOWN, SCAN_STATUS.ABORTED ];
        const LS_DARK_MODE_KEY = `appscanViewerDarkMode_v1`;
        let LS_SEVERITY_FILTER_KEY, LS_STATUS_FILTER_KEY, LS_SCREENSHOT_FILTER_KEY,
            LS_SOURCE_FILTER_KEY, LS_REPORT_FILTER_KEY, LS_SORT_KEY,
            LS_MODAL_MERGE_DUP_KEY, LS_MODAL_INCLUDE_NOTES_KEY;
        const DEFAULT_SEVERITY_FILTERS = ['critical', 'high', 'medium', 'low', 'informational'];
        let DEFAULT_STATUS_FILTERS;
        const DEFAULT_SCREENSHOT_FILTERS = [];
        const DEFAULT_SOURCE_FILTERS = ['appscan', 'manual'];
        const DEFAULT_REPORT_FILTER = 'low';
        const DEFAULT_SORT = 'severity';
        const DEFAULT_STATUS = '未審查';

        // --- API URL 輔助函式 ---
        function getApiUrl(endpoint) {
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
            return `/project/${encodeURIComponent(CURRENT_PROJECT_NAME)}/${cleanEndpoint}`;
        }

        // ========================================================================
        // === DOMContentLoaded 事件監聽器 (初始化頁面) ===
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // --- 定義依賴後端注入的常數 ---
            CURRENT_PROJECT_NAME = {{ project_name | tojson | safe }};
            CURRENT_PROJECT_DISPLAY_NAME = {{ project_display_name | default(project_name) | tojson | safe }};
            BASE_CONFIRMED_EXPORT_URL = "{{ url_for('export_confirmed_vulnerabilities', project_name=project_name) }}";
            BASE_ABNORMAL_EXPORT_URL = "{{ url_for('export_abnormal_reports', project_name=project_name) }}";
            WEAKNESS_NAME_LIST = {{ weakness_name_list | default([]) | tojson | safe }};
            STATUS_OPTIONS = {{ status_options | default({}) | tojson | safe }};
            SEVERITY_OPTIONS = {{ severities | default({}) | tojson | safe }};
            SEVERITY_LEVELS = {{ severity_levels_map | default({}) | tojson | safe }};
            AUTO_EXCLUDED_STATUS = {{ auto_excluded_status_value | default('已自動排除') | tojson | safe }};
            SCREENSHOT_FILTER_OPTIONS = {{ screenshot_filter_options | default({}) | tojson | safe }};
            EXTERNAL_LINK_REASONING = EXTERNAL_LINK_REASONING_TEXT;
            commonNotesData = {{ common_notes | default({}) | tojson | safe }};
            console.log("Common notes loaded:", Object.keys(commonNotesData).length, "types");

            // --- 定義衍生的常數 ---
            SEVERITY_KEYS = Object.keys(SEVERITY_LEVELS);
            STATUS_KEYS = Object.keys(STATUS_OPTIONS);
            SCREENSHOT_FILTER_KEYS = Object.keys(SCREENSHOT_FILTER_OPTIONS);
            displayNameToKeyMap = {};
            for (const [key, value] of Object.entries(SEVERITY_OPTIONS)) { displayNameToKeyMap[value] = key.toLowerCase(); };
            if (SEVERITY_OPTIONS["Informational"]) { displayNameToKeyMap[SEVERITY_OPTIONS["Informational"]] = "informational"; }
            DEFAULT_STATUS_FILTERS = STATUS_KEYS.filter(k => k !== AUTO_EXCLUDED_STATUS);

            // --- 定義 LocalStorage 鍵名 ---
            LS_SEVERITY_FILTER_KEY = `appscanViewerSeverityFilters_${CURRENT_PROJECT_NAME}_v2`;
            LS_STATUS_FILTER_KEY = `appscanViewerStatusFilters_${CURRENT_PROJECT_NAME}_v2`;
            LS_SCREENSHOT_FILTER_KEY = `appscanViewerScreenshotFilters_${CURRENT_PROJECT_NAME}_v1`;
            LS_SOURCE_FILTER_KEY = `appscanViewerSourceFilters_${CURRENT_PROJECT_NAME}_v1`;
            LS_REPORT_FILTER_KEY = `appscanViewerReportFilter_${CURRENT_PROJECT_NAME}_v1`;
            LS_SORT_KEY = `appscanViewerSortOption_${CURRENT_PROJECT_NAME}_v1`;
            LS_MODAL_MERGE_DUP_KEY = `appscanViewerModalMergeDup_${CURRENT_PROJECT_NAME}_v1`;
            LS_MODAL_INCLUDE_NOTES_KEY = `appscanViewerModalIncludeNotes_${CURRENT_PROJECT_NAME}_v1`;

            // --- 初始化全局 DOM 元素變數 ---
            console.log("DOMContentLoaded: Initializing DOM element variables...");
            reportModalListBody = document.getElementById('reportModalListBody');
            selectedReportDisplay = document.getElementById('selectedReportDisplay');
            openScanFileButton = document.getElementById('openScanFileButton');
            exportButton = document.getElementById('exportButton');
            exportJsonButton = document.getElementById('exportJsonButton');
            exportAllNotesButton = document.getElementById('exportAllNotesButton');
            filterForm = document.getElementById('filterForm');
            filterSection = document.getElementById('filterSection');
            reportDetailsDiv = document.getElementById('reportDetails');
            reportListErrorDiv = document.getElementById('reportListError');
            reportFilterSelect = document.getElementById('reportFilterSelect');
            issueListHeaderDiv = document.querySelector('.issue-list-header');
            issueCountSpan = document.getElementById('issueCount');
            sortControlsDiv = document.getElementById('sortControls');
            sortSelect = document.getElementById('sortSelect');
            reportHeaderInfoDiv = document.getElementById('reportHeaderInfo');
            issueListContainer = document.getElementById('reportIssueList');
            previewModalElement = document.getElementById('screenshotPreviewModal');
            previewImage = document.getElementById('previewImage');
            previewError = document.getElementById('previewError');
            modalConfirmButton = document.getElementById('modalConfirmButton');
            selectionContainer = document.getElementById('selection-container');
            displayContainer = document.getElementById('display-container');
            darkModeToggle = document.getElementById('darkModeToggle');
            fabContainer = document.querySelector('.fab-container');
            fabScrollTop = document.getElementById('fabScrollTop');
            fabSelectReport = document.getElementById('fabSelectReport');
            fabOpenScanFile = document.getElementById('fabOpenScanFile');
            fabFilterToggle = document.getElementById('fabFilterToggle');
            exportOptionsModalElement = document.getElementById('exportOptionsModal');
            modalMergeDuplicatesCheckbox = document.getElementById('modalMergeDuplicatesCheckbox');
            modalIncludeNotesCheckbox = document.getElementById('modalIncludeNotesCheckbox');
            confirmExportBtn = document.getElementById('confirmExportBtn');
            exportAbnormalButton = document.getElementById('exportAbnormalButton');
            addVulnerabilityBtn = document.getElementById('addVulnerabilityBtn');
            addVulnerabilityModalElement = document.getElementById('addVulnerabilityModal');
            addVulnerabilityForm = document.getElementById('addVulnerabilityForm');
            saveCustomVulnerabilityBtn = document.getElementById('saveCustomVulnerabilityBtn');
            addVulnFeedback = document.getElementById('addVulnFeedback');
            weaknessDatalist = document.getElementById('weakness-names-list');
            filterStatusDiv = document.getElementById('filterStatus');
            activeFiltersDisplaySpan = document.getElementById('activeFiltersDisplay');
            clearFiltersBtn = document.getElementById('clearFiltersBtn');
            selectedReportTargetInfoDiv = document.getElementById('selectedReportTargetInfo'); // <<< Initialize target info div
            targetNameDisplaySpan = document.getElementById('targetNameDisplay'); // <<< Initialize target name span
            targetUrlDisplaySpan = document.getElementById('targetUrlDisplay'); // <<< Initialize target url span
            console.log("DOMContentLoaded: DOM element variables initialized.");

            // --- 初始化功能 ---
            console.log(`DOM loaded for project: ${CURRENT_PROJECT_NAME} (${CURRENT_PROJECT_DISPLAY_NAME})`);
            document.title = `${CURRENT_PROJECT_DISPLAY_NAME} - AppScan 報告檢視器`;

            // 初始化 Bootstrap Modals
            try {
                const reportModalEl = document.getElementById('reportSelectModal');
                const previewModalEl = document.getElementById('screenshotPreviewModal');
                const exportOptionsModalEl = document.getElementById('exportOptionsModal');
                const addVulnerabilityModalEl = document.getElementById('addVulnerabilityModal');

                if (reportModalEl) { reportSelectModal = new bootstrap.Modal(reportModalEl); console.log("Report modal initialized."); } else { console.error("Report modal element ('reportSelectModal') not found!"); }
                if (previewModalEl) {
                    previewModal = new bootstrap.Modal(previewModalEl); console.log("Preview modal initialized.");
                    if (!previewModalEl.dataset.listenerAttached) {
                        // <<< MODIFIED Modal Cleanup Listener >>>
                        previewModalEl.addEventListener('hidden.bs.modal', () => {
                            if (previewImage.src && previewImage.src.startsWith('blob:')) URL.revokeObjectURL(previewImage.src);
                            previewImage.src = '#';
                            previewImage.style.display = 'none';
                            previewError.style.display = 'none';
                            const captionInput = document.getElementById('previewCaptionInput');
                            if (captionInput) captionInput.value = '';
                            const captionDisplay = document.getElementById('previewCaptionDisplay');
                            if (captionDisplay) captionDisplay.textContent = '';

                            // Clear context
                            blobToUpload = null;
                            fileToUpload = null; // <<< Clear file upload context
                            uploadContext = {};
                            previewModalEl.dataset.modalMode = '';
                            previewModalEl.dataset.issueId = '';
                            previewModalEl.dataset.screenshotFilename = '';

                             // Reset button state just in case
                             const modalConfirmBtn = document.getElementById('modalConfirmButton');
                             if(modalConfirmBtn) {
                                 resetModalConfirmButton(modalConfirmBtn, "確認"); // Use a default text
                             }
                        });
                        previewModalEl.dataset.listenerAttached = 'true';
                    }
                } else { console.error("Preview modal element ('screenshotPreviewModal') not found!"); }
                if (exportOptionsModalEl) { exportOptionsModal = new bootstrap.Modal(exportOptionsModalEl); console.log("Export options modal initialized."); } else { console.error("Export options modal element ('exportOptionsModal') not found!"); }
                if (addVulnerabilityModalEl) {
                    addVulnerabilityModal = new bootstrap.Modal(addVulnerabilityModalEl); console.log("Add Vulnerability modal initialized.");
                    addVulnerabilityModalEl.addEventListener('hidden.bs.modal', () => {
                        addVulnerabilityForm.reset();
                        addVulnFeedback.style.display = 'none';
                        addVulnFeedback.textContent = '';
                        addVulnerabilityForm.classList.remove('was-validated');
                        const issueNameInput = document.getElementById('addVulnIssueName');
                        issueNameInput?.classList.remove('is-invalid');
                    });
                } else { console.error("Add Vulnerability modal element ('addVulnerabilityModal') not found!"); }

                 const previewCommonNoteBtn = document.getElementById('preview-common-note-btn');
                 if (previewCommonNoteBtn) {
                     console.log("Preview common note button dropdown initialized.");
                 }

            } catch (e) {
                console.error("Error initializing Modals:", e);
                alert("無法初始化互動視窗元件，部分功能可能異常。");
            }

            // 載入並應用 LocalStorage 中的設定
            loadAndApplyDarkMode();
            loadAndApplyFilters();
            loadAndApplyReportFilter();
            loadAndApplySort();
            updateFilterStatusDisplay();
            populateWeaknessDatalist();

            // 初始化時獲取報告列表
            fetchReportList();
            toggleAbnormalExportButtonVisibility();

            // --- 綁定事件監聽器 ---
            console.log("DOMContentLoaded: Attaching event listeners...");
            if (reportFilterSelect) reportFilterSelect.addEventListener('change', handleReportListFilterChange);
            if (filterForm) filterForm.querySelectorAll('input.filter-checkbox').forEach(cb => cb.addEventListener('change', handleFilterChange));
            if (issueListContainer) {
                issueListContainer.addEventListener('change', handleIssueCardChange);
                issueListContainer.addEventListener('click', handleIssueCardClick);
            } else { console.error("issueListContainer not found, cannot add listeners!"); }
            if (reportModalListBody) {
                 reportModalListBody.addEventListener('change', handleReportModalChange);
                 reportModalListBody.addEventListener('click', handleModalReportClick);
            }
            if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
            // <<< UPDATED: Attach listener to the modal confirm button >>>
            if (modalConfirmButton) {
                modalConfirmButton.addEventListener('click', handleModalConfirm);
            }
            if (openScanFileButton) openScanFileButton.addEventListener('click', handleOpenScanFile);
            if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);
            if (exportButton) exportButton.addEventListener('click', handleExportButtonClick);
            if (confirmExportBtn) confirmExportBtn.addEventListener('click', handleConfirmExport);
            if (exportAbnormalButton) exportAbnormalButton.addEventListener('click', handleExportAbnormalClick);
            if (exportAllNotesButton) exportAllNotesButton.addEventListener('click', handleExportAllNotesClick);
            if (addVulnerabilityBtn) addVulnerabilityBtn.addEventListener('click', handleAddVulnerabilityClick);
            if (saveCustomVulnerabilityBtn) saveCustomVulnerabilityBtn.addEventListener('click', handleSaveCustomVulnerability);
            if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', handleClearFilters);
            if (fabScrollTop) fabScrollTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            if (fabSelectReport) fabSelectReport.addEventListener('click', () => { if(reportSelectModal) reportSelectModal.show(); });
            if (fabOpenScanFile) fabOpenScanFile.addEventListener('click', handleOpenScanFile);
            if (fabFilterToggle) document.querySelectorAll('.fab-report-filter').forEach(item => { item.addEventListener('click', handleFabReportFilterClick); });
            console.log("DOMContentLoaded: Event listeners attached.");

            // <<< NEW: Add listener for dropdown show event to populate common notes >>>
            document.addEventListener('show.bs.dropdown', function (event) {
                const dropdownButton = event.relatedTarget;
                if (dropdownButton && dropdownButton.classList.contains('btn-insert-common-note')) {
                    showCommonNotesDropdown(dropdownButton); // Populate the menu when it's about to show
                }
            });

            // 初始化 FAB 按鈕的可見性
            updateFabNavButtons();

        }); // END DOMContentLoaded

        // ========================================================================
        // === 深色模式處理邏輯 ===
        // ========================================================================
        function loadAndApplyDarkMode() {
            const savedMode = localStorage.getItem(LS_DARK_MODE_KEY);
            const isDark = savedMode === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            updateDarkModeButton(isDark);
            document.documentElement.style.setProperty('--sticky-bg', isDark ? '#1a1a1a' : '#ffffff');
            document.documentElement.style.setProperty('--sticky-border', isDark ? '#444' : '#dee2e6');
        }
        function updateDarkModeButton(isDark) {
            if (!darkModeToggle) return;
            const icon = darkModeToggle.querySelector('i');
            const text = darkModeToggle.querySelector('span');
            if (isDark) {
                icon?.classList.replace('fa-moon', 'fa-sun');
                if (text) text.textContent = '淺色模式';
                darkModeToggle.title = '切換至淺色模式';
            } else {
                icon?.classList.replace('fa-sun', 'fa-moon');
                if (text) text.textContent = '深色模式';
                darkModeToggle.title = '切換至深色模式';
            }
        }
        function toggleDarkMode() {
            const isCurrentlyDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(LS_DARK_MODE_KEY, isCurrentlyDark ? 'dark' : 'light');
            updateDarkModeButton(isCurrentlyDark);
            document.documentElement.style.setProperty('--sticky-bg', isCurrentlyDark ? '#1a1a1a' : '#ffffff');
            document.documentElement.style.setProperty('--sticky-border', isCurrentlyDark ? '#444' : '#dee2e6');
            if (severityChartInstance && currentReportFullData?.summary) {
                renderSeverityChart(currentReportFullData.summary);
            }
        }

        // ========================================================================
        // === 輔助函式 ===
        // ========================================================================
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return 'N/A';
            if (typeof unsafe !== 'string') {
                try { unsafe = String(unsafe); } catch (e) { return 'Err'; }
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        function disposeCollapses() {
            activeCollapses.forEach(c => {
                if (c) { try { c.dispose(); } catch (e) {} }
            });
            activeCollapses = [];
        }
        function initializeCollapses() {
            disposeCollapses();
            if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                const collapseElements = Array.from(document.querySelectorAll('.collapse'));
                activeCollapses = collapseElements.map(el => {
                    try {
                        return bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, { toggle: false });
                    } catch (e) { console.error("Collapse initialization error:", e); return null; }
                }).filter(Boolean);
            } else { console.warn("Bootstrap Collapse not ready for initialization."); }
        }
        function getSeverityBadgeColor(key) {
            switch (key?.toLowerCase()) {
                case 'critical': return 'badge-custom-critical';
                case 'high': return 'badge-custom-high';
                case 'medium': return 'badge-custom-medium';
                case 'low': return 'badge-custom-low';
                case 'informational': return 'badge-custom-informational';
                default: return 'badge-custom-unknown';
            }
        }
        function extractHostname(urlString) {
            if (!urlString || typeof urlString !== 'string' || urlString.toLowerCase() === 'n/a') return null;
            try {
                let urlToParse = urlString;
                if (!urlString.startsWith('http://') && !urlString.startsWith('https://')) {
                    urlToParse = urlString.includes('.') ? ('https://' + urlString) : null;
                }
                if (!urlToParse) return null;
                const url = new URL(urlToParse);
                let hostname = url.hostname;
                if (hostname.startsWith('[') && hostname.endsWith(']')) {
                    hostname = hostname.substring(1, hostname.length - 1);
                }
                return hostname || null;
            } catch (e) {
                const match = urlString.match(/^(?:(?:https?|ftp):\/\/)?(?:www\.)?([^\/:\?#]+)/i);
                if (match && match[1]) {
                    let hostname = match[1];
                    if (hostname.startsWith('[') && hostname.endsWith(']')) {
                        hostname = hostname.substring(1, hostname.length - 1);
                    }
                    return hostname;
                }
                return null;
            }
        }
        // <<< MODIFIED: resetReportSelection >>>
        function resetReportSelection() {
            currentReportFilename = ''; currentReportFullData = null; currentReportIndex = -1; groupedIssuesData = {};
            if(selectedReportDisplay) { selectedReportDisplay.textContent = '尚未選擇報告'; selectedReportDisplay.classList.remove('has-selection'); }
            if (severityChartInstance) { severityChartInstance.destroy(); severityChartInstance = null; }
            if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = '';
            if(issueListContainer) { issueListContainer.innerHTML = '<div class="alert alert-secondary initial-message" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>請從上方選擇報告檔案。</div>'; }
            if(filterSection) filterSection.style.display = 'none';
            if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none';
            if(displayContainer) displayContainer.style.display = 'none';
            if(filterStatusDiv) filterStatusDiv.style.display = 'none';
            // <<< NEW: Reset Target Info Display >>>
            if (selectedReportTargetInfoDiv) {
                 selectedReportTargetInfoDiv.style.display = 'none';
                 if(targetNameDisplaySpan) targetNameDisplaySpan.textContent = 'N/A';
                 if(targetUrlDisplaySpan) targetUrlDisplaySpan.textContent = 'N/A';
            }
            // <<< END NEW >>>
            if(openScanFileButton) openScanFileButton.style.display = 'none';
            if(addVulnerabilityBtn) addVulnerabilityBtn.disabled = true;
            if(fabOpenScanFile) fabOpenScanFile.style.display = 'none';
            updateFabNavButtons();
            disposeCollapses();
        }
        function updateFabNavButtons() {
            if(fabOpenScanFile) { fabOpenScanFile.style.display = (currentReportFilename && !currentReportFilename.endsWith("-找不到掃描檔")) ? 'flex' : 'none'; }
        }
        // <<< NEW Helper Functions >>>
        function findIssueElement(issueId) {
            if (!issueId) return null;
            return issueListContainer?.querySelector(`.issue-card[id*="issue-${issueId.replace(/[^a-zA-Z0-9-_]/g, '_')}"]`) ||
                   issueListContainer?.querySelector(`.issue-group-container[data-group-members*='"issueId":"${issueId}"']`);
        }
         function findScreenshotListItem(issueId, filename) {
             const issueElement = findIssueElement(issueId);
             if (!issueElement || !filename) return null;
             const links = issueElement.querySelectorAll('.uploaded-screenshots-list a.screenshot-view-link');
             for (const link of links) {
                 if (link.dataset.filename === filename) {
                     return link.closest('li');
                 }
             }
             return null;
         }
        function resetModalConfirmButton(button, originalText) {
            if (button?.closest('body')) {
                 button.disabled = false;
                 button.innerHTML = originalText || "確認";
             }
        }

        // ========================================================================
        // === 過濾器/排序狀態的讀取、保存與顯示 ===
        // ========================================================================
        function loadAndApplyFilters() {
             let savedSeverities = null, savedStatuses = null, savedScreenshotStatuses = null, savedSources = null;
             try { const sD = localStorage.getItem(LS_SEVERITY_FILTER_KEY); if (sD) savedSeverities = JSON.parse(sD); if (!Array.isArray(savedSeverities)) savedSeverities = null; } catch (e) { console.warn("Failed to parse saved severity filters", e); }
             try { const stD = localStorage.getItem(LS_STATUS_FILTER_KEY); if (stD) savedStatuses = JSON.parse(stD); if (!Array.isArray(savedStatuses)) savedStatuses = null; } catch (e) { console.warn("Failed to parse saved status filters", e); }
             try { const ssD = localStorage.getItem(LS_SCREENSHOT_FILTER_KEY); if (ssD) savedScreenshotStatuses = JSON.parse(ssD); if (!Array.isArray(savedScreenshotStatuses)) savedScreenshotStatuses = null; } catch (e) { console.warn("Failed to parse saved screenshot filters", e); }
             try { const srcD = localStorage.getItem(LS_SOURCE_FILTER_KEY); if (srcD) savedSources = JSON.parse(srcD); if (!Array.isArray(savedSources)) savedSources = null; } catch (e) { console.warn("Failed to parse saved source filters", e); }

             const severitiesToCheck = savedSeverities ?? DEFAULT_SEVERITY_FILTERS;
             const statusesToCheck = savedStatuses ?? DEFAULT_STATUS_FILTERS;
             const screenshotStatusesToCheck = savedScreenshotStatuses ?? DEFAULT_SCREENSHOT_FILTERS;
             const sourcesToCheck = savedSources ?? DEFAULT_SOURCE_FILTERS;

             if(filterForm) {
                 filterForm.querySelectorAll('.severity-checkbox').forEach(cb => { cb.checked = severitiesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.status-filter-checkbox').forEach(cb => { cb.checked = statusesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.screenshot-status-filter-checkbox').forEach(cb => { cb.checked = screenshotStatusesToCheck.includes(cb.value); });
                 filterForm.querySelectorAll('.source-filter-checkbox').forEach(cb => { cb.checked = sourcesToCheck.includes(cb.value); });
             }
        }
        function saveFiltersToLocalStorage() {
            if (!filterForm) return;
            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.value);
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked'))
                                  .map(cb => cb.value)
                                  .filter(val => val === 'appscan' || val === 'manual');
            try { localStorage.setItem(LS_SEVERITY_FILTER_KEY, JSON.stringify(severities)); } catch (e) { console.error("Failed to save severity filters", e); }
            try { localStorage.setItem(LS_STATUS_FILTER_KEY, JSON.stringify(statuses)); } catch (e) { console.error("Failed to save status filters", e); }
            try { localStorage.setItem(LS_SCREENSHOT_FILTER_KEY, JSON.stringify(screenshotStatuses)); } catch (e) { console.error("Failed to save screenshot filters", e); }
            try { localStorage.setItem(LS_SOURCE_FILTER_KEY, JSON.stringify(sources)); } catch (e) { console.error("Failed to save source filters", e); }
        }
        function loadAndApplyReportFilter() {
            if(reportFilterSelect) { reportFilterSelect.value = localStorage.getItem(LS_REPORT_FILTER_KEY) || DEFAULT_REPORT_FILTER; }
        }
        function loadAndApplySort() {
            if(sortSelect) { sortSelect.value = localStorage.getItem(LS_SORT_KEY) || DEFAULT_SORT; }
        }
        function getActiveFilters() {
            if (!filterForm) return { severities: [], statuses: [], screenshotStatuses: [], sources: [], sourceFiltered: false };
            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.labels[0]?.textContent || cb.value);
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked'))
                                  .filter(cb => cb.value === 'appscan' || cb.value === 'manual')
                                  .map(cb => cb.labels[0]?.textContent || cb.value);
            const allAvailableSources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox'))
                                        .filter(cb => cb.value === 'appscan' || cb.value === 'manual')
                                        .map(cb => cb.labels[0]?.textContent || cb.value);
            const sourceFiltered = sources.length > 0 && sources.length < allAvailableSources.length;
            return { severities, statuses, screenshotStatuses, sources, sourceFiltered };
        }
        function updateFilterStatusDisplay() {
            if (!filterStatusDiv || !activeFiltersDisplaySpan) return;
            const { severities, statuses, screenshotStatuses, sources, sourceFiltered } = getActiveFilters();
            const hasActiveFilters = severities.length < DEFAULT_SEVERITY_FILTERS.length ||
                                     statuses.length < DEFAULT_STATUS_FILTERS.length ||
                                     screenshotStatuses.length > 0 ||
                                     sourceFiltered;
            if (hasActiveFilters) {
                let html = '';
                const getBadge = (label, values, colorClass) => {
                    let show = false;
                    if (label === '嚴重性') show = values.length < DEFAULT_SEVERITY_FILTERS.length;
                    else if (label === '狀況') show = values.length < DEFAULT_STATUS_FILTERS.length;
                    else if (label === '截圖') show = values.length > 0;
                    else if (label === '來源') show = sourceFiltered;
                    return show ? ` <span class="badge ${colorClass}">${label}: ${values.join(', ')}</span>` : '';
                };
                html += getBadge('嚴重性', severities, 'bg-danger');
                html += getBadge('狀況', statuses, 'bg-info text-dark');
                html += getBadge('截圖', screenshotStatuses, 'bg-warning text-dark');
                if (sourceFiltered) html += getBadge('來源', sources, 'bg-primary');
                activeFiltersDisplaySpan.innerHTML = html || '無有效篩選';
                filterStatusDiv.style.display = 'block';
                if (clearFiltersBtn) clearFiltersBtn.style.display = 'inline-block';
            } else {
                activeFiltersDisplaySpan.textContent = '無';
                filterStatusDiv.style.display = 'none';
                if (clearFiltersBtn) clearFiltersBtn.style.display = 'none';
            }
        }
        function handleFilterChange() {
             saveFiltersToLocalStorage();
             updateFilterStatusDisplay();
             if (currentReportFilename) {
                 const scrollY = window.scrollY;
                 fetchReportData(currentReportFilename, scrollY);
             }
        }
        function handleClearFilters() {
            if (!filterForm) return;
            filterForm.querySelectorAll('input.filter-checkbox').forEach(cb => {
                 cb.checked = (cb.value !== 'error');
            });
            saveFiltersToLocalStorage();
            updateFilterStatusDisplay();
            if (currentReportFilename) {
                 const scrollY = window.scrollY;
                 fetchReportData(currentReportFilename, scrollY);
            }
        }

        // ========================================================================
        // === 匯出選項彈窗狀態的讀取與保存 ===
        // ========================================================================
        function loadExportModalOptions() {
             if (!modalMergeDuplicatesCheckbox || !modalIncludeNotesCheckbox) return;
             const savedMerge = localStorage.getItem(LS_MODAL_MERGE_DUP_KEY);
             const savedNotes = localStorage.getItem(LS_MODAL_INCLUDE_NOTES_KEY);
             modalMergeDuplicatesCheckbox.checked = savedMerge === 'true';
             modalIncludeNotesCheckbox.checked = savedNotes !== 'false';
        }
        function saveExportModalOptions() {
             if (!modalMergeDuplicatesCheckbox || !modalIncludeNotesCheckbox) return;
             localStorage.setItem(LS_MODAL_MERGE_DUP_KEY, modalMergeDuplicatesCheckbox.checked);
             localStorage.setItem(LS_MODAL_INCLUDE_NOTES_KEY, modalIncludeNotesCheckbox.checked);
        }

        // ========================================================================
        // === FAB 報告列表過濾器處理 ===
        // ========================================================================
        function handleFabReportFilterClick(event) {
            event.preventDefault();
            const selectedValue = event.target.dataset.value;
            if (selectedValue && reportFilterSelect) {
                reportFilterSelect.value = selectedValue;
                handleReportListFilterChange();
            }
            const dropdownInstance = bootstrap.Dropdown.getInstance(fabFilterToggle);
            if (dropdownInstance) dropdownInstance.hide();
        }

        // ========================================================================
        // === 主要事件處理函式 ===
        // ========================================================================
         function handleModalReportClick(event) {
             const targetCell = event.target.closest('td');
             if (targetCell && targetCell.classList.contains('col-completed')) return;
             const targetRow = event.target.closest('tr[data-filename]');
             if (targetRow && reportSelectModal) {
                 const filename = targetRow.dataset.filename;
                 if (targetRow.classList.contains('report-row-disabled')) {
                     console.log(`Clicked on filtered-out report: ${filename}`);
                     return;
                 }
                 selectReport(filename);
                 reportSelectModal.hide();
             }
        }
        

        function handleIssueCardChange(event) {
            console.log("*************************************");
            console.log("handleIssueCardChange 函數被觸發了！");
            const target = event.target; // 觸發事件的原始元素 (理論上是 input[type=file] 或 select 或 checkbox)
            console.log("事件目標 (event.target):", target);
            console.log("事件目標 TagName:", target.tagName);
            console.log("事件目標 ClassList:", target.classList);
            console.log("*************************************");

            // --- 優先處理檔案輸入框 change 事件 ---
            // 檢查觸發事件的元素本身是否是我們要的檔案輸入框
            if (target && target.classList && target.classList.contains('screenshot-file-input')) {
                console.log("判斷為：screenshot-file-input，準備呼叫 handleScreenshotFileInputChange");
                handleScreenshotFileInputChange(target); // 將觸發事件的 input 元素傳遞過去
                return; // 處理完畢，直接返回，不再執行後續的卡片查找和狀態/完成度判斷
            }

            // --- 如果不是檔案輸入框，再嘗試尋找父層卡片/群組容器，處理其他 change 事件 (狀態、完成度) ---
            const groupContainer = target.closest('.issue-group-container');
            const singleIssueCard = !groupContainer ? target.closest('.issue-card') : null;
            let targetElement = groupContainer || singleIssueCard; // 父層卡片或群組

            if (targetElement) {
                console.log("找到 targetElement (父層卡片/群組):", targetElement.id || targetElement.dataset.groupKey);
                const membersJson = targetElement.dataset.groupMembers;
                // console.log("取得 membersJson:", membersJson); // 之前的 Log，可以保留或移除

                // 判斷是卡片內的哪種元件觸發了 change 事件 (注意：這裡的 target 仍然是原始觸發元素)
                if (target.classList.contains('screenshot-completion-checkbox')) {
                    console.log("判斷為：screenshot-completion-checkbox");
                    const issueId = target.dataset.issueId;
                    const reportFilename = target.dataset.reportFilename;
                    if(issueId && reportFilename && membersJson) {
                        handleScreenshotCompletionChange(target, issueId, reportFilename, membersJson);
                    } else {
                        console.error("處理 screenshot-completion-checkbox 時缺少資料。", {issueId, reportFilename, membersJson});
                    }
                } else if (target.classList.contains('status-select')) {
                    console.log("判斷為：status-select");
                    const issueId = target.dataset.issueId;
                    const reportFilename = target.dataset.reportFilename;
                    if(issueId && reportFilename && membersJson) {
                        handleStatusUpdate(target, issueId, reportFilename, membersJson);
                    } else {
                        console.error("處理 status-select 時缺少資料。", {issueId, reportFilename, membersJson});
                    }
                } else {
                    // 如果找到了父層卡片，但觸發事件的元件不是上面兩種，記錄一下
                    console.log("在卡片/群組內，但未匹配到已知的 change 事件元件類型:", target.classList);
                }
                console.log("--- if (targetElement) 區塊結束 (處理非檔案輸入事件) ---");

            } else {
                // 如果既不是檔案輸入框，也找不到父層卡片/群組，這通常不應該發生
                console.error("無法識別的 change 事件來源，且找不到父層卡片/群組:", target);
            }
        }


        function handleReportModalChange(event) {
            if (event.target?.classList.contains('report-completion-checkbox')) {
                handleReportCompletionChange(event.target);
            }
        }
        function handleReportListFilterChange() {
            if (!reportFilterSelect) return;
            const newReportFilter = reportFilterSelect.value || DEFAULT_REPORT_FILTER;
            console.log(`Report list filter changed to: ${newReportFilter}`);
            localStorage.setItem(LS_REPORT_FILTER_KEY, newReportFilter);
            if (currentReportFilename) {
                 resetReportSelection();
                 if (reportListErrorDiv) {
                     reportListErrorDiv.textContent = '報告列表篩選條件已變更。請從下方更新後的列表中重新選擇報告。';
                     reportListErrorDiv.style.display = 'block';
                 }
                 if(displayContainer) displayContainer.style.display = 'none';
            }
            toggleAbnormalExportButtonVisibility();
            fetchReportList();
        }
        function handleSortChange() {
            if(sortSelect) localStorage.setItem(LS_SORT_KEY, sortSelect.value);
            if (currentReportFullData?.issues) {
                renderIssueList(currentReportFullData.issues);
            }
        }
        // <<< MODIFIED: handleIssueCardClick >>>
        function handleIssueCardClick(event) {
            const target = event.target;

            // --- Handle Screenshot View Link ---
            if (target.classList.contains('screenshot-view-link') || target.closest('.screenshot-view-link')) {
                event.preventDefault();
                const link = target.closest('.screenshot-view-link');
                const imageUrl = link.href;
                const caption = link.dataset.caption || '';
                const filename = link.dataset.filename || 'Image';
                handleViewImageClick(imageUrl, caption, filename);
                return;
            }
            // --- End Handle Screenshot View Link ---

            const button = target.closest('button');
            if (!button) return;

            const issueCardOrGroup = button.closest('.issue-card, .issue-group-container');
            if (!issueCardOrGroup) return;

            if (button.classList.contains('upload-screenshot-btn')) {
                handleUploadButtonClick(button);
            } else if (button.classList.contains('paste-screenshot-btn')) {
                handlePasteButtonClick(button);
            } else if (button.classList.contains('delete-screenshot-btn')) {
                 const filename = button.dataset.filename;
                 const issueId = button.dataset.issueId || issueCardOrGroup.querySelector('.upload-screenshot-btn')?.dataset.issueId;
                 const reportFilename = currentReportFilename;
                 if (filename && issueId && reportFilename) {
                     handleDeleteButtonClick(button, filename, issueId, reportFilename);
                 } else {
                     console.error("Could not find filename, issueId or reportFilename for delete button:", button);
                 }
            } else if (button.classList.contains('save-note-btn')) {
                handleSaveNote(button);
            } else if (button.classList.contains('verify-vulnerability-btn')) {
                handleVerifyVulnerabilityClick(button);
            } else if (button.classList.contains('edit-caption-btn')) {
                 handleEditCaptionClick(button);
            } else if (button.classList.contains('btn-insert-common-note')) {
                // No action needed here, Bootstrap handles the toggle.
            }
        }

        // ========================================================================
        // === 狀態與截圖完成標記更新邏輯 ===
        // ========================================================================
        async function handleStatusUpdate(selectElement, issueId, reportFilename, membersJson) {
            const newStatus = selectElement.value;
            const groupContainer = selectElement.closest('.issue-group-container');
            const issueCard = selectElement.closest('.issue-card');
            const targetElementForUI = groupContainer || issueCard;
            if (!targetElementForUI) { console.error("Could not find parent card or group for status update UI."); return; }
            if (!issueId || !reportFilename || !membersJson) { console.error("Missing data for status update (params or groupMembers).", {issueId, reportFilename, membersJson}); return; }
            let membersToUpdate;
            try { membersToUpdate = JSON.parse(membersJson); if (!Array.isArray(membersToUpdate) || membersToUpdate.length === 0) throw new Error("Invalid members data."); }
            catch (e) { alert("狀態更新失敗：無法讀取相關弱點資訊。"); return; }

            const container = selectElement.closest('.status-container');
            const feedback = container?.querySelector('.status-update-feedback');
            const spinner = container?.querySelector('.status-update-spinner');
            let oldStatuses = {};
            membersToUpdate.forEach(member => {
                const issue = currentReportFullData?.issues.find(i => i.id === member.issueId);
                if (issue) oldStatuses[member.issueId] = issue.status;
            });

            if (feedback) { feedback.style.display = 'none'; feedback.textContent = ''; feedback.className = 'status-update-feedback ms-1'; }
            if (spinner) spinner.style.display = 'inline-block';
            targetElementForUI.querySelectorAll(`select.status-select`).forEach(sel => sel.disabled = true);

            const requestData = { updates: membersToUpdate, status: newStatus };
            console.log("Sending batch status update:", requestData);

            try {
                const response = await fetch(getApiUrl('api/batch_update_status'), { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(requestData) });
                const responseData = await response.json().catch(() => ({ error: `伺服器回應無效 (${response.status})` }));
                if (!response.ok) { throw new Error(responseData?.error || `伺服器錯誤 ${response.status}`); }

                let headerNeedsUpdate = false;
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1) {
                        if (currentReportFullData.issues[idx].status !== newStatus) {
                            currentReportFullData.issues[idx].status = newStatus;
                            headerNeedsUpdate = true;
                        }
                    }
                    document.querySelectorAll(`select.status-select[data-issue-id="${id}"]`).forEach(sel => {
                        sel.value = newStatus;
                        const colors = statusOptionColors[newStatus] || statusOptionColors['default'];
                        sel.style.backgroundColor = colors.bg;
                        sel.style.color = colors.text;
                    });
                });

                if (feedback) {
                    const count = responseData?.updated_count ?? membersToUpdate.length;
                    feedback.textContent = count > 1 ? `✔ 群組已更新 (${count})` : '✔ 已更新';
                    feedback.classList.add('text-success');
                    feedback.style.display = 'inline';
                    setTimeout(() => { if (feedback?.classList.contains('text-success')) { feedback.style.display = 'none'; feedback.classList.remove('text-success'); } }, 2000);
                }
                if (headerNeedsUpdate && currentReportFullData?.status_summary) {
                    displayReportHeaderInfo(currentReportFullData);
                }
            } catch (error) {
                console.error("Batch status update failed:", error);
                if (feedback) {
                    feedback.textContent = `✘ 更新失敗`;
                    feedback.title = error.message;
                    feedback.classList.add('text-danger');
                    feedback.style.display = 'inline';
                    setTimeout(() => { if (feedback?.classList.contains('text-danger')) { feedback.style.display = 'none'; feedback.classList.remove('text-danger'); feedback.title='';} }, 6000);
                } else {
                    alert(`狀態更新失敗：\n${error.message}`);
                }
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const oldStatus = oldStatuses[id];
                    if (oldStatus !== undefined) {
                         targetElementForUI.querySelectorAll(`select.status-select[data-issue-id="${id}"]`).forEach(sel => {
                             sel.value = oldStatus;
                             const oldColors = statusOptionColors[oldStatus] || statusOptionColors['default'];
                             sel.style.backgroundColor = oldColors.bg;
                             sel.style.color = oldColors.text;
                         });
                    }
                });
            } finally {
                if (spinner) spinner.style.display = 'none';
                targetElementForUI.querySelectorAll(`select.status-select`).forEach(sel => sel.disabled = false);
            }
        }
        async function handleScreenshotCompletionChange(checkboxElement, issueId, reportFilename, membersJson) {
            const isChecked = checkboxElement.checked;
            const groupContainer = checkboxElement.closest('.issue-group-container');
            const issueCard = checkboxElement.closest('.issue-card');
            const targetElementForUI = groupContainer || issueCard;
            if (!targetElementForUI) { console.error("Could not find parent card/group for screenshot completion update UI."); return; }
            if (!issueId || !reportFilename || !membersJson) { console.error("Missing data for screenshot completion update (params or groupMembers).", {issueId, reportFilename, membersJson}); checkboxElement.checked = !isChecked; return; }
            let membersToUpdate;
            try { membersToUpdate = JSON.parse(membersJson); if (!Array.isArray(membersToUpdate) || membersToUpdate.length === 0) throw new Error("Invalid members data."); }
            catch (e) { alert("截圖狀態更新失敗：無法讀取相關弱點資訊。"); checkboxElement.checked = !isChecked; return; }

            const container = checkboxElement.closest('.screenshot-line');
            const spinner = container?.querySelector('.spinner-border-sm');
            const errorSpan = container?.querySelector('.text-danger');
            let oldFlags = {};
            membersToUpdate.forEach(member => {
                const issue = currentReportFullData?.issues.find(i => i.id === member.issueId);
                if (issue) oldFlags[member.issueId] = issue.screenshot_taken;
            });

            if (spinner) spinner.style.display = 'inline-block';
            if (errorSpan) { errorSpan.style.display = 'none'; errorSpan.textContent = ''; }
            targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox`).forEach(cb => cb.disabled = true);

            const requestData = { updates: membersToUpdate, screenshot_taken: isChecked };
            console.log("Sending batch screenshot update:", requestData);

            try {
                const response = await fetch(getApiUrl('api/batch_update_status'), { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(requestData) });
                const responseData = await response.json().catch(() => ({ error: `伺服器回應無效 (${response.status})` }));
                if (!response.ok) { throw new Error(responseData?.error || `伺服器錯誤 ${response.status}`); }
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1) { currentReportFullData.issues[idx].screenshot_taken = isChecked; }
                    document.querySelectorAll(`input.screenshot-completion-checkbox[data-issue-id="${id}"]`).forEach(cb => cb.checked = isChecked);
                });
            } catch (error) {
                console.error("Batch screenshot update failed:", error);
                if (errorSpan) {
                    errorSpan.textContent = `✘ 儲存失敗`;
                    errorSpan.style.display = 'inline';
                    setTimeout(() => { if (errorSpan) errorSpan.style.display = 'none'; }, 3000);
                } else { alert(`截圖狀態更新失敗：\n${error.message}`); }
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const oldFlag = oldFlags[id];
                    if (oldFlag !== undefined) { targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox[data-issue-id="${id}"]`).forEach(cb => cb.checked = oldFlag); }
                });
                membersToUpdate.forEach(member => {
                    const id = member.issueId;
                    const idx = currentReportFullData?.issues.findIndex(i => i.id === id);
                    if (idx !== undefined && idx > -1 && oldFlags[id] !== undefined) { currentReportFullData.issues[idx].screenshot_taken = oldFlags[id]; }
                });
            } finally {
                if (spinner) spinner.style.display = 'none';
                targetElementForUI.querySelectorAll(`input.screenshot-completion-checkbox`).forEach(cb => cb.disabled = false);
            }
        }
        function handleReportCompletionChange(checkboxElement) {
            const reportFilename = checkboxElement.dataset.reportFilename;
            const isChecked = checkboxElement.checked;
            const cell = checkboxElement.closest('td');
            const spinner = cell?.querySelector('.spinner-report-completion');

            if (!reportFilename) { checkboxElement.checked = !isChecked; return; }
            checkboxElement.disabled = true;
            if (spinner) spinner.style.display = 'inline-block';

            fetch(getApiUrl('api/report_completion_status'), {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reportFilename: reportFilename, isCompleted: isChecked })
            })
            .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.error || `Server error ${response.status}`); }))
            .then(data => {
                const modalIdx = currentModalReportList.findIndex(r => r.filename === reportFilename);
                if (modalIdx > -1) currentModalReportList[modalIdx].review_completed = isChecked;
                const navIdx = currentReportList.findIndex(r => r.filename === reportFilename);
                if (navIdx > -1) currentReportList[navIdx].review_completed = isChecked;
            })
            .catch(error => {
                alert(`更新報告完成狀態失敗: ${error.message}`);
                if (checkboxElement?.closest('body')) { checkboxElement.checked = !isChecked; }
            })
            .finally(() => {
                if (checkboxElement?.closest('body')) {
                    checkboxElement.disabled = false;
                    if (spinner) spinner.style.display = 'none';
                }
            });
        }

        // ========================================================================
        // === 筆記儲存邏輯 ===
        // ========================================================================
         async function handleSaveNote(button) {
            const noteSection = button.closest('.note-section');
            if (!noteSection) return;
            const textarea = noteSection.querySelector('textarea.issue-note-textarea');
            const feedbackSpan = noteSection.querySelector('.note-feedback');
            const spinner = noteSection.querySelector('.note-spinner');
            if (!textarea || !feedbackSpan || !spinner) return;

            const issueId = textarea.dataset.issueId;
            const reportFilename = textarea.dataset.reportFilename;
            const newNote = textarea.value;
            if (!issueId || !reportFilename) {
                feedbackSpan.textContent = '✘ 內部錯誤';
                feedbackSpan.className = 'note-feedback text-danger';
                return;
            }

            button.disabled = true;
            spinner.style.display = 'inline-block';
            feedbackSpan.textContent = '儲存中...';
            feedbackSpan.className = 'note-feedback text-muted';

            try {
                const response = await fetch(getApiUrl('api/note'), {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ reportFilename, issueId, note: newNote })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `伺服器錯誤 ${response.status}`);

                feedbackSpan.textContent = '✔ 已儲存';
                feedbackSpan.className = 'note-feedback text-success';
                if (currentReportFullData?.issues) {
                    const idx = currentReportFullData.issues.findIndex(iss => iss.id === issueId);
                    if (idx > -1) currentReportFullData.issues[idx].note = newNote;
                }
                setTimeout(() => {
                    if (feedbackSpan?.classList.contains('text-success')) {
                        feedbackSpan.textContent = '';
                        feedbackSpan.className = 'note-feedback';
                    }
                }, 2500);
            } catch (error) {
                feedbackSpan.textContent = `✘ 儲存失敗`;
                feedbackSpan.title = error.message;
                feedbackSpan.className = 'note-feedback text-danger';
                setTimeout(() => {
                    if (feedbackSpan?.classList.contains('text-danger')) {
                        feedbackSpan.textContent = '';
                        feedbackSpan.className = 'note-feedback';
                        feedbackSpan.title='';
                    }
                }, 6000);
            } finally {
                if (button?.closest('body')) button.disabled = false;
                if (spinner) spinner.style.display = 'none';
            }
        }

        // ========================================================================
        // === 截圖上傳 / 貼上 / 刪除 / 編輯備註 / 查看 相關邏輯 ===
        // ========================================================================
        function setUploadFeedback(feedbackElement, message, isError = false, clearAfter = 3000) {
             if (!feedbackElement) return;
             feedbackElement.textContent = message;
             feedbackElement.className = `upload-feedback ms-1 ${isError ? 'text-danger' : 'text-success'}`;
             feedbackElement.style.display = message ? 'inline' : 'none';
             const existingTimeoutId = feedbackElement.dataset.timeoutId;
             if (existingTimeoutId) clearTimeout(parseInt(existingTimeoutId));
             delete feedbackElement.dataset.timeoutId;
             if (clearAfter > 0 && message) {
                 const timeoutId = setTimeout(() => {
                     if (feedbackElement?.closest('body')) {
                         feedbackElement.textContent = '';
                         feedbackElement.style.display = 'none';
                         delete feedbackElement.dataset.timeoutId;
                     }
                 }, clearAfter);
                 feedbackElement.dataset.timeoutId = timeoutId;
             }
        }
        function uploadScreenshot(formData, feedbackSpan, screenshotListDiv) {
            const controlsDiv = feedbackSpan.closest('.screenshot-controls');
            const spinner = controlsDiv?.querySelector('.spinner-border-sm');
            const uploadBtn = controlsDiv?.querySelector('.upload-screenshot-btn');
            const pasteBtn = controlsDiv?.querySelector('.paste-screenshot-btn');

            if (spinner) spinner.style.display = 'inline-block';
            if (uploadBtn) uploadBtn.disabled = true;
            if (pasteBtn) pasteBtn.disabled = true;
            setUploadFeedback(feedbackSpan, '上傳中...', false, 0);

            fetch(getApiUrl('api/upload_screenshot'), { method: 'POST', body: formData })
            .then(response => response.ok ? response.json() : response.json().catch(() => response.text().then(text => ({ error: `伺服器錯誤 ${response.status}: ${text || '未知錯誤'}` }))).then(errData => { throw new Error(errData.error || `伺服器錯誤 ${response.status}`); }))
            .then(data => {
                setUploadFeedback(feedbackSpan, '✔ 上傳成功', false, 3000);
                if (data.filename && screenshotListDiv) {
                    const issueId = formData.get('issueId');
                    addScreenshotToList(screenshotListDiv, data.filename, data.caption || '', issueId);
                     if (currentReportFullData?.issues) {
                         const idx = currentReportFullData.issues.findIndex(iss => iss.id === issueId);
                         if (idx > -1) {
                             if (!currentReportFullData.issues[idx].screenshots_detailed) currentReportFullData.issues[idx].screenshots_detailed = [];
                             const existingIndex = currentReportFullData.issues[idx].screenshots_detailed.findIndex(s => s.filename === data.filename);
                             if (existingIndex === -1) {
                                 currentReportFullData.issues[idx].screenshots_detailed.push({ filename: data.filename, caption: data.caption || '' });
                                 currentReportFullData.issues[idx].screenshots_detailed.sort((a, b) => naturalSort(a.filename, b.filename));
                             } else {
                                 currentReportFullData.issues[idx].screenshots_detailed[existingIndex].caption = data.caption || '';
                             }
                         }
                     }
                } else if (!data.filename) {
                    setUploadFeedback(feedbackSpan, '⚠ 上傳完成但未收到檔名', true, 5000);
                }
            }).catch(error => {
                setUploadFeedback(feedbackSpan, `✘ 上傳失敗: ${error.message}`, true, 5000);
            })
            .finally(() => {
                try {
                    if (controlsDiv?.closest('body')) {
                        if (spinner) spinner.style.display = 'none';
                        if (uploadBtn) uploadBtn.disabled = false;
                        if (pasteBtn) pasteBtn.disabled = false;
                    }
                } catch(e){}
            });
        }
        function naturalSort(a, b) {
            const re = /(\d+)/g;
            const ax = a.split(re);
            const bx = b.split(re);
            for (let i = 0; i < Math.min(ax.length, bx.length); i++) {
                const an = parseInt(ax[i], 10);
                const bn = parseInt(bx[i], 10);
                if (!isNaN(an) && !isNaN(bn)) {
                    if (an !== bn) return an - bn;
                } else if (ax[i] !== bx[i]) {
                    return ax[i].localeCompare(bx[i]);
                }
            }
            return ax.length - bx.length;
        }
        // --- Modified: Add screenshot list item ---
        function addScreenshotToList(listDiv, filename, caption, issueId) {
            if (!listDiv || !filename || !issueId) return;
            const fileUrl = getApiUrl(`screenshots/${encodeURIComponent(filename)}`);
            const noMsg = listDiv.querySelector('.no-screenshots-msg');
            if (noMsg) noMsg.remove();

             const existingLink = listDiv.querySelector(`a.screenshot-view-link[data-filename="${filename}"]`);
             if (existingLink) {
                 const listItem = existingLink.closest('li');
                 const captionSpan = listItem?.querySelector('.screenshot-caption');
                 if (captionSpan) captionSpan.textContent = caption ? escapeHtml(caption) : '';
                 existingLink.dataset.caption = caption ? caption : '';
                 console.log(`Updated caption for existing item: ${filename}`);
                 return;
             }

            const li = document.createElement('li');
            li.innerHTML = `
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="flex-grow-1 me-2">
                         <a href="${fileUrl}" class="screenshot-view-link" data-caption="${escapeHtml(caption)}" data-filename="${escapeHtml(filename)}" title="點擊查看圖片與備註">${escapeHtml(filename)}</a>
                         <small class="text-muted screenshot-caption ms-1" style="word-break: break-all;">${caption ? escapeHtml(caption) : ''}</small>
                    </div>
                    <div class="btn-group btn-group-sm flex-shrink-0" role="group">
                         <button type="button" class="btn btn-outline-secondary btn-xs edit-caption-btn" data-filename="${escapeHtml(filename)}" data-issue-id="${escapeHtml(issueId)}" title="編輯備註"><i class="fas fa-edit"></i></button>
                         <button type="button" class="btn btn-outline-danger btn-xs delete-screenshot-btn" data-filename="${escapeHtml(filename)}" data-issue-id="${escapeHtml(issueId)}" title="移至垃圾桶"><i class="fas fa-trash-alt"></i></button>
                     </div>
                 </div>
            `;
            listDiv.appendChild(li);

            const items = Array.from(listDiv.querySelectorAll('li:not(.no-screenshots-msg)'));
            items.sort((a, b) => {
                 const filenameA = a.querySelector('a.screenshot-view-link')?.dataset.filename || '';
                 const filenameB = b.querySelector('a.screenshot-view-link')?.dataset.filename || '';
                 return naturalSort(filenameA, filenameB);
             });
            items.forEach(item => listDiv.appendChild(item));
        }
        function handleDeleteButtonClick(button, filename, issueId, reportFilename) {
            const listItem = button.closest('li');
            const listDiv = button.closest('.uploaded-screenshots-list');
            const controlsDiv = button.closest('.screenshot-section')?.querySelector('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');
            if (!filename || !listItem || !listDiv || !issueId || !reportFilename) {
                if(feedbackSpan) setUploadFeedback(feedbackSpan, '✘ 刪除錯誤(內部)', true, 4000);
                return;
            }
            if (confirm(`確定要將截圖檔案 "${filename}" 移至垃圾桶嗎？\n(可在伺服器 data 資料夾內找回)`)) {
                 button.disabled = true;
                 button.innerHTML = '<span class="spinner-border spinner-border-xs" style="width: 0.8rem; height: 0.8rem;"></span>';
                 if (feedbackSpan) setUploadFeedback(feedbackSpan, '移動中...', false, 0);
                 deleteScreenshot(filename, issueId, reportFilename)
                 .then(result => {
                      listItem.remove();
                      if (listDiv.querySelectorAll('li:not(.no-screenshots-msg)').length === 0) {
                          const m = document.createElement('li');
                          m.className = 'no-screenshots-msg text-muted'; m.innerHTML = '<em>尚無截圖</em>';
                          listDiv.appendChild(m);
                      }
                      if (feedbackSpan) setUploadFeedback(feedbackSpan, '✔ 已移至垃圾桶', false, 2000);
                      if (currentReportFullData?.issues && issueId) {
                          const idx = currentReportFullData.issues.findIndex(i => i.id === issueId);
                          if (idx > -1 && currentReportFullData.issues[idx].screenshots_detailed) {
                              currentReportFullData.issues[idx].screenshots_detailed = currentReportFullData.issues[idx].screenshots_detailed.filter(f => f.filename !== filename);
                          }
                      }
                 }).catch(error => {
                      if (feedbackSpan) setUploadFeedback(feedbackSpan, `✘ 操作失敗: ${error.message}`, true, 5000);
                      if (button?.closest('body')) {
                          button.disabled = false;
                          button.innerHTML = '<i class="fas fa-trash-alt"></i>';
                      }
                 });
            }
        }
        async function deleteScreenshot(filename, issueId, reportFilename) {
            const response = await fetch(getApiUrl('api/delete_screenshot'), {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename, issueId, reportFilename })
            });
            if (!response.ok) {
                const errData = await response.json().catch(() => ({ error: `伺服器錯誤 ${response.status}` }));
                throw new Error(errData.error || `伺服器錯誤 ${response.status}`);
            }
            return await response.json();
        }
        // --- Edit Caption Functions ---
        async function updateScreenshotCaption(reportFilename, issueId, screenshotFilename, newCaption) {
            const response = await fetch(getApiUrl('api/update_screenshot_caption'), {
                method: 'POST', headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                body: JSON.stringify({ reportFilename, issueId, screenshotFilename, newCaption })
            });
            if (!response.ok) {
                const errData = await response.json().catch(() => ({ error: `Server error ${response.status}` }));
                throw new Error(errData.error || `Server error ${response.status}`);
            }
            return await response.json();
        }
        // <<< MODIFIED: Use modal for editing caption >>>
        async function handleEditCaptionClick(button) {
            const filename = button.dataset.filename;
            const issueId = button.dataset.issueId;
            const listItem = button.closest('li');
            const captionSpan = listItem?.querySelector('.screenshot-caption');
            const linkElement = listItem?.querySelector('a.screenshot-view-link');
            const currentCaption = captionSpan ? captionSpan.textContent.trim() : '';
            const imageUrl = linkElement ? linkElement.href : null;

            if (!filename || !issueId || !listItem || !captionSpan || !imageUrl) {
                alert("編輯備註錯誤：找不到必要資訊 (檔案名, ID, 列表項, 備註span, 圖片URL)。");
                return;
            }

            const previewModalEl = document.getElementById('screenshotPreviewModal');
            const previewImg = document.getElementById('previewImage');
            const previewErr = document.getElementById('previewError');
            const captionInputModal = document.getElementById('previewCaptionInput');
            const captionDisplayArea = document.getElementById('captionDisplayArea');
            const captionInputArea = document.getElementById('captionInputArea');
            const modalConfirmBtn = document.getElementById('modalConfirmButton');
            const modalTitle = document.getElementById('screenshotPreviewModalLabel');
            const previewCommonNoteBtn = document.getElementById('preview-common-note-btn');

            previewModalEl.dataset.modalMode = 'editCaption';
            previewModalEl.dataset.issueId = issueId;
            previewModalEl.dataset.screenshotFilename = filename;

            modalTitle.textContent = `編輯備註: ${filename}`;
            previewImg.src = imageUrl;
            previewImg.style.display = 'block';
            previewErr.style.display = 'none';
            captionInputArea.style.display = 'flex';
            captionDisplayArea.style.display = 'none';
            captionInputModal.value = currentCaption;
            modalConfirmBtn.textContent = '儲存備註';
            modalConfirmBtn.style.display = 'inline-block';
            modalConfirmBtn.disabled = false;

             const issue = currentReportFullData?.issues.find(i => i.id === issueId);
             const issueTypeForCommonNotes = issue?.issue_type || 'Unknown Type';
             if (previewCommonNoteBtn) previewCommonNoteBtn.dataset.issueType = issueTypeForCommonNotes;

            if (previewModal) {
                console.log("handleScreenshotFileInputChange：呼叫 previewModal.show()"); // << 新增Log
                previewModal.show();
            } else {

                console.error("handleScreenshotFileInputChange: Preview modal 實例未找到！"); // << 新增錯誤Log
                 alert("無法顯示編輯彈窗。");
            }
        }
        // --- NEW: Handle viewing image ---
        function handleViewImageClick(imageUrl, caption, filename) {
             if (!imageUrl) {
                 alert("無法取得圖片 URL。");
                 return;
             }

            const previewModalEl = document.getElementById('screenshotPreviewModal');
            const previewImg = document.getElementById('previewImage');
            const previewErr = document.getElementById('previewError');
            const captionDisplay = document.getElementById('previewCaptionDisplay');
            const captionDisplayArea = document.getElementById('captionDisplayArea');
            const captionInputArea = document.getElementById('captionInputArea');
            const modalConfirmBtn = document.getElementById('modalConfirmButton');
            const modalTitle = document.getElementById('screenshotPreviewModalLabel');

            previewModalEl.dataset.modalMode = 'view';
            previewModalEl.dataset.issueId = '';
            previewModalEl.dataset.screenshotFilename = '';

            modalTitle.textContent = `查看圖片: ${filename}`;
            previewImg.src = imageUrl;
            previewImg.style.display = 'block';
            previewErr.style.display = 'none';
            captionInputArea.style.display = 'none';
            captionDisplayArea.style.display = 'block';
            captionDisplay.textContent = caption || '(無備註)';
            modalConfirmBtn.style.display = 'none';

            if (previewModal) {
                previewModal.show();
            } else {
                 console.error("Preview modal instance not found!");
                 alert("無法顯示查看彈窗。");
            }
        }
        // --- Common Notes Functions (Using Bootstrap Dropdown) ---
        function showCommonNotesDropdown(button) {
            const issueType = button.dataset.issueType;
            const targetId = button.dataset.targetTextareaId || button.dataset.targetInputId;
            const targetElement = document.getElementById(targetId);
            const dropdownMenu = button.nextElementSibling;

            if (!dropdownMenu || dropdownMenu.tagName !== 'UL') {
                 console.error("Could not find the dropdown menu element next to the button.", button);
                 return;
            }

            if (!issueType || !targetElement) {
                console.warn("Missing issue type or target element for common notes.");
                dropdownMenu.innerHTML = '<li><span class="dropdown-item-text text-muted small px-3">無可用備註</span></li>';
                return;
            }

            const notes = commonNotesData[issueType] || [];
            dropdownMenu.innerHTML = '';

            if (notes.length === 0) {
                console.log(`No common notes found for type: ${issueType}`);
                dropdownMenu.innerHTML = '<li><span class="dropdown-item-text text-muted small px-3">此類型無常用備註</span></li>';
            } else {
                notes.forEach(note => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.className = 'dropdown-item small common-note-item';
                    a.href = '#';
                    a.textContent = note;
                    a.dataset.note = note;
                    a.dataset.targetId = targetId;
                    li.appendChild(a);
                    dropdownMenu.appendChild(li);
                });
                 dropdownMenu.removeEventListener('click', handleCommonNoteSelection);
                 dropdownMenu.addEventListener('click', handleCommonNoteSelection);
            }
        }
        function handleCommonNoteSelection(event) {
            event.preventDefault();
            const targetItem = event.target.closest('.common-note-item');
            if (targetItem) {
                const noteToInsert = targetItem.dataset.note;
                const targetId = targetItem.dataset.targetId;
                const targetElement = document.getElementById(targetId);
                if (targetElement && noteToInsert) {
                    const separator = (targetElement.tagName === 'TEXTAREA') ? "\n" : " ";
                    if (typeof targetElement.selectionStart === 'number' && typeof targetElement.selectionEnd === 'number') {
                        const start = targetElement.selectionStart;
                        const end = targetElement.selectionEnd;
                        const text = targetElement.value;
                        const before = text.substring(0, start);
                        const after = text.substring(end, text.length);
                        const prefix = (before && !before.endsWith('\n') && !before.endsWith(' ')) ? separator : '';
                        targetElement.value = before + prefix + noteToInsert + after;
                        targetElement.selectionStart = targetElement.selectionEnd = start + prefix.length + noteToInsert.length;
                    } else {
                        targetElement.value += (targetElement.value ? separator : '') + noteToInsert;
                    }
                    targetElement.focus();
                    targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                    targetElement.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        }
        // --- End Common Notes Functions ---
        function handleUploadButtonClick(button) {
            const fileInputId = button.dataset.fileInputId;
            const fileInput = document.getElementById(fileInputId);
            if (fileInput) {
                fileInput.click();
            } else {
                alert("內部錯誤：無法找到上傳元件。");
            }
        }
        // <<< MODIFIED: handleScreenshotFileInputChange to show modal >>>
        function handleScreenshotFileInputChange(fileInput) {
            if (!fileInput.files || fileInput.files.length === 0) return;
            const file = fileInput.files[0];
            const issueId = fileInput.dataset.issueId;
            const issueName = fileInput.dataset.issueName;
            const controlsDiv = fileInput.closest('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');

            if (!currentReportFilename || !issueId || !issueName) {
                if(feedbackSpan) setUploadFeedback(feedbackSpan, '✘ 內部錯誤 (缺少上下文)', true, 4000);
                else alert('內部錯誤 (缺少上下文)');
                fileInput.value = '';
                return;
            }

            const ext = file.name.split('.').pop()?.toLowerCase();
            const validExts = ['png', 'jpg', 'jpeg', 'gif', 'bmp'];
            if (!ALLOWED_IMAGE_TYPES.includes(file.type) || !ext || !validExts.includes(ext)) {
                 if(feedbackSpan) setUploadFeedback(feedbackSpan, `✘ 不支援的檔案類型 (${ext})`, true, 4000);
                 else alert(`不支援的檔案類型 (${ext})`);
                fileInput.value = '';
                return;
            }

            console.log("handleScreenshotFileInputChange：建立 FileReader..."); // << 新增Log
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log("--- FileReader onload 事件觸發 ---"); // << 新增Log
                const previewModalEl = document.getElementById('screenshotPreviewModal');
                const previewImg = document.getElementById('previewImage');
                const previewErr = document.getElementById('previewError');
                const captionInputModal = document.getElementById('previewCaptionInput');
                const captionDisplayArea = document.getElementById('captionDisplayArea');
                const captionInputArea = document.getElementById('captionInputArea');
                const modalConfirmBtn = document.getElementById('modalConfirmButton');
                const modalTitle = document.getElementById('screenshotPreviewModalLabel');
                const previewCommonNoteBtn = document.getElementById('preview-common-note-btn');
                
                console.log("handleScreenshotFileInputChange：準備顯示彈窗..."); // << 新增Log
                fileToUpload = file;
                uploadContext = {
                    issueId: issueId, issueName: issueName,
                    source: findIssueElement(issueId)?.dataset.source || 'appscan',
                    issueUrl: findIssueElement(issueId)?.querySelector('.issue-url-link')?.textContent || 'N/A',
                    entityName: findIssueElement(issueId)?.querySelector('.issue-entity-link')?.textContent || 'N/A'
                 };

                previewModalEl.dataset.modalMode = 'uploadFile';
                previewModalEl.dataset.issueId = issueId;

                modalTitle.textContent = `上傳圖片: ${file.name}`;
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                previewErr.style.display = 'none';
                captionInputArea.style.display = 'flex';
                captionDisplayArea.style.display = 'none';
                captionInputModal.value = ''; // Clear caption for new upload
                modalConfirmBtn.textContent = '確認上傳';
                modalConfirmBtn.style.display = 'inline-block';
                modalConfirmBtn.disabled = false;

                 const issue = currentReportFullData?.issues.find(i => i.id === issueId);
                 const issueTypeForCommonNotes = issue?.issue_type || 'Unknown Type';
                 if (previewCommonNoteBtn) {
                      previewCommonNoteBtn.dataset.issueType = issueTypeForCommonNotes;
                      console.log("Set issue type on preview btn for file upload:", issueTypeForCommonNotes);
                 } else {
                     console.warn("Preview common note button not found!");
                 }

                if (previewModal) {
                    previewModal.show();
                } else {
                     console.error("Preview modal instance not found!");
                     alert("無法顯示預覽彈窗。");
                     fileToUpload = null; uploadContext = {};
                }
            }
            reader.onerror = function(e) {
                 if(feedbackSpan) setUploadFeedback(feedbackSpan, '✘ 讀取檔案錯誤', true, 4000);
                 else alert('讀取檔案錯誤');
                 fileToUpload = null; uploadContext = {};
            }
            reader.readAsDataURL(file);
            fileInput.value = ''; // Reset input
        }
        // <<< MODIFIED: handlePasteButtonClick to use modal >>>
        async function handlePasteButtonClick(button) {
            const issueId = button.dataset.issueId;
            const issueName = button.dataset.issueName;
            const controlsDiv = button.closest('.screenshot-controls');
            const feedbackSpan = controlsDiv?.querySelector('.upload-feedback');
            let issueTypeForCommonNotes = 'Unknown Type';
            const issue = currentReportFullData?.issues.find(i => i.id === issueId);
            if (issue && issue.issue_type) { issueTypeForCommonNotes = issue.issue_type; }
            console.log("handlePasteButtonClick - issueType for common notes:", issueTypeForCommonNotes);

            if (!feedbackSpan || !navigator.clipboard?.read) { alert('瀏覽器不支援剪貼簿讀取或找不到元件。'); return; }
            setUploadFeedback(feedbackSpan, '讀取中...', false, 0);
            button.disabled = true;
            try {
                const items = await navigator.clipboard.read();
                let blob = null;
                for (const item of items) {
                    const type = item.types.find(t => t.startsWith('image/') && ALLOWED_IMAGE_TYPES.includes(t));
                    if (type) { blob = await item.getType(type); break; }
                }
                if (blob) {
                    setUploadFeedback(feedbackSpan, '', false, 0);
                    blobToUpload = blob;
                    uploadContext = { issueId, issueName, isManual: (issue?.source === 'manual'), source: (issue?.source || 'appscan'), issueUrl: (issue?.url || 'N/A'), entityName: (issue?.entity_name || 'N/A'), issueType: issueTypeForCommonNotes };

                    const url = URL.createObjectURL(blob);

                    const previewModalEl = document.getElementById('screenshotPreviewModal');
                    const previewImg = document.getElementById('previewImage');
                    const previewErr = document.getElementById('previewError');
                    const captionInputModal = document.getElementById('previewCaptionInput');
                    const captionDisplayArea = document.getElementById('captionDisplayArea');
                    const captionInputArea = document.getElementById('captionInputArea');
                    const modalConfirmBtn = document.getElementById('modalConfirmButton');
                    const modalTitle = document.getElementById('screenshotPreviewModalLabel');
                    const previewCommonNoteBtn = document.getElementById('preview-common-note-btn');

                    previewModalEl.dataset.modalMode = 'paste';
                    previewModalEl.dataset.issueId = issueId;

                    modalTitle.textContent = '預覽剪貼簿圖片';
                    previewImg.src = url;
                    previewImg.style.display = 'block';
                    previewErr.style.display = 'none';
                    captionInputArea.style.display = 'flex';
                    captionDisplayArea.style.display = 'none';
                    captionInputModal.value = '';
                    modalConfirmBtn.textContent = '確認上傳';
                    modalConfirmBtn.style.display = 'inline-block';
                    modalConfirmBtn.disabled = false;

                    if (previewCommonNoteBtn) previewCommonNoteBtn.dataset.issueType = issueTypeForCommonNotes;

                    if (previewModal) {
                        previewModal.show();
                    } else {
                        URL.revokeObjectURL(url); blobToUpload = null; uploadContext = {};
                    }
                } else { throw new Error('剪貼簿中未找到支援的圖片格式。'); }
            } catch (error) {
                setUploadFeedback(feedbackSpan, '', false, 0);
                alert(`讀取剪貼簿失敗：${error.message}.`);
                blobToUpload = null; uploadContext = {};
            } finally { if (button?.closest('body')) button.disabled = false; }
        }
        // <<< MODIFIED: handleModalConfirm >>>
         function handleModalConfirm() {
             const previewModalEl = document.getElementById('screenshotPreviewModal');
             const mode = previewModalEl.dataset.modalMode;
             const issueId = previewModalEl.dataset.issueId || uploadContext.issueId;
             const screenshotFilename = previewModalEl.dataset.screenshotFilename;
             const captionInput = document.getElementById('previewCaptionInput');
             const imageCaption = captionInput ? captionInput.value.trim() : '';

             const modalConfirmBtn = document.getElementById('modalConfirmButton');
             modalConfirmBtn.disabled = true;
             const originalButtonText = modalConfirmBtn.textContent;
             modalConfirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 處理中...`;

             const targetIssueElement = findIssueElement(issueId);
             const targetFeedbackSpan = targetIssueElement?.querySelector('.upload-feedback');
             const targetScreenshotListDiv = targetIssueElement?.querySelector('.uploaded-screenshots-list');

             switch (mode) {
                 case 'paste':
                     if (!blobToUpload || !issueId) {
                          console.error("Paste mode confirmation error: Missing blob or issueId.");
                          if (previewModal) previewModal.hide();
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                          blobToUpload = null; uploadContext = {};
                          return;
                      }
                      if (!currentReportFilename || !targetFeedbackSpan || !targetScreenshotListDiv) {
                          console.error("Paste mode confirmation error: Missing elements for upload.");
                          alert("貼上確認失敗：找不到必要的頁面元件。");
                          if (previewModal) previewModal.hide();
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                          blobToUpload = null; uploadContext = {};
                          return;
                      }
                     let ext = 'png'; const mime = blobToUpload.type;
                     if (mime?.startsWith('image/')) { const pExt = mime.split('/')[1]; const valid = ['png', 'jpg', 'jpeg', 'gif', 'bmp']; if (pExt && valid.includes(pExt.toLowerCase())) { ext = pExt.toLowerCase() === 'jpeg' ? 'jpg' : pExt.toLowerCase(); } }
                     const formDataPaste = new FormData();
                     formDataPaste.append('imageFile', blobToUpload, `pasted_image_${Date.now()}.${ext}`);
                     formDataPaste.append('reportFilename', currentReportFilename);
                     formDataPaste.append('issueId', issueId);
                     formDataPaste.append('issueName', uploadContext.issueName || 'Unknown Issue');
                     formDataPaste.append('imageCaption', imageCaption);
                     formDataPaste.append('isManual', String(uploadContext.isManual || false));
                     formDataPaste.append('source', uploadContext.source || 'appscan');
                     formDataPaste.append('issueUrl', uploadContext.issueUrl || 'N/A');
                     formDataPaste.append('entityName', uploadContext.entityName || 'N/A');

                     uploadScreenshot(formDataPaste, targetFeedbackSpan, targetScreenshotListDiv);
                     if (previewModal) previewModal.hide();
                     blobToUpload = null; uploadContext = {};
                     break;

                 case 'uploadFile':
                      if (!fileToUpload || !issueId) {
                          console.error("Upload file mode confirmation error: Missing file or issueId.");
                          if (previewModal) previewModal.hide();
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                          fileToUpload = null; uploadContext = {};
                          return;
                      }
                      if (!currentReportFilename || !targetFeedbackSpan || !targetScreenshotListDiv) {
                          console.error("Upload file mode confirmation error: Missing elements for upload.");
                          alert("上傳確認失敗：找不到必要的頁面元件。");
                          if (previewModal) previewModal.hide();
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                          fileToUpload = null; uploadContext = {};
                          return;
                      }

                      const formDataUpload = new FormData();
                      formDataUpload.append('imageFile', fileToUpload);
                      formDataUpload.append('reportFilename', currentReportFilename);
                      formDataUpload.append('issueId', issueId);
                      formDataUpload.append('issueName', uploadContext.issueName || 'Unknown Issue');
                      formDataUpload.append('imageCaption', imageCaption);

                      formDataUpload.append('isManual', String(uploadContext.source === 'manual'));
                      formDataUpload.append('source', uploadContext.source || 'appscan');
                      formDataUpload.append('issueUrl', uploadContext.issueUrl || 'N/A');
                      formDataUpload.append('entityName', uploadContext.entityName || 'N/A');

                      uploadScreenshot(formDataUpload, targetFeedbackSpan, targetScreenshotListDiv);
                      if (previewModal) previewModal.hide();
                      fileToUpload = null; uploadContext = {};
                      break;

                 case 'editCaption':
                     if (!issueId || !screenshotFilename) {
                          console.error("Edit caption mode confirmation error: Missing context.");
                          if (previewModal) previewModal.hide();
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                          return;
                      }
                      updateScreenshotCaption(currentReportFilename, issueId, screenshotFilename, imageCaption)
                      .then(result => {
                          console.log(`Caption for ${screenshotFilename} updated successfully.`);
                          const listItem = findScreenshotListItem(issueId, screenshotFilename);
                          const captionSpan = listItem?.querySelector('.screenshot-caption');
                          if (captionSpan) { captionSpan.textContent = imageCaption ? escapeHtml(imageCaption) : ''; }
                          const viewLink = listItem?.querySelector('a.screenshot-view-link');
                          if (viewLink) { viewLink.dataset.caption = imageCaption; }

                          if (currentReportFullData?.issues) {
                              const issueIndex = currentReportFullData.issues.findIndex(iss => iss.id === issueId);
                              if (issueIndex > -1 && currentReportFullData.issues[issueIndex].screenshots_detailed) {
                                  const screenshotIndex = currentReportFullData.issues[issueIndex].screenshots_detailed.findIndex(ss => ss.filename === screenshotFilename);
                                  if (screenshotIndex > -1) { currentReportFullData.issues[issueIndex].screenshots_detailed[screenshotIndex].caption = imageCaption; }
                              }
                          }
                          if (previewModal) previewModal.hide();
                      })
                      .catch(error => {
                          console.error("Error updating caption via modal:", error);
                          alert(`儲存備註失敗：${error.message}`);
                      })
                      .finally(() => {
                          resetModalConfirmButton(modalConfirmBtn, originalButtonText);
                      });
                     break;

                 default:
                     console.warn("Unknown modal mode:", mode);
                     if (previewModal) previewModal.hide();
                     resetModalConfirmButton(modalConfirmBtn, originalButtonText);
             }
         }

        // ========================================================================
        // === 打開 .scan 檔案邏輯 ===
        // ========================================================================
        function handleOpenScanFile() {
            if (!currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔")) { alert("無法開啟遺失報告的 .scan 檔案。"); return; }
            if (openScanFileButton) openScanFileButton.disabled = true;
            if (fabOpenScanFile) fabOpenScanFile.disabled = true;
            const originalText = openScanFileButton ? openScanFileButton.innerHTML : '';
            const fabOriginalIcon = fabOpenScanFile ? fabOpenScanFile.innerHTML : '';
            if (openScanFileButton) openScanFileButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 開啟中...`;
            if (fabOpenScanFile) fabOpenScanFile.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
            fetch(getApiUrl('api/open_scan_file'), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ reportFilename: currentReportFilename }) })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => { if (!ok) throw new Error(data.error || '伺服器錯誤'); console.log(data.message); })
            .catch(error => { alert(`無法開啟 .scan 檔案: ${error.message}`); })
            .finally(() => {
                try { if (openScanFileButton?.closest('body')) { openScanFileButton.disabled = !currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔"); openScanFileButton.innerHTML = originalText; } } catch(e) {};
                try { if (fabOpenScanFile?.closest('body')) { fabOpenScanFile.disabled = !currentReportFilename || currentReportFilename.endsWith("-找不到掃描檔"); fabOpenScanFile.innerHTML = fabOriginalIcon; } } catch(e) {}
            });
        }

        // ========================================================================
        // === 匯出處理邏輯 ===
        // ========================================================================
        function handleExportButtonClick(event) {
            event.preventDefault();
            if (exportOptionsModal) { loadExportModalOptions(); exportOptionsModal.show(); }
            else { console.error("Export options modal not initialized!"); alert("匯出選項視窗錯誤，將使用預設選項匯出。"); window.location.href = BASE_CONFIRMED_EXPORT_URL; }
        }
        function handleConfirmExport() {
            saveExportModalOptions();
            const mergeChecked = modalMergeDuplicatesCheckbox.checked;
            const notesChecked = modalIncludeNotesCheckbox.checked;
            let url = new URL(BASE_CONFIRMED_EXPORT_URL, window.location.origin);
            const params = url.searchParams;
            if (mergeChecked) { params.set('merge_duplicates', 'true'); } else { params.delete('merge_duplicates'); }
            if (notesChecked) { params.set('include_notes', 'true'); } else { params.delete('include_notes'); }
            const downloadUrl = url.pathname + url.search;
            console.log("Triggering confirmed export with URL:", downloadUrl);
            window.location.href = downloadUrl;
            if (exportOptionsModal) exportOptionsModal.hide();
        }
        function handleExportAllNotesClick(event) { console.log("All notes export clicked. Href:", exportAllNotesButton.href); }
        function handleExportAbnormalClick() { console.log("Abnormal report export clicked. Href:", exportAbnormalButton.href); }


        // ========================================================================
        // === Selenium 驗證邏輯 ===
        // ========================================================================
        async function handleVerifyVulnerabilityClick(button) {
            const issueUrl = button.dataset.issueUrl;
            const entityName = button.dataset.entityName; const entityType = button.dataset.entityType;
            const reasoning = button.dataset.reasoning;
            const componentName = button.dataset.componentName; const componentVersion = button.dataset.componentVersion;
            if (!issueUrl || issueUrl === 'N/A') { alert("無法驗證：缺少有效的頁面 URL。"); return; }
            button.disabled = true;
            const originalIcon = button.innerHTML;
            button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 驗證中...`;
            try {
                const response = await fetch(getApiUrl('api/verify_vulnerability'), { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ issueUrl, entityName, entityType, reasoning, componentName, componentVersion }) });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error || `伺服器錯誤 ${response.status}`); }
                alert(data.message || "已嘗試開啟瀏覽器進行驗證。");
                console.log("Verification result:", data);
            } catch (error) {
                console.error("Verification failed:", error);
                alert(`驗證請求失敗：\n${error.message}`);
            } finally {
                if (document.body.contains(button)) { button.disabled = false; button.innerHTML = originalIcon; }
            }
        }

        // ========================================================================
        // === 新增自訂弱點邏輯 ===
        // ========================================================================
        function populateWeaknessDatalist() {
            if (weaknessDatalist && Array.isArray(WEAKNESS_NAME_LIST)) {
                let optionsHtml = '';
                WEAKNESS_NAME_LIST.forEach(name => { optionsHtml += `<option value="${escapeHtml(name)}"></option>`; });
                weaknessDatalist.innerHTML = optionsHtml;
            }
        }
        function handleAddVulnerabilityClick() {
            if (!currentReportFilename) { alert("請先選擇一個報告檔案，才能新增自訂弱點。"); return; }
            if (addVulnerabilityModal) {
                addVulnerabilityModalElement.dataset.reportFilename = currentReportFilename;
                addVulnerabilityForm.reset(); document.getElementById('addVulnSeverity').value = 'medium';
                 addVulnFeedback.style.display = 'none'; addVulnFeedback.textContent = '';
                 addVulnFeedback.classList.remove('alert-danger','alert-success');
                 addVulnerabilityForm.classList.remove('was-validated');
                 const issueNameInput = document.getElementById('addVulnIssueName');
                 issueNameInput?.classList.remove('is-invalid');
                 addVulnerabilityModal.show();
            } else { alert("新增弱點介面錯誤。"); }
        }
        async function handleSaveCustomVulnerability() {
            const reportFilename = addVulnerabilityModalElement.dataset.reportFilename;
            if (!reportFilename) { addVulnFeedback.textContent = '錯誤：缺少報告檔案資訊。'; addVulnFeedback.style.display = 'block'; addVulnFeedback.className = 'alert alert-danger small mt-2 py-2'; return; }
            addVulnFeedback.style.display = 'none'; addVulnerabilityForm.classList.remove('was-validated');
            const issueNameInput = document.getElementById('addVulnIssueName');
            if (!issueNameInput.value.trim()) { issueNameInput.classList.add('is-invalid'); addVulnFeedback.textContent = '請填寫弱點名稱。'; addVulnFeedback.style.display = 'block'; addVulnFeedback.className = 'alert alert-danger small mt-2 py-2'; return; }
            else { issueNameInput.classList.remove('is-invalid'); }
            const formData = new FormData(addVulnerabilityForm);
            const data = { reportFilename: reportFilename, issueName: formData.get('issueName'), severity: formData.get('severity'), url: formData.get('url') || 'N/A', entityName: formData.get('entityName') || 'N/A', note: formData.get('note') };
            saveCustomVulnerabilityBtn.disabled = true; saveCustomVulnerabilityBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 儲存中...`;
            try {
                const response = await fetch(getApiUrl('api/add_custom_vulnerability'), { method: 'POST', headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}, body: JSON.stringify(data) });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.error || `伺服器錯誤 ${response.status}`); }
                console.log("Custom vulnerability added:", result);
                addVulnFeedback.textContent = ''; addVulnerabilityModal.hide();
                fetchReportData(currentReportFilename);
            } catch (error) {
                console.error("Failed to add custom vulnerability:", error);
                addVulnFeedback.textContent = `新增失敗: ${error.message}`; addVulnFeedback.style.display = 'block'; addVulnFeedback.className = 'alert alert-danger small mt-2 py-2';
            } finally { if (saveCustomVulnerabilityBtn.closest('body')) { saveCustomVulnerabilityBtn.disabled = false; saveCustomVulnerabilityBtn.innerHTML = '儲存新增'; } }
        }

        // ========================================================================
        // === 報告選擇與數據獲取 ===
        // ========================================================================
         function selectReport(filename) {
            if (!filename) return;
            const modalRow = reportModalListBody?.querySelector(`tr[data-filename="${filename}"]`);
            if (modalRow && modalRow.classList.contains('report-row-disabled')) { console.warn(`Attempted to select filtered-out report: ${filename}`); return; }
            currentReportFilename = filename;
            if(selectedReportDisplay) { selectedReportDisplay.textContent = filename; selectedReportDisplay.classList.add('has-selection'); }
            const isPlaceholder = filename.endsWith("-找不到掃描檔");
            if(openScanFileButton) openScanFileButton.style.display = isPlaceholder ? 'none' : 'inline-block';
            if(addVulnerabilityBtn) addVulnerabilityBtn.disabled = false;
            if(fabOpenScanFile) fabOpenScanFile.style.display = isPlaceholder ? 'none' : 'flex';
            currentReportIndex = currentReportList.findIndex(r => r.filename === filename && !r.is_missing);
            updateFabNavButtons();
            fetchReportData(filename);
            if(filterSection) filterSection.style.display = 'block';
            if(displayContainer) displayContainer.style.display = 'block';
            if(reportListErrorDiv) { reportListErrorDiv.style.display = 'none'; reportListErrorDiv.textContent = ''; }
            updateFilterStatusDisplay();
            setTimeout(() => { if (displayContainer) { displayContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 100);
        }
        function fetchReportList() {
             if (!reportFilterSelect || !reportModalListBody) return;
             const reportFilterValue = reportFilterSelect.value || DEFAULT_REPORT_FILTER;
             console.log(`Fetching report list: Filter=${reportFilterValue}`);
             reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm"></div> 載入中...</td></tr>`;
             const apiUrl = getApiUrl(`api/reports?filter=${encodeURIComponent(reportFilterValue)}`);
             fetch(apiUrl)
                 .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.error || `Server error ${response.status}`); }))
                 .then(reportData => {
                     if (!Array.isArray(reportData)) throw new Error("報告列表格式無效。");
                     currentModalReportList = reportData;
                     populateReportModalList(currentModalReportList);
                     currentReportList = reportData.filter(r => !r.is_missing);
                     currentReportIndex = currentReportList.findIndex(r => r.filename === currentReportFilename);
                     updateFabNavButtons();
                     toggleAbnormalExportButtonVisibility();
                 })
                 .catch(error => {
                     reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>無法載入報告列表: ${escapeHtml(error.message)}</td></tr>`;
                     if(reportListErrorDiv) { reportListErrorDiv.textContent = `無法載入報告列表: ${error.message}`; reportListErrorDiv.style.display = 'block'; }
                     currentReportList = []; currentModalReportList = []; currentReportIndex = -1;
                     updateFabNavButtons(); toggleAbnormalExportButtonVisibility();
                  });
         }
         function compareReports(a, b, filter) {
            const getNumericNumber = (report) => {
                const num = report?.file_number;
                if (typeof num === 'number' && !isNaN(num)) { return num; }
                if (typeof num === 'string' && /^\d+$/.test(num)) { try { return parseInt(num, 10); } catch (e) { return Infinity; } }
                return Infinity;
            };
            const aNum = getNumericNumber(a); const bNum = getNumericNumber(b);
            const aIsProblematic = a?.is_missing || problematicStatuses.includes(a?.status);
            const bIsProblematic = b?.is_missing || problematicStatuses.includes(b?.status);
            const aMeetsThreshold = a?.meets_threshold ?? false; const bMeetsThreshold = b?.meets_threshold ?? false;
            if (filter === 'errors_only') { if (aIsProblematic !== bIsProblematic) { return aIsProblematic ? -1 : 1; } return aNum - bNum; }
            else if (filter === 'informational') { return aNum - bNum; }
            else { const scoreA = aIsProblematic ? 2 : (aMeetsThreshold ? 0 : 1); const scoreB = bIsProblematic ? 2 : (bMeetsThreshold ? 0 : 1); if (scoreA !== scoreB) { return scoreA - scoreB; } return aNum - bNum; }
        }
        function toggleAbnormalExportButtonVisibility() {
            if (exportAbnormalButton && reportFilterSelect) { exportAbnormalButton.style.display = (reportFilterSelect.value === 'errors_only') ? 'inline-block' : 'none'; }
        }
        function populateReportModalList(reports) {
             if (!reportModalListBody) return;
             reportModalListBody.innerHTML = '';
             if (!Array.isArray(reports)) { console.error("populateReportModalList received non-array:", reports); reports = []; }
             const reportFilterValue = reportFilterSelect.value || DEFAULT_REPORT_FILTER;
             reports.sort((a, b) => compareReports(a, b, reportFilterValue));
             if (reports && reports.length > 0) {
                 reports.forEach(report => {
                     const tr = document.createElement('tr');
                     tr.dataset.filename = report.filename;
                     if (report.file_number !== undefined && report.file_number !== null) tr.dataset.fileNumber = report.file_number;
                     tr.dataset.isMissing = report.is_missing ?? false;
                     const isErrorOrMissing = report.is_missing || problematicStatuses.includes(report.status);
                     const isDisabledDueToFilter = !report.meets_threshold && !isErrorOrMissing && !['informational', 'errors_only'].includes(reportFilterValue);
                     let rowClass = 'report-row-hover'; let titleText = `點擊載入: ${escapeHtml(report.filename)}`;
                     if (report.is_missing) { rowClass += ' missing-row'; titleText = `檔案遺失 (${escapeHtml(report.filename)})，點擊以新增手動弱點`; }
                     else if (isErrorOrMissing) { titleText = `掃描異常 (${escapeHtml(report.status)})，點擊以新增手動弱點`; }
                     else if (isDisabledDueToFilter) { rowClass = 'report-row-disabled'; titleText = '低於篩選條件，無法載入'; }
                     tr.className = rowClass; tr.title = titleText;
                     const statusText = report.status || SCAN_STATUS.UNKNOWN; const statusEmoji = STATUS_EMOJI[statusText] || STATUS_EMOJI[SCAN_STATUS.UNKNOWN];
                     let statusClass = 'modal-status-unknown';
                     if (statusText === SCAN_STATUS.SUCCESS) statusClass = 'modal-status-success';
                     else if ([SCAN_STATUS.FAILED, SCAN_STATUS.PARSE_ERROR, SCAN_STATUS.READ_ERROR].includes(statusText)) statusClass = 'modal-status-error';
                     else if ([SCAN_STATUS.ABORTED, SCAN_STATUS.INCOMPLETE].includes(statusText)) statusClass = 'modal-status-warning';
                     else if (statusText === SCAN_STATUS.MISSING || statusText === SCAN_STATUS.FILE_NOT_FOUND) statusClass = 'modal-status-missing';
                     let pagesStr = '-', entitiesStr = '-';
                     if (report.scan_stats && !report.is_missing) { const { pages_scanned: ps = '?', total_pages: tp = '?', entities_tested: et = '?', total_entities: te = '?' } = report.scan_stats; pagesStr = `${ps}/${tp}`; entitiesStr = `${et}/${te}`; }
                     const sevCounts = { c: '-', h: '-', m: '-', l: '-', i: '-' };
                     if (report.severity_summary && !report.is_missing) { sevCounts.c = report.severity_summary['critical'] ?? 0; sevCounts.h = report.severity_summary['high'] ?? 0; sevCounts.m = report.severity_summary['medium'] ?? 0; sevCounts.l = report.severity_summary['low'] ?? 0; sevCounts.i = report.severity_summary['informational'] ?? report.severity_summary['info'] ?? 0; }
                     const completedChecked = report.review_completed ? 'checked' : ''; const checkboxDisabled = report.is_missing ? 'disabled' : '';
                     const completedCell = `<td class="col-completed"><input class="form-check-input report-completion-checkbox" type="checkbox" value="" data-report-filename="${escapeHtml(report.filename)}" ${completedChecked} ${checkboxDisabled} title="${checkboxDisabled ? '無法標記遺失檔案' : '標記/取消標記判讀完成'}"><span class="spinner-border spinner-border-sm spinner-report-completion"></span></td>`;
                     const sevCls = (s, k) => (parseInt(s[k]) > 0 ? `sev-count-${k}` : '');
                     const filenameCellTitle = isDisabledDueToFilter ? '低於篩選條件' : `點擊載入: ${escapeHtml(report.filename)}`;
                     tr.innerHTML = `${completedCell}<td class="col-status ${statusClass}" title="${escapeHtml(statusText)}">${statusEmoji}</td><td class="col-filename filename-cell" title="${filenameCellTitle}">${escapeHtml(report.filename)}</td><td class="col-pages">${escapeHtml(pagesStr)}</td><td class="col-entities">${escapeHtml(entitiesStr)}</td><td class="col-sev-c ${sevCls(sevCounts, 'c')}">${escapeHtml(sevCounts.c)}</td><td class="col-sev-h ${sevCls(sevCounts, 'h')}">${escapeHtml(sevCounts.h)}</td><td class="col-sev-m ${sevCls(sevCounts, 'm')}">${escapeHtml(sevCounts.m)}</td><td class="col-sev-l ${sevCls(sevCounts, 'l')}">${escapeHtml(sevCounts.l)}</td><td class="col-sev-i ${sevCls(sevCounts, 'i')}">${escapeHtml(sevCounts.i)}</td>`;
                     reportModalListBody.appendChild(tr);
                 });
             } else {
                  const filterText = reportFilterSelect?.options[reportFilterSelect.selectedIndex]?.text || `"${reportFilterSelect?.value}"`;
                  let msg = `未找到符合條件 "${escapeHtml(filterText)}" 的報告。`;
                  if (reportFilterSelect?.value === 'informational') { msg = '此專案報告資料夾中目前沒有任何 XML 報告檔案。'; }
                  reportModalListBody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">${msg}</td></tr>`;
             }
        }
        // <<< MODIFIED: fetchReportData >>>
        function fetchReportData(filename, scrollYToRestore = null) {
            console.log(`Fetching data for report: ${filename}`);
            if (scrollYToRestore !== null) { console.log("fetchReportData - Will restore scroll to:", scrollYToRestore); }
            if (severityChartInstance) { severityChartInstance.destroy(); severityChartInstance = null; }
            if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = ''; if(issueListContainer) issueListContainer.innerHTML = '';
            groupedIssuesData = {}; if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none';
            if(displayContainer) displayContainer.style.display = 'block';
            if(issueListContainer) issueListContainer.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div><p class="mt-2">載入中...</p></div>`;
            // <<< NEW: Hide target info initially >>>
            if (selectedReportTargetInfoDiv) {
                 selectedReportTargetInfoDiv.style.display = 'none';
                 if(targetNameDisplaySpan) targetNameDisplaySpan.textContent = 'N/A';
                 if(targetUrlDisplaySpan) targetUrlDisplaySpan.textContent = 'N/A';
            }

            const severities = Array.from(filterForm.querySelectorAll('.severity-checkbox:checked')).map(cb => cb.value);
            const statuses = Array.from(filterForm.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
            const screenshotStatuses = Array.from(filterForm.querySelectorAll('.screenshot-status-filter-checkbox:checked')).map(cb => cb.value);
            const sources = Array.from(filterForm.querySelectorAll('.source-filter-checkbox:checked')).map(cb => cb.value).filter(val => val === 'appscan' || val === 'manual');
            const params = new URLSearchParams();
            severities.forEach(s => params.append('severity', s)); statuses.forEach(s => params.append('status_filter', s));
            screenshotStatuses.forEach(s => params.append('screenshot_status_filter', s)); sources.forEach(s => params.append('source_filter', s));
            const url = getApiUrl(`report/${encodeURIComponent(filename)}?${params.toString()}`);
            console.log("Fetching Report Data URL:", url);
            fetch(url)
            .then(response => { if (!response.ok) { return response.json().catch(() => null).then(errData => { throw new Error(errData?.error || `伺服器錯誤 ${response.status}: ${response.statusText}`); }); } return response.json(); })
            .then(data => {
                 if (!data || typeof data !== 'object') { throw new Error("報告數據格式無效或為空。"); }
                 console.log("Received report data:", data);
                 currentReportFullData = data;

                 // <<< Populate Target Info >>>
                 if (selectedReportTargetInfoDiv && targetNameDisplaySpan && targetUrlDisplaySpan) {
                     const targetName = data.target_name || "N/A";
                     const targetUrl = data.target_url || "N/A";
                     targetNameDisplaySpan.textContent = escapeHtml(targetName);
                     if (targetUrl !== "N/A" && (targetUrl.startsWith('http') || targetUrl.includes('.'))) {
                          let clickableUrl = targetUrl;
                          if (!clickableUrl.startsWith('http://') && !clickableUrl.startsWith('https://')) { clickableUrl = 'http://' + clickableUrl; }
                          try {
                               new URL(clickableUrl);
                               targetUrlDisplaySpan.innerHTML = `<a href="${escapeHtml(clickableUrl)}" target="_blank">${escapeHtml(targetUrl)} <i class="fas fa-external-link-alt fa-xs"></i></a>`;
                          } catch(e) { targetUrlDisplaySpan.textContent = escapeHtml(targetUrl) + " (格式無效)"; }
                     } else { targetUrlDisplaySpan.textContent = escapeHtml(targetUrl); }
                     selectedReportTargetInfoDiv.style.display = 'block';
                 }

                 console.log("Calling displayReportHeaderInfo..."); displayReportHeaderInfo(currentReportFullData); console.log("displayReportHeaderInfo finished.");
                 console.log("Calling renderIssueList..."); renderIssueList(data.issues || []); console.log("renderIssueList finished.");
                 if(filterSection) filterSection.style.display = 'block'; if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'flex';
                 updateFilterStatusDisplay(); console.log("Report data processed successfully.");
                 if (scrollYToRestore !== null) { console.log("Restoring scroll position to:", scrollYToRestore); requestAnimationFrame(() => { window.scrollTo({ top: scrollYToRestore, left: 0, behavior: 'instant' }); console.log("Scroll position restore attempt finished."); }); }
             })
            .catch(error => {
                 console.error("Error fetching or processing report data:", error);
                 if(reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = '';
                 if(issueListContainer) { issueListContainer.innerHTML = `<div class="alert alert-danger" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-octagon-fill me-2" viewBox="0 0 16 16"><path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>載入報告失敗: ${escapeHtml(error.message)}</div>`; }
                 // <<< Hide target info on error >>>
                 if (selectedReportTargetInfoDiv) { selectedReportTargetInfoDiv.style.display = 'none'; }
                 if(issueListHeaderDiv) issueListHeaderDiv.style.display = 'none'; if(filterSection) filterSection.style.display = 'none'; if(filterStatusDiv) filterStatusDiv.style.display = 'none';
             });
         }


        // ========================================================================
        // === 渲染邏輯 (將數據轉換為 HTML) ===
        // ========================================================================
        function displayReportHeaderInfo(data) {
            console.log("Inside displayReportHeaderInfo - Start");
            let headerHtml = ''; disposeCollapses();
            if (severityChartInstance) { try { severityChartInstance.destroy(); } catch (e) { console.error("Error destroying existing chart:", e); } severityChartInstance = null; }
            try {
                if (data.scan_info) {
                    headerHtml += `<h2 class="text-center report-scan-name">${escapeHtml(data.scan_info.scan_name)}</h2>`;
                    headerHtml += `<div class="scan-meta-area">`;
                    headerHtml += `<div class="scan-meta-block"><strong>掃描時間:</strong> <span class="value">${escapeHtml(data.scan_info.scan_date)}</span></div>`;
                    if (data.scan_stats && Object.keys(data.scan_stats).length > 0) { const { pages_scanned: ps = '?', total_pages: tp = '?', entities_tested: et = '?', total_entities: te = '?', issues_found: ifs = '?' } = data.scan_stats; headerHtml += `<div class="scan-meta-block"><strong>掃描統計:</strong><span class="value">頁面: <span class="badge bg-secondary">${escapeHtml(ps)}/${escapeHtml(tp)}</span></span><span class="value">實體: <span class="badge bg-secondary">${escapeHtml(et)}/${escapeHtml(te)}</span></span><span class="value">問題: <span class="badge bg-primary">${escapeHtml(ifs)}</span></span></div>`; }
                    else { headerHtml += `<div class="scan-meta-block"><strong>掃描統計:</strong> <span class="badge bg-light text-dark">N/A</span></div>`; }
                    let statusEntries = []; const statusOrder = ['未審查', '人工審查中', '已確認弱點', '誤判', '已自動排除', '處理錯誤']; const statusCounts = data.status_summary || {};
                    statusOrder.forEach(statusKey => { const count = statusCounts[statusKey] || 0; const badgeClass = count > 0 ? `status-badge-${statusKey.replace(/\s+/g, '')}` : 'status-badge-zero'; statusEntries.push(`<span class="badge ${badgeClass}" title="${escapeHtml(statusKey)}">${escapeHtml(statusKey)}: ${count}</span>`); });
                    for (const k in statusCounts) { if (!statusOrder.includes(k) && k !== '__unexpected__' && statusCounts[k] > 0) { statusEntries.push(`<span class="badge status-badge-非預期">${escapeHtml(k)}: ${statusCounts[k]}</span>`); } };
                    if (statusCounts['__unexpected__'] > 0) { statusEntries.push(`<span class="badge status-badge-非預期">非預期: ${statusCounts['__unexpected__']}</span>`); }
                    headerHtml += `<div class="scan-meta-block"><strong>狀態統計(已套用規則):</strong> <div class="status-summary-group">${statusEntries.join('')}</div></div>`;
                    headerHtml += `</div>`;
                } else { headerHtml += `<h2 class="text-center text-muted">掃描資訊 N/A</h2>`; }
                if (data.summary && Object.keys(data.summary).length > 0 && parseInt(data.summary.total_issues || '0') > 0) { headerHtml += `<h4 class="text-center mt-3">問題摘要 (依嚴重性)</h4>`; headerHtml += `<div id="severityChartContainer" style="position: relative; height:200px; width:80%; margin: 15px auto;"><canvas id="severityChartCanvas"></canvas></div>`; }
                headerHtml += `<hr/>`;
                if (reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = headerHtml; else console.error("reportHeaderInfoDiv not found!");
                if (data.summary && Object.keys(data.summary).length > 0 && parseInt(data.summary.total_issues || '0') > 0) { console.log("Scheduling chart rendering..."); setTimeout(() => { renderSeverityChart(data.summary); }, 0); }
                else { const chartContainer = document.getElementById('severityChartContainer'); if (chartContainer) chartContainer.innerHTML = ''; console.log("No chart data."); }
            } catch (e) { console.error("Error inside displayReportHeaderInfo logic:", e); if (reportHeaderInfoDiv) reportHeaderInfoDiv.innerHTML = `<div class="alert alert-danger">顯示報告標頭時出錯: ${escapeHtml(e.message)}</div>`; }
            console.log("Inside displayReportHeaderInfo - End");
        }
        function renderSeverityChart(summaryData) {
             const canvasElement = document.getElementById('severityChartCanvas');
             if (!canvasElement) {console.error("Canvas element not found for chart."); return; }
             const container = canvasElement.parentNode;
             if (!container || container.offsetParent === null) { console.warn("Chart container is not visible, skipping render."); return; }
             const severityOrder = ['critical', 'high', 'medium', 'low', 'informational'];
             const backgroundColors = ['#8B0000', '#dc3545', '#fd7e14', '#ffc107', '#0dcaf0'];
             const labels = severityOrder.map(k => SEVERITY_OPTIONS[k.charAt(0).toUpperCase() + k.slice(1)] || k);
             const dataPoints = severityOrder.map(k => { const dataKey = k === 'informational' ? 'info' : k; const count = parseInt(summaryData[dataKey] || summaryData[k] || '0', 10); return isNaN(count) ? 0 : count; });
             if (severityChartInstance) { try { severityChartInstance.destroy(); } catch(e) {} }
             try {
                 const isDarkMode = document.body.classList.contains('dark-mode');
                 const tickColor = isDarkMode ? '#bdc1c6' : '#555'; const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                 severityChartInstance = new Chart(canvasElement, {
                     type: 'bar', data: { labels: labels, datasets: [{ label: '問題數量', data: dataPoints, backgroundColor: backgroundColors, borderWidth: 1 }] },
                     options: { indexAxis: 'x', responsive: true, maintainAspectRatio: false,
                         scales: { y: { beginAtZero: true, ticks: { precision: 0, color: tickColor }, grid: { color: gridColor } }, x: { ticks: { autoSkip: false, maxRotation: 0, minRotation: 0, color: tickColor, callback: function(v, i) { return `${this.getLabelForValue(v)}\n(${dataPoints[i] ?? '?'})`; } }, grid: { display: false } } },
                         plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label || ''}: ${ctx.parsed.y ?? ''}` } } } } });
             } catch (e) { console.error("Error rendering chart:", e); if (container) { container.innerHTML = '<p class="text-danger small text-center">無法載入圖表。</p>'; } }
        }
        // <<< MODIFIED: generateIssueCardHTML (Removed inline caption input) >>>
        function generateIssueCardHTML(issue, uniqueIndexSuffix, isGroupRepresentative = false, groupKey = null, groupMembersJson = '[]') {
            if (!issue || !issue.id) return '';
            const severityKey = issue.severity_key || 'unknown'; const severityClass = `severity-${severityKey}`;
            const cardId = `issue-card-${uniqueIndexSuffix}`; const collapseId = `traffic-${uniqueIndexSuffix}`;
            const trafficCodeId = `traffic-code-${collapseId}`; const screenshotCheckboxId = `screenshot-completion-check-${uniqueIndexSuffix}`;
            const screenshotFileInputId = `screenshot-input-${uniqueIndexSuffix}`; const screenshotListId = `screenshot-list-${uniqueIndexSuffix}`;
            const noteTextareaId = `note-textarea-${uniqueIndexSuffix}`; const noteFeedbackId = `note-feedback-${uniqueIndexSuffix}`;
            const noteSpinnerId = `note-spinner-${uniqueIndexSuffix}`; const noteSaveBtnId = `note-save-btn-${uniqueIndexSuffix}`;
            // Removed captionInputId

            const isManual = issue.source === 'manual'; const isError = issue.source === 'error';
            const cardClasses = `issue-card ${severityClass} source-${issue.source || 'appscan'}`;
            const representativeAttr = isGroupRepresentative ? `data-is-representative="true"` : '';
            const groupKeyAttr = groupKey ? `data-group-key="${escapeHtml(groupKey)}"` : '';
            const representativeIssueIdAttr = isGroupRepresentative ? `data-representative-issue-id="${escapeHtml(issue.id)}"` : '';
            const groupMembersAttr = `data-group-members='${escapeHtml(groupMembersJson)}'`;
            const entityType = issue.entity_type || ''; const entityName = issue.entity_name || '';
            const issueReasoning = issue.reasoning || ''; const isComponent = entityType.toLowerCase().includes('component');
            const isLink = entityType.toLowerCase().includes('link'); let componentVersion = 'N/A'; let componentName = 'N/A';
            if (isComponent && entityName !== 'N/A') { componentName = entityName; const versionMatch = entityName.match(/([\d][\d\.a-zA-Z_-]+)/); if (versionMatch) { componentVersion = versionMatch[0]; let baseName = entityName.substring(0, versionMatch.index).trim(); if (baseName.endsWith(' (')) baseName = baseName.substring(0, baseName.length - 2).trim(); if(baseName) componentName = baseName; } else { componentName = entityName.replace(/\(Component\)$/i, '').trim(); } }
            let detailsHtml = ''; if (issue.cve_name) { detailsHtml = issue.cve_url ? `<a href="${escapeHtml(issue.cve_url)}" target="_blank">${escapeHtml(issue.cve_name)}</a>` : escapeHtml(issue.cve_name); } else if (issue.cvss_score && issue.cvss_score !== 'N/A') { detailsHtml = `CVSS: ${escapeHtml(issue.cvss_score)}`; }
            const issueType = issue.issue_type || ''; const issueUrl = issue.url || ''; let issueTypeHtml = escapeHtml(issueType);
            const specificTlsIssueNames = ['支援較早的 TLS 版本', 'SSL/TLS Server Supports TLSv1.0', 'SSL/TLS Server Supports TLSv1.1'];
            if (specificTlsIssueNames.includes(issueType)) { const hostname = extractHostname(issueUrl); if (hostname) { const sslLabsUrl = `https://www.ssllabs.com/ssltest/analyze.html?d=${encodeURIComponent(hostname)}`; issueTypeHtml = `<a href="${sslLabsUrl}" target="_blank" class="issue-type-link">${escapeHtml(issueType)} <i class="fas fa-external-link-alt fa-xs"></i></a>`; } }
            const sourceIndicatorHtml = isManual ? '<span class="manual-indicator">手動</span>' : (isError ? '<span class="error-indicator">錯誤</span>' : '');
            const headerHtml = `<div class="issue-card-header">{#Num#}<span class="badge ${getSeverityBadgeColor(severityKey)} me-2">${escapeHtml(issue.severity_display)}</span><span class="issue-title-part">${issueTypeHtml} ${sourceIndicatorHtml}</span><span class="details-part">${detailsHtml}</span></div>`;
            const initialStatusValue = issue.status || DEFAULT_STATUS; const initialSelectColors = statusOptionColors[initialStatusValue] || statusOptionColors['default'];
            const initialSelectStyleAttribute = `style="background-color: ${initialSelectColors.bg}; color: ${initialSelectColors.text};"`;
            let statusDropdownHtml = `<select class="form-select form-select-sm status-select" ${initialSelectStyleAttribute} data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}" ${isError ? 'disabled title="無法變更錯誤狀態"' : ''}>`;
            for (const [value, text] of Object.entries(STATUS_OPTIONS)) { const isDisabled = value === AUTO_EXCLUDED_STATUS; const isSelected = value === issue.status; const colors = statusOptionColors[value] || statusOptionColors['default']; const styleAttribute = `style="background-color: ${colors.bg}; color: ${colors.text};"`; statusDropdownHtml += `<option value="${escapeHtml(value)}" ${styleAttribute} ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}>${escapeHtml(text)}</option>`; }
            statusDropdownHtml += `</select>`;
            const statusContainerHtml = `<span class="status-container ms-1">${statusDropdownHtml}<span class="spinner-border spinner-border-sm status-update-spinner ms-1" style="display: none;"></span><span class="status-update-feedback ms-1" style="display: none;"></span></span>`;
            const isScreenshotCompleted = issue.screenshot_taken === true;
            const screenshotCompletionCheckHtml = `<div class="form-check form-switch screenshot-line"><input class="form-check-input screenshot-completion-checkbox" type="checkbox" role="switch" id="${screenshotCheckboxId}" data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}" ${isScreenshotCompleted ? 'checked' : ''} ${isError ? 'disabled' : ''}><label class="form-check-label" for="${screenshotCheckboxId}">已完成全部截圖</label><div class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></div><span class="text-danger ms-1" style="display: none;"></span></div>`;
            let urlHtml = escapeHtml(issue.url); const rawUrl = issue.url;
            if (rawUrl && typeof rawUrl === 'string' && rawUrl.toLowerCase() !== 'n/a' && (rawUrl.startsWith('http') || rawUrl.includes('.'))) { let clickableUrl = rawUrl; if (!clickableUrl.startsWith('http://') && !clickableUrl.startsWith('https://')) clickableUrl = 'http://' + clickableUrl; try { new URL(clickableUrl); urlHtml = `<a href="${escapeHtml(clickableUrl)}" target="_blank" class="issue-url-link">${escapeHtml(rawUrl)} <i class="fas fa-external-link-alt fa-xs"></i></a>`; } catch (e) {} }
            const rawEntityName = issue.entity_name; let entityDisplayHtml = '';
            if (typeof rawEntityName === 'string' && (rawEntityName.startsWith('http://') || rawEntityName.startsWith('https://'))) { entityDisplayHtml = `<a href="${escapeHtml(rawEntityName)}" target="_blank" class="issue-entity-link">${escapeHtml(rawEntityName)}</a>`; } else { entityDisplayHtml = escapeHtml(rawEntityName || 'N/A'); }
            const entityHtml = `<span style="word-break: break-all;">${entityDisplayHtml} (${escapeHtml(entityType)})</span>`;
            let trafficSectionHtml = '';
            if (!isError && !isManual) { const rawTraffic = issue.http_traffic || '無 HTTP 流量數據。'; const escapedTraffic = escapeHtml(rawTraffic); let formattedTrafficHtml = escapedTraffic.replace(/--begin_mark_tag--(.*?)--end_mark_tag--/g,'<span class="text-danger fw-bold">$1</span>'); formattedTrafficHtml = formattedTrafficHtml.replace(/--begin_highlight_tag--(.*?)--end_highlight_tag--/g,'<span class="text-danger fw-bold">$1</span>'); const trafficToggleHtml = `<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}"><i class="fas fa-code"></i> 顯示/隱藏 HTTP 流量</button>`; const trafficCollapseHtml = `<div class="collapse" id="${collapseId}"><div class="traffic-details mt-2"><pre><code id="${trafficCodeId}">${formattedTrafficHtml}</code></pre></div></div>`; let verifyButtonHtml = ''; if ((isComponent || isLink || issueReasoning == EXTERNAL_LINK_REASONING) && issue.url && issue.url !== 'N/A') { verifyButtonHtml = `<button type="button" class="btn btn-outline-warning btn-sm verify-vulnerability-btn ms-2" title="嘗試使用 Selenium 開啟原始碼並尋找相關內容" data-issue-url="${escapeHtml(issue.url)}" data-entity-name="${escapeHtml(entityName)}" data-entity-type="${escapeHtml(entityType)}" data-reasoning="${escapeHtml(issueReasoning)}" data-component-name="${escapeHtml(componentName)}" data-component-version="${escapeHtml(componentVersion)}"><i class="fab fa-chrome"></i> 驗證</button>`; } trafficSectionHtml = `<div class="mt-2 d-flex gap-2 flex-wrap">${trafficToggleHtml}${verifyButtonHtml}</div>${trafficCollapseHtml}`; }
            let screenshotSectionHtml = '';
            if (!isError) {
                // <<< REMOVED inline caption input, common note button for caption (handled in modal) >>>
                screenshotSectionHtml = `
                    <div class="screenshot-section">
                        <div class="screenshot-controls">
                            <button type="button" class="btn btn-outline-primary btn-sm upload-screenshot-btn" data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}" data-file-input-id="${screenshotFileInputId}"><i class="fas fa-upload"></i> 上傳</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm paste-screenshot-btn ms-1" data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}"><i class="fas fa-paste"></i> 貼上</button>
                            <input type="file" id="${screenshotFileInputId}" class="screenshot-file-input" accept="image/*" style="display: none;" data-issue-id="${escapeHtml(issue.id)}" data-issue-name="${escapeHtml(issue.issue_type)}">
                            <span class="spinner-border spinner-border-sm ms-1" style="display: none;"></span>
                            <span class="upload-feedback ms-1" style="display: none;"></span>
                        </div>
                        <ul class="uploaded-screenshots-list mt-2" id="${screenshotListId}">`;
                if (issue.screenshots_detailed && issue.screenshots_detailed.length > 0) {
                     const sortedScreenshots = [...issue.screenshots_detailed].sort((a, b) => naturalSort(a.filename, b.filename));
                     sortedScreenshots.forEach(ss_data => {
                         const url = getApiUrl(`screenshots/${encodeURIComponent(ss_data.filename)}`);
                         const captionText = ss_data.caption ? escapeHtml(ss_data.caption) : '';
                         screenshotSectionHtml += `
                             <li>
                                 <div class="d-flex justify-content-between align-items-center w-100">
                                    <div class="flex-grow-1 me-2">
                                        <a href="${url}" class="screenshot-view-link" data-caption="${escapeHtml(captionText)}" data-filename="${escapeHtml(ss_data.filename)}" title="點擊查看圖片與備註">${escapeHtml(ss_data.filename)}</a>
                                        <small class="text-muted screenshot-caption ms-1" style="word-break: break-all;">${captionText}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm flex-shrink-0" role="group">
                                         <button type="button" class="btn btn-outline-secondary btn-xs edit-caption-btn" data-filename="${escapeHtml(ss_data.filename)}" data-issue-id="${escapeHtml(issue.id)}" title="編輯備註"><i class="fas fa-edit"></i></button>
                                         <button type="button" class="btn btn-outline-danger btn-xs delete-screenshot-btn" data-filename="${escapeHtml(ss_data.filename)}" data-issue-id="${escapeHtml(issue.id)}" title="移至垃圾桶"><i class="fas fa-trash-alt"></i></button>
                                     </div>
                                 </div>
                             </li>`;
                     });
                 } else { screenshotSectionHtml += `<li class="no-screenshots-msg text-muted"><em>尚無截圖</em></li>`; }
                 screenshotSectionHtml += `</ul></div>`;
            }
            let noteSectionHtml = '';
            if (!isError) {
                noteSectionHtml = `
                    <div class="note-section">
                        <label for="${noteTextareaId}" class="form-label form-label-sm mb-1">筆記:</label>
                        <textarea class="form-control form-control-sm issue-note-textarea" id="${noteTextareaId}" rows="3" data-issue-id="${escapeHtml(issue.id)}" data-report-filename="${escapeHtml(currentReportFilename)}" placeholder="在此輸入筆記...">${escapeHtml(issue.note || '')}</textarea>
                        <div class="note-controls">
                            <button type="button" class="btn btn-outline-success btn-sm save-note-btn" id="${noteSaveBtnId}"><i class="fas fa-save"></i> 儲存筆記</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-insert-common-note ms-2"
                                    data-bs-toggle="dropdown" aria-expanded="false"
                                    data-target-textarea-id="${noteTextareaId}"
                                    data-issue-type="${escapeHtml(issue.issue_type)}" title="插入常用備註至問題筆記">
                                <i class="fas fa-list"></i>
                            </button>
                            <ul class="dropdown-menu common-notes-dynamic-menu" aria-labelledby="dropdownMenuButton-${uniqueIndexSuffix}-note"></ul>
                            <span class="spinner-border spinner-border-sm text-secondary note-spinner" id="${noteSpinnerId}" role="status" style="display: none;"></span>
                            <span class="note-feedback ms-2" id="${noteFeedbackId}"></span>
                        </div>
                    </div>`;
            }
            const cardBodyHtml = `<div class="issue-card-body"><div class="status-and-screenshot-area"><div class="status-line"><strong>狀態:</strong>${statusContainerHtml}</div>${screenshotCompletionCheckHtml}</div><p class="mb-1"><strong>URL:</strong> <span style="word-break: break-all;">${urlHtml}</span></p><p class="mb-1"><strong>實體:</strong> ${entityHtml}</p><p class="mb-1"><strong>原因:</strong> <span style="white-space: pre-wrap;">${escapeHtml(issueReasoning)}</span></p>${trafficSectionHtml}${screenshotSectionHtml}${noteSectionHtml}</div>`;
            return `<div class="${cardClasses}" id="${cardId}" ${representativeAttr} ${groupKeyAttr} ${representativeIssueIdAttr} ${groupMembersAttr}>${headerHtml.replace('{#Num#}', '')}${cardBodyHtml}</div>`;
        }
        function renderIssueList(issues) {
            console.log("Inside renderIssueList - Start, issue count:", (issues || []).length);
            let issueListHtml = '';
            const issueCount = (issues || []).length;
            if(issueCountSpan) issueCountSpan.textContent = issueCount;
            const sortBy = sortSelect?.value || DEFAULT_SORT;
            let issuesToDisplay = [...(issues || [])];
            let groupedIssues = {};
            try {
                issuesToDisplay.sort((a, b) => { const ia = a || {}, ib = b || {}; const aIsError = ia.source === 'error'; const bIsError = ib.source === 'error'; if (aIsError !== bIsError) return aIsError ? 1 : -1; switch (sortBy) { case 'severity': return (SEVERITY_LEVELS[ib.severity_key?.toLowerCase()] ?? -1) - (SEVERITY_LEVELS[ia.severity_key?.toLowerCase()] ?? -1); case 'url': return (ia.url || '').localeCompare(ib.url || ''); case 'issue_type': return (ia.issue_type || '').localeCompare(ib.issue_type || ''); case 'status': return (ia.status || '').localeCompare(ib.status || ''); default: return 0; } });
                console.log("Sorting finished.");
                groupedIssues = {};
                issuesToDisplay.forEach(issue => { const groupKey = issue.source === 'error' ? `error_${issue.id}` : `${issue.url || 'N/A'}|||${issue.issue_type || 'Unknown Type'}|||${issue.entity_name || 'N/A'}`; if (!groupedIssues[groupKey]) groupedIssues[groupKey] = []; groupedIssues[groupKey].push(issue); });
                groupedIssuesData = groupedIssues;
                console.log("Grouping finished. Group count:", Object.keys(groupedIssues).length);
                let displayIndex = 0;
                if (groupedIssues && typeof groupedIssues === 'object') {
                    Object.entries(groupedIssues).forEach(([groupKey, group], groupIndex) => {
                        displayIndex++;
                        const isErrorGroup = group[0]?.source === 'error';
                        const memberIdentifiers = group.map(member => ({ reportFilename: currentReportFilename, issueId: member.id }));
                        const membersJsonString = JSON.stringify(memberIdentifiers);
                        if (group.length === 1 || isErrorGroup) {
                            const issue = group[0]; const uniqueSuffix = `issue-${issue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`;
                            let cardHtml = generateIssueCardHTML(issue, uniqueSuffix, false, null, membersJsonString);
                            if (cardHtml) { const headerRegex = /(<div class="issue-card-header.*?>)/; cardHtml = cardHtml.replace(headerRegex, `$1<span class="me-2 issue-title-part">${displayIndex}.</span> `); issueListHtml += cardHtml; }
                         } else {
                            let highestSeverityLevel = -1; let representativeIssue = group[0];
                            group.forEach(iss => { const level = SEVERITY_LEVELS[iss.severity_key?.toLowerCase()] ?? -1; if (level > highestSeverityLevel) { highestSeverityLevel = level; representativeIssue = iss; } });
                            const groupSeverityKey = Object.keys(SEVERITY_LEVELS).find(key => SEVERITY_LEVELS[key] === highestSeverityLevel) || 'unknown';
                            const groupSeverityClass = `severity-${groupSeverityKey}`; const highestSeverityDisplay = representativeIssue?.severity_display || '未知';
                            const groupCollapseId = `group-collapse-${groupIndex}`; const groupContainerId = `group-container-${groupIndex}`;
                            const representativeUniqueSuffix = `issue-${representativeIssue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`;
                            let repCardHtml = generateIssueCardHTML(representativeIssue, representativeUniqueSuffix, true, groupKey, membersJsonString);
                            if (repCardHtml) { repCardHtml = repCardHtml.replace(/ severity-[a-z\-]+/, ''); }
                            const groupHeaderHtml = `<div class="issue-group-header"><span class="issue-title-part">${displayIndex}. <span class="badge ${getSeverityBadgeColor(groupSeverityKey)} me-2">${escapeHtml(highestSeverityDisplay)}</span>${escapeHtml(representativeIssue.issue_type)}<span class="badge bg-secondary ms-2">${group.length} 個實例</span></span><button class="btn btn-outline-secondary btn-sm btn-toggle-group" type="button" data-bs-toggle="collapse" data-bs-target="#${groupCollapseId}"><i class="fas fa-chevron-down"></i> <span>查看 ${group.length} 個實例</span></button></div>`;
                            let innerCardsHtml = '';
                            group.forEach((issue, issueIndex) => { if (issue.id === representativeIssue.id) return; const uniqueSuffix = `issue-${issue.id.replace(/[^a-zA-Z0-9-_]/g, '_')}`; let cardHtml = generateIssueCardHTML(issue, uniqueSuffix, false, groupKey, membersJsonString); if(cardHtml) { const headerRegex = /(<div class="issue-card-header.*?>)/; cardHtml = cardHtml.replace(headerRegex, `$1<span class="me-2 text-muted small issue-title-part">(實例 ${issueIndex + 1} / CVE: ${escapeHtml(issue.cve_name || 'N/A')})</span>`); cardHtml = cardHtml.replace(/ severity-[a-z\-]+/, ''); innerCardsHtml += cardHtml; } });
                            issueListHtml += `<div class="issue-group-container ${groupSeverityClass}" id="${groupContainerId}" data-group-key="${escapeHtml(groupKey)}" data-group-members='${escapeHtml(membersJsonString)}'>${groupHeaderHtml}<div class="issue-group-representative-card">${repCardHtml}</div><div class="collapse issue-group-body" id="${groupCollapseId}">${innerCardsHtml}</div></div>`;
                        }
                    });
                     console.log("HTML generation loop finished.");
                } else { console.error("groupedIssues is not an object after grouping logic!"); issueListHtml = `<div class="alert alert-danger">處理問題分組時發生內部錯誤。</div>`; }
            } catch (e) { console.error("Error during issue processing or HTML generation:", e); issueListHtml = `<div class="alert alert-danger">渲染問題列表時出錯: ${escapeHtml(e.message)}</div>`; }
            if (issueCount === 0 && !issueListHtml.includes('alert-danger')) { const filterCheckboxes = filterForm?.querySelectorAll('.filter-checkbox'); const checkedCheckboxes = filterForm?.querySelectorAll('.filter-checkbox:checked'); const hasFilters = filterCheckboxes && checkedCheckboxes && checkedCheckboxes.length < filterCheckboxes.length; const msg = hasFilters ? '目前報告中沒有任何問題符合目前的篩選條件。請嘗試清除篩選條件。' : '此報告中未發現問題，或所有問題已被預設篩選器排除。'; issueListHtml = `<div class="alert alert-${hasFilters ? 'warning' : 'info'} mt-3" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412l-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>${escapeHtml(msg)}</div>`; }
            if(issueListContainer) issueListContainer.innerHTML = issueListHtml;
            try {
                if(issueListContainer) {
                    issueListContainer.querySelectorAll('.btn-toggle-group').forEach(button => {
                        const targetId = button.dataset.bsTarget; const collapseEl = document.querySelector(targetId);
                        const container = button.closest('.issue-group-container'); const groupKey = container?.dataset.groupKey;
                        const count = groupedIssuesData[groupKey]?.length || 0;
                        if (collapseEl && count > 1) { const viewText = `查看 ${count} 個實例`; const collapseText = `收合實例`; button.querySelector('span').textContent = viewText; collapseEl.addEventListener('show.bs.collapse', () => { button.querySelector('span').textContent = collapseText; button.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up'); }); collapseEl.addEventListener('hide.bs.collapse', () => { button.querySelector('span').textContent = viewText; button.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down'); }); }
                        else if (button) { button.style.display = 'none'; }
                    });
                }
                initializeCollapses();
            } catch (e) { console.error("Error initializing collapses or toggle buttons:", e); }
            console.log("Inside renderIssueList - End");
        }

    </script>

</body>
</html>